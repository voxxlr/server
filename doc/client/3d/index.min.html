<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon"> 
    <meta charset="UTF-8">
    <title>Voxxlr Viewer</title>
    <link rel="canonical" href="https://www.voxxlr.com/index.html">
     
    <script>
    
        window.addEventListener("load", () => 
        {
            document.addEventListener('contextmenu', event => event.preventDefault());
            
            var config = {{#content}}{{{.}}}{{/content}}   {{^content}}null{{/content}};
            
            var viewer = new V3.Viewer(config);
            if (config != null)
            {
                if (config.type == "model")
                {
                    viewer.load(config.id, new M.Model(config, V.viewerCb));
                }
                else if (config.type == "cloud")
                {
                    viewer.load(config.id, new M.Cloud(config, V.viewerCb));
                }
            }
       });
        
    </script>
        
    <style>
    
        body { overflow: hidden;  touch-action: none; }
        canvas { position: absolute; top: 0px; left: 0px; width:100%; height:100% }
        
    </style>
  
</head>
<body>

    <canvas id="canvas3D"></canvas>
    <canvas id="canvas2D" class="events"></canvas> 
   
</body>
 
<script id="/geom/geom.js">GM={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,clamp:function(a,b,c){return Math.max(b,Math.min(c,a))}};
GM.Vector3=class{constructor(a,b,c){this.x=a||0;this.y=b||0;this.z=c||0}clone(){return new GM.Vector3(this.x,this.y,this.z)}copy(a){this.x=a.x;this.y=a.y;this.z=a.z;return this}set(a,b,c){this.x=a;this.y=b;this.z=c;return this}readArray(a,b){this.x=a[b];this.y=a[b+1];this.z=a[b+2];return this}add(a){this.x+=a.x;this.y+=a.y;this.z+=a.z;return this}sub(a){this.x-=a.x;this.y-=a.y;this.z-=a.z;return this}multiply(a){this.x*=a.x;this.y*=a.y;this.z*=a.z;return this}addScaledVector(a,b){this.x+=a.x*b;this.y+=
a.y*b;this.z+=a.z*b;return this}crossVectors(a,b){var c=a.x,d=a.y;a=a.z;var e=b.x,f=b.y;b=b.z;this.x=d*b-a*f;this.y=a*e-c*b;this.z=c*f-d*e;return this}subVectors(a,b){this.x=a.x-b.x;this.y=a.y-b.y;this.z=a.z-b.z;return this}multiplyScalar(a){isFinite(a)?(this.x*=a,this.y*=a,this.z*=a):this.z=this.y=this.x=0;return this}multiplyVectors(a,b){this.x=a.x*b.x;this.y=a.y*b.y;this.z=a.z*b.z;return this}applyMatrix3(a){var b=this.x,c=this.y,d=this.z;a=a.elements;this.x=a[0]*b+a[3]*c+a[6]*d;this.y=a[1]*b+
a[4]*c+a[7]*d;this.z=a[2]*b+a[5]*c+a[8]*d;return this}transform(a){var b=this.x,c=this.y,d=this.z;a=a.elements;this.x=a[0]*b+a[4]*c+a[8]*d+a[12];this.y=a[1]*b+a[5]*c+a[9]*d+a[13];this.z=a[2]*b+a[6]*c+a[10]*d+a[14];return this}applyQuaternion(a){var b=this.x,c=this.y,d=this.z,e=a.x,f=a.y,g=a.z;a=a.w;var h=a*b+f*d-g*c,k=a*c+g*b-e*d,l=a*d+e*c-f*b;b=-e*b-f*c-g*d;this.x=h*a+b*-e+k*-g-l*-f;this.y=k*a+b*-f+l*-e-h*-g;this.z=l*a+b*-g+h*-f-k*-e;return this}divide(a){this.x/=a.x;this.y/=a.y;this.z/=a.z;return this}divideScalar(a){return this.multiplyScalar(1/
a)}min(a){this.x=Math.min(this.x,a.x);this.y=Math.min(this.y,a.y);this.z=Math.min(this.z,a.z);return this}max(a){this.x=Math.max(this.x,a.x);this.y=Math.max(this.y,a.y);this.z=Math.max(this.z,a.z);return this}negate(){this.x=-this.x;this.y=-this.y;this.z=-this.z;return this}dot(a){return this.x*a.x+this.y*a.y+this.z*a.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}normalize(){return this.divideScalar(this.length())}distanceTo(a){return Math.sqrt(this.distanceToSquared(a))}distanceToSquared(a){var b=
this.x-a.x,c=this.y-a.y;a=this.z-a.z;return b*b+c*c+a*a}setFromMatrixColumn(a,b){return this.readArray(a.elements,4*b)}toJson(){return{x:this.x,y:this.y,z:this.z}}static create(a,b,c){return{x:a,y:b,z:c}}static mag(a){return Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z)}static normalize(a,b){var c=GM.Vector3.mag(a);b.x=a.x/c;b.y=a.y/c;b.z=a.z/c;return b}static negate(a,b){b.x=-a.x;b.y=-a.y;b.z=-a.z}static cross(a,b,c){var d=a.x,e=a.y;a=a.z;var f=b.x,g=b.y;b=b.z;c.x=e*b-a*g;c.y=a*f-d*b;c.z=d*g-e*f;return c}static distance(a,
b){var c=a.x-b.x,d=a.y-b.y;a=a.z-b.z;return Math.sqrt(c*c+d*d+a*a)}static dot(a,b){return a.x*b.x+a.y*b.y+a.z*b.z}static rotate(a,b,c){var d=a.x,e=a.y;a=a.z;c.x=b[0]*d+b[4]*e+b[8]*a;c.y=b[1]*d+b[5]*e+b[9]*a;c.z=b[2]*d+b[6]*e+b[10]*a;return c}static addScalar(a,b,c,d){d.x=a.x+b.x*c;d.y=a.y+b.y*c;d.z=a.z+b.z*c;return d}static copy(a,b){b.x=a.x;b.y=a.y;b.z=a.z;return b}static scale(a,b,c){c.x=a.x*b;c.y=a.y*b;c.z=a.z*b;return c}static transform(a,b,c){let d=a.x;var e=a.y;a=a.z;c.x=b[0]*d+b[4]*e+b[8]*
a+b[12];c.y=b[1]*d+b[5]*e+b[9]*a+b[13];c.z=b[2]*d+b[6]*e+b[10]*a+b[14];return c}static subtract(a,b,c){c.x=a.x-b.x;c.y=a.y-b.y;c.z=a.z-b.z;return c}static min(a,b,c){c.x=Math.min(a.x,b.x);c.y=Math.min(a.y,b.y);c.z=Math.min(a.z,b.z);return c}static max(a,b,c){c.x=Math.max(a.x,b.x);c.y=Math.max(a.y,b.y);c.z=Math.max(a.z,b.z);return c}static add(a,b,c){c.x=a.x+b.x;c.y=a.y+b.y;c.z=a.z+b.z;return c}static sub(a,b,c){c=c||{};c.x=a.x-b.x;c.y=a.y-b.y;c.z=a.z-b.z;return c}static sub3V(a,b,c,d,e){e=e||{};e.x=
a-d.x;e.y=b-d.y;e.z=c-d.z;return e}static read(a,b,c){a.x=b[c];a.y=b[c+1];a.z=b[c+2];return a}static fromMatrix(a,b){b.x=a[12];b.y=a[13];b.z=a[14]}};
GM.Ray=class{constructor(a,b){this.origin=void 0!==a?a:new GM.Vector3;this.direction=void 0!==b?b:new GM.Vector3}set(a,b){this.origin.copy(a);this.direction.copy(b);return this}copy(a){this.origin.copy(a.origin);this.direction.copy(a.direction)}transform(a){this.direction.x+=this.origin.x;this.direction.y+=this.origin.y;this.direction.z+=this.origin.z;this.direction.transform(a);this.origin.transform(a);this.direction.x-=this.origin.x;this.direction.y-=this.origin.y;this.direction.z-=this.origin.z;
return this}at(a,b){b.x=this.origin.x+this.direction.x*a;b.y=this.origin.y+this.direction.y*a;b.z=this.origin.z+this.direction.z*a;return b}intersectBox(a){var b=[0,0,0];var c=1/this.direction.x;var d=1/this.direction.y;var e=1/this.direction.z,f=this.origin;if(0<=c){var g=(a.min.x-f.x)*c;c*=a.max.x-f.x;b[0]=0}else g=(a.max.x-f.x)*c,c*=a.min.x-f.x,b[0]=1;var h=b[0];if(0<=d){var k=(a.min.y-f.y)*d;d*=a.max.y-f.y;b[1]=2}else k=(a.max.y-f.y)*d,d*=a.min.y-f.y,b[1]=3;if(g>d||k>c)return null;if(k>g||g!==
g)g=k,h=b[1];if(d<c||c!==c)c=d;0<=e?(k=(a.min.z-f.z)*e,a=(a.max.z-f.z)*e,b[2]=4):(k=(a.max.z-f.z)*e,a=(a.min.z-f.z)*e,b[2]=5);if(g>a||k>c)return null;if(k>g||g!==g)g=k,h=b[2];if(a<c||c!==c)c=a;return 0>c?null:{distance:g,face:h}}intersectMinMax(a,b){var c=1/this.direction.x;var d=1/this.direction.y;var e=1/this.direction.z,f=this.origin;if(0<=c){var g=(a[0]-f.x)*c;c*=b[0]-f.x}else g=(b[0]-f.x)*c,c*=a[0]-f.x;if(0<=d){var h=(a[1]-f.y)*d;d*=b[1]-f.y}else h=(b[1]-f.y)*d,d*=a[1]-f.y;if(g>d||h>c)return null;
if(h>g||g!==g)g=h;if(d<c||c!==c)c=d;0<=e?(h=(a[2]-f.z)*e,a=(b[2]-f.z)*e):(h=(b[2]-f.z)*e,a=(a[2]-f.z)*e);if(g>a||h>c)return null;if(h>g||g!==g)g=h;if(a<c||c!==c)c=a;return 0>c?null:g}intersectPlane(a,b){a=-(GM.Vector3.dot(a,this.origin)-a.w)/GM.Vector3.dot(a,this.direction);return 0<=a?this.at(a,b):null}static transform(a,b,c){GM.Vector3.add(a.direction,a.origin,c.direction);GM.Vector3.transform(c.direction,b,c.direction);GM.Vector3.transform(a.origin,b,c.origin);GM.Vector3.sub(c.direction,c.origin,
c.direction);return c}static intersectPlane(a,b,c){b=-(b.x*a.origin.x+b.y*a.origin.y+b.z*a.origin.z-b.w)/(b.x*a.direction.x+b.y*a.direction.y+b.z*a.direction.z);c.x=a.direction.x*b+a.origin.x;c.y=a.direction.y*b+a.origin.y;c.z=a.direction.z*b+a.origin.z;return c}};
GM.Plane=class{static create(a,b,c,d){return{x:a,y:b,z:c,w:d}}static init(a,b,c,d,e){a.x=b;a.y=c;a.z=d;a.w=e;return a}static fromNormalPoint(a,b,c){GM.Vector3.copy(a,c);c.w=GM.Vector3.dot(b,a)}static copy(a,b){GM.Vector3.copy(a,b);b.w=a.w}static normalize(a,b){var c=1/GM.Vector3.mag(a);GM.Vector3.scale(a,c,b);b.w=a.w*c}static transform(a,b,c){let d=a.x;var e=a.y;let f=a.z;a=a.w;c.x=b[0]*d+b[4]*e+b[8]*f+b[12]*a;c.y=b[1]*d+b[5]*e+b[9]*f+b[13]*a;c.z=b[2]*d+b[6]*e+b[10]*f+b[14]*a;c.w=b[3]*d+b[7]*e+b[11]*
f+b[15]*a;return c}};
GM.Quaternion=class{constructor(a,b,c,d){this.x=a||0;this.y=b||0;this.z=c||0;this.w=void 0!==d?d:1}fromEuler(a){var b=Math.cos(a.x/2),c=Math.cos(a.y/2),d=Math.cos(a.z/2),e=Math.sin(a.x/2),f=Math.sin(a.y/2);a=Math.sin(a.z/2);this.x=e*c*d+b*f*a;this.y=b*f*d-e*c*a;this.z=b*c*a-e*f*d;this.w=b*c*d+e*f*a}fromAxisAngle(a,b){b/=2;var c=Math.sin(b);this.x=a.x*c;this.y=a.y*c;this.z=a.z*c;this.w=Math.cos(b)}slerp(a,b){var c=this.x,d=this.y,e=this.z,f=this.w,g=f*a.w+c*a.x+d*a.y+e*a.z;0>g?(this.w=-a.w,this.x=
-a.x,this.y=-a.y,this.z=-a.z,g=-g):(this.w=a.w,this.x=a.x,this.y=a.y,this.z=a.z);if(1<=g)return this.w=f,this.x=c,this.y=d,this.z=e,this;a=Math.sqrt(1-g*g);if(.001>Math.abs(a))return this.w=.5*(f+this.w),this.x=.5*(c+this.x),this.y=.5*(d+this.y),this.z=.5*(e+this.z),this;var h=Math.atan2(a,g);g=Math.sin((1-b)*h)/a;b=Math.sin(b*h)/a;this.w=f*g+this.w*b;this.x=c*g+this.x*b;this.y=d*g+this.y*b;this.z=e*g+this.z*b;return this}static multiply(a,b,c){const d=a.x,e=a.y,f=a.z;a=a.w;const g=b.x,h=b.y,k=b.z;
b=b.w;c.x=d*b+a*g+e*k-f*h;c.y=e*b+a*h+f*g-d*k;c.z=f*b+a*k+d*h-e*g;c.w=a*b-d*g-e*h-f*k;return c}static between(a,b,c){let d=GM.Vector3.dot(a,b)+1;d<Number.EPSILON?(Math.abs(a.x)>Math.abs(a.z)?(c.x=-a.y,c.y=a.x,c.z=0):(c.x=0,c.y=-a.z,c.z=a.y),c.w=0):(c.x=a.y*b.z-a.z*b.y,c.y=a.z*b.x-a.x*b.z,c.z=a.x*b.y-a.y*b.x,c.w=d);a=Math.sqrt(c.x*c.x+c.y*c.y+c.z*c.z+c.w*c.w);a>Number.EPSILON?(c.x/=a,c.y/=a,c.z/=a,c.w/=a):(c.x=0,c.y=0,c.z=0,c.w=1);return c}static axisAngle(a,b,c,d,e){d/=2;let f=Math.sin(d);e.x=a*f;
e.y=b*f;e.z=c*f;e.w=Math.cos(d);return e}static slerp(a,b,c,d){c.x=a.x;c.y=a.y;c.z=a.z;c.w=a.w;c.slerp(b,d)}static create(a,b,c,d){return{x:a,y:b,z:c,w:d}}};GM.Matrix3=function(){this.elements=new Float32Array([1,0,0,0,1,0,0,0,1])};GM.Matrix3.prototype.clone=function(){var a=new GM.Matrix3;a.elements.set(this.elements);return a};
GM.Matrix4=class{static create(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}static init(a){return new Float32Array(a)}static transpose(a,b){for(var c=0;4>c;c++)for(var d=0;4>d;d++)b[4*c+d]=a[c+4*d];return b}static invert(a,b){let c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],k=a[6],l=a[7],m=a[8],n=a[9],q=a[10],p=a[11],r=a[12],t=a[13],u=a[14];a=a[15];let w=n*u*l-t*q*l+t*k*p-h*u*p-n*k*a+h*q*a,x=r*q*l-m*u*l-r*k*p+g*u*p+m*k*a-g*q*a,y=m*t*l-r*n*l+r*h*p-g*t*p-m*h*a+g*n*a,z=r*n*k-m*t*k-r*h*q+
g*t*q+m*h*u-g*n*u,v=1/(c*w+d*x+e*y+f*z);b[0]=w*v;b[1]=(t*q*f-n*u*f-t*e*p+d*u*p+n*e*a-d*q*a)*v;b[2]=(h*u*f-t*k*f+t*e*l-d*u*l-h*e*a+d*k*a)*v;b[3]=(n*k*f-h*q*f-n*e*l+d*q*l+h*e*p-d*k*p)*v;b[4]=x*v;b[5]=(m*u*f-r*q*f+r*e*p-c*u*p-m*e*a+c*q*a)*v;b[6]=(r*k*f-g*u*f-r*e*l+c*u*l+g*e*a-c*k*a)*v;b[7]=(g*q*f-m*k*f+m*e*l-c*q*l-g*e*p+c*k*p)*v;b[8]=y*v;b[9]=(r*n*f-m*t*f-r*d*p+c*t*p+m*d*a-c*n*a)*v;b[10]=(g*t*f-r*h*f+r*d*l-c*t*l-g*d*a+c*h*a)*v;b[11]=(m*h*f-g*n*f-m*d*l+c*n*l+g*d*p-c*h*p)*v;b[12]=z*v;b[13]=(m*t*e-r*n*
e+r*d*q-c*t*q-m*d*u+c*n*u)*v;b[14]=(r*h*e-g*t*e-r*d*k+c*t*k+g*d*u-c*h*u)*v;b[15]=(g*n*e-m*h*e+m*d*k-c*n*k-g*d*q+c*h*q)*v;return b}static quaternion(a,b){var c=a.x,d=a.y,e=a.z,f=a.w,g=c+c,h=d+d;let k=e+e;a=c*g;let l=c*h;c*=k;let m=d*h;d*=k;e*=k;g*=f;h*=f;f*=k;b[0]=1-(m+e);b[4]=l-f;b[8]=c+h;b[1]=l+f;b[5]=1-(a+e);b[9]=d-g;b[2]=c-h;b[6]=d+g;b[10]=1-(a+m);b[3]=0;b[7]=0;b[11]=0;b[12]=0;b[13]=0;b[14]=0;b[15]=1;return b}static fromEuler(a,b){var c=Math.cos(a.x),d=Math.sin(a.x),e=Math.cos(a.y),f=Math.sin(a.y),
g=Math.cos(a.z);a=Math.sin(a.z);var h=e*g,k=e*a,l=f*g,m=f*a;b[0]=h+m*d;b[4]=l*d-k;b[8]=c*f;b[1]=c*a;b[5]=c*g;b[9]=-d;b[2]=k*d-l;b[6]=m+h*d;b[10]=c*e;return b}static position(a,b){b[12]=a.x;b[13]=a.y;b[14]=a.z;return b}static copy(a,b){b.set(a);return a}static multiply(a,b,c){var d=a[0],e=a[4],f=a[8],g=a[12],h=a[1],k=a[5],l=a[9],m=a[13],n=a[2],q=a[6],p=a[10],r=a[14],t=a[3],u=a[7],w=a[11];a=a[15];var x=b[0],y=b[4],z=b[8],v=b[12],A=b[1],B=b[5],C=b[9],D=b[13],E=b[2],F=b[6],G=b[10],H=b[14],I=b[3],J=b[7],
K=b[11];b=b[15];c[0]=d*x+e*A+f*E+g*I;c[4]=d*y+e*B+f*F+g*J;c[8]=d*z+e*C+f*G+g*K;c[12]=d*v+e*D+f*H+g*b;c[1]=h*x+k*A+l*E+m*I;c[5]=h*y+k*B+l*F+m*J;c[9]=h*z+k*C+l*G+m*K;c[13]=h*v+k*D+l*H+m*b;c[2]=n*x+q*A+p*E+r*I;c[6]=n*y+q*B+p*F+r*J;c[10]=n*z+q*C+p*G+r*K;c[14]=n*v+q*D+p*H+r*b;c[3]=t*x+u*A+w*E+a*I;c[7]=t*y+u*B+w*F+a*J;c[11]=t*z+u*C+w*G+a*K;c[15]=t*v+u*D+w*H+a*b;return c}static yAxisT(a,b){b.x=a[4];b.y=a[5];b.z=a[6];return b}static yAxis(a,b){b.x=a[1];b.y=a[5];b.z=a[9];return b}};
GM.Euler=class{constructor(a,b,c){this.x=a||0;this.y=b||0;this.z=c||0}fromQuaternion(a){var b=a.x+a.x,c=a.y+a.y,d=a.z+a.z,e=a.x*b,f=a.x*c,g=a.x*d,h=a.y*c,k=a.y*d,l=a.z*d;b*=a.w;c*=a.w;a=a.w*d;this.x=Math.asin(-GM.clamp(k-b,-1,1));.99999>Math.abs(k-b)?(this.y=Math.atan2(g+c,1-(e+h)),this.z=Math.atan2(f+a,1-(e+l))):(this.y=Math.atan2(c-g,1-(h+l)),this.z=0)}toJson(){return{x:this.x,y:this.y,z:this.z}}static create(a,b,c){return{x:a,y:b,z:c}}static fromMatrix(a,b){var c=a[0],d=a[8],e=a[1],f=a[5],g=a[9],
h=a[2];a=a[10];b.x=Math.asin(-GM.clamp(g,-1,1));.99999>Math.abs(g)?(b.y=Math.atan2(d,a),b.z=Math.atan2(e,f)):(b.y=Math.atan2(-h,c),b.z=0)}static convert(a,b,c){var d=Math.cos(a.x),e=Math.sin(a.x),f=Math.cos(a.y),g=Math.sin(a.y),h=Math.cos(a.z);a=Math.sin(a.z);let k=GM.Matrix4.create();if("XYZ"===c){c=d*h;var l=d*a,m=e*h,n=e*a;k[0]=f*h;k[4]=-f*a;k[8]=g;k[1]=l+m*g;k[5]=c-n*g;k[9]=-e*f;k[2]=n-c*g;k[6]=m+l*g;k[10]=d*f}else"YXZ"===c?(c=f*h,l=f*a,m=g*h,n=g*a,k[0]=c+n*e,k[4]=m*e-l,k[8]=d*g,k[1]=d*a,k[5]=
d*h,k[9]=-e,k[2]=l*e-m,k[6]=n+c*e,k[10]=d*f):"ZXY"===c?(c=f*h,l=f*a,m=g*h,n=g*a,k[0]=c-n*e,k[4]=-d*a,k[8]=m+l*e,k[1]=l+m*e,k[5]=d*h,k[9]=n-c*e,k[2]=-d*g,k[6]=e,k[1]=d*f):"ZYX"===c?(c=d*h,l=d*a,m=e*h,n=e*a,k[0]=f*h,k[4]=m*g-l,k[8]=c*g+n,k[1]=f*a,k[5]=n*g+c,k[9]=l*g-m,k[2]=-g,k[6]=e*f,k[10]=d*f):"YZX"===c?(c=d*f,l=d*g,m=e*f,n=e*g,k[0]=f*h,k[4]=n-c*a,k[8]=m*a+l,k[1]=a,k[5]=d*h,k[9]=-e*h,k[2]=-g*h,k[6]=l*a+m,k[10]=c-n*a):"XZY"===c&&(c=d*f,l=d*g,m=e*f,n=e*g,k[0]=f*h,k[4]=-a,k[8]=g*h,k[1]=c*a+n,k[5]=d*
h,k[9]=l*a-m,k[2]=m*a-l,k[6]=e*h,k[10]=n*a+c);GM.Euler.fromMatrix(k,b)}static zAxisT(a,b){var c=Math.cos(a.x),d=Math.sin(a.x),e=Math.cos(a.y);b.x=c*Math.sin(a.y);b.y=-d;b.z=c*e;return b}static fromDirection(a){return{x:-Math.asin(-a.y),y:Math.atan2(-a.x,-a.z),z:0}}static copy(a,b){b.x=a.x;b.y=a.y;b.z=a.z;return b}};
GM.Frustum=class{static create(){return[GM.Plane.create(1,0,0,0),GM.Plane.create(1,0,0,0),GM.Plane.create(1,0,0,0),GM.Plane.create(1,0,0,0),GM.Plane.create(1,0,0,0),GM.Plane.create(1,0,0,0)]}static init(a,b){let c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],k=b[6],l=b[7],m=b[8],n=b[9],q=b[10],p=b[11],r=b[12],t=b[13],u=b[14];b=b[15];GM.Plane.init(a[0],f-c,l-g,p-m,b-r);GM.Plane.init(a[1],f+c,l+g,p+m,b+r);GM.Plane.init(a[2],f+d,l+h,p+n,b+t);GM.Plane.init(a[3],f-d,l-h,p-n,b-t);GM.Plane.init(a[4],f-e,l-k,
p-q,b-u);GM.Plane.init(a[5],f+e,l+k,p+q,b+u);GM.Plane.normalize(a[0],a[0]);GM.Plane.normalize(a[1],a[1]);GM.Plane.normalize(a[2],a[2]);GM.Plane.normalize(a[3],a[3]);GM.Plane.normalize(a[4],a[4]);GM.Plane.normalize(a[5],a[5]);return a}static transform(a,b,c){GM.Matrix4.transpose(b,GM.Frustum.matrix);GM.Matrix4.invert(GM.Frustum.matrix,GM.Frustum.matrix);for(b=0;b<a.length;b++)GM.Plane.transform(a[b],GM.Frustum.matrix,c[b])}static intersectsBox(a,b){for(var c=0;5>c;c++){var d=a[c],e=GM.Vector3.dot(d,
{x:0<d.x?b.min.x:b.max.x,y:0<d.y?b.min.y:b.max.y,z:0<d.z?b.min.z:b.max.z})+d.w;d=GM.Vector3.dot(d,{x:0<d.x?b.max.x:b.min.x,y:0<d.y?b.max.y:b.min.y,z:0<d.z?b.max.z:b.min.z})+d.w;if(0>e&&0>d)return!1}d=a[5];e=GM.Vector3.dot(d,{x:0<d.x?b.min.x:b.max.x,y:0<d.y?b.min.y:b.max.y,z:0<d.z?b.min.z:b.max.z})+d.w;d=GM.Vector3.dot(d,{x:0<d.x?b.max.x:b.min.x,y:0<d.y?b.max.y:b.min.y,z:0<d.z?b.max.z:b.min.z})+d.w;if(0>e&&0>d)return!1;b.nearDistance=Math.max(0,Math.min(e,d));return!0}static farDistance(a,b){for(var c=
Number.POSITIVE_INFINITY,d=0;6>d;d++){var e=a[d];c=Math.min(GM.Vector3.dot(e,{x:0<e.x?b.min.x:b.max.x,y:0<e.y?b.min.y:b.max.y,z:0<e.z?b.min.z:b.max.z})+e.w,c);c=Math.min(GM.Vector3.dot(e,{x:0<e.x?b.max.x:b.min.x,y:0<e.y?b.max.y:b.min.y,z:0<e.z?b.max.z:b.min.z})+e.w,c)}return c}static copy(a,b){for(var c=0;6>c;c++)GM.Plane.copy(a[c],b[c])}};GM.Frustum.matrix=GM.Matrix4.create();
GM.Projection=class{constructor(a){this.matrix=GM.Matrix4.create();this.inverse=GM.Matrix4.create();this.mvpMatrix=GM.Matrix4.create();this.mvpInverse=GM.Matrix4.create();this.type=a;this.farOffset=1;this.nearOffset=0;this.far=1E5;this.near=.1}update(a,b,c){GM.Matrix4.invert(this.matrix,this.inverse);GM.Matrix4.multiply(this.matrix,b,this.mvpMatrix);GM.Matrix4.multiply(a,this.inverse,this.mvpInverse)}setRange(a,b){this.near=a;this.far=b}getNear(){return this.near}getFar(){return this.far}set(a){}toJson(){return{}}};
GM.PerspectiveProjection=class extends GM.Projection{constructor(a){super("Perspective");this.setFov(a)}update(a,b,c){let d=this.near,e=this.far,f=c.width/c.height;this.fovV=this.fovH/f;let g=1/this.fovV,h=this.matrix;h[0]=g/f;h[4]=0;h[8]=0;h[12]=0;h[1]=0;h[5]=g;h[9]=0;h[13]=0;h[2]=0;h[6]=0;h[10]=(e+d)/(d-e);h[14]=2*e*d/(d-e);h[3]=0;h[7]=0;h[11]=-1;h[15]=0;super.update(a,b,c)}setFov(a){this.fovH=Math.tan(GM.DEG2RAD*a*.5)}project(a){var b=a.x,c=a.y;a=a.z;var d=this.mvpMatrix,e=1/(d[3]*b+d[7]*c+d[11]*
a+d[15]);0>e&&(e=-e);var f=new GM.Vector3;f.x=(d[0]*b+d[4]*c+d[8]*a+d[12])*e;f.y=(d[1]*b+d[5]*c+d[9]*a+d[13])*e;f.z=(d[2]*b+d[6]*c+d[10]*a+d[14])*e;return f}unproject(a,b){var c=a.x;a=a.y;var d=this.mvpInverse,e=1/(d[3]*c+d[7]*a+d[11]+d[15]);0>e&&(e=-e);b.x=(d[0]*c+d[4]*a+d[8]+d[12])*e;b.y=(d[1]*c+d[5]*a+d[9]+d[13])*e;b.z=(d[2]*c+d[6]*a+d[10]+d[14])*e;return b}setRange2(a,b){var c=b.min,d=b.max,e=0;a.x<c.x?e=c.x-a.x:a.x>d.x&&(e=a.x-d.x);var f=e*e;e=0;a.y<c.y?e=c.y-a.y:a.y>d.y&&(e=a.y-d.y);f+=e*e;
e=0;a.z<c.z?e=c.z-a.z:a.z>d.z&&(e=a.z-d.z);f+=e*e;a=GL.BoundingBox.diagonal(b);f=Math.max(a/1E3,Math.sqrt(f));this.near=f/2;this.far=f+a}getRay(a,b,c){this.unproject(a,c.direction);c.direction.sub(b.position).normalize();c.origin.copy(b.position);return c}toJson(){var a=super.toJson();a.fovV=this.fovV;a.fovH=this.fovH;return a}};
GM.Camera=class{constructor(a){this.viewport=a;this.position=new GM.Vector3;this.rotation=new GM.Euler;this.xAxis=GM.Vector3.create(1,0,0);this.yAxis=GM.Vector3.create(0,1,0);this.zAxis=GM.Vector3.create(0,0,-1);this.ray=new GM.Ray(new GM.Vector3(0,0,0),new GM.Vector3(0,0,-1));this.toggle=this.moving=!1}set(a){this.toggle=!0}changed(){let a=this.toggle;this.toggle=!1;return a}screenToCamera(a){return{x:a.pageX/this.viewport.width*2-1,y:2*-(a.pageY/this.viewport.height)+1}}};
GM.CameraMVP=class extends GM.Camera{constructor(a,b){super(a);this.projection=b;this.matrix=GM.Matrix4.create();this.inverse=GM.Matrix4.create();this.modelViewMatrix=GM.Matrix4.create();this.frustum=GM.Frustum.create()}set(a){super.set();a.matrix?(GM.Euler.fromMatrix(a.matrix,this.rotation),GM.Vector3.fromMatrix(a.matrix,this.position)):(a.position&&GM.Vector3.copy(a.position,this.position),a.rotation&&(a.rotation.order?GM.Euler.convert(a.rotation,this.rotation,a.rotation.order):GM.Vector3.copy(a.rotation,
this.rotation)));a.K&&(this.projection.fovH=.5*a.K[0]/a.K[2])}updateMatrix(){GM.Matrix4.fromEuler(this.rotation,this.matrix);GM.Matrix4.position(this.position,this.matrix);GM.Vector3.read(this.xAxis,this.matrix,0);GM.Vector3.read(this.yAxis,this.matrix,4);GM.Vector3.read(this.zAxis,this.matrix,8);GM.Matrix4.invert(this.matrix,this.inverse);GM.Matrix4.copy(this.inverse,this.modelViewMatrix);this.projection.update(this.matrix,this.inverse,this.viewport);GM.Frustum.init(this.frustum,this.projection.mvpMatrix)}updateRange(a){this.projection.setRange2(this.position,
a)}screenToCamera(a){return{x:a.pageX/this.viewport.width*2-1,y:2*-(a.pageY/this.viewport.height)+1}}intersectsBox(a){return GM.Frustum.intersectsBox(this.frustum,a)}getNearPlane(){var a=this.position.x*this.zAxis.x+this.position.y*this.zAxis.y+this.position.z*this.zAxis.z,b=this.projection.getNear()+.001*(this.projection.getFar()-this.projection.getNear());return{x:this.zAxis.x,y:this.zAxis.y,z:this.zAxis.z,w:a-b}}project(a){a=this.projection.project(a);a.x=(a.x+1)/2;a.y=1-(a.y+1)/2;return a}getRay(a,
b){b||(b=this.ray);return this.projection.getRay(this.screenToCamera(a),this,b)}getRayToPoint(a,b){GM.Vector3.subtract(b,this.position,a.direction);GM.Vector3.normalize(a.direction,a.direction);GM.Vector3.copy(this.position,a.origin);return a}toJson(){return{projection:this.projection.toJson(),position:this.position.toJson(),rotation:this.rotation.toJson(),xAxis:this.xAxis,yAxis:this.yAxis,zAxis:this.zAxis}}};
GM.OrthographicProjection=class extends GM.Projection{constructor(){super("Orthographic");this.zoom=1}update(a,b,c){var d=this.far-this.near,e=this.near+d*this.nearOffset;d=this.far-d*(1-this.farOffset);var f=1/(d-e),g=1/c.height;let h=this.matrix;h[0]=1/c.width*2;h[4]=0;h[8]=0;h[12]=0;h[1]=0;h[5]=2*g;h[9]=0;h[13]=0;h[2]=0;h[6]=0;h[10]=-2*f;h[14]=-((d+e)*f);h[3]=0;h[7]=0;h[11]=0;h[15]=1;super.update(a,b,c)}setRange2(a,b){}project(a){var b=a.x,c=a.y;a=a.z;var d=this.mvpMatrix,e=new GM.Vector3;e.x=
d[0]*b+d[4]*c+d[8]*a+d[12];e.y=d[1]*b+d[5]*c+d[9]*a+d[13];e.z=d[2]*b+d[6]*c+d[10]*a+d[14];return e}unproject(a,b){var c=a.x;a=a.y;var d=this.mvpInverse;b.x=d[0]*c+d[4]*a+d[8]+d[12];b.y=d[1]*c+d[5]*a+d[9]+d[13];b.z=d[2]*c+d[6]*a+d[10]+d[14];return b}getRay(a,b){b=new GM.Vector3(-b.zAxis.x,-b.zAxis.y,-b.zAxis.z);var c=new GM.Vector3;this.unproject(a,c);a=this.getNear();var d=this.getFar();c.x-=b.x*(d-a);c.y-=b.y*(d-a);c.z-=b.z*(d-a);return new GM.Ray(c,b)}};
</script>
<script id="/gl/gl.js">GL={};var gl;GL.Buffer=function(){this.glId=gl.createBuffer()};GL.Buffer.prototype.clear=function(){null!=this.glId&&(gl.deleteBuffer(this.glId),this.glId=null)};
GL.ArrayBuffer=class extends GL.Buffer{constructor(a){super();gl.bindBuffer(gl.ARRAY_BUFFER,this.glId);gl.bufferData(gl.ARRAY_BUFFER,a,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,null);this.length="number"==typeof a?a:a.length}set(a){gl.bindBuffer(gl.ARRAY_BUFFER,this.glId);gl.bufferData(gl.ARRAY_BUFFER,a,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,null);this.length="number"==typeof a?a:a.length}write(a,c){gl.bindBuffer(gl.ARRAY_BUFFER,this.glId);gl.bufferSubData(gl.ARRAY_BUFFER,a,c);gl.bindBuffer(gl.ARRAY_BUFFER,
null)}};GL.ElementBuffer=function(a){GL.Buffer.call(this);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.glId);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,a,gl.STATIC_DRAW);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null);this.length=a.length};GL.ElementBuffer.prototype=Object.create(GL.Buffer.prototype);GL.ElementBuffer.prototype.constructor=GL.ElementBuffer;GL.ImageLoader=function(a,c){this.listener=[];c&&this.listener.push(c);a&&this.load(a)};GL.ImageLoader.prototype.listen=function(a){this.listener.push(a)};
GL.ImageLoader.prototype.load=function(a){function c(b){return 0==(b&b-1)}function d(b){--b;for(var e=1;32>e;e<<=1)b|=b>>e;return b+1}this.image=document.createElementNS("http://www.w3.org/1999/xhtml","img");this.image.onload=function(){URL.revokeObjectURL(this.image.src);if(!c(this.image.width)||!c(this.image.height)){var b=document.createElement("canvas");b.width=d(this.image.width);b.height=d(this.image.height);b.getContext("2d").drawImage(this.image,0,0,b.width,b.height);this.image=b}for(b=0;b<
this.listener.length;b++)this.listener[b].notify(this.image);this.image=null}.bind(this);this.image.crossOrigin="Anonymous";this.image.src=a};
GL.Texture=function(a,c,d){this.name=d;this.glId=gl.createTexture();this.sampler=c;this.sampler||(this.sampler={});gl.bindTexture(gl.TEXTURE_2D,this.glId);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,1,1,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array([255,255,255,255]));gl.bindTexture(gl.TEXTURE_2D,null);a instanceof GL.ImageLoader?a.listen(this):a instanceof Image&&this.notify(a)};
GL.Texture.prototype.clear=function(){null!=this.glId&&(gl.deleteTexture(this.glId),this.glId=null)};
GL.Texture.prototype.notify=function(a){gl.bindTexture(gl.TEXTURE_2D,this.glId);this.sampler.minFilter?gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.sampler.minFilter):gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST_MIPMAP_LINEAR);this.sampler.magFilter?gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.sampler.magFilter):gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);this.sampler.wrapS?gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,this.sampler.wrapS):
gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.REPEAT);this.sampler.wrapT?gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,this.sampler.wrapT):gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.REPEAT);gl.supports_EXT_texture_filter_anisotropic&&gl.texParameterf(gl.TEXTURE_2D,gl.anisotropy,gl.maxAnisotropy);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,a);gl.generateMipmap(gl.TEXTURE_2D);gl.bindTexture(gl.TEXTURE_2D,null)};
GL.Gradient=function(a){this.name=name;this.glId=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,this.glId);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,a.length/4,1,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array(a));gl.bindTexture(gl.TEXTURE_2D,null)};
GL.Material=function(a){this.name=a.id;this.diffuse=a.diffuse;this.emissive=a.emissive;this.specular=a.specular;this.ambient=a.ambient;this.normal=a.normal;this.transparency=a.transparency};GL.Material.prototype.clear=function(){};
</script>
<script id="/gl/shader.js">GL.Shader=function(a,b){this.defines={};this.uniforms={};this.vertexShader=gl.createShader(gl.VERTEX_SHADER);this.fragmentShader=gl.createShader(gl.FRAGMENT_SHADER);this.glId=gl.createProgram();gl.attachShader(this.glId,this.vertexShader);gl.attachShader(this.glId,this.fragmentShader);this.vertexCode=a;this.fragmentCode=b;this.config=""};GL.Shader.prototype.defineUniforms=function(a){for(var b=0;b<a.length;b++)this.uniforms[a[b]]=gl.getUniformLocation(this.glId,a[b])};
GL.Shader.prototype.enableBuffer=function(a){if(a)for(var b=0;b<this.attributes.length;b++){var c=this.attributes[b];a[c.name]&&gl.enableVertexAttribArray(c.location)}else for(b=0;b<this.attributes.length;b++)c=this.attributes[b],gl.enableVertexAttribArray(c.location)};GL.Shader.prototype.bindBuffer=function(a){for(var b=0;b<this.attributes.length;b++){var c=this.attributes[b];a[c.name]&&(gl.bindBuffer(gl.ARRAY_BUFFER,a[c.name].glId),gl.vertexAttribPointer(c.location,c.size,c.type,c.normalize,0,0))}};
GL.Shader.prototype.disableBuffer=function(a){if(a)for(var b=0;b<this.attributes.length;b++){var c=this.attributes[b];a[c.name]&&gl.disableVertexAttribArray(c.location)}else for(b=0;b<this.attributes.length;b++)c=this.attributes[b],gl.disableVertexAttribArray(c.location)};GL.Shader.prototype.defineAttribute=function(a,b,c,e,d){d=gl.getAttribLocation(this.glId,null==d?a:d);-1!=d?this.attributes.push({location:d,name:a,size:b,type:c,normalize:e}):console.log("attribute "+a+" not found ")};
GL.Shader.prototype.undefineAttribute=function(a){for(var b=0;b<this.attributes.length;b++)if(this.attributes[b].name===a){this.attributes.splice(b,1);break}};GL.Shader.prototype.defineDirective=function(a){this.defines[a]=value};GL.Shader.prototype.undefineDirective=function(a){delete this.defines[a]};
GL.Shader.prototype.compile=function(a){for(var b in this.defines)1==this.defines[b]&&(this.config+="#define "+b+"\n");this.vertexCode.startsWith("#version")?(a=this.vertexCode.indexOf("\n")+1,a=this.vertexCode.slice(0,a)+this.config+this.vertexCode.slice(a)):a=this.config+this.vertexCode;gl.shaderSource(this.vertexShader,a);gl.compileShader(this.vertexShader);!1===gl.getShaderParameter(this.vertexShader,gl.COMPILE_STATUS)&&console.error("Vertex Shader compile error");""!==gl.getShaderInfoLog(this.vertexShader)&&
console.warn(gl.getShaderInfoLog(this.vertexShader));this.fragmentCode.startsWith("#version")?(a=this.fragmentCode.indexOf("\n")+1,a=this.fragmentCode.slice(0,a)+this.config+this.fragmentCode.slice(a)):a=this.config+this.fragmentCode;gl.shaderSource(this.fragmentShader,a);gl.compileShader(this.fragmentShader);!1===gl.getShaderParameter(this.fragmentShader,gl.COMPILE_STATUS)&&console.error("Fragment Shader compile error");""!==gl.getShaderInfoLog(this.fragmentShader)&&console.warn(gl.getShaderInfoLog(this.fragmentShader));
gl.linkProgram(this.glId);this.config="";this.attributes=[]};GL.Shader.prototype.useProgram=function(a){GL.Shader.glId=this.glId;gl.useProgram(this.glId)};GL.Shader.prototype.isActive=function(){return GL.Shader.glId==this.glId};GL.Shader.prototype.clear=function(){gl.deleteProgram(this.glId)};GL.ShaderMVP=function(a,b){GL.Shader.call(this,a,b)};GL.ShaderMVP.prototype=Object.create(GL.Shader.prototype);GL.ShaderMVP.prototype.constructor=GL.ShaderMVP;
GL.ShaderMVP.prototype.useProgram=function(a){GL.Shader.prototype.useProgram.call(this);gl.uniformMatrix4fv(this.modelViewMatrix,!1,a.modelViewMatrix);gl.uniformMatrix4fv(this.projectionMatrix,!1,a.projection.matrix)};GL.ShaderMVP.prototype.updateModelMatrix=function(a){gl.uniformMatrix4fv(this.modelViewMatrix,!1,a.modelViewMatrix)};
GL.ShaderMVP.prototype.compile=function(){GL.Shader.prototype.compile.call(this);this.modelViewMatrix=gl.getUniformLocation(this.glId,"modelViewMatrix");this.projectionMatrix=gl.getUniformLocation(this.glId,"projectionMatrix")};GL.LineShader=function(){GL.ShaderMVP.call(this,GL.LineShader.vs,GL.LineShader.fs)};GL.LineShader.prototype=Object.create(GL.ShaderMVP.prototype);GL.LineShader.prototype.constructor=GL.LineShader;
GL.LineShader.prototype.compile=function(){GL.ShaderMVP.prototype.compile.call(this);this.defineAttribute("position",3,gl.FLOAT,!1);this.defineAttribute("color",3,gl.UNSIGNED_BYTE,!0)};GL.LineShader.vs="\nprecision mediump float;\nprecision mediump int;\n\nuniform mat4 modelViewMatrix; \nuniform mat4 projectionMatrix; \n\nattribute vec3 position;\nattribute vec3 color;\n\nvarying vec3 vColor;\n\nvoid main()\t\n{\n    vColor = color;\n    gl_Position = projectionMatrix * (modelViewMatrix * vec4(position, 1.0));\n}\n";
GL.LineShader.fs="\nprecision mediump float;\nprecision mediump int;\n\nvarying vec3 vColor;\n\nvoid main()\t\n{\n    gl_FragColor = vec4(vColor, 1);\n    //gl_FragColor = vec4(1,1,1, 1);\n}";GL.CopyShader=function(){GL.Shader.call(this,GL.CopyShader.vs,GL.CopyShader.fs)};GL.CopyShader.prototype=Object.create(GL.ShaderMVP.prototype);GL.CopyShader.prototype.constructor=GL.CopyShader;
GL.CopyShader.prototype.compile=function(){GL.ShaderMVP.prototype.compile.call(this);this.defineAttribute("position",3,gl.FLOAT,!1);this.defineAttribute("color",3,gl.UNSIGNED_BYTE,!0)};GL.CopyShader.vs="\nattribute vec3 position;\n\nvoid main()\t\n{\n    gl_Position = position;\n}\n";GL.CopyShader.fs="\nprecision mediump float;\nprecision mediump int;\n\nvarying vec3 vColor;\n\nvoid main()\t\n{\n    gl_FragColor = vec4(vColor, 1);\n    //gl_FragColor = vec4(1,1,1, 1);\n}";
</script>
<script id="/gl/object.js">GL.Axis=function(a,b,c){this.pz=this.py=this.px=0;this.sx=a|1;this.sy=b|1;this.sz=c|1;this.visible=!0;this.color=new GL.ArrayBuffer(new Uint8Array([255,0,0,255,0,0,0,255,0,0,255,0,0,0,255,0,0,255]));this.shader=new GL.LineShader;this.shader.compile();this.update()};GL.Axis.prototype.render=function(a){this.visible&&(this.shader.useProgram(a),this.shader.enableBuffer(this),this.shader.bindBuffer(this),gl.disable(gl.DEPTH_TEST),gl.drawArrays(gl.LINES,0,6),this.shader.disableBuffer(this),gl.enable(gl.DEPTH_TEST))};
GL.Axis.prototype.update=function(){this.position=new GL.ArrayBuffer(new Float32Array([this.px,this.py,this.pz,this.px+this.sx,this.py,this.pz,this.px,this.py,this.pz,this.px,this.py+this.sy,this.pz,this.px,this.py,this.pz,this.px,this.py,this.pz+this.sz]))};GL.Axis.prototype.resize=function(a,b){b=.25*GM.Vector3.mag(GM.Vector3.sub3V(this.px,this.py,this.pz,b.position));this.sx=Math.min(b,a.max.x-a.min.x);this.sy=Math.min(b,a.max.y-a.min.y);this.sz=Math.min(b,a.max.z-a.min.z);this.update()};
GL.Axis.prototype.moveTo=function(a,b,c){this.px=a;this.py=b;this.pz=c;this.update()};
GL.BoundingBox=class{constructor(a){this.position=new GL.ArrayBuffer(new Float32Array([a.min.x,a.min.y,a.min.z,a.max.x,a.min.y,a.min.z,a.max.x,a.min.y,a.min.z,a.max.x,a.max.y,a.min.z,a.max.x,a.max.y,a.min.z,a.min.x,a.max.y,a.min.z,a.min.x,a.max.y,a.min.z,a.min.x,a.min.y,a.min.z,a.min.x,a.min.y,a.max.z,a.max.x,a.min.y,a.max.z,a.max.x,a.min.y,a.max.z,a.max.x,a.max.y,a.max.z,a.max.x,a.max.y,a.max.z,a.min.x,a.max.y,a.max.z,a.min.x,a.max.y,a.max.z,a.min.x,a.min.y,a.max.z,a.min.x,a.min.y,a.min.z,a.min.x,
a.min.y,a.max.z,a.min.x,a.max.y,a.min.z,a.min.x,a.max.y,a.max.z,a.max.x,a.max.y,a.min.z,a.max.x,a.max.y,a.max.z,a.max.x,a.min.y,a.min.z,a.max.x,a.min.y,a.max.z]));this.color=new GL.ArrayBuffer(new Uint8Array([255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0]));this.shader=new GL.LineShader;this.shader.compile()}render(a){this.shader.useProgram(a);gl.disable(gl.DEPTH_TEST);
this.shader.enableBuffer(this);this.shader.bindBuffer(this);gl.drawArrays(gl.LINES,0,24);this.shader.disableBuffer(this);gl.enable(gl.DEPTH_TEST)}setColor(a,b,c){this.color=new GL.ArrayBuffer(new Uint8Array([a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c]))}update(a){this.position=new GL.ArrayBuffer(new Float32Array([a.min.x,a.min.y,a.min.z,a.max.x,a.min.y,a.min.z,a.max.x,a.min.y,a.min.z,a.max.x,a.max.y,
a.min.z,a.max.x,a.max.y,a.min.z,a.min.x,a.max.y,a.min.z,a.min.x,a.max.y,a.min.z,a.min.x,a.min.y,a.min.z,a.min.x,a.min.y,a.max.z,a.max.x,a.min.y,a.max.z,a.max.x,a.min.y,a.max.z,a.max.x,a.max.y,a.max.z,a.max.x,a.max.y,a.max.z,a.min.x,a.max.y,a.max.z,a.min.x,a.max.y,a.max.z,a.min.x,a.min.y,a.max.z,a.min.x,a.min.y,a.min.z,a.min.x,a.min.y,a.max.z,a.min.x,a.max.y,a.min.z,a.min.x,a.max.y,a.max.z,a.max.x,a.max.y,a.min.z,a.max.x,a.max.y,a.max.z,a.max.x,a.min.y,a.min.z,a.max.x,a.min.y,a.max.z]))}static init(a){a.min=
{x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY,z:Number.POSITIVE_INFINITY};a.max={x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY,z:Number.NEGATIVE_INFINITY};return a}static create(a,b){return{min:{x:a.x||a[0],y:a.y||a[1],z:a.z||a[2]},max:{x:b.x||b[0],y:b.y||b[1],z:b.z||b[2]}}}static set(a,b,c){a.min={x:b.x||b[0],y:b.y||b[1],z:b.z||b[2]};a.max={x:c.x||c[0],y:c.y||c[1],z:c.z||c[2]}}static merge(a,b){GM.Vector3.min(a.min,b.min,a.min);GM.Vector3.max(a.max,b.max,a.max)}static grow(a,b){GM.Vector3.min(a.min,
b,a.min);GM.Vector3.max(a.max,b,a.max)}static center(a,b){b=b||{};b.x=(a.min.x+a.max.x)/2;b.y=(a.min.y+a.max.y)/2;b.z=(a.min.z+a.max.z)/2;return b}static diagonal(a){var b=a.max.x-a.min.x,c=a.max.y-a.min.y;a=a.max.z-a.min.z;return Math.sqrt(b*b+c*c+a*a)}static copy(a,b){GM.Vector3.copy(a.min,b.min);GM.Vector3.copy(a.max,b.max);return b}static transform(a,b,c){var d=[b[0]*a.min.x,b[4]*a.min.x,b[8]*a.min.x],e=[b[0]*a.max.x,b[4]*a.max.x,b[8]*a.max.x],f=[b[1]*a.min.y,b[5]*a.min.y,b[9]*a.min.y],g=[b[1]*
a.max.y,b[5]*a.max.y,b[9]*a.max.y],h=[b[2]*a.min.z,b[6]*a.min.z,b[10]*a.min.z];a=[b[2]*a.max.z,b[6]*a.max.z,b[10]*a.max.z];c.min.x=Math.min(d[0],e[0])+Math.min(f[0],g[0])+Math.min(h[0],a[0])+b[12];c.max.x=Math.max(d[0],e[0])+Math.max(f[0],g[0])+Math.max(h[0],a[0])+b[12];c.min.y=Math.min(d[1],e[1])+Math.min(f[1],g[1])+Math.min(h[1],a[1])+b[13];c.max.y=Math.max(d[1],e[1])+Math.max(f[1],g[1])+Math.max(h[1],a[1])+b[13];c.min.z=Math.min(d[2],e[2])+Math.min(f[2],g[2])+Math.min(h[2],a[2])+b[14];c.max.z=
Math.max(d[2],e[2])+Math.max(f[2],g[2])+Math.max(h[2],a[2])+b[14]}};
</script>
<script id="/index.js">U={};
V=function(){var a={viewer:null,touch3d:function(){V.viewer.repaint3d=!0},touch2d:function(){V.viewer.repaint2d=!0},api:{},notify:(b,c)=>{V.EventHandler.APPEVENTS[b].forEach(d=>d.method(c))},startLoading:()=>{a.loading++},stopLoading:()=>{a.loading--},loading:0};a.time=window.performance.now();a.DRAGERROR={r:1,g:.8,b:.8};a.DRAGOK={r:.8,g:1,b:.8};a.NODRAG={r:1,g:1,b:1};a.keyMap=[];a.keyCount=0;document.addEventListener("keydown",b=>{a.keyMap[b.keyCode]||(a.keyCount++,a.keyMap[b.keyCode]=!0)});document.addEventListener("keyup",
b=>{a.keyCount&&(a.keyCount--,a.keyMap[b.keyCode]=!1)});document.addEventListener("mouseout",b=>{a.keyMap=[];a.keyCount=0});a.log=!1;a.postMessage=(b,c,d)=>{V.logging&&console.log(`%c>>>> ${b}\n`,"color:grey; font-weight:800",c);window.parent.postMessage({action:b,args:c,optional:d},"*")};a.recvMessage=(b,c,d)=>{b instanceof Array?b.forEach(e=>a.recvMessage(e,c)):(c.owner=d,V.api[b]?V.api[b].push(c):V.api[b]=[c])};a.unrecvMessage=(b,c)=>{if(b instanceof Array)b.forEach(d=>a.unrecvMessage(d,c));else if(V.api[b]){let d=
V.api[b];for(b=0;b<d.length;b++)d[b].owner==c&&d.splice(b,1)}};a.viewerCb=function(b){let c={},d=RegExp("[?&]custom=([^&#]*)").exec(window.location.href);d&&(c=JSON.parse(decodeURIComponent(d[1])));V.postMessage("viewer.load",b,c)};a.importCb=function(b,c){V.postMessage("import.create",b,this)};a.METRIC=0;a.IMPERIAL=1;a.units=0;a.canvas=document.getElementById("canvas3D");window.addEventListener("message",function(b){if(b.data.action instanceof Array)b.data.action.forEach((e,f)=>{if(e=this.api[e]){this.logging&&
console.log(`%c<<< ${b.data.action}\n`,"color:green; font-weight:800",b.data.args[f]);for(var g=0;g<e.length;g++)e[g](b.data.args[f]||{},b.data.custom||{})}else this.logging&&console.log(`%c<<< ${b.data.action}\n`,"color:red; font-weight:800",b.data.args)});else{var c=this.api[b.data.action];if(c){this.logging&&console.log(`%c<<< ${b.data.action}\n`,"color:green; font-weight:800",b.data.args);for(var d=0;d<c.length;d++)c[d](b.data.args||{},b.data.custom||{})}else this.logging&&console.log(`%c<<< ${b.data.action}\n`,
"color:red; font-weight:800",b.data.args)}}.bind(a));return a}();M={MAX_MEM:367001600,MIN_MEM:325058560,memoryUsed:0,rendered:0};
V.EventHandler=class{constructor(a,b){this.prioSys=a;this.prioApp=b||a;this.cvsListener=[];this.onMouseDown&&this.cvsListener.push({name:"mousedown",method:this.onMouseDown.bind(this),options:{capture:!1}});this.onMouseMove&&this.cvsListener.push({name:"mousemove",method:this.onMouseMove.bind(this),options:{capture:!1}});this.onMouseUp&&this.cvsListener.push({name:"mouseup",method:this.onMouseUp.bind(this),options:{capture:!1}});this.onMouseOut&&this.cvsListener.push({name:"mouseout",method:this.onMouseOut.bind(this),
options:{capture:!1}});this.onMouseWheel&&(this.cvsListener.push({name:"mousewheel",method:this.onMouseWheel.bind(this),options:{capture:!1,passive:!1}}),this.cvsListener.push({name:"DOMMouseScroll",method:this.onMouseWheel.bind(this),options:{capture:!1}}));this.onDblClick&&this.cvsListener.push({name:"dblclick",method:this.onDblClick.bind(this),options:{capture:!1}});this.onClick&&this.cvsListener.push({name:"click",method:this.onClick.bind(this),options:{capture:!1}});this.onTouchStart&&this.cvsListener.push({name:"touchstart",
method:this.onTouchStart.bind(this),options:{capture:!1}});this.onTouchEnd&&this.cvsListener.push({name:"touchend",method:this.onTouchEnd.bind(this),options:{capture:!1}});this.onTouchCancel&&this.cvsListener.push({name:"touchcancel",method:this.onTouchCancel.bind(this),options:{capture:!1}});this.onTouchMove&&this.cvsListener.push({name:"touchmove",method:this.onTouchMove.bind(this),options:{capture:!1}});this.keyListener=[];this.onKeyUp&&this.keyListener.push({name:"keyup",method:this.onKeyUp.bind(this),
options:{capture:!1}});this.onKeyDown&&this.keyListener.push({name:"keydown",method:this.onKeyDown.bind(this),options:{capture:!1}});this.onKeyPressed&&this.keyListener.push({name:"keypress",method:this.onKeyPressed.bind(this),options:{capture:!1}});this.appListener=[];for(var c in V.EventHandler.APPEVENTS)this[c]&&this.appListener.push({name:c,method:this[c].bind(this)})}attach(){V.EventHandler.SYSPRIO.forEach(a=>a.forEach(b=>b.detachSysHandlers()));V.EventHandler.SYSPRIO[this.prioSys].push(this);
V.EventHandler.SYSPRIO.forEach(a=>a.forEach(b=>b.attachSysHandlers()));V.EventHandler.APPPRIO.forEach(a=>a.forEach(b=>b.detachAppHandlers()));V.EventHandler.APPPRIO[this.prioApp].push(this);V.EventHandler.APPPRIO.forEach(a=>a.forEach(b=>b.attachAppHandlers()))}detach(){V.EventHandler.SYSPRIO.forEach(a=>a.forEach(b=>b.detachSysHandlers()));V.EventHandler.SYSPRIO[this.prioSys].splice(V.EventHandler.SYSPRIO[this.prioSys].indexOf(this),1);V.EventHandler.SYSPRIO.forEach(a=>a.forEach(b=>b.attachSysHandlers()));
V.EventHandler.APPPRIO.forEach(a=>a.forEach(b=>b.detachAppHandlers()));V.EventHandler.APPPRIO[this.prioApp].splice(V.EventHandler.APPPRIO[this.prioApp].indexOf(this),1);V.EventHandler.APPPRIO.forEach(a=>a.forEach(b=>b.attachAppHandlers()))}detachSysHandlers(){this.cvsListener.forEach(a=>V.EventHandler.CONTAINER.removeEventListener(a.name,a.method,a.options));this.keyListener.forEach(a=>document.removeEventListener(a.name,a.method,a.options))}attachSysHandlers(){this.cvsListener.forEach(a=>V.EventHandler.CONTAINER.addEventListener(a.name,
a.method,a.options));this.keyListener.forEach(a=>document.addEventListener(a.name,a.method,a.options))}detachAppHandlers(){this.appListener.forEach(a=>V.EventHandler.APPEVENTS[a.name].pop(a))}attachAppHandlers(){this.appListener.forEach(a=>V.EventHandler.APPEVENTS[a.name].push(a))}isAttached(){return V.EventHandler.APPPRIO[this.prioApp].includes(this)}};V.EventHandler.APPPRIO=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]];V.EventHandler.SYSPRIO=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]];
V.EventHandler.APPEVENTS={onRender2D:[],onRender3D:[],onResize:[],onUpdate:[]};V.EventHandler.PRIO0=0;V.EventHandler.PRIO1=1;V.EventHandler.PRIO2=2;V.EventHandler.PRIO3=3;V.EventHandler.PRIO4=4;V.EventHandler.PRIO5=5;V.EventHandler.PRIO6=6;V.EventHandler.CONTAINER=document.querySelector(".events");
V.Viewer=class{constructor(a){V.viewer=this;this.datasets={};this.aabb=GL.BoundingBox.init({});this.canvas=V.canvas;this.canvas.width=this.canvas.clientWidth;this.canvas.height=this.canvas.clientHeight;this.overlay=new O.Overlay(this);this.overlay.attach();window.addEventListener("resize",()=>{this.canvas.width=this.canvas.clientWidth;this.canvas.height=this.canvas.clientHeight;V.camera.updateMatrix();V.notify("onResize",{width:window.innerWidth,height:window.innerHeight});V.touch2d();V.touch3d()});
gl=this.canvas.getContext("webgl2",a)||this.canvas.getContext("experimental-webgl",a);gl.clearColor(1,1,1,1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.enable(gl.DEPTH_TEST);gl.enable(gl.CULL_FACE);gl.cullFace(gl.BACK);(a=gl.getExtension("EXT_texture_filter_anisotropic"))?(gl.anisotropy=a.TEXTURE_MAX_ANISOTROPY_EXT,gl.maxAnisotropy=gl.getParameter(a.MAX_TEXTURE_MAX_ANISOTROPY_EXT),gl.supports_EXT_texture_filter_anisotropic=!0):gl.supports_EXT_texture_filter_anisotropic=
!1;GL.GL_EXT_frag_depth=gl.getExtension("EXT_frag_depth");this.animateFn=this.animate.bind(this);this.repaint=this.visible=!0;V.recvMessage("viewer.image.get",b=>{this.imageCallback=b;V.touch3d()});V.recvMessage("import.update",b=>{this.datasets[b.id]&&b.hasOwnProperty("visible")&&(this.datasets[b.id].visible=b.visible,V.touch3d())});V.recvMessage("import.delete",(b,c)=>{if(c=this.datasets[b.id])c.unload(),V.postMessage("import.delete",b),delete this.datasets[b.id],V.touch3d();GL.BoundingBox.init(this.aabb,
{});for(var d in this.datasets)GL.BoundingBox.merge(this.aabb,this.datasets[d])});V.recvMessage("viewer.unload",b=>{for(var c in this.datasets)this.datasets[c].unload(),delete this.datasets[c];GL.BoundingBox.init(this.aabb,{});V.postMessage("viewer.unload",b)});V.recvMessage("repaint",b=>{V.touch2d();V.touch3d()});V.recvMessage("viewpoint",b=>{for(var c in this.datasets){let d=this.datasets[c];b[d.id]&&d.setViewpoint(b[d.id])}V.touch3d();V.postMessage("viewpoint",b)});V.recvMessage("raycast.overlay",
b=>{let c=V.camera.getRay({pageX:b.x,pageY:b.y});b=O.instance.raycast(c,b.x,b.y);V.postMessage("raycast.overlay",b)});V.recvMessage("raycast.content",b=>{let c=V.camera.getRay({pageX:b.x,pageY:b.y});b=V.viewer.raycast(c,{xyz:{},normal:b.normal,distance:Number.POSITIVE_INFINITY});b.distance!=Number.POSITIVE_INFINITY&&b.normal&&GM.Vector3.normalize(b.normal,b.normal);V.postMessage("raycast.content",b)});V.recvMessage("camera.project",b=>{b=V.camera.project(b);V.postMessage("camera.project",{pageX:b.x*
O.canvas.width,pageY:b.y*O.canvas.height})});V.recvMessage("viewer.update",(b,c)=>{b.hasOwnProperty("logging")&&(V.logging=b.logging);b.hasOwnProperty("units")&&(V.units="imperial"===b.units?V.IMPERIAL:V.METRIC);b.hasOwnProperty("clearColor")&&gl.clearColor(b.clearColor[0],b.clearColor[1],b.clearColor[2],1);b.hasOwnProperty("code")&&Function("return "+decodeURI(b.code))().call();V.postMessage("viewer.update",b,c)})}raycast(a,b){for(var c in this.datasets){let e=this.datasets[c];if(e.visible){var d=
a.intersectBox(e);d&&d.distance<b.distance&&(d=b.distance,e.raycast(a,b),b.distance<d&&(b.id=e.id))}}return b}load(a,b){GL.BoundingBox.merge(this.aabb,b);this.datasets[a]=b}startImage(){this.imageCallback.width&&this.imageCallback.height&&(this.imageCallback.oldWidth=this.canvas.width,this.imageCallback.oldHeight=this.canvas.height,V.canvas.width=this.imageCallback.width,V.canvas.height=this.imageCallback.height,V.notify("onResize",{width:V.canvas.width,height:V.canvas.height}),V.touch2d())}endImage(){if(this.imageCallback.oldWidth&&
this.imageCallback.oldHeight){if(this.imageCallback.overlay){var a=document.createElement("canvas");a.width=V.canvas.width;a.height=V.canvas.height;var b=a.getContext("2d");b.drawImage(V.canvas,0,0,a.width,a.height);b.drawImage(O.canvas,0,0,a.width,a.height);V.postMessage("viewer.image.get",a.toDataURL(this.imageCallback.type,this.imageCallback.options))}else V.postMessage("viewer.image.get",V.canvas.toDataURL(this.imageCallback.type,this.imageCallback.options));V.canvas.width=this.imageCallback.oldWidth;
V.canvas.height=this.imageCallback.oldHeight;V.notify("onResize",{width:V.canvas.width,height:V.canvas.height});gl.viewport(0,0,gl.drawingBufferWidth,gl.drawingBufferHeight);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);this.render(this.camera);V.notify("onRender3D",this);V.notify("onRender2D",this)}else if(this.imageCallback.maxWidth||this.imageCallback.maxHeight){a=document.createElement("canvas");b=a.getContext("2d");if(this.imageCallback.maxWidth&&this.imageCallback.maxHeight){var c=Math.min(1,
Math.max(this.imageCallback.maxHeight/gl.drawingBufferHeight,this.imageCallback.maxWidth/gl.drawingBufferWidth));a.width=this.imageCallback.maxWidth;a.height=this.imageCallback.maxHeight;let d=Math.floor(.5*(1-c)*gl.drawingBufferWidth),e=Math.floor(.5*(1-c)*gl.drawingBufferHeight);b.drawImage(V.canvas,d,e,gl.drawingBufferWidth*c,gl.drawingBufferHeight*c,0,0,a.width,a.height);this.imageCallback.overlay&&b.drawImage(O.canvas,d,e,gl.drawingBufferWidth*c,gl.drawingBufferHeight*c,0,0,a.width,a.height)}else c=
1,!this.imageCallback.maxHeight&&gl.drawingBufferWidth>this.imageCallback.maxWidth?c=Math.min(c,this.imageCallback.maxWidth/gl.drawingBufferWidth):!this.imageCallback.maxWidth&&gl.drawingBufferHeight>this.imageCallback.maxHeight&&(c=Math.min(c,this.imageCallback.maxHeight/gl.drawingBufferHeight)),a.width=gl.drawingBufferWidth*c,a.height=gl.drawingBufferHeight*c,b.drawImage(V.canvas,0,0,a.width,a.height),this.imageCallback.overlay&&b.drawImage(O.canvas,0,0,a.width,a.height);V.postMessage("viewer.image.get",
a.toDataURL(this.imageCallback.type,this.imageCallback.options))}else this.imageCallback.overlay?(a=document.createElement("canvas"),a.width=V.canvas.width,a.height=V.canvas.height,b=a.getContext("2d"),b.drawImage(V.canvas,0,0,a.width,a.height),b.drawImage(O.canvas,0,0,a.width,a.height),V.postMessage("viewer.image.get",a.toDataURL(this.imageCallback.type,this.imageCallback.options))):V.postMessage("viewer.image.get",V.canvas.toDataURL(this.imageCallback.type,this.imageCallback.options))}animate(){requestAnimationFrame(this.animateFn);
if(this.visible){var a=window.performance.now();V.dT=(a-V.time)/1E3;V.time=a;this.imageCallback&&this.startImage();a=V.camera.moving;V.camera.moving=V.camera.changed();V.notify("onUpdate",{});V.camera.starting=V.camera.moving&&!a;if(V.viewer.repaint3d||V.camera.moving)V.viewer.repaint3d=!1,gl.viewport(0,0,gl.drawingBufferWidth,gl.drawingBufferHeight),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),this.render(this.camera),V.notify("onRender3D",this);if(V.viewer.repaint2d||V.camera.moving)V.viewer.repaint2d=
!1,V.notify("onRender2D",this);this.imageCallback&&(this.endImage(),delete this.imageCallback);V.camera.stopping=a&&!V.camera.moving;a&&V.postMessage("camera.update",V.camera.toJson())}}setBufferSize(a,b){V.canvas.width=a;V.canvas.height=b;V.camera.moving=!0}};
V.Dataset=class{constructor(a){this.config=a;this.id=a.id;this.type=a.type;this.root=a.root;this.visible=a.hasOwnProperty("visible")?a.visible:!0;this.lastRefresh=0;this.url=a.source;this.refresh=a.refresh}refreshToken(){!this.promise&&this.refresh&&(this.promise=new Promise((a,b)=>{var c=new XMLHttpRequest;c.open("GET",this.refresh,!0);c.onload=d=>{200==c.status?(d=JSON.parse(d.currentTarget.responseText),this.url=d.source.data,this.refresh=d.source.refresh,a(this.url)):b(c.status)};c.onerror=d=>
{b(c.status)};c.send()}),this.promise.then(()=>{this.promise=null}));return this.promise}};
V.CameraController=class extends V.EventHandler{constructor(a,b,c,d){super(a,b);this.name=name;this.camera=c;this.currPos={x:0,y:0};this.currZoom=0;this.pointerPosition={pageX:0,pageY:0};this.pointerRay=new GM.Ray;this.pointerAge=0;this.cast3d={distance:Number.POSITIVE_INFINITY};this.ray=new GM.Ray;this.q0=new GM.Quaternion;this.qN=new GM.Quaternion;this.qR=new GM.Quaternion;this.min=new GM.Vector3(0,0,0);this.max=new GM.Vector3(0,0,0);this.drag=0;this.dragMax=d;this.shiftKey=!1;this.tn=0;this.keys=
{};this.position={sT:1,p0:{x:0,y:0,z:0},p1:{x:0,y:0,z:0}};this.rotation={sT:1,q0:new GM.Quaternion,q1:new GM.Quaternion,qR:new GM.Quaternion};this.tweenT=this.tweenR=400}tweenPosition(a,b){this.position.p0.x=this.camera.position.x;this.position.p0.y=this.camera.position.y;this.position.p0.z=this.camera.position.z;this.position.p1.x=a.x;this.position.p1.y=a.y;this.position.p1.z=a.z;this.position.t=V.time+(b||this.tweenT);this.position.sT=0}tweenRotation(a,b){this.rotation.q0.fromEuler(this.camera.rotation);
this.rotation.q1.fromEuler(a);this.rotation.t=V.time+(b||this.tweenR);this.rotation.sT=0}tweenStart(a){this.t0=V.time;this.updateFn=a;this.drag=0}tweenStop(){this.position.sT=1;this.position.sT=1;this.updateFn=null;this.drag=0}onUpdate(a){if(1>this.position.sT||1>this.rotation.sT){if(1>this.position.sT){this.position.sT=Math.min(1,(V.time-this.t0)/(this.position.t-this.t0));var b=Easing.Sinusoidal.In(this.position.sT),c=this.position.p0,d=this.position.p1;this.camera.position.x=c.x+(d.x-c.x)*b;this.camera.position.y=
c.y+(d.y-c.y)*b;this.camera.position.z=c.z+(d.z-c.z)*b}1>this.rotation.sT&&(this.rotation.sT=Math.min(1,(V.time-this.t0)/(this.rotation.t-this.t0)),GM.Quaternion.slerp(this.rotation.q0,this.rotation.q1,this.rotation.qR,Easing.Sinusoidal.In(this.rotation.sT)),this.camera.rotation.fromQuaternion(this.rotation.qR));this.camera.moving=!0;this.updateFn&&(this.updateFn.call(this,this,a),1==this.position.sT&&1==this.rotation.sT&&(this.updateFn=null))}else this.updateFn&&(this.updateFn.call(this,this,a),
this.drag&&1==this.drag--&&(this.updateFn=null),this.camera.moving=!0);V.camera.stopping&&(V.camera.getRay(this.pointerPosition,this.pointerRay),V.postMessage("viewer.mousemove",this.castRay3d()))}getWheelDelta(a){var b=a.shiftKey?.2:1;if(void 0!==a.wheelDelta)return-b*a.wheelDelta/4300;if(void 0!==a.detail)return b*a.detail/250}onMouseWheel(a){this.currPos=this.camera.screenToCamera(this.pointerPosition);this.currZoomD=this.getWheelDelta(a);this.currZoom-=this.currZoomD;this.currZoom=Math.min(Math.max(-1,
this.currZoom),1);a.preventDefault()}onMouseDown(a){this.startPos=this.camera.screenToCamera(this.pointerPosition);this.currPos.x=this.startPos.x;this.currPos.y=this.startPos.y;this.drag=0;V.postMessage("viewer.mousedown",this.cast3d)}onTouchStart(a){a=a.targetTouches;1==a.length&&(this.pointerPosition={pageX:a[0].pageX,pageY:a[0].pageY},this.onMouseDown({pageX:a[0].pageX,pageY:a[0].pageY,button:0}),V.camera.getRay(this.pointerPosition,this.pointerRay),this.cast2d=O.instance.raycast(this.pointerRay,
this.pointerPosition),V.postMessage("viewer.mousemove",this.castRay3d()),this.touchStamp=V.time,this.touchLast=a[0])}onMouseMove(a){this.currPos=this.camera.screenToCamera(a);this.shiftKey=a.shiftKey;this.pointerPosition={pageX:a.pageX,pageY:a.pageY};null!=this._timer||V.camera.moving||(this._timer=setTimeout(()=>{null!=this._timer&&V.postMessage("viewer.mousemove",this.castRay3d())},150));V.camera.getRay(this.pointerPosition,this.pointerRay)}onTouchMove(a){a=a.targetTouches;1==a.length&&(this.onMouseMove({pageX:a[0].pageX,
pageY:a[0].pageY,button:0}),this.touchLast=a[0]);this.touchStamp=0}onMouseUp(a){this.drag=this.dragMax}onMouseOut(a){this.currZoom=0;this.updateFn=null}onClick(a){a.ray=V.camera.getRay(a,this.ray);this.cast2d=O.instance.raycast(a.ray,a.pageX,a.pageY);if(0<this.cast2d.hits.length){this.cast2d.hits.sort(function(c,d){return c.distance-d.distance});var b=this.cast2d.hits[0].object;V.postMessage(b.type+".click",b.CLICK({id:b.id,type:b.type,pageX:a.pageX,pageY:a.pageY}));return!0}return!1}onDblClick(a){V.camera.getRay(this.pointerPosition,
this.pointerRay);this.castRay3d();a.ray=this.ray;if(0<this.cast2d.hits.length){var b=this.cast2d.hits[0].object;V.postMessage(b.type+".dblclick",b.DBLCLICK({id:b.id,type:b.type,pageX:a.pageX,pageY:a.pageY}));return!0}V.postMessage("viewer.dblclick",this.cast3d);return!1}onTouchEnd(a){if(0==a.targetTouches.length){a.pageX=this.touchLast.pageX;a.pageY=this.touchLast.pageY;if(300>V.time-this.touchStamp)return this.onDblClick(a);this.onMouseUp(a);return this.onClick(a)}return!1}onKeyDown(a){this.drag=
0;this.keys[a.keyCode]=!0}onKeyUp(a){V.keyCount||(this.drag=this.dragMax);delete this.keys[a.keyCode];this.startPos.x=this.currPos.x;this.startPos.y=this.currPos.y}onTouchCancel(a){}castRay3d(){let a=V.viewer.raycast(this.pointerRay,{xyz:{},normal:{},distance:Number.POSITIVE_INFINITY});a.distance!=Number.POSITIVE_INFINITY&&GM.Vector3.normalize(a.normal,a.normal);this.cast3d=a;this.pointerAge=V.time;this._timer=null;return a}};
Easing={Linear:function(a){return a},Quadratic:{In:function(a){return a*a},Out:function(a){return a*(2-a)},InOut:function(a){return 1>(a*=2)?.5*a*a:-.5*(--a*(a-2)-1)}},Cubic:{In:function(a){return a*a*a},Out:function(a){return--a*a*a+1},InOut:function(a){return 1>(a*=2)?.5*a*a*a:.5*((a-=2)*a*a+2)}},Quartic:{In:function(a){return a*a*a*a},Out:function(a){return 1- --a*a*a*a},InOut:function(a){return 1>(a*=2)?.5*a*a*a*a:-.5*((a-=2)*a*a*a-2)}},Sinusoidal:{In:function(a){return 1-Math.cos(a*Math.PI/2)},
Out:function(a){return Math.sin(a*Math.PI/2)},InOut:function(a){return.5*(1-Math.cos(Math.PI*a))}},Exponential:{In:function(a){return 0===a?0:Math.pow(1024,a-1)},Out:function(a){return 1===a?1:1-Math.pow(2,-10*a)},InOut:function(a){return 0===a?0:1===a?1:1>(a*=2)?.5*Math.pow(1024,a-1):.5*(-Math.pow(2,-10*(a-1))+2)}},Circular:{In:function(a){return 1-Math.sqrt(1-a*a)},Out:function(a){return Math.sqrt(1- --a*a)},InOut:function(a){return 1>(a*=2)?-.5*(Math.sqrt(1-a*a)-1):.5*(Math.sqrt(1-(a-=2)*a)+1)}},
Elastic:{In:function(a){var b=.1;if(0===a)return 0;if(1===a)return 1;if(!b||1>b){b=1;var c=.1}else c=.4*Math.asin(1/b)/(2*Math.PI);return-(b*Math.pow(2,10*--a)*Math.sin(2*(a-c)*Math.PI/.4))},Out:function(a){var b=.1;if(0===a)return 0;if(1===a)return 1;if(!b||1>b){b=1;var c=.1}else c=.4*Math.asin(1/b)/(2*Math.PI);return b*Math.pow(2,-10*a)*Math.sin(2*(a-c)*Math.PI/.4)+1},InOut:function(a){var b=.1;if(0===a)return 0;if(1===a)return 1;if(!b||1>b){b=1;var c=.1}else c=.4*Math.asin(1/b)/(2*Math.PI);return 1>
(a*=2)?-.5*b*Math.pow(2,10*--a)*Math.sin(2*(a-c)*Math.PI/.4):b*Math.pow(2,-10*--a)*Math.sin(2*(a-c)*Math.PI/.4)*.5+1}},Back:{In:function(a){return a*a*(2.70158*a-1.70158)},Out:function(a){return--a*a*(2.70158*a+1.70158)+1},InOut:function(a){return 1>(a*=2)?.5*a*a*(3.5949095*a-2.5949095):.5*((a-=2)*a*(3.5949095*a+2.5949095)+2)}},Bounce:{In:function(a){return 1-Easing.Bounce.Out(1-a)},Out:function(a){return a<1/2.75?7.5625*a*a:a<2/2.75?7.5625*(a-=1.5/2.75)*a+.75:a<2.5/2.75?7.5625*(a-=2.25/2.75)*a+.9375:
7.5625*(a-=2.625/2.75)*a+.984375},InOut:function(a){return.5>a?.5*Easing.Bounce.In(2*a):.5*Easing.Bounce.Out(2*a-1)+.5}}};V.KEY_CANCEL=3;V.KEY_HELP=6;V.KEY_BACK_SPACE=8;V.KEY_TAB=9;V.KEY_CLEAR=12;V.KEY_RETURN=13;V.KEY_ENTER=14;V.KEY_SHIFT=16;V.KEY_CONTROL=17;V.KEY_ALT=18;V.KEY_PAUSE=19;V.KEY_CAPS_LOCK=20;V.KEY_ESCAPE=27;V.KEY_SPACE=32;V.KEY_PAGE_UP=33;V.KEY_PAGE_DOWN=34;V.KEY_END=35;V.KEY_HOME=36;V.KEY_LEFT=37;V.KEY_UP=38;V.KEY_RIGHT=39;V.KEY_DOWN=40;V.KEY_PRINTSCREEN=44;V.KEY_INSERT=45;
V.KEY_DELETE=46;V.KEY_0=48;V.KEY_1=49;V.KEY_2=50;V.KEY_3=51;V.KEY_4=52;V.KEY_5=53;V.KEY_6=54;V.KEY_7=55;V.KEY_8=56;V.KEY_9=57;V.KEY_SEMICOLON=59;V.KEY_EQUALS=61;V.KEY_A=65;V.KEY_B=66;V.KEY_C=67;V.KEY_D=68;V.KEY_E=69;V.KEY_F=70;V.KEY_G=71;V.KEY_H=72;V.KEY_I=73;V.KEY_J=74;V.KEY_K=75;V.KEY_L=76;V.KEY_M=77;V.KEY_N=78;V.KEY_O=79;V.KEY_P=80;V.KEY_Q=81;V.KEY_R=82;V.KEY_S=83;V.KEY_T=84;V.KEY_U=85;V.KEY_V=86;V.KEY_W=87;V.KEY_X=88;V.KEY_Y=89;V.KEY_Z=90;V.KEY_CONTEXT_MENU=93;V.KEY_NUMPAD0=96;V.KEY_NUMPAD1=97;
V.KEY_NUMPAD2=98;V.KEY_NUMPAD3=99;V.KEY_NUMPAD4=100;V.KEY_NUMPAD5=101;V.KEY_NUMPAD6=102;V.KEY_NUMPAD7=103;V.KEY_NUMPAD8=104;V.KEY_NUMPAD9=105;V.KEY_MULTIPLY=106;V.KEY_ADD=107;V.KEY_SEPARATOR=108;V.KEY_SUBTRACT=109;V.KEY_DECIMAL=110;V.KEY_DIVIDE=111;V.KEY_F1=112;V.KEY_F2=113;V.KEY_F3=114;V.KEY_F4=115;V.KEY_F5=116;V.KEY_F6=117;V.KEY_F7=118;V.KEY_F8=119;V.KEY_F9=120;V.KEY_F10=121;V.KEY_F11=122;V.KEY_F12=123;V.KEY_F13=124;V.KEY_F14=125;V.KEY_F15=126;V.KEY_F16=127;V.KEY_F17=128;V.KEY_F18=129;
V.KEY_F19=130;V.KEY_F20=131;V.KEY_F21=132;V.KEY_F22=133;V.KEY_F23=134;V.KEY_F24=135;V.KEY_NUM_LOCK=144;V.KEY_SCROLL_LOCK=145;V.KEY_COMMA=188;V.KEY_PERIOD=190;V.KEY_SLASH=191;V.KEY_BACK_QUOTE=192;V.KEY_OPEN_BRACKET=219;V.KEY_BACK_SLASH=220;V.KEY_CLOSE_BRACKET=221;V.KEY_QUOTE=222;V.KEY_META=224;V.Queue=function(){this.last=this.first=null;this.size=0};V.Queue.prototype.enqueue=function(a){this.first?this.last.next=a:this.first=a;this.last=a;this.size++};
V.Queue.prototype.dequeue=function(){var a=this.first;this.first=this.first.next;null==this.first&&(this.last=null);a.next=null;this.size--;return a};V.Queue.prototype.empty=function(){return null==this.first};V.Queue.prototype.clear=function(){this.last=this.first=null;this.size=0};V.Queue.prototype.front=function(){return this.first};V.PriorityQueue=function(a){this.data=[];this.length=0;this.compare=a};
V.PriorityQueue.prototype.enqueue=function(a){this.data.push(a);this.length++;this._up(this.length-1)};V.PriorityQueue.prototype.dequeue=function(){var a=this.data[0];this.length--;0<this.length&&(this.data[0]=this.data[this.length],this._down(0));this.data.pop();return a};V.PriorityQueue.prototype.empty=function(){return 0==this.length};V.PriorityQueue.prototype.clear=function(){this.data=[];this.length=0};
V.PriorityQueue.prototype._up=function(a){for(var b=this.data,c=this.compare,d=b[a];0<a;){var e=a-1>>1,f=b[e];if(0<=c(d,f))break;b[a]=f;a=e}b[a]=d};V.PriorityQueue.prototype._down=function(a){for(var b=this.data,c=this.compare,d=this.length>>1,e=b[a];a<d;){var f=(a<<1)+1,g=f+1,h=b[f];g<this.length&&0>c(b[g],h)&&(f=g,h=b[g]);if(0<=c(h,e))break;b[a]=h;a=f}b[a]=e};
</script>
<script id="/overlay/overlay.js">O={instance:null,camera:null,DISTANCE:"distance",ANGLE:"angle",VOLUME:"volume",AREA:"area",canvas:document.getElementById("canvas2D"),units:0,numberFormat:new Intl.NumberFormat,s1:1,s2:1,s3:1,setScalar:function(a,b,c){O.s1=a;O.s2=b;O.s3=c},cursor:a=>{O.canvas.style.cursor=a},add:a=>{O.instance.addObject(a)},find:a=>O.instance.registry[a],remove:a=>{a instanceof O.Object?O.instance.removeObject(a.id):O.instance.removePanel(a)},getSelected:()=>O.instance.getSelected(),getAll:a=>{let b={};O.instance.objects.forEach(c=>
{c.type===a&&(b[c.id]=c.toJson())});return b},Component:function(a){this.style=a;this.visible=!0;this.zIndex=100;this.normal3D={x:0,y:0,z:0}}};O.Component.prototype.setVisibile=function(a){this.visible=a};
O.Object=class{constructor(a,b,c){this.id=null==a?(new Date).getTime():a;this.exclude=c;this.components=[];this.controls=[];this.anchors=[];if(this.activation=b)this.activation.easing=this.activation.easing||"Linear";this.aabb={min:{x:0,y:0,z:0},max:{x:0,y:0,z:0},center:{x:0,y:0,z:0}};this.attached=this.selected=!1;this.scale=1;this.visible=!0}CLICK(a){return a}DBLCLICK(a){return a}detach(){for(var a=0;a<this.controls.length;a++)this.controls[a].detach();this.attached=!1}attach(){for(var a=0;a<this.controls.length;a++)this.controls[a].attach();
this.attached=!0}onUpdate(a){this.activation&&this.visible&&(this.scale=Easing[this.activation.easing](V.viewer.getDistanceAlpha(this.aabb.center,this.activation.p0,this.activation.p1)))}isVisible(){return this.visible&&V.camera.intersectsBox(this.aabb)}addAnchor(a){this.anchors.push(a);return a}insertAnchor(a,b){this.anchors.splice(a,0,b);return b}removeAnchor(a){this.anchors.splice(this.anchors.indexOf(a),1)}addControl(a){this.controls.push(a);a.attach();a.addListener(this);return a}insertControl(a,
b){this.controls.splice(a,0,b);b.attach();b.addListener(this);return b}removeControl(a){[a]=this.controls.splice(this.controls.indexOf(a),1);a.detach()}addComponent(a){this.components.push(a);return a}insertComponent(a,b){this.components.splice(a,0,b);return b}removeComponent(a){this.components.splice(this.components.indexOf(a),1)}endControl(){V.touch2d()}projectAnchors(){for(var a=0;a<this.anchors.length;a++)this.anchors[a].project();var b=this.aabb.min,c=this.aabb.max,d=this.aabb.center;b.x=Number.POSITIVE_INFINITY;
b.y=Number.POSITIVE_INFINITY;b.z=Number.POSITIVE_INFINITY;c.x=Number.NEGATIVE_INFINITY;c.y=Number.NEGATIVE_INFINITY;c.z=Number.NEGATIVE_INFINITY;for(a=0;a<this.anchors.length;a++){var e=this.anchors[a];b.x=Math.min(e.wx,b.x);b.y=Math.min(e.wy,b.y);b.z=Math.min(e.wz,b.z);c.x=Math.max(e.wx,c.x);c.y=Math.max(e.wy,c.y);c.z=Math.max(e.wz,c.z)}d.x=(c.x+b.x)/2;d.y=(c.y+b.y)/2;d.z=(c.z+b.z)/2}updateUnits(){for(var a=0;a<this.components.length;a++)this.components[a].updateUnits&&this.components[a].updateUnits()}intersectRay3D(a){var b=
Number.POSITIVE_INFINITY;this.components.forEach(c=>{c.intersectRay3D&&(b=Math.min(b,c.intersectRay3D(a,this)))});return b}containsPoint2D(a){if(this.selected)for(var b=0;b<this.controls.length;b++)if(this.controls[b].containsPoint2D(a))return a.component=this.controls[b],!0;for(b=0;b<this.components.length;b++)if(this.components[b].containsPoint2D&&this.components[b].containsPoint2D(a))return a.component=this.components[b],!0;return!1}select(){this.projectAnchors();this.selected?console.log("object already selected"):
(this.selected=!0,this.onDblClick&&O.instance.addEventListener("onDblClick",this))}unselect(){this.selected=!1;for(var a=0;a<this.controls.length;a++)this.controls[a].detach();this.controls=[];this.onDblClick&&O.instance.removeEventListener("onDblClick",this)}update(a){a.hasOwnProperty("activation")&&(this.activation=a.activation,V.touch2d());a.hasOwnProperty("visible")&&(this.visible=a.visible)&&this.projectAnchors()}render2D(a){if(0<this.scale)for(var b=0;b<this.components.length;b++){var c=this.components[b];
c.visible&&c.render2D&&this.components[b].render2D(a)}}render3D(a){for(var b=0;b<this.components.length;b++)this.components[b].visible&&this.components[b].render3D&&this.components[b].render3D(a,this)}toJson(a){let b={};if(void 0==a||a.includes("id"))b.id=this.id;(void 0==a||a.includes("activation"))&&this.activation&&(b.activation=this.activation);(void 0==a||a.includes("visible"))&&this.hasOwnProperty("visible")&&(b.visible=this.visible);return b}};O.Object.INFINITE={easing:"Linear"};
O.Composite=class extends O.Object{constructor(a,b,c){super(a,b,c);this.objects=[]}detach(){super.detach();for(var a=0;a<this.objects.length;a++)this.objects[a].detach()}attach(){super.attach();for(var a=0;a<this.objects.length;a++)this.objects[a].attach()}onUpdate(a){super.onUpdate(a);if(this.activation&&V.camera.moving)for(var b=0;b<this.objects.length;b++)this.objects[b].scale=this.scale;for(b=0;b<this.objects.length;b++)this.objects[b].onUpdate(a)}addObject(a){a.attached||a.attach();this.objects.push(a);
return a}insertObject(a,b){b.attached&&b.detach();this.objects.splice(a,0,b);return b}removeObject(a){a.attached&&a.detach();this.objects.splice(this.objects.indexOf(a),1)}projectAnchors(){super.projectAnchors();for(var a=0;a<this.objects.length;a++)this.objects[a].projectAnchors()}select(){super.select();for(var a=0;a<this.objects.length;a++)this.objects[a].select()}unselect(){super.unselect();for(var a=0;a<this.objects.length;a++)this.objects[a].unselect()}render2D(a){super.render2D(a);for(var b=
0;b<this.objects.length;b++)this.objects[b].visible&&this.objects[b].render2D(a)}render3D(a){for(var b=0;b<this.objects.length;b++)this.objects[b].visible&&this.objects[b].render3D(a,this);super.render3D(a)}};
O.Overlay=class extends V.EventHandler{constructor(){super(V.EventHandler.PRIO0,V.EventHandler.PRIO3);O.canvas.width=O.canvas.clientWidth;O.canvas.height=O.canvas.clientHeight;this.context=O.canvas.getContext("2d");O.instance=this;this.objects=[];this.visibleObjects=[];this.registry={};this.points=[];this.handlers={onMouseDown:[],onMouseMove:[],onMouseUp:[],onMouseOut:[],onClick:[],onDblClick:[]};O.ControlPoint.PATH=new Path2D;O.ControlPoint.PATH.arc(0,0,O.ControlPoint.R,0,2*Math.PI);this.anchors=
{};V.recvMessage("anchor.create",a=>{if(this.anchors[a.id])V.postMessage("error","anchor already exists "+a.id);else{let b=new O.AnchorX(a,a.id);this.anchors[a.id]=b;V.postMessage("anchor.create",Object.assign(b.toJson(),{id:b.id}))}});V.recvMessage("anchor.update",a=>{this.anchors[a.id]?a.hasOwnProperty("point")&&(this.anchors[a.id].set3D(a),V.postMessage("anchor.update",Object.assign(anchor.toJson(),{id:anchor.id}))):V.postMessage("error","anchor does not exist "+a.id)});V.recvMessage("anchor.delete",
a=>{this.anchors[a.id]?(delete this.anchors[a.id],V.postMessage("anchor.delete",a)):V.postMessage("error","anchor does not exist "+a.id)});V.recvMessage("viewpoint.get",a=>{let b={};this.objects.forEach(c=>{c.exclude||c.visible||(b[c.id]=!0)});a.hidden=Object.assign(a.hidden||{},b)});V.recvMessage("viewpoint",a=>{let b=a.hidden;this.objects.forEach(c=>{c.exclude||c.visible==!b[c.id]||(c.visible=!b[c.id],V.postMessage(`${c.type}.update`,{id:c.id,visible:c.visible}))});V.touch2d()});V.recvMessage("viewer.unload",
a=>{this.objects.forEach(b=>{delete this.registry[b.id];b.detach()});this.objects=[];this.visibleObjects=[]});V.recvMessage("*.scan.stop",(a,b)=>{this.objects.forEach(c=>{"function"===typeof c.stopScan&&c.stopScan()});V.postMessage("*.selected.get",{},b);V.touch2d()});V.recvMessage("*.unselect",(a,b)=>{if(a&&a.id){let c=this.getObject(a.id);c&&(c.unselect(),V.postMessage(`${c.type}.unselect`,{id:c.id},b))}else this.objects.forEach(c=>{c.selected&&(c.unselect(),V.postMessage(`${c.type}.unselect`,{id:c.id},
b))});V.postMessage("*.unselect",a,b);V.touch2d()});V.recvMessage("*.selected.get",(a,b)=>{let c={};this.objects.forEach(d=>{d.selected&&(c[d.id]=d.toJson(a.filter))});V.postMessage("*.selected.get",c,b);V.touch2d()});V.recvMessage("*.get",(a,b)=>{this.objects.forEach(c=>{a[c.id]=c.toJson(a.filter)})});V.recvMessage("*.delete",(a,b)=>{let c=null;a.filter&&(c=Function("return "+decodeURI(entry.filter))());for(var d=this.objects.length-1;0<=d;d--){var e=this.objects[d];if(null==c||c.call(e))delete this.registry[e.id],
e.detach(),this.objects.splice(d,1),e=this.visibleObjects.indexOf(e),-1!=e&&this.visibleObjects.splice(e,1)}V.postMessage("*.delete",a,b)});V.recvMessage("record.cancel",(a,b)=>{O.Builder.get().end();V.touch2d()});V.recvMessage("viewer.update",a=>{if(a.hasOwnProperty("units"))for(a=0;a<this.objects.length;a++)this.objects[a].updateUnits()})}addEventListener(a,b,c,d){c={object:b,zIndex:null==c?999:c};c.callback=d?d:b[a].bind(b);a=this.handlers[a];a.push(c);for(b=a.length-1;0<b;b--)a[b].zIndex<a[b-
1].zIndex&&(d=a[b-1],a[b-1]=a[b],a[b]=d)}removeEventListener(a,b){a=this.handlers[a];for(var c=0;c<a.length;c++)if(a[c].object===b){a.splice(c,1);break}}onMouseDown(a){for(var b=this.handlers.onMouseDown,c=0;c<b.length;c++)if(b[c].object.containsPoint2D(a)){b[c].callback(a);break}}onMouseMove(a){for(var b=this.handlers.onMouseMove,c=0;c<b.length;c++)b[c].callback(a)}onMouseUp(a){for(var b=this.handlers.onMouseUp,c=0;c<b.length;c++)b[c].callback(a)}onMouseOut(a){for(var b=this.handlers.onMouseOut,
c=0;c<b.length;c++)b[c].callback(a)}onClick(a){for(var b=this.handlers.onClick,c=0;c<b.length;c++)if(b[c].object.containsPoint2D){if(b[c].object.containsPoint2D(a)){b[c].callback(a);break}}else if(b[c].callback(a))break}onDblClick(a){for(var b=this.handlers.onDblClick,c=0;c<b.length;c++)if(b[c].object.containsPoint2D){if(b[c].object.containsPoint2D(a)){b[c].callback(a);break}}else{b[c].callback(a);break}}onUpdate(a){this.visibleObjects=[];this.objects.forEach(b=>{b.isVisible()&&this.visibleObjects.push(b)});
this.visibleObjects.forEach(b=>{b.onUpdate(a)});V.camera.moving&&(this.updateAnchors=!0)}onRender3D(a){this.updateAnchors&&(this.points.forEach(b=>b.anchor.project()),this.visibleObjects.forEach(b=>b.projectAnchors()),Object.keys(this.anchors).forEach(b=>this.anchors[b].project()),this.updateAnchors=!1);this.visibleObjects.forEach(b=>{b.render3D&&b.visible&&b.render3D(a)})}onRender2D(a){this.context.clearRect(0,0,O.canvas.width,O.canvas.height);this.context.beginPath();a.background&&this.context.drawImage(a.background,
0,0);this.context.save();for(a=0;a<this.visibleObjects.length;a++)this.visibleObjects[a].visible&&this.visibleObjects[a].render2D(this.context);this.context.restore();this.context.save();this.context.lineWidth=3;for(a=0;a<this.points.length;a++)this.points[a].render2D(this.context);this.context.lineWidth=1;this.context.restore()}onResize(a){O.canvas.width=a.width;O.canvas.height=a.height;this.updateAnchors=!0;for(var b=0;b<this.visibleObjects.length;b++)if(this.visibleObjects[b].onResize)this.visibleObjects[b].onResize(a)}getSelected(a){for(a=
0;a<this.objects.length;a++)if(this.objects[a].selected)return this.objects[a];return null}createControlPoint(a,b){a=b.getPoint(a);return null!=a?(b=new O.ControlPoint(new O.Anchor(a),b),b.attach(),b):null}removeControlPoint(a){for(var b=0;b<this.points.length;b++)if(this.points[b]==a){this.points.splice(b,1);break}}addControlPoint(a){this.points.push(a)}addObject(a){a.attach();this.objects.push(a);this.registry[a.id]=a;this.updateAnchors=!0;this.visibleObjects.push(a)}removeObject(a){for(var b=0;b<
this.objects.length;b++)if(this.objects[b].id==a)return a=this.objects[b],delete this.registry[a.id],a.detach(),this.objects.splice(b,1),b=this.visibleObjects.indexOf(a),-1!=b&&this.visibleObjects.splice(b,1),a;return null}raycast(a,b,c){var d={ray:a,distance:Number.POSITIVE_INFINITY,pageX:b,pageY:c,hits:[]};this.context.save();this.visibleObjects.forEach(e=>{let f=e.intersectRay3D(d);0<e.scale&&f!=Number.POSITIVE_INFINITY&&d.hits.push({distance:f,object:e})});this.context.restore();return d}getObject(a){return this.registry[a]}};
O.Builder=class extends V.EventHandler{constructor(){super(V.EventHandler.PRIO1);this.points=[]}start(a){this.tool&&this.end();this.tool=a;O.cursor("crosshair");this.attach()}end(){this.points.forEach(a=>a.detach());this.points=[];this.tool=null;O.cursor("default");this.isAttached()&&this.detach()}onClick(a){let b=this.tool.addPoint(a,this.escaped);if(b&&(this.points.push(b),this.tool.isDone(this.points))){var c=[];this.points.forEach(d=>c.push(d.anchor.toJson()));this.tool.complete(c);this.end()}a.stopImmediatePropagation()}onKeyUp(a){27==
a.keyCode?(this.escaped=!0,this.tool.isDone(a.keyCode)&&this.end()):8==a.keyCode&&this.removePoint&&this.removePoint()}};O.Builder.get=function(){O.Builder.instance||(O.Builder.instance=new O.Builder);return O.Builder.instance};
</script>
<script id="/overlay/anchor.js">O.Anchor=class{constructor(a){a?(this.wx=a.x||0,this.wy=a.y||0,this.wz=a.z||0):this.wz=this.wy=this.wx=0;this.listener=[];this.id=O.Anchor.nextId++;this.project()}between3D(a,b,c){return new O.Anchor({x:a.wx+(b.wx-a.wx)*c,y:a.wy+(b.wy-a.wy)*c,z:a.wz+(b.wz-a.wz)*c})}set3D(a){this.wx=a.x;this.wy=a.y;this.wz=a.z;for(a=0;a<this.listener.length;a++)this.listener[a].update3D&&this.listener[a].update3D();this.project()}translate3D(a,b,c){this.wx+=a;this.wy+=b;this.wz+=c;this.px=this.wx;this.py=this.wy;this.pz=
this.wz;for(a=0;a<this.listener.length;a++)this.listener[a].update3D&&this.listener[a].update3D();this.project()}project(){var a=V.camera.project({x:this.wx,y:this.wy,z:this.wz});this.sx=a.x*O.canvas.width;this.sy=a.y*O.canvas.height}move2D(a){this.sx=a.pageX;this.sy=a.pageY}addListener(a){this.listener.push(a)}removeListener(a){for(var b=0;b<this.listener.length;b++)if(this.listener[b]==a){this.listener.splice(b,1);break}}toJson(a){return{x:this.wx,y:this.wy,z:this.wz}}};O.Anchor.nextId=1;
O.AnchorX=class extends O.Anchor{constructor(a,b){super(a);this.id=b}project(){super.project();0<this.sx&&this.sx<O.canvas.width&&0<this.sy&&this.sy<O.canvas.height&&V.postMessage("anchor.update",{id:this.id,xyz:{x:this.wx,y:this.wy,z:this.wz},uv:{x:this.sx,y:this.sy}})}};
O.ControlPoint=class{constructor(a,b){this.constraint=b;this.anchor=a;this.anchor.addListener(this);this.zIndex=0;this.visible=!0;this.timer=null;this.click=function(c){c.preventDefault();c.stopPropagation()};this.listener=[]}detach(){O.instance.removeEventListener("onMouseDown",this);O.instance.removeControlPoint(this)}attach(){O.instance.addControlPoint(this);O.instance.addEventListener("onMouseDown",this,0)}updateAnchor(a){a=this.constraint.moveControl(a,this);if(null!=a){this.anchor.set3D(a);
for(var b=0;b<this.listener.length;b++)void 0!=this.listener[b].moveControl&&this.listener[b].moveControl(this);O.cursor("crosshair")}else O.cursor("not-allowed");return a}onMouseDown(a){O.instance.addEventListener("onMouseUp",this,0);O.instance.addEventListener("onMouseMove",this,0);O.instance.addEventListener("onMouseOut",this,0);for(var b=0;b<this.listener.length;b++)void 0!=this.listener[b].startControl&&this.listener[b].startControl(this);this.dragEvent={pageX:a.pageX,pageY:a.pageY};O.cursor("crosshair");
a.stopImmediatePropagation()}onMouseMove(a){this.constraint instanceof C.Intersect?(this.anchor.move2D(a),null==this.timer&&(this.timer=setTimeout(function(){null!=this.timer&&(this.updateAnchor(this.dragEvent),this.timer=null)}.bind(this),400)),this.dragEvent={pageX:a.pageX,pageY:a.pageY}):(this.dragEvent={pageX:a.pageX,pageY:a.pageY},this.updateAnchor(this.dragEvent));V.touch2d();a.stopImmediatePropagation()}onMouseUp(a){O.instance.removeEventListener("onMouseUp",this);O.instance.removeEventListener("onMouseMove",
this);O.instance.removeEventListener("onMouseOut",this);null!=this.timer&&(clearTimeout(this.timer),this.timer=null);this.updateAnchor(a)||this.anchor.project();for(var b=0;b<this.listener.length;b++)void 0!=this.listener[b].endControl&&this.listener[b].endControl(this);O.cursor("default");a.stopImmediatePropagation()}onMouseOut(a){this.onMouseUp(a)}containsPoint2D(a){var b=a.pageX-this.anchor.sx;a=a.pageY-this.anchor.sy;return b*b+a*a<O.ControlPoint.R2}addListener(a){this.listener.push(a)}removeListener(a){for(var b=
0;b<this.listener.length;b++)if(this.listener[b]==a){this.listener.splice(b,1);break}}render2D(a){this.visible&&(a.strokeStyle=this.constraint.strokeStyle,a.setTransform(1,0,0,1,this.anchor.sx,this.anchor.sy),a.stroke(O.ControlPoint.PATH))}};O.ControlPoint.R=7;O.ControlPoint.R2=O.ControlPoint.R*O.ControlPoint.R;O.ControlPoint.PATH=null;
C={create:function(a){return"Cloud"===a[0]?new C.Intersect(a[1]):C[a[0]]?new C[a[0]](a[1]):C.Intersect.instance},p:{x:0,y:0,z:0},Plane:function(a){this.plane=a;this.strokeStyle=C.Plane.ACTIVE}};C.Plane.ACTIVE="#66FF00";C.Plane.PASSIVE="#4FC40F";C.Plane.prototype.moveControl=function(a){return this.getPoint(a)};
C.Plane.prototype.getPoint=function(a){a=V.camera.getRay(a);var b=-(this.plane.x*a.origin.x+this.plane.y*a.origin.y+this.plane.z*a.origin.z-this.plane.w)/(this.plane.x*a.direction.x+this.plane.y*a.direction.y+this.plane.z*a.direction.z);C.p.x=a.direction.x*b+a.origin.x;C.p.y=a.direction.y*b+a.origin.y;C.p.z=a.direction.z*b+a.origin.z;return C.p};C.Plane.prototype.toJson=function(){return["Plane",this.plane]};C.Intersect=function(){this.strokeStyle=C.Intersect.ACTIVE};C.Intersect.ACTIVE="#40C4FF";
C.Intersect.PASSIVE="#40C4FF";C.Intersect.prototype.moveControl=function(a){return this.getPoint(a)};C.Intersect.prototype.getPoint=function(a){a=V.camera.getRay(a);a=V.viewer.raycast(a,{distance:Number.POSITIVE_INFINITY,xyz:{}});return a.distance!=Number.POSITIVE_INFINITY?(C.p.x=a.xyz.x,C.p.y=a.xyz.y,C.p.z=a.xyz.z,C.p):null};C.Intersect.prototype.toJson=function(){return["Intersect"]};C.Intersect.instance=new C.Intersect;
C.Segment=function(a,b){this.anchor0=a;this.anchor1=b;this.t=0;this.strokeStyle=C.Segment.ACTIVE};C.Segment.ACTIVE="green";C.Segment.PASSIVE="#c2a90f";
C.Segment.prototype.moveControl=function(a){a=V.camera.getRay(a);var b=this.anchor0.wx-a.origin.x,c=this.anchor0.wy-a.origin.y,f=this.anchor0.wz-a.origin.z,e=this.anchor1.wx-this.anchor0.wx,d=this.anchor1.wy-this.anchor0.wy,g=this.anchor1.wz-this.anchor0.wz,h=Math.sqrt(e*e+d*d+g*g);e/=h;d/=h;g/=h;var k=e*a.direction.x+d*a.direction.y+g*a.direction.z;this.t=Math.min(h,Math.max(0,(k*(a.direction.x*b+a.direction.y*c+a.direction.z*f)-(e*b+d*c+g*f))/(1-k*k)));C.p.x=this.t*e+this.anchor0.wx;C.p.y=this.t*
d+this.anchor0.wy;C.p.z=this.t*g+this.anchor0.wz;this.t/=h;return C.p};C.Segment.prototype.toJson=function(){return["Segment"]};C.Ray=function(a,b){this.nx=b.x;this.ny=b.y;this.nz=b.z;this.anchor=a;this.strokeStyle=C.Ray.ACTIVE};C.Ray.ACTIVE="yellow";C.Ray.PASSIVE="#c2a90f";
C.Ray.prototype.moveControl=function(a){var b=V.camera.getRay(a),c=this.anchor.wx-b.origin.x,f=this.anchor.wy-b.origin.y,e=this.anchor.wz-b.origin.z;a=this.nx*b.direction.x+this.ny*b.direction.y+this.nz*b.direction.z;var d=this.nx*c+this.ny*f+this.nz*e;b=b.direction.x*c+b.direction.y*f+b.direction.z*e;c=1-a*a;return.001<c?(a=Math.max(0,(a*b-d)/c),C.p.x=a*this.nx+this.anchor.wx,C.p.y=a*this.ny+this.anchor.wy,C.p.z=a*this.nz+this.anchor.wz,C.p):null};C.Ray.prototype.toJson=function(){return["Ray"]};
C.Line=function(a,b){this.nx=b.x;this.ny=b.y;this.nz=b.z;this.anchor=a;this.strokeStyle=C.Line.ACTIVE};C.Line.ACTIVE=C.Ray.ACTIVE;C.Line.PASSIVE=C.Ray.PASSIVE;C.Line.prototype.moveControl=function(a){return this.getPoint(a)};
C.Line.prototype.getPoint=function(a){var b=V.camera.getRay(a),c=this.anchor.wx-b.origin.x,f=this.anchor.wy-b.origin.y,e=this.anchor.wz-b.origin.z;a=this.nx*b.direction.x+this.ny*b.direction.y+this.nz*b.direction.z;var d=this.nx*c+this.ny*f+this.nz*e;b=b.direction.x*c+b.direction.y*f+b.direction.z*e;c=1-a*a;return.001<c?(a=(a*b-d)/c,C.p.x=a*this.nx+this.anchor.wx,C.p.y=a*this.ny+this.anchor.wy,C.p.z=a*this.nz+this.anchor.wz,C.p):null};C.Horizontal=function(a,b){this.anchor=a;this.strokeStyle=C.Line.ACTIVE};
C.Horizontal.ACTIVE=C.Ray.ACTIVE;C.Horizontal.PASSIVE=C.Ray.PASSIVE;C.Horizontal.prototype.moveControl=function(a){return this.getPoint(a)};
C.Horizontal.prototype.getPoint=function(a){var b=V.camera.getRay(a),c=this.anchor.wx-b.origin.x,f=this.anchor.wy-b.origin.y,e=this.anchor.wz-b.origin.z;a=V.camera.xAxis;var d=a.x*b.direction.x+a.y*b.direction.y+a.z*b.direction.z,g=a.x*c+a.y*f+a.z*e;b=b.direction.x*c+b.direction.y*f+b.direction.z*e;c=1-d*d;return.001<c?(d=(d*b-g)/c,C.p.x=d*a.x+this.anchor.wx,C.p.y=d*a.y+this.anchor.wy,C.p.z=d*a.z+this.anchor.wz,C.p):null};C.Sphere=function(a,b){this.strokeStyle=C.Plane.ACTIVE};C.Sphere.ACTIVE=C.Plane.ACTIVE;
C.Sphere.PASSIVE=C.Plane.PASSIVE;C.Sphere.prototype.moveControl=function(a){return this.getPoint(a)};C.Sphere.prototype.getPoint=function(a){a=V.camera.getRay(a);C.p.x=.708*a.direction.x;C.p.y=.708*a.direction.y;C.p.z=.708*a.direction.z;return C.p};C.Sphere.prototype.toJson=function(){return["Sphere"]};C.Polygon=function(a){this.geometry=a;this.strokeStyle=C.Plane.ACTIVE};
C.Polygon.prototype.moveControl=function(a,b){a=GM.Ray.intersectPlane(V.camera.getRay(a),this.geometry.plane,{});return this.geometry.canMovePoint(b.anchor.id,a)?a:null};C.Polygon.prototype.getPoint=function(a){return GM.Ray.intersectPlane(V.camera.getRay(a),this.geometry.plane,{})};C.Polygon.prototype.toJson=function(){return["Polygon",this.geometry.plane]};
</script>
<script id="/overlay/component.js">O.Style={FRONT:1,BACK:2,FRONT_BACK:3,NONE:0,A:8};
O.Style.Line=class{constructor(a,b,c){this.selected=!1;this.lineWidth=1;this.fillStyle=b||"red";this.dash=a;this.arrows=c}render2d(a,b,c,d,e,g){var k=d-b,h=e-c,f=Math.atan2(h,k);a.setTransform(1,0,0,1,b,c);a.beginPath();a.moveTo(0,0);a.lineTo(k,h);a.lineWidth=this.lineWidth;a.strokeStyle=this.fillStyle;this.dash&&a.setLineDash(this.dash);a.stroke();this.dash&&a.setLineDash([]);a.lineWidth=1;if(this.arrows==O.Style.FRONT||this.arrows==O.Style.FRONT_BACK)a.beginPath(),a.moveTo(k,h),a.lineTo(k-12*Math.cos(f-
Math.PI/7),h-12*Math.sin(f-Math.PI/7)),a.lineTo(k-12*Math.cos(f+Math.PI/7),h-12*Math.sin(f+Math.PI/7)),a.fillStyle=this.fillStyle,a.fill();if(this.arrows==O.Style.BACK||this.arrows==O.Style.FRONT_BACK)a.beginPath(),a.moveTo(0,0),a.lineTo(12*Math.cos(f-Math.PI/7),12*Math.sin(f-Math.PI/7)),a.lineTo(12*Math.cos(f+Math.PI/7),12*Math.sin(f+Math.PI/7)),a.fillStyle=this.fillStyle,a.fill();g&&g.size.width*g.size.width<.25*(k*k+h*h)&&(f=b<d?-f:Math.PI-f,k=Math.cos(f),f=Math.sin(f),a.setTransform(k,-f,f,k,
(b+d)/2,(c+e)/2),a.fillStyle="rgba(255,255,255,0.7)",b=O.Style.A,c=g.size.width+2*O.Style.A,d=12+O.Style.A,e=-c/2,f=-d+-3,a.moveTo(e+b,f),a.lineTo(e+c-b,f),a.quadraticCurveTo(e+c,f,e+c,f+b),a.lineTo(e+c,f+d-b),a.quadraticCurveTo(e+c,f+d,e+c-b,f+d),a.lineTo(e+b,f+d),a.quadraticCurveTo(e,f+d,e,f+d-b),a.lineTo(e,f+b),a.quadraticCurveTo(e,f,e+b,f),a.fill(),a.font="12px Arial",a.textAlign="center",a.textBaseline="bottom",a.fillStyle="blue",a.fillText(g.text,0,-3-O.Style.A/2+1))}containsPoint2d(a,b,c,d,
e){d-=b;e-=c;let g=((a.pageX-b)*d+(a.pageY-c)*e)/(d*d+e*e);0>g?g=0:1<g&&(g=1);d=a.pageX-g*d-b;e=a.pageY-g*e-c;return 225>d*d+e*e}createLabel(a,b){a=V.to1DUnitString(b);O.instance.context.font="12px Arial";return{text:a,size:O.instance.context.measureText(a)}}};
O.Style.Line.Custom=class{constructor(a,b){this.selected=!1;this.exec={};a.init&&(this.exec.init=Function("return "+decodeURI(a.init))());a.render2d&&(this.exec.render2d=Function("return "+decodeURI(a.render2d))());a.intersect2d&&(this.exec.intersect2d=Function("return "+decodeURI(a.intersect2d))());a.update&&(this.exec.update=Function("return "+decodeURI(a.update))());this.scope=Object.assign({},b);this.exec.init&&this.exec.init.call(this.scope)}render2d(a,b,c,d,e,g){this.exec.render2d.call(this.scope,
a,{x0:b,y0:c,x1:d,y1:e,t:V.time,dt:V.dT,label:g,selected:this.selected})&&V.touch2d()}containsPoint2d(a,b,c,d,e){return this.exec.intersect2d?this.exec.intersect2d.call(this.scope,O.instance.context,a.pageX,a.pageY,{x0:b,y0:c,x1:d,y1:e}):!1}update(a){a&&(this.exec.update?this.exec.update.call(this.scope,a):Object.assign(this.scope,a))}};
O.Segment=class extends O.Component{constructor(a,b,c,d){super(d);this.anchor0=a;this.anchor0.addListener(this);this.anchor1=b;this.anchor1.addListener(this);this.text=c;this.update3D()}update3D(){if(this.text){let a=G.sx*(this.anchor0.wx-this.anchor1.wx),b=G.sy*(this.anchor0.wy-this.anchor1.wy),c=G.sz*(this.anchor0.wz-this.anchor1.wz);this.label=this.style.createLabel(this.text,Math.sqrt(a*a+b*b+c*c))}}updateUnits(){if(this.text){let a=G.sx*(this.anchor0.wx-this.anchor1.wx),b=G.sy*(this.anchor0.wy-
this.anchor1.wy),c=G.sz*(this.anchor0.wz-this.anchor1.wz);this.label=this.style.createLabel(this.text,Math.sqrt(a*a+b*b+c*c))}}updateLabel(a){if(this.text=a){a=G.sx*(this.anchor0.wx-this.anchor1.wx);let b=G.sy*(this.anchor0.wy-this.anchor1.wy),c=G.sz*(this.anchor0.wz-this.anchor1.wz);this.label=this.style.createLabel(this.text,Math.sqrt(a*a+b*b+c*c))}else delete this.label}intersectRay3D(a){return this.containsPoint2D(a)?V.camera.distanceTo({x:this.anchor0.wx,y:this.anchor0.wy,z:this.anchor0.wz}):
Number.POSITIVE_INFINITY}containsPoint2D(a){return this.style.containsPoint2d(a,this.anchor0.sx,this.anchor0.sy,this.anchor1.sx,this.anchor1.sy)}render2D(a){this.style.render2d(a,this.anchor0.sx,this.anchor0.sy,this.anchor1.sx,this.anchor1.sy,this.label)}};
O.Style.Arc=class{constructor(a,b,c){this.selected=!1;this.fillStyle=b;this.dash=a;this.labelled=c;this.length2=0}line(a){a.strokeStyle=this.fillStyle;this.dash&&a.setLineDash(this.dash);a.stroke();this.dash&&a.setLineDash([])}render2d(a,b,c,d,e,g,k,h,f){var l=b-d,m=c-e;b=Math.sqrt(l*l+m*m);l/=b;m/=b;c=Math.atan2(m,l);g-=d;var n=k-e,p=Math.sqrt(g*g+n*n);g/=p;n/=p;k=Math.atan2(n,g);1>Math.abs(g*l+n*m)+.05&&(b=Math.min(b,p)/2.7,a.setTransform(1,0,0,1,d,e),a.beginPath(),a.arc(0,0,b,c,k,0<GM.Vector3.dot(V.camera.zAxis,
h)),a.strokeStyle=this.fillStyle,this.dash&&a.setLineDash(this.dash),a.stroke(),this.dash&&a.setLineDash([]),f&&f.size.width*f.size.width<b*b*.7&&(h=l+g,l=m+n,m=Math.sqrt(h*h+l*l),k=Math.PI/2-(c+k)/2,c=-Math.cos(k),k=-Math.sin(k),a.setTransform(c,-k,k,c,d+h/m*b,e+l/m*b),d=O.Style.A,e=f.size.width+2*O.Style.A,c=12+O.Style.A,h=-e/2,b=-c+-3,a.beginPath(),a.fillStyle="rgba(255,255,255,0.7)",a.moveTo(h+d,b),a.lineTo(h+e-d,b),a.quadraticCurveTo(h+e,b,h+e,b+d),a.lineTo(h+e,b+c-d),a.quadraticCurveTo(h+e,
b+c,h+e-d,b+c),a.lineTo(h+d,b+c),a.quadraticCurveTo(h,b+c,h,b+c-d),a.lineTo(h,b+d),a.quadraticCurveTo(h,b,h+d,b),a.fill(),a.font="12px Arial",a.textAlign="center",a.textBaseline="bottom",a.fillStyle="blue",a.fillText(f.text,0,-3-O.Style.A/2+1)))}createLabel(a,b){a=b.toFixed(0)+String.fromCharCode(176);O.instance.context.font="12px Arial";return{text:a,size:O.instance.context.measureText(a)}}};
O.Arc=class extends O.Component{constructor(a,b,c,d,e){super(e);this.anchor1=b;this.anchor1.addListener(this);this.anchor0=a;this.anchor0.addListener(this);this.anchor2=c;this.anchor2.addListener(this);this.text=d;this.angle=0;this.update3D()}update3D(){var a=this.anchor0.wx-this.anchor1.wx,b=this.anchor0.wy-this.anchor1.wy,c=this.anchor0.wz-this.anchor1.wz,d=Math.sqrt(a*a+b*b+c*c);a/=d;b/=d;c/=d;d=this.anchor2.wx-this.anchor1.wx;var e=this.anchor2.wy-this.anchor1.wy,g=this.anchor2.wz-this.anchor1.wz,
k=Math.sqrt(d*d+e*e+g*g);d/=k;e/=k;g/=k;this.angle=180*Math.acos(a*d+b*e+c*g)/Math.PI;this.normal3D.x=b*g-c*e;this.normal3D.y=c*d-a*g;this.normal3D.z=a*e-b*d;this.text&&(this.label=this.style.createLabel(this.text,this.angle))}updateLabel(a){(this.text=a)?this.label=this.style.createLabel(this.text,this.angle):delete this.label}render2D(a){this.style.render2d(a,this.anchor0.sx,this.anchor0.sy,this.anchor1.sx,this.anchor1.sy,this.anchor2.sx,this.anchor2.sy,this.normal3D,this.label)}};
</script>
<script id="/overlay/geometry.js">G={EPSISLON:.999,sx:1,sy:1,sz:1,getPlane:function(b,a,c){var d=b.wx-a.wx,e=b.wy-a.wy,f=b.wz-a.wz;b=c.wx-a.wx;let g=c.wy-a.wy,h=c.wz-a.wz;c=g*f-h*e;f=h*d-b*f;d=b*e-g*d;e=Math.sqrt(c*c+f*f+d*d);c/=e;f/=e;d/=e;w=a.wx*c+a.wy*f+a.wz*d;return{x:c,y:f,z:d,w}},edgeIntersect:function(b,a,c,d){let e=b.du*(c.v-b.v)-b.dv*(c.u-b.u);d=b.du*(d.v-b.v)-b.dv*(d.u-b.u);if(0<e*d)return!1;e=c.du*(b.v-c.v)-c.dv*(b.u-c.u);d=c.du*(a.v-c.v)-c.dv*(a.u-c.u);return 0<e*d?!1:!0},containsPoint:function(b,a,c,d){let e=.5*(-a.v*
c.u+b.v*(-a.u+c.u)+b.u*(a.v-c.v)+a.u*c.v),f=0>e?-1:1;c=(b.v*c.u-b.u*c.v+(c.v-b.v)*d.u+(b.u-c.u)*d.v)*f;b=(b.u*a.v-b.v*a.u+(b.v-a.v)*d.u+(a.u-b.u)*d.v)*f;return 0<c&&0<b&&c+b<2*e*f},Polygon:function(b){this.plane=b;this.sv=this.su=1;this.vEnd=this.vPos=0}};G.Polygon.prototype.translate=function(b,a,c){this.plane.w+=this.plane.x*b+this.plane.y*a+this.plane.z*c};
G.Polygon.prototype.update=function(b){for(var a={x:0,y:0,z:0},c=0;c<b.length;c++)a.x+=b[c].wx,a.y+=b[c].wy,a.z+=b[c].wz;a.x/=b.length;a.y/=b.length;a.z/=b.length;this.radius=Number.NEGATIVE_INFINITY;var d={x:b[0].wx-a.x,y:b[0].wy-a.y,z:b[0].wz-a.z};for(c=1;c<b.length;c++){var e=b[c].wx-a.x,f=b[c].wy-a.y,g=b[c].wz-a.z,h=e*e+f*f+g*g;this.radius<h&&(d.x=e,d.y=f,d.z=g,this.radius=h)}this.radius=Math.sqrt(this.radius);e=Math.sqrt(d.x*d.x+d.y*d.y+d.z*d.z);d.x/=e;d.y/=e;d.z/=e;e={x:this.plane.y*d.z-this.plane.z*
d.y,y:this.plane.z*d.x-this.plane.x*d.z,z:this.plane.x*d.y-this.plane.y*d.x};f=[];this.umin=Number.POSITIVE_INFINITY;this.umax=Number.NEGATIVE_INFINITY;this.vmin=Number.POSITIVE_INFINITY;this.vmax=Number.NEGATIVE_INFINITY;for(c=0;c<b.length;c++){h=b[c].wx-a.x;var k=b[c].wy-a.y,l=b[c].wz-a.z;g=h*e.x+k*e.y+l*e.z;h=h*d.x+k*d.y+l*d.z;f.push({u:g,v:h,id:b[c].id,next:(c+1)%b.length});this.umin=Math.min(this.umin,g);this.umax=Math.max(this.umax,g);this.vmin=Math.min(this.vmin,h);this.vmax=Math.max(this.vmax,
h)}this.du=this.umax-this.umin;this.dv=this.vmax-this.vmin;b=[];g=c=0;do{h=f[g];k=f[h.next];l=f[k.next];if((k.u-h.u)*(l.v-h.v)<(k.v-h.v)*(l.u-h.u)){let m=l.next;for(;m!==g;){let n=f[m];if(G.containsPoint(h,k,l,n))break;m=n.next}m==g&&(b.push(g,h.next,k.next),f[g].next=k.next)}g=f[g].next;if(c++>3*f.length){console.log("DDDDDDDDDDDDDDDDDDD");break}}while(f[f[g].next].next!=g);this.points=f;this.u=e;this.v=d;this.center=a;this.triangles=b;a=this.u.x*G.sx;d=this.u.y*G.sy;e=this.u.z*G.sz;this.su=Math.sqrt(a*
a+d*d+e*e);a=this.v.x*G.sx;d=this.v.y*G.sy;e=this.v.z*G.sz;this.sv=Math.sqrt(a*a+d*d+e*e)};G.Polygon.prototype.getMesh=function(b){let a=b?this.plane.x*b:0,c=b?this.plane.y*b:0;b=b?this.plane.z*b:0;let d=new Float32Array(3*this.triangles.length);for(var e=0;e<this.triangles.length;e++){let f=this.points[this.triangles[e]];d[3*e]=this.center.x+f.u*this.u.x+f.v*this.v.x+a;d[3*e+1]=this.center.y+f.u*this.u.y+f.v*this.v.y+c;d[3*e+2]=this.center.z+f.u*this.u.z+f.v*this.v.z+b}return d};
G.Polygon.prototype.containsPoint=function(b){var a=b.x-this.center.x,c=b.y-this.center.y;b=b.z-this.center.z;a={u:a*this.u.x+c*this.u.y+b*this.u.z,v:a*this.v.x+c*this.v.y+b*this.v.z};for(c=0;c<this.triangles.length/3;c++)if(G.containsPoint(this.points[this.triangles[3*c]],this.points[this.triangles[3*c+1]],this.points[this.triangles[3*c+2]],a))return!0;return!1};
G.Polygon.prototype.canRemovePoint=function(b,a){var c=0;for(a=0;a<this.points.length;a++){var d=this.points[a];d.next=(a+1)%this.points.length;var e=this.points[d.next];d.id==b&&(c=a);d.du=e.u-d.u;d.dv=e.v-d.v}b=this.points[(c-1+this.points.length)%this.points.length];d=this.points[(c+1)%this.points.length];b.next=(b.next+1)%this.points.length;b.du=d.u-b.u;b.dv=d.v-b.v;e=(c-3+this.points.length)%this.points.length;for(a=0;a<this.points.length-4;a++){var f=this.points[e];if(G.edgeIntersect(b,d,f,
this.points[f.next]))return!1;e=(e-1+this.points.length)%this.points.length}e=(c+2)%this.points.length;for(a=0;a<this.points.length-4;a++){f=this.points[e];if(G.edgeIntersect(b,d,f,this.points[f.next]))return!1;e=(e+1)%this.points.length}b=0;c=(c+1)%this.points.length;for(a=0;a<this.points.length-1;a++)d=this.points[c],c=d.next,e=this.points[c],b+=(d.u+e.u)*(d.v-e.v);return 0<b};
G.Polygon.prototype.canMovePoint=function(b,a){var c=a.x-this.center.x,d=a.y-this.center.y,e=a.z-this.center.z;a=c*this.u.x+d*this.u.y+e*this.u.z;var f=c*this.v.x+d*this.v.y+e*this.v.z;for(d=e=c=0;d<this.points.length;d++){let g=this.points[d];g.next=(d+1)%this.points.length;let h=this.points[g.next];g.id==b&&(g.u=a,g.v=f,c=d);h.id==b&&(h.u=a,h.v=f,e=d);g.du=h.u-g.u;g.dv=h.v-g.v}a=this.points[e];b=this.points[c];e=(e-2+this.points.length)%this.points.length;for(d=0;d<this.points.length-3;d++){f=this.points[e];
if(G.edgeIntersect(a,b,f,this.points[f.next]))return!1;e=(e-1+this.points.length)%this.points.length}a=this.points[(c+1)%this.points.length];c=(c+2)%this.points.length;for(d=0;d<this.points.length-3;d++){e=this.points[c];if(G.edgeIntersect(b,a,e,this.points[e.next]))return!1;c=(c+1)%this.points.length}return 0<this.getArea()};
G.Polygon.prototype.getArea=function(){let b=0,a=this.points.length-1;for(var c=0;c<this.points.length;c++)b+=(this.points[a].u+this.points[c].u)*(this.points[a].v-this.points[c].v),a=c;return b/2};
G.Polygon.prototype.startScan=function(b,a){let c=this.points,d=[];for(var e=0;e<c.length;e++){let f=c[e],g=c[(e+1)%c.length];Math.abs(g.v-f.v)>b&&d.push({id0:f.id,id1:g.id,vmin:Math.min(f.v,g.v),vmax:Math.max(f.v,g.v),umin:Math.min(f.u,g.u),umax:Math.max(f.u,g.u),u0:f.u,v0:f.v,m:(g.u-f.u)/(g.v-f.v)})}d.sort(function(f,g){return f.vmin-g.vmin});this.edges=d;this.vEdge=0;this.vEnd=this.vmax-.5*b;this.vPos=this.vmin+.5*b;this.active=[];this.integral=0;this.resolution=b;this.ray=new GM.Ray;this.ray.direction.x=
a.x;this.ray.direction.y=a.y;this.ray.direction.z=a.z;return this.context={du:Math.ceil(this.du/b),dv:Math.ceil(this.dv/b),resolution:b}};
G.Polygon.prototype.scanLine=function(b){for(var a=0;a<this.active.length;a++)this.edges[this.active[a]].vmax<this.vPos&&(this.active.splice(a,1),a--);for(a=this.vEdge;a<this.edges.length;a++)this.edges[a].vmin<this.vPos&&(this.active.push(a),this.vEdge++);for(a=0;a<this.active.length;a++){var c=this.edges[this.active[a]];c.u=c.u0+c.m*(this.vPos-c.v0)}this.active=this.active.sort(function(g,h){return this.edges[g].u-this.edges[h].u}.bind(this));b.startLine&&b.startLine(this.context);c=this.center.x+
this.vPos*this.v.x;let d=this.center.y+this.vPos*this.v.y,e=this.center.z+this.vPos*this.v.z;for(a=0;a<Math.floor(this.active.length/2);a++){let g=this.edges[this.active[2*a+1]];for(var f=this.edges[this.active[2*a]].u;f<g.u;f+=this.resolution)this.ray.origin.x=c+f*this.u.x,this.ray.origin.y=d+f*this.u.y,this.ray.origin.z=e+f*this.u.z,b.sample(this.ray,this.resolution,f-this.umin,this.vPos-this.vmin)}b.endLine&&b.endLine(this.context);this.vPos+=this.resolution};
G.Polygon.prototype.endScan=function(){return this.vPos>=this.vEnd?!0:!1};
</script>
<script id="/overlay/elevation.js">O.Elevation=function(a,b){O.Object.call(this,a.id,a.content.radius);this.callback=b;this.type="elevation";this.constraint=C.create(a.content.constraint);this.anchor0=this.addAnchor(new O.Anchor(a.content.p0||a.content.points[0]));this.anchor1=this.addAnchor(new O.Anchor(a.content.p1||a.content.points[1]));this.anchorC=this.addAnchor(new O.Anchor({x:this.anchor1.wx,y:this.anchor0.wy,z:this.anchor1.wz}));this.projectAnchors();this.line=this.addComponent(new O.Segment(this.anchor0,this.anchor1,new O.Style.Line([3,
3],"red",O.Style.NONE,!0)));this.vert=this.addComponent(new O.Segment(this.anchorC,this.anchor1,new O.Style.Line(null,"red",O.Style.FRONT,!0)));this.horz=this.addComponent(new O.Segment(this.anchorC,this.anchor0,new O.Style.Line(null,"red",O.Style.FRONT,!0)));this.arc=this.addComponent(new O.Arc(this.anchor1,this.anchor0,this.anchorC,new O.Style.Line(null,"blue",O.Style.NONE,!0)))};O.Elevation.prototype=Object.create(O.Object.prototype);O.Elevation.prototype.constructor=O.Elevation;
O.Elevation.NAME="elevation";O.Elevation.prototype.select=function(a){O.Object.prototype.select.call(this);this.addControl(new O.ControlPoint(this.anchor0,this.constraint));this.addControl(new O.ControlPoint(this.anchor1,this.constraint))};O.Elevation.prototype.moveControl=function(a){this.anchorC.set3D({x:this.anchor1.wx,y:this.anchor0.wy,z:this.anchor1.wz})};
O.Elevation.prototype.endControl=function(){O.Object.prototype.endControl.call(this);this.callback.update&&this.callback.update(this,{p0:this.anchor0.toJson(),p1:this.anchor1.toJson()})};
O.Elevation.Builder=class{constructor(a,b){this.config=a||{};this.custom=b;this.constraint=V.viewer.getConstraint()}addPoint(a,b){return O.instance.createControlPoint(a,this.constraint)}removePoint(a){2==points.length&&points[this.points.length-1].detach()}isDone(a){return 2==a.length}complete(a){this.config.type="elevation";this.config.points=a;this.config.constraint=this.constraint.toJson();V.postMessage("elevation.record",this.config,this.custom)}};
V.recvMessage("elevation.record",(a,b)=>{O.Builder.get().start(new O.Elevation.Builder(a,b))});V.recvMessage("elevation.update",function(a,b){var c=O.instance.getObject(a.id);c&&(c.update(a),V.postMessage("elevation.update",a,b),V.touch2d(),V.touch3d())});V.recvMessage("elevation.select",function(a,b){if(a=O.instance.getObject(a.id))a.select(),V.postMessage("elevation.select",a.toJson(),b),V.touch2d()});
V.recvMessage("elevation.unselect",function(a,b){O.instance.getObject(a.id)&&(line.unselect(),V.postMessage("elevation.unselect",a,b),V.touch2d())});
</script>
<script id="/overlay/line.js">O.Line=class extends O.Object{constructor(a){super(a.id,a.activation);this.type="line";this.visible=a.visible;this.constraint=C.create(a.constraint);this.mode=a.mode;this.lineStyle=a.code?new O.Style.Line.Custom(a.code,a.scope):new O.Style.Line(null,"red",O.Style.FRONT);this.arcStyle=new O.Style.Arc([3,3],"blue",this.mode[O.ANGLE]);for(var b=0;b<a.points.length;b++)this.addAnchor(new O.Anchor(a.points[b]));this.projectAnchors();this.addComponent(new O.Segment(this.anchors[0],this.anchors[1],this.mode[O.DISTANCE],
this.lineStyle));for(b=0;b<a.points.length-2;b++)this.addComponent(new O.Arc(this.anchors[b],this.anchors[b+1],this.anchors[b+2],this.mode[O.ANGLE],this.arcStyle)).visible=this.mode[O.ANGLE],this.addComponent(new O.Segment(this.anchors[b+1],this.anchors[b+2],this.mode[O.DISTANCE],this.lineStyle))}length(){let a=0;for(var b=0;b<this.anchors.length-1;b++){let c=this.anchors[b+1].wx-this.anchors[b].wx,e=this.anchors[b+1].wy-this.anchors[b].wy,f=this.anchors[b+1].wz-this.anchors[b].wz;a+=Math.sqrt(c*
c+e*e+f*f)}return a}select(){super.select();for(var a=0;a<this.anchors.length;a++)this.addControl(new O.ControlPoint(this.anchors[a],this.constraint))}update(a){super.update(a);a.hasOwnProperty("mode")&&(this.mode=a.mode,this.components.forEach(b=>{b instanceof O.Segment?b.updateLabel(this.mode[O.DISTANCE]):b instanceof O.Arc&&(b.visible=this.mode[O.ANGLE],b.updateLabel(this.mode[O.ANGLE]))}));a.scope&&this.lineStyle.update(a.scope)}onDblClick(a){if(a.component instanceof O.ControlPoint)for(var b=
1;b<this.controls.length-1;b++){if(this.controls[b]===a.component){this.components.splice(2*(b-1),2);var c=this.anchors[b-1];this.removeControl(this.controls[b]);this.removeAnchor(this.anchors[b]);var e=2*(b-1),f=this.components[e];f.anchor0=c;f.anchor0.addListener(f);f.update3D();b<this.controls.length-1&&(e=this.components[e+1],e.anchor0=c,e.anchor0.addListener(e),e.update3D());1<b&&(b=this.components[2*(b-1)-1],b.anchor2=f.anchor1,b.anchor2.addListener(b),b.update3D());break}}else if(a.component instanceof
O.Segment)for(b=0;b<this.components.length;b++)if(this.components[b]==a.component){c=this.constraint.getPoint(a);if(null!=c){f=a.component.anchor0;c=this.insertAnchor(b/2+1,new O.Anchor(c));e=a.component.anchor1;if(b<2*(this.controls.length-2)){var d=this.components[b+1];d.anchor0.removeListener(d);d.anchor0=c;d.anchor0.addListener(d);d.update3D()}1<b&&(d=this.components[(b-1+2*this.controls.length)%(2*this.controls.length)],d.anchor2.removeListener(d),d.anchor2=c,d.anchor2.addListener(d),d.update3D());
d=this.components[b];d.anchor0.removeListener(d);d.anchor0=c;d.anchor0.addListener(d);d.update3D();d=b;this.insertComponent(d,new O.Arc(f,c,e,this.mode[O.ANGLE],this.arcStyle)).visible=this.mode[O.ANGLE];this.insertComponent(d,new O.Segment(f,c,this.mode[O.DISTANCE],this.lineStyle));this.insertControl(b/2+1,new O.ControlPoint(c,this.constraint))}break}a.stopImmediatePropagation();this.endControl()}endControl(){super.endControl();V.postMessage("line.update",this.toJson())}toJson(a){let b={};if(void 0==
a||a.includes("type"))b.type=this.type;if(void 0==a||a.includes("points")){for(var c=[],e=0;e<this.anchors.length;e++)c.push(this.anchors[e].toJson());b.points=c}if(void 0==a||a.includes("constraint"))b.constraint=this.constraint.toJson();if(void 0==a||a.includes("mode"))b.mode=this.mode;return Object.assign(super.toJson(a),b)}};
O.Line.validate=a=>{if(!a.points||2>a.points.length)return V.postMessage("error","No enough points to complete line"),!1;if(O.find(a.id))return V.postMessage("error",`Duplicate line ID : ${a.id}`),!1;a.hasOwnProperty("visible")||(a.visible=!0);a.hasOwnProperty("constraint")||(a.constraint=V.viewer.getConstraint());a.hasOwnProperty("mode")||(a.mode={});return!0};
O.Line.Builder=class{constructor(a,b){this.config=a||{};this.custom=b;this.constraint=V.viewer.getConstraint()}addPoint(a,b){return O.instance.createControlPoint(a,this.constraint)}removePoint(a){2==points.length&&points[this.points.length-1].detach()}isDone(a){return 2==a.length}complete(a){this.config.type="line";this.config.points=a;this.config.constraint=this.constraint.toJson();V.postMessage("line.record",this.config,this.custom)}};
V.recvMessage("line.record",(a,b)=>{O.Builder.get().start(new O.Line.Builder(a,b))});V.recvMessage("line.update",(a,b)=>{var c=O.instance.getObject(a.id);c&&(c.update(a),V.postMessage("line.update",c.toJson(),b),V.touch2d(),V.touch3d())});V.recvMessage("line.select",(a,b)=>{if(a=O.instance.getObject(a.id))a.select(),V.postMessage("line.select",a.toJson(),b),V.touch2d()});
V.recvMessage("line.unselect",(a,b)=>{if(a=O.instance.getObject(a.id))a.unselect(),V.postMessage("line.unselect",a.toJson(),b),V.touch2d()});V.recvMessage("line.get",(a,b)=>{if(a&&a.id){var c=O.instance.getObject(a.id);c&&V.postMessage("line.get",c.toJson(a.filter),b)}else V.postMessage("line.get",O.getAll("line"),b)});
</script>
<script id="/overlay/polygon.js">O.ControlUV=class extends O.Object{constructor(a){super(a.id+"uv");this.container=a;this.geometry=a.geometry;this.anchor=this.addAnchor(new O.Anchor);this.anchor0=this.addAnchor(new O.Anchor);this.anchor1=this.addAnchor(new O.Anchor);this.anchor2=this.addAnchor(new O.Anchor);this.anchor3=this.addAnchor(new O.Anchor);this.style=new O.Style.Line([3,3],C.Plane.PASSIVE,O.Style.NONE);this.line=this.addComponent(new O.Segment(this.anchor0,this.anchor1,null,this.style));this.line=this.addComponent(new O.Segment(this.anchor2,
this.anchor3,null,this.style))}attach(){super.attach();this.update();this.controlPoint=this.addControl(new O.ControlPoint(this.anchor,new C.Plane(this.geometry.plane)))}startControl(a){this.style.fillStyle=C.Plane.ACTIVE;this.style.lineWidth=3;this.container.startControl()}endControl(a){this.style.fillStyle=C.Plane.PASSIVE;this.style.lineWidth=1;this.container.endControl()}moveControl(a){a=this.anchor.wx-this.center.x;let b=this.anchor.wy-this.center.y,c=this.anchor.wz-this.center.z;this.container.translate(a,
b,c);this.anchor0.translate3D(a,b,c);this.anchor1.translate3D(a,b,c);this.anchor2.translate3D(a,b,c);this.anchor3.translate3D(a,b,c);this.center.x=this.anchor.wx;this.center.y=this.anchor.wy;this.center.z=this.anchor.wz;this.container.moveControl()}update(){this.center=this.geometry.center;this.anchor.set3D(this.center);let a=.25*this.geometry.radius,b=this.geometry.u,c=this.geometry.v;this.anchor0.set3D({x:this.center.x+a*b.x,y:this.center.y+a*b.y,z:this.center.z+a*b.z});this.anchor1.set3D({x:this.center.x-
a*b.x,y:this.center.y-a*b.y,z:this.center.z-a*b.z});this.anchor2.set3D({x:this.center.x+a*c.x,y:this.center.y+a*c.y,z:this.center.z+a*c.z});this.anchor3.set3D({x:this.center.x-a*c.x,y:this.center.y-a*c.y,z:this.center.z-a*c.z})}};
O.Polygon=class extends O.Composite{constructor(a){super(a.id,a.activation);this.type="polygon";this.mode=a.mode;this.visible=a.visible;this.lineStyle=new O.Style.Line(null,"red",O.Segment.NONE);this.arcStyle=new O.Style.Arc([3,3],"blue",null!=this.mode[O.ANGLE]);for(var b=0;b<a.points.length;b++)this.addAnchor(new O.Anchor(a.points[b]));this.projectAnchors();for(b=0;b<a.points.length;b++)this.addComponent(new O.Segment(this.anchors[b],this.anchors[(b+1)%this.anchors.length],this.mode[O.DISTANCE],
this.lineStyle)),this.addComponent(new O.Arc(this.anchors[b],this.anchors[(b+1)%this.anchors.length],this.anchors[(b+2)%this.anchors.length],this.mode[O.ANGLE],this.arcStyle)).visible=this.mode[O.ANGLE];"Polygon"==a.constraint[0]?(this.geometry=new G.Polygon(a.constraint[1]),this.constraint=new C.Polygon(this.geometry)):(this.geometry=new G.Polygon(G.getPlane(this.anchors[0],this.anchors[1],this.anchors[2])),this.constraint=new C.create(a.constraint));this.geometry.update(this.anchors);this.processScanFn=
this.processScan.bind(this)}update(a){super.update(a);this.selected&&this.constraint instanceof C.Polygon&&this.removeControls();a.hasOwnProperty("mode")&&(this.mode=a.mode,this.components.forEach(b=>{b instanceof O.Segment?b.updateLabel(this.mode[O.DISTANCE]):b instanceof O.Arc&&(b.visible=this.mode[O.ANGLE],b.updateLabel(this.mode[O.ANGLE]))}));this.selected&&this.constraint instanceof C.Polygon&&this.addControls()}onDblClick(a){this.startControl();if(a.component instanceof O.ControlPoint){if(3<
this.controls.length)for(var b=0;b<this.controls.length;b++)if(this.controls[b]===a.component){if(this.geometry.canRemovePoint(a.component.anchor.id)){this.components.splice(2*b,2);this.removeControl(this.controls[b]);this.removeAnchor(this.anchors[b]);var c=(b-1+this.controls.length)%this.controls.length*2,e=this.components[c],f=this.components[c+1];c=(b-2+this.controls.length)%this.controls.length*2;c=this.components[c+1];b=this.components[b%this.controls.length*2];f.anchor1=f.anchor2;f.anchor2=
b.anchor1;f.anchor2.addListener(f);f.update3D();c.anchor2=f.anchor1;c.anchor2.addListener(c);c.update3D();e.anchor1=b.anchor0;e.anchor1.addListener(e);e.update3D()}else O.cursor("not-allowed"),setTimeout(function(){O.cursor("default")},1E3);break}}else if(a.component instanceof O.Segment){if(3==this.controls.length&&!(this.constraint instanceof C.Polygon)){this.geometry.plane=G.getPlane(this.anchors[0],this.anchors[1],this.anchors[2]);this.constraint=new C.Polygon(this.geometry);for(b=0;b<this.controls.length;b++)this.controls[b].constraint=
this.constraint;this.addControls()}for(b=0;b<this.components.length;b++)if(this.components[b]==a.component){e=a.component.anchor0;f=this.insertAnchor(b/2+1,new O.Anchor(this.constraint.getPoint(a)));c=a.component.anchor1;var d=this.components[b+1];d.anchor0.removeListener(d);d.anchor0=f;d.anchor0.addListener(d);d.update3D();d=this.components[(b-1+2*this.controls.length)%(2*this.controls.length)];d.anchor2.removeListener(d);d.anchor2=f;d.anchor2.addListener(d);d.update3D();d=this.components[b];d.anchor0.removeListener(this.components[b]);
d.anchor0=f;d.anchor0.addListener(this.components[b]);d.update3D();d=b;this.insertComponent(d,new O.Arc(e,f,c,this.mode[O.ANGLE],this.arcStyle)).visible=this.mode[O.ANGLE];this.insertComponent(d,new O.Segment(e,f,this.mode[O.DISTANCE],this.lineStyle));this.insertControl(b/2+1,new O.ControlPoint(f,this.constraint));break}}a.stopImmediatePropagation();this.endControl()}toJson(a){let b={};if(void 0==a||a.includes("type"))b.type=this.type;if(void 0==a||a.includes("points")){let e=[];for(var c=0;c<this.anchors.length;c++)e.push(this.anchors[c].toJson());
b.points=e}if(void 0==a||a.includes("constraint"))b.constraint=this.constraint.toJson();if(void 0==a||a.includes("mode"))b.mode=this.mode;return Object.assign(super.toJson(a),b)}translate(a,b,c){for(var e=0;e<this.anchors.length;e++)this.anchors[e].translate3D(a,b,c);this.geometry.translate(a,b,c)}moveControl(){3==this.anchors.length&&(this.geometry.plane=G.getPlane(this.anchors[0],this.anchors[1],this.anchors[2]));this.geometry.update(this.anchors);V.touch3d()}endControl(a){super.endControl();3==
this.anchors.length&&(this.geometry.plane=G.getPlane(this.anchors[0],this.anchors[1],this.anchors[2]));this.geometry.update(this.anchors);V.touch3d();V.postMessage("polygon.update",this.toJson(),{uv:this.geometry.points})}select(){super.select();for(var a=0;a<this.anchors.length;a++)this.addControl(new O.ControlPoint(this.anchors[a],this.constraint));this.constraint instanceof C.Polygon&&this.addControls()}unselect(){super.unselect();this.constraint instanceof C.Polygon&&this.removeControls()}processScan(){V.camera.moving||
this.geometry.scanLine(this);this.geometry.endScan()?(V.postMessage("polygon.scan.end",this.toJson()),this.timer=null):this.timer=setTimeout(this.processScanFn,0)}startScan(a,b){this.timer&&this.stopScan();this.timer=setTimeout(this.processScanFn,0);return this.geometry.startScan(a,b)}stopScan(){this.timer&&(clearTimeout(this.timer),this.timer=null)}render2D(a){super.render2D(a)}};
O.Polygon.validate=a=>{if(!a.points||3>a.points.length)return V.postMessage("error","No enough points to complete line"),!1;if(O.find(a.id))return V.postMessage("error",`Duplicate line ID : ${a.id}`),!1;a.hasOwnProperty("visible")||(a.visible=!0);a.hasOwnProperty("constraint")||(a.constraint=V.viewer.getConstraint());a.hasOwnProperty("mode")||(a.mode={});return!0};
O.Polygon.Builder=class{constructor(a,b){this.config=a||{};this.custom=b;this.constraint=V.viewer.getConstraint()}addPoint(a,b){return O.instance.createControlPoint(a,this.constraint)}removePoint(a){3<points.length&&points[this.points.length-1].detach()}isDone(a){return 3==a.length}complete(a){this.config.type="polygon";this.config.points=a;this.config.constraint=this.constraint.toJson();V.postMessage("polygon.record",this.config,this.custom)}};
V.recvMessage("polygon.record",(a,b)=>{O.Builder.get().start(new O.Polygon.Builder(a,b))});V.recvMessage("polygon.select",function(a,b){if(a=O.instance.getObject(a.id))a.select(),V.postMessage("polygon.select",a.toJson(),b),V.touch2d()});V.recvMessage("polygon.unselect",function(a,b){if(a=O.instance.getObject(a.id))a.unselect(),V.postMessage("polygon.unselect",a.toJson(),b),V.touch2d()});
V.recvMessage("polygon.update",(a,b)=>{let c=O.instance.getObject(a.id);c&&(c.update(a),b.uv=c.geometry.points,V.postMessage("polygon.update",c.toJson(),b),V.touch2d(),V.touch3d())});V.recvMessage("polygon.get",(a,b)=>{if(a&&a.id){let c=O.instance.getObject(a.id);c&&V.postMessage("polygon.get",c.toJson(a.filter),b)}else V.postMessage("polygon.get",O.getAll("polygon"),b)});
</script>
<script id="/overlay/point.js">O.Point=class extends O.Object{constructor(a){super(a.id,a.activation,a.exclude);this.type="point";this.visible=a.visible;this.constraint=C.create(a.constraint);this.anchor=this.addAnchor(new O.Anchor(a.point));this.projectAnchors();this.exec={};a.code.init&&(this.exec.init=Function("return "+decodeURI(a.code.init))());a.code.render2d&&(this.exec.render2d=Function("return "+decodeURI(a.code.render2d))());a.code.update&&(this.exec.update=Function("return "+decodeURI(a.code.update))());a.code.intersect&&
(this.exec.intersect=Function("return "+decodeURI(a.code.intersect))());this.scope=Object.assign({},a.scope);this.exec.init&&this.exec.init.call(this.scope);this.source={code:a.code,scope:a.scope};this.meta=a.meta}CLICK(a){a.point={x:this.anchor.wx,y:this.anchor.wy,z:this.anchor.wz};a.meta=this.meta;return a}DBLCLICK(a){a.point={x:this.anchor.wx,y:this.anchor.wy,z:this.anchor.wz};a.meta=this.meta;return a}update(a){super.update(a);a.point&&(this.anchor.set3D(a.point),this.projectAnchors());a.scope&&
(this.source.scope=Object.assign(this.source.scope,a.scope),this.exec.update?this.exec.update.call(this.scope,this.source.scope):Object.assign(this.scope,a.scope));a.meta&&(this.meta=Object.assign({},a.meta));V.touch2d();V.touch3d()}containsPoint2D(a){return this.exec.intersect?this.exec.intersect.call(this.scope,O.instance.context,a.pageX,a.pageY,{scale:this.scale,x:this.anchor.sx,y:this.anchor.sy}):!1}intersectRay3D(a){return this.containsPoint2D(a)?V.camera.distanceTo({x:this.anchor.wx,y:this.anchor.wy,
z:this.anchor.wz}):Number.POSITIVE_INFINITY}render2D(a){this.exec.render2d&&(a.setTransform(this.scale,0,0,this.scale,this.anchor.sx,this.anchor.sy),this.exec.render2d.call(this.scope,a,{scale:this.scale,x:this.anchor.sx,y:this.anchor.sy,t:V.time,dt:V.dT,selected:this.selected})&&V.touch2d())}select(){super.select();this.addControl(new O.ControlPoint(this.anchor,this.constraint))}endControl(){super.endControl();V.postMessage("point.update",this.toJson())}toJson(a){let b={};if(void 0==a||a.includes("type"))b.type=
this.type;if(void 0==a||a.includes("point"))b.point=this.anchor.toJson();if(void 0==a||a.includes("code"))b.code=this.source.code;if(void 0==a||a.includes("scope"))b.scope=this.source.scope;return Object.assign(super.toJson(a),b)}};
O.Point.validate=a=>{if(!a.point)return V.postMessage("error","No coordinates supplied"),!1;if(O.find(a.id))return V.postMessage("error",`Duplicate point ID : ${a.id}`),!1;if(!a.hasOwnProperty("code"))return V.postMessage("error","Point requires a code object"),!1;a.hasOwnProperty("visible")||(a.visible=!0);a.hasOwnProperty("constraint")||(a.constraint=V.viewer.getConstraint());return!0};
O.Point.Builder=class{constructor(a,b){this.config=a||{};this.custom=b;this.constraint=V.viewer.getConstraint()}addPoint(a,b){return O.instance.createControlPoint(a,this.constraint)}removePoint(a){}isDone(a){return 1==a.length}complete(a){this.config.type="point";this.config.point=a[0];this.config.constraint=this.constraint.toJson();V.postMessage("point.record",this.config,this.custom)}};V.recvMessage("point.record",(a,b)=>{O.Builder.get().start(new O.Point.Builder(a,b))});
V.recvMessage("point.create",(a,b)=>{if(O.Point.validate(a)){a=new O.Point(a);if(b.transform){let c=V.viewer.datasets[b.transform];c&&c.addAnchors(a)}O.instance.addObject(a);V.postMessage("point.create",a.toJson(),b);V.touch3d();V.touch2d()}});V.recvMessage("point.delete",function(a,b){if(b.transform&&(b=V.viewer.datasets[b.transform])){let c=O.instance.getObject(a.id);b.removeAnchors(c)}O.instance.removeObject(a.id);V.postMessage("point.delete",a);V.touch2d()});
V.recvMessage("point.update",function(a,b){var c=O.instance.getObject(a.id);c&&(c.update(a),V.postMessage("point.update",a,b),V.touch2d(),V.touch3d())});V.recvMessage("point.select",function(a,b){if(a=O.instance.getObject(a.id))a.select(),V.postMessage("point.select",a.toJson(),b),V.touch2d()});V.recvMessage("point.unselect",function(a,b){var c=O.instance.getObject(a.id);c&&(c.unselect(),V.postMessage("point.unselect",a,b),V.touch2d())});
V.recvMessage("point.get",(a,b)=>{if(a&&a.id){var c=O.instance.getObject(a.id);c&&V.postMessage("point.get",c.toJson(a.filter),b)}else V.postMessage("point.get",O.getAll("point"),b)});
</script>
<script id="/3d/index.js">var V3={EXPLORER:"explorer",INSPECTOR:"inspector",TOUCH:"touch",EDITOR:0,VIEWER:1,CLOUD:"cloud",MESH:"model"};
V3.Viewer=class extends V.Viewer{constructor(c){super({alpha:!1,depth:!0,stencil:!1,antialias:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1});V3.PERSPECTIVE=new GM.PerspectiveProjection(90);V3.ORTHOGRAPHIC=new GM.OrthographicProjection;V.camera=new V3.Camera(this.canvas,V3.PERSPECTIVE,1);V.camera.moving=!0;this.controller=new V3.Controller;this.controller.attach();this.axis=new GL.Axis(1,1,1);this.axis.visible=!1;V.recvMessage("import.create",(a,b)=>{let d=b.id;if(this.datasets[d])V.postMessage("error",
"duplicate document id "+d);else{let e=null;a.type==V3.CLOUD?e=new M.Cloud(a,V.importCb.bind(b)):a.type==V3.MESH?e=new M.Model(a,V.importCb.bind(b)):V.postMessage("error","mismatching viewer and document types");e&&(this.range=GL.BoundingBox.diagonal(e),b.transform&&(e=new V3.Transform(d,b,e)),this.load(d,e));V.touch3d()}});V.recvMessage("*.get",(a,b)=>{for(var d in this.datasets)this.datasets[d]instanceof V3.Transform&&(a[d]=this.datasets[d].toJson());V.postMessage("*.get",a,b)});V.recvMessage("axes",
(a,b)=>{a.hasOwnProperty("origin")&&this.axis.moveTo(a.origin.x,a.origin.y,a.origin.z);a.hasOwnProperty("visible")&&(this.axis.visible=a.visible);V.postMessage("axes",a,b);V.touch3d()});V.recvMessage("viewpoint.get",a=>{for(var b in this.datasets)a[b]=this.datasets[b].getViewpoint();V.postMessage("viewpoint.get",a)});V.recvMessage("import.select",(a,b)=>{this.datasets[a.id]&&this.datasets[a.id]instanceof V3.Transform?(V3.Transformer.get().set(this.datasets[a.id]),V.postMessage("import.select",a,b)):
V.postMessage(`${a.id} is not a transform`)});V.recvMessage("import.unselect",(a,b)=>{this.datasets[a.id]&&this.datasets[a.id]instanceof V3.Transform?(V3.Transformer.get().clr(),V.postMessage("import.unselect",a,b)):V.postMessage(`${a.id} is not a transform`)});V.to1DUnitString=a=>{switch(V.units){case V.METRIC:return O.numberFormat.format(a.toFixed(2))+" m";case V.IMPERIAL:a*=39.3701;var b=Math.floor(a/12);a=Math.round(a-12*b);return O.numberFormat.format(b)+"' "+a+'"'}};V.to2DUnitString=a=>{switch(V.units){case V.METRIC:return O.numberFormat.format(a.toFixed(2))+
" m\u00b2";case V.IMPERIAL:return O.numberFormat.format((10.7639*a).toFixed(2))+" ft\u00b2"}};V.to3DUnitString=a=>{switch(V.units){case V.METRIC:return O.numberFormat.format(a.toFixed(2))+" m\u00b3";case V.IMPERIAL:return O.numberFormat.format((35.3147*a).toFixed(2))+" ft\u00b3"}};this.animate()}render(){V.camera.moving&&V.camera.updateRange(this.aabb);V.camera.updateMatrix();this.frameBuffer&&gl.bindFramebuffer(gl.FRAMEBUFFER,this.frameBuffer.glId);GL.BoundingBox.init(this.aabb);for(var c in this.datasets){let a=
this.datasets[c];V.camera.intersectsBox(a)&&a.visible&&a.render(V.camera.frustum);GL.BoundingBox.merge(this.aabb,a);this.axis.resize(this.aabb,V.camera)}this.axis.render(V.camera);this.frameBuffer&&(gl.bindFramebuffer(gl.FRAMEBUFFER,null),this.frameBuffer.render())}getDistanceAlpha(c,a,b){c=V.camera.distanceTo(c);return a!=b?GM.clamp((b-c)/(b-a),0,1):c<a?1:0}getConstraint(){return V.camera.projection===V3.PERSPECTIVE?C.create(["Intersect"]):C.create(["Plane",V.camera.getNearPlane()])}load(c,a){super.load(c,
a);a.visible&&1==Object.keys(this.datasets).length&&this.controller.load(a);V.camera.updateRange(this.aabb)}};
GL.FrameBuffer=function(){this.colorTexture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,this.colorTexture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.drawingBufferWidth,gl.drawingBufferHeight,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.bindTexture(gl.TEXTURE_2D,
null);this.depthTexture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,this.depthTexture);gl.texImage2D(gl.TEXTURE_2D,0,gl.DEPTH_COMPONENT24,gl.drawingBufferWidth,gl.drawingBufferHeight,0,gl.DEPTH_COMPONENT,gl.UNSIGNED_INT,null);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.bindTexture(gl.TEXTURE_2D,
null);this.glId=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,this.glId);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.colorTexture,0);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,this.depthTexture,0);gl.bindFramebuffer(gl.FRAMEBUFFER,null);this.position=new GL.ArrayBuffer(new Float32Array([1,1,0,-1,1,0,-1,-1,0,-1,-1,0,1,-1,0,1,1,0]))};GL.FrameBuffer.prototype.render=function(){};
GL.FrameBuffer.prototype.render=function(c){c.useProgram();gl.enableVertexAttribArray(this.shader.position);gl.bindBuffer(gl.ARRAY_BUFFER,this.position.glId);gl.vertexAttribPointer(this.shader.position,3,gl.FLOAT,!1,0,0);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,this.colorTexture);gl.uniform1i(this.shader.color,0);gl.activeTexture(gl.TEXTURE1);gl.bindTexture(gl.TEXTURE_2D,this.colorTexture);gl.uniform1i(this.shader.depth,1);gl.drawArrays(gl.TRIANGLES,0,6);gl.disableVertexAttribArray(this.shader.position)};
GL.FrameBuffer.prototype.resize=function(){gl.bindTexture(gl.TEXTURE_2D,this.colorTexture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.drawingBufferWidth,gl.drawingBufferHeight,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindTexture(gl.TEXTURE_2D,this.depthTexture);gl.texImage2D(gl.TEXTURE_2D,0,gl.DEPTH_COMPONENT24,gl.drawingBufferWidth,gl.drawingBufferHeight,0,gl.DEPTH_COMPONENT,gl.UNSIGNED_INT,null);gl.bindTexture(gl.TEXTURE_2D,null)};
</script>
<script id="/3d/camera.js">V3.Camera=class extends GM.CameraMVP{constructor(b,a){super(b,a);this.modelViewMatrixStack2=[];this.min={x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY,z:Number.POSITIVE_INFINITY};this.max={x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY,z:Number.NEGATIVE_INFINITY};V.recvMessage("camera.distance.get",c=>{V.postMessage("camera.distance.get",GM.Vector3.distance(this.position,c))});V.recvMessage("camera.get",c=>{V.postMessage("camera.get",this.toJson())});V.recvMessage("camera.set",c=>{this.set(c);
V.refresh=!0;V.touch2d();V.touch3d()});V.recvMessage("viewpoint.get",c=>{c.camera=this.toJson()})}pushWorldMatrix(b){this.modelViewMatrixStack2.push(GM.Matrix4.init(this.modelViewMatrix));GM.Matrix4.multiply(this.inverse,b,this.modelViewMatrix)}popWorldMatrix(){GM.Matrix4.copy(this.modelViewMatrixStack2[this.modelViewMatrixStack2.length-1],this.modelViewMatrix);this.modelViewMatrixStack2.pop()}set(b){super.set(b);V.postMessage("camera",b)}distanceTo(b){let a=b.x-this.position.x,c=b.y-this.position.y;
b=b.z-this.position.z;return Math.sqrt(a*a+c*c+b*b)}};
V3.Controller=class extends V.CameraController{constructor(){super(V.EventHandler.PRIO1,V.EventHandler.PRIO0,V.camera,6);V3.Controller.instance=this;this.controllers={};this.controllers.orbiter=new V3.Orbiter(V.camera);this.controllers.flyer=new V3.Flyer(V.camera);this.controllers.walker=new V3.Walker(V.camera);this.controllers.manual=new V3.Manual(V.camera);this.cast3d={distance:Number.POSITIVE_INFINITY};V.recvMessage("controller.view",b=>{let a=b.aabb;a||b.min&&b.max&&(a=GL.BoundingBox.create(b.min,
b.max));this.active?(this.active.focus&&this.active.focus(a,this),V.postMessage("controller.view",b)):V.postMessage("error","No controller acive")});V.recvMessage("controller.target",b=>{this.active?(this.active.target&&this.active.target(b,this),V.postMessage("controller.view",b)):V.postMessage("error","No controller acive")});V.recvMessage("controller.set",b=>{let a=this.active;b.hasOwnProperty("name")&&this.active!=this.controllers[b.name]&&this.controllers[b.name]&&(this.active=this.controllers[b.name]);
this.active?(this.active.init&&this.active.init(b,this,a),V.postMessage("controller.set",this.active.toJson())):V.postMessage("error","no controller selected");V.camera.moving=!0;V.touch3d();V.touch2d()});V.recvMessage("viewpoint",b=>{b.controller?(this.active!=this.controllers[b.controller.name]&&(this.active=this.controllers[b.controller.name]),this.active.init&&this.active.init(b.controller,this,this.active),V.postMessage("controller.set",this.active.toJson())):this.active=null;b.navcube&&(this.navCube||
(this.navCube=new V3.NavCube(this),this.navCube.show(!0)),V.postMessage("navcube",this.navCube.toJson()));b.target&&(this.target||(this.target=new V3.Target(this)),this.target.fromJson(b.target),V.postMessage("target",this.target.toJson()));V.camera.projection.set(b.camera.projection);this.tweenPosition(b.camera.position);this.tweenRotation(b.camera.rotation);this.tweenStart();V.postMessage("camera",b.camera)});V.recvMessage("viewpoint.get",b=>{this.active&&(b.controller=this.active.toJson(),this.navCube&&
(b.navCube=this.navCube.toJson()),this.target&&(b.target=this.target.toJson()))});V.recvMessage("navcube",b=>{this.navCube||(this.navCube=new V3.NavCube(this),this.navCube.show(!0));b.hasOwnProperty("visible")&&this.navCube.show(b.visible);V.touch3d();V.postMessage("navcube",b)});V.recvMessage("target",b=>{this.target||(this.target=new V3.Target(this));this.target.fromJson(b);V.touch3d();V.postMessage("target",this.target.toJson())});V.recvMessage("target.get",()=>{this.target?V.postMessage("target.get",
{}):V.postMessage("target.get",this.target.toJson())})}load(){let b=GL.BoundingBox.center(V.viewer.aabb),a=GL.BoundingBox.diagonal(V.viewer.aabb);GM.Euler.copy(V3.Controller.rotation,V.camera.rotation);GM.Vector3.addScalar(b,GM.Euler.zAxisT(V3.Controller.rotation,{}),a,V.camera.position)}onUpdate(b){super.onUpdate(b);this.active&&this.active.update&&this.active.update(this)}onDblClick(b){super.onDblClick(b)||this.cast3d.distance!=Number.POSITIVE_INFINITY&&V.postMessage(V.viewer.datasets[this.cast3d.id].type+
".dblclick",this.cast3d);b.stopImmediatePropagation()}onMouseDown(b){super.onMouseDown(b);this.active&&this.active.mouseDown&&this.active.mouseDown(b,this)}onMouseWheel(b){super.onMouseWheel(b);this.active&&this.active.mouseWheel&&this.active.mouseWheel(b,this)}onKeyDown(b){super.onKeyDown(b);this.active&&this.active.keyDown&&this.active.keyDown(b,this)}onNavCube(b){this.active&&this.active.navCube&&this.active.navCube(b,this)}onTouchStart(b){super.onTouchStart(b);if(this.active&&this.active.onTouchDown)this.active.onTouchDown(b,
this)}onTouchMove(b){super.onTouchMove(b);if(this.active&&this.active.onTouchMove)this.active.onTouchMove(b,this)}onTouchEnd(b){super.onTouchEnd(b);if(this.active&&this.active.onTouchEnd)this.active.onTouchEnd(b,this)}touchControl(b,a){b.addEventListener("touchstart",c=>{1==c.targetTouches.length&&(this.timer&&clearInterval(this.timer),document.dispatchEvent(new KeyboardEvent("keydown",{keyCode:a})),this.timer=setInterval(()=>{document.dispatchEvent(new KeyboardEvent("keydown",{keyCode:a}))},20))});
b.addEventListener("touchend",c=>{this.timer&&clearInterval(this.timer)})}};V3.Controller.rotation=GM.Euler.create(-Math.PI/8,0,0);
V3.Orbiter=class{constructor(b){this.camera=b;this.matrixUP=GM.Matrix4.create();this.inverseUP=GM.Matrix4.create();this.rotation=GM.Euler.copy(V3.Controller.rotation,{});this.matrix=GM.Matrix4.create();this.zoomFn=(a,c)=>{.1<Math.abs(this.targetOrbit-this.orbit)?c=.29*(this.targetOrbit-this.orbit):(c=this.targetOrbit-this.orbit,a.updateFn=null);this.orbit+=c;GM.Vector3.addScalar(this.camera.position,this.camera.zAxis,c,this.camera.position)};this.panFn=a=>{let c=0,d=0;a.keys[V.KEY_A]?c=.05:a.keys[V.KEY_D]?
c=-.05:a.keys[V.KEY_UP]?d=-.05:a.keys[V.KEY_DOWN]?d=.05:(c=a.currPos.x-a.startPos.x,d=a.currPos.y-a.startPos.y);c/=a.dragMax;d/=a.dragMax;a.startPos.x+=c;a.startPos.y+=d;this.camera.position.x-=this.orbit*(this.camera.xAxis.x*c+this.camera.yAxis.x*d);this.camera.position.y-=this.orbit*(this.camera.xAxis.y*c+this.camera.yAxis.y*d);this.camera.position.z-=this.orbit*(this.camera.xAxis.z*c+this.camera.yAxis.z*d)};this.rotateFn=a=>{let c=0;if(a.keys[V.KEY_LEFT])var d=-.1;else a.keys[V.KEY_RIGHT]?d=.1:
(d=a.currPos.x-a.startPos.x,c=a.currPos.y-a.startPos.y);d/=a.dragMax;c/=a.dragMax;a.startPos.x+=d;a.startPos.y+=c;a=GM.Vector3.addScalar(this.camera.position,this.camera.zAxis,-this.orbit,{});GM.Matrix4.multiply(this.inverseUP,this.camera.matrix,this.matrix);GM.Euler.fromMatrix(this.matrix,this.rotation);this.rotation.x=GM.clamp(this.rotation.x+c,-1.57079632679,1.57079632679);this.rotation.y-=4*d;this.rotation.z=0;GM.Matrix4.fromEuler(this.rotation,this.matrix);GM.Matrix4.multiply(this.matrixUP,this.matrix,
this.matrix);GM.Euler.fromMatrix(this.matrix,this.camera.rotation);d=GM.Euler.zAxisT(this.camera.rotation,{});GM.Vector3.addScalar(a,d,this.orbit,this.camera.position)};this.orbitFn=a=>{a=GM.Vector3.addScalar(this.camera.position,this.camera.zAxis,-this.orbit,{});let c=GM.Euler.zAxisT(this.camera.rotation,{});GM.Vector3.addScalar(a,c,this.orbit,this.camera.position)}}init(b,a,c){this.maxOrbit=GL.BoundingBox.diagonal(V.viewer.aabb);this.minOrbit=this.maxOrbit/300;b.hasOwnProperty("orbit")?this.orbit=
b.orbit:b.min&&b.max?(a=GL.BoundingBox.create(b.min,b.max),c=GL.BoundingBox.diagonal(a),isFinite(c)&&(b.position=GM.Vector3.addScalar(GL.BoundingBox.center(a),this.camera.zAxis,c,{}),this.orbit=c)):this.orbit=c&&c instanceof V3.Flyer?c.range:c&&c instanceof V3.Walker?V3.Walker.HEIGHT:this.maxOrbit;b.hasOwnProperty("up")&&(GM.Matrix4.quaternion(GM.Quaternion.between(GM.Vector3.create(0,1,0),GM.Vector3.create(b.up.x,b.up.y,b.up.z),{}),this.matrixUP),GM.Matrix4.invert(this.matrixUP,this.inverseUP),GM.Matrix4.fromEuler(this.rotation,
this.matrix),GM.Matrix4.multiply(this.matrixUP,this.matrix,this.matrix),GM.Euler.fromMatrix(this.matrix,this.camera.rotation));V.camera.set(b)}focus(b,a){let c=GL.BoundingBox.diagonal(b);isFinite(c)&&(b=GL.BoundingBox.center(b),this.orbit=c,a.tweenPosition(GM.Vector3.addScalar(b,this.camera.zAxis,c,{})),a.tweenStart())}target(b,a){isFinite(b.x)&&isFinite(b.y)&&isFinite(b.z)&&(this.orbit=Math.min(this.orbit,GM.Vector3.distance(V.camera.position,b)),a.tweenPosition(GM.Vector3.addScalar(b,this.camera.zAxis,
this.orbit,{})),a.tweenStart())}navCube(b,a){a.tweenRotation(b);a.tweenStart(this.orbitFn)}mouseDown(b,a){a.tweenStop();0==b.button?a.updateFn=this.rotateFn:2==b.button&&(a.updateFn=this.panFn)}mouseWheel(b,a){a.tweenStop();this.targetOrbit=Math.max(1.1*this.minOrbit,this.orbit+4*a.currZoomD*(this.orbit-this.minOrbit));a.updateFn=this.zoomFn}keyDown(b,a){a.tweenStop();switch(b.keyCode){case V.KEY_W:this.targetOrbit=Math.max(this.minOrbit,.85*this.orbit);a.updateFn=this.zoomFn;break;case V.KEY_S:this.targetOrbit+=
Math.max(.5,.1*(this.orbit-this.minOrbit));a.updateFn=this.zoomFn;break;case V.KEY_A:case V.KEY_D:case V.KEY_UP:case V.KEY_DOWN:a.updateFn=this.panFn;break;case V.KEY_LEFT:case V.KEY_RIGHT:a.updateFn=this.rotateFn}}toJson(){return{name:"orbiter",orbit:this.orbit}}};
V3.Flyer=class{constructor(b){this.camera=b;this.flyFn=a=>{if(.005<Math.abs(a.currZoom)){var c=.25*a.currZoom*this.range;0>a.currZoom&&(c=Math.min(-.1,c));a.currZoom*=.9;.005>=Math.abs(a.currZoom)&&(a.currZoom=0);let d=a.pointerRay.direction;this.camera.position.x+=c*d.x;this.camera.position.y+=c*d.y;this.camera.position.z+=c*d.z;a.cast3d.distance!=Number.POSITIVE_INFINITY&&(this.range=Math.max(.4,this.range-c))}else a.updateFn=null};this.panFn=a=>{let c=0,d=0;a.keys[V.KEY_A]?c=.05:a.keys[V.KEY_D]?
c=-.05:a.keys[V.KEY_UP]?d=-.05:a.keys[V.KEY_DOWN]?d=.05:(c=a.currPos.x-a.startPos.x,d=a.currPos.y-a.startPos.y);c/=a.dragMax;d/=a.dragMax;a.startPos.x+=c;a.startPos.y+=d;this.camera.position.x-=.9*this.range*(this.camera.xAxis.x*c+this.camera.yAxis.x*d);this.camera.position.y-=.9*this.range*(this.camera.xAxis.y*c+this.camera.yAxis.y*d);this.camera.position.z-=.9*this.range*(this.camera.xAxis.z*c+this.camera.yAxis.z*d)};this.rotateFn=a=>{let c,d=0;a.keys[V.KEY_LEFT]?c=-.1:a.keys[V.KEY_RIGHT]?c=.1:
(c=a.currPos.x-a.startPos.x,d=a.currPos.y-a.startPos.y);c/=a.dragMax;d/=a.dragMax;a.startPos.x+=c;a.startPos.y+=d;this.camera.rotation.x=GM.clamp(this.camera.rotation.x+d,-1.57079632679,1.57079632679);this.camera.rotation.y-=(this.shiftKey?.4:4)*c;this.camera.rotation.z=0};this.mouseStamp=0}init(b,a){this.range=GL.BoundingBox.diagonal(V.viewer.aabb)}target(b,a){let c=GM.Vector3.sub(b,V.camera.position,{});GM.Vector3.scale(c,.85,c);a.tweenPosition(GM.Vector3.add(V.camera.position,c,b));GM.Vector3.normalize(c,
c);a.tweenRotation(GM.Euler.fromDirection(c));a.tweenStart()}update(b){b.updateFn||b.cast3d.distance==Number.POSITIVE_INFINITY||(this.range=b.cast3d.distance)}mouseDown(b,a){a.tweenStop();0==b.button?a.updateFn=this.rotateFn:2==b.button&&(a.updateFn=this.panFn)}mouseWheel(b,a){a.tweenStop();a.updateFn=this.flyFn}keyDown(b,a){a.tweenStop();switch(b.keyCode){case V.KEY_W:case V.KEY_S:a.updateFn=this.flyFn;break;case V.KEY_A:case V.KEY_D:case V.KEY_UP:case V.KEY_DOWN:a.updateFn=this.panFn;break;case V.KEY_LEFT:case V.KEY_RIGHT:a.updateFn=
this.rotateFn}}toJson(){return{name:"flyer"}}};
V3.Walker=class{constructor(b){this.camera=b;this.walkFn=a=>{let c=0,d=0,e=0;V.keyMap[V.KEY_W]?(c-=this.walkSpeed*this.camera.zAxis.x,d-=this.walkSpeed*this.camera.zAxis.y,e-=this.walkSpeed*this.camera.zAxis.z):V.keyMap[V.KEY_S]&&(c+=this.walkSpeed*this.camera.zAxis.x,d+=this.walkSpeed*this.camera.zAxis.y,e+=this.walkSpeed*this.camera.zAxis.z);V.keyMap[V.KEY_A]?(c-=this.walkSpeed*this.camera.xAxis.x,d-=this.walkSpeed*this.camera.xAxis.y,e-=this.walkSpeed*this.camera.xAxis.z):V.keyMap[V.KEY_D]&&(c+=
this.walkSpeed*this.camera.xAxis.x,d+=this.walkSpeed*this.camera.xAxis.y,e+=this.walkSpeed*this.camera.xAxis.z);if(c||d||e)this.camera.position.x+=c*V.dT,this.camera.position.y+=d*V.dT,this.camera.position.z+=e*V.dT,this.snapToGround(this.camera.position);this.rotateFn(a)};this.rotateFn=a=>{let c,d=0;a.keys[V.KEY_LEFT]?c=-.1:a.keys[V.KEY_RIGHT]?c=.1:(c=a.currPos.x-a.startPos.x,d=a.currPos.y-a.startPos.y);c/=a.dragMax;d/=a.dragMax;a.startPos.x+=c;a.startPos.y+=d;this.camera.rotation.x=GM.clamp(this.camera.rotation.x+
d,-1.57079632679,1.57079632679);this.camera.rotation.y-=(this.shiftKey?.4:4)*c;this.camera.rotation.z=0};this.panFn=a=>{let c=0,d;a.keys[V.KEY_LEFT]?d=-.1:a.keys[V.KEY_RIGHT]?d=.1:(c=a.currPos.x-a.startPos.x,d=a.currPos.y-a.startPos.y);c/=a.dragMax;d/=a.dragMax;a.startPos.x+=c;a.startPos.y+=d;this.camera.position.x-=.9*V3.Walker.HEIGHT*(this.camera.xAxis.x*c+this.camera.yAxis.x*d);this.camera.position.y-=.9*V3.Walker.HEIGHT*(this.camera.xAxis.y*c+this.camera.yAxis.y*d);this.camera.position.z-=.9*
V3.Walker.HEIGHT*(this.camera.xAxis.z*c+this.camera.yAxis.z*d)};this.walkSpeed=3.4;this._sampleRay=new GM.Ray(new GM.Vector3,new GM.Vector3(0,-1,0))}init(b,a){b.target&&this.target(b.target,a)}target(b,a){b.y+=V3.Walker.HEIGHT;this.snapToGround(b);a.tweenPosition(b);GM.Vector3.subtract(b,this.camera.position,b);b.y=0;GM.Vector3.normalize(b,b);a.tweenRotation(GM.Euler.fromDirection(b));a.tweenStart()}mouseDown(b,a){a.tweenStop();0==b.button?a.updateFn=this.rotateFn:2==b.button&&(a.updateFn=this.panFn)}mouseWheel(b,
a){a.tweenStop();this.walkSpeed=Math.max(1,this.walkSpeed+a.currZoom)}keyDown(b,a){a.tweenStop();switch(b.keyCode){case V.KEY_W:case V.KEY_S:case V.KEY_A:case V.KEY_D:a.updateFn=this.walkFn;break;case V.KEY_UP:case V.KEY_DOWN:a.updateFn=this.panFn;break;case V.KEY_LEFT:case V.KEY_RIGHT:a.updateFn=this.rotateFn}}snapToGround(b){this._sampleRay.origin.y=b.y-V3.Walker.HEIGHT/2;for(var a=0,c=0,d=0;d<V3.Walker.DXY.length;d++){this._sampleRay.origin.z=b.z+V3.Walker.DXY[d].z;this._sampleRay.origin.x=b.x+
V3.Walker.DXY[d].x;var e=V.viewer.raycast(this._sampleRay,{distance:Number.POSITIVE_INFINITY}).distance;e!=Number.POSITIVE_INFINITY&&(a+=e,c++)}0<c&&(b.y=b.y-a/c+V3.Walker.HEIGHT/2)}toJson(){return{name:"walker"}}};V3.Walker.WALK=1;V3.Walker.WIDTH=.4;V3.Walker.DXY=[{x:V3.Walker.WIDTH,z:V3.Walker.WIDTH},{x:V3.Walker.WIDTH,z:-V3.Walker.WIDTH},{x:-V3.Walker.WIDTH,z:V3.Walker.WIDTH},{x:-V3.Walker.WIDTH,z:-V3.Walker.WIDTH}];V3.Walker.HEIGHT=1.7;
V3.Manual=class{constructor(b){this.camera=b}init(b,a){}target(b,a){}};
</script>
<script id="/3d/controls/navcube.js">V3.NavCube=class extends V.EventHandler{constructor(a){super(V.EventHandler.PRIO1);this.controller=a;this.camera=new GM.CameraMVP({width:V3.NavCube.VIEWPORT,height:V3.NavCube.VIEWPORT},new GM.PerspectiveProjection(30));this.navTextureMap=new GL.Texture(new GL.ImageLoader("3d/controls/navcube.png",{notify:V.touch3d}));this.navIndex=new GL.ElementBuffer(new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]));this.visible=!0;this.dx=this.dy=0;
this.zones=new Float32Array([0,0,.2,.2,.8,0,1,.2,.8,.8,1,1,0,.8,.2,1,.2,0,.8,.2,.8,.2,1,.8,.2,.8,.8,1,0,.2,.2,.8,.2,.2,.8,.8]);this.activeFace=[-1,-1,-1];this.activeZone=[0,0,0];this.adjCorner=[[[[5,1],[2,1]],[[4,0],[2,0]],[[4,3],[3,3]],[[5,2],[3,2]]],[[[4,1],[2,3]],[[2,2],[5,0]],[[3,1],[5,3]],[[4,2],[3,0]]],[[[4,0],[0,1]],[[0,0],[5,1]],[[1,1],[5,0]],[[1,0],[4,1]]],[[[1,3],[4,2]],[[1,2],[5,3]],[[5,2],[0,3]],[[4,3],[0,2]]],[[[2,0],[0,1]],[[2,3],[1,0]],[[1,3],[3,0]],[[3,3],[0,2]]],[[[1,1],[2,2]],[[2,
1],[0,0]],[[0,3],[3,2]],[[3,1],[1,2]]]];this.adjSide=[[[2,4],[4,7],[3,6],[5,5]],[[2,6],[5,7],[3,4],[4,5]],[[0,4],[5,4],[1,4],[4,4]],[[1,6],[5,6],[0,6],[4,6]],[[2,7],[1,7],[3,7],[0,5]],[[2,5],[0,7],[3,5],[1,5]]];a=Math.PI;var c=Math.PI/2,b=Math.PI/4;this.rX=[b,b,-b,-b,b,b,-b,-b,b,0,-b,0,b,0,-b,0,b,b,-b,-b,0,0,c,-c,0,0];this.rY=[a-b,a+b,a+b,a-b,-b,b,b,-b,a,a+b,a,a-b,0,b,0,-b,c,-c,c,-c,a,0,0,0,-c,c];this.rotZone=[[0,1,2,3,8,9,10,11,20],[4,5,6,7,12,13,14,15,21],[1,0,5,4,8,16,12,17,22],[7,6,3,2,14,18,
10,19,23],[1,4,7,2,17,15,19,9,24],[5,0,3,6,16,11,18,13,25]];this.shader=new GL.ShaderMVP(V3.NavCube.vs,V3.NavCube.fs);this.shader.compile();this.navTexture=gl.getUniformLocation(this.shader.glId,"navTexture");this.activeFaceId=gl.getUniformLocation(this.shader.glId,"uActive");this.activeZoneId=gl.getUniformLocation(this.shader.glId,"uRegion");gl.useProgram(this.shader.glId);gl.uniform4fv(gl.getUniformLocation(this.shader.glId,"uZones"),this.zones);gl.useProgram(null)}onRender3D(a){this.visible&&(this.camera.rotation.x+=
this.dy,this.camera.rotation.y-=this.dx,a=GM.Euler.zAxisT(this.camera.rotation,{}),this.camera.position.x=3.3*a.x,this.camera.position.y=3.3*a.y,this.camera.position.z=3.3*a.z,this.camera.updateMatrix(),GM.Vector3.copy(V.camera.rotation,this.camera.rotation),gl.viewport(gl.drawingBufferWidth-V3.NavCube.VIEWPORT,0,V3.NavCube.VIEWPORT,V3.NavCube.VIEWPORT),this.shader.useProgram(this.camera),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,this.navTextureMap.glId),gl.uniform1i(this.navTexture,
0),gl.uniform3fv(this.activeFaceId,this.activeFace),gl.uniform3iv(this.activeZoneId,this.activeZone),gl.disable(gl.DEPTH_TEST),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.navIndex.glId),gl.drawElements(gl.TRIANGLES,36,gl.UNSIGNED_SHORT,0),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null),gl.enable(gl.DEPTH_TEST),gl.viewport(0,0,gl.drawingBufferWidth,gl.drawingBufferHeight))}onUpdate(a){if(V.camera.stopping)this.onMouseMove(this.controller.pointerPosition)}onClick(a){if(a.pageX>gl.drawingBufferWidth-V3.NavCube.VIEWPORT&&
a.pageY>gl.drawingBufferHeight-V3.NavCube.VIEWPORT&&500>V.time-this.clickStart&&-1!=this.activeFace[0]){var c=this.rotZone[this.activeFace[0]][this.activeZone[0]];this.controller.onNavCube({x:this.rX[c],y:this.rY[c],z:0});a.stopImmediatePropagation()}}onMouseDown(a){a.pageX>gl.drawingBufferWidth-V3.NavCube.VIEWPORT&&a.pageY>gl.drawingBufferHeight-V3.NavCube.VIEWPORT&&(this.clickStart=V.time,a.stopImmediatePropagation())}onMouseUp(a){a.pageX>gl.drawingBufferWidth-V3.NavCube.VIEWPORT&&a.pageY>gl.drawingBufferHeight-
V3.NavCube.VIEWPORT&&a.stopImmediatePropagation()}onMouseMove(a){if(a.pageX>gl.drawingBufferWidth-V3.NavCube.VIEWPORT&&a.pageY>gl.drawingBufferHeight-V3.NavCube.VIEWPORT){let c=this.camera.getRay({pageX:V3.NavCube.VIEWPORT-(gl.drawingBufferWidth-a.pageX),pageY:V3.NavCube.VIEWPORT-(gl.drawingBufferHeight-a.pageY)});this.activeFace[0]=-1;this.activeFace[1]=-1;this.activeFace[2]=-1;this.activeZone[0]=23;this.activeZone[1]=23;this.activeZone[2]=23;0>this.camera.zAxis.z?(a=c.intersectPlane({x:0,y:0,z:-1,
w:.5},{}))&&-.5<a.x&&.5>a.x&&-.5<a.y&&.5>a.y&&(this.activeFace[0]=0,this.activeZone[0]=this.findZone(-a.x+.5,a.y+.5)):0<this.camera.zAxis.z&&(a=c.intersectPlane({x:0,y:0,z:1,w:.5},{}))&&-.5<a.x&&.5>a.x&&-.5<a.y&&.5>a.y&&(this.activeFace[0]=1,this.activeZone[0]=this.findZone(a.x+.5,a.y+.5));0>this.camera.zAxis.y?(a=c.intersectPlane({x:0,y:-1,z:0,w:.5},{}))&&-.5<a.z&&.5>a.z&&-.5<a.x&&.5>a.x&&(this.activeFace[0]=2,this.activeZone[0]=this.findZone(a.x+.5,a.z+.5)):0<this.camera.zAxis.y&&(a=c.intersectPlane({x:0,
y:1,z:0,w:.5},{}))&&-.5<a.z&&.5>a.z&&-.5<a.x&&.5>a.x&&(this.activeFace[0]=3,this.activeZone[0]=this.findZone(a.x+.5,-a.z+.5));0>this.camera.zAxis.x?(a=c.intersectPlane({x:-1,y:0,z:0,w:.5},{}))&&-.5<a.z&&.5>a.z&&-.5<a.y&&.5>a.y&&(this.activeFace[0]=4,this.activeZone[0]=this.findZone(a.z+.5,a.y+.5)):0<this.camera.zAxis.x&&(a=c.intersectPlane({x:1,y:0,z:0,w:.5},{}))&&-.5<a.z&&.5>a.z&&-.5<a.y&&.5>a.y&&(this.activeFace[0]=5,this.activeZone[0]=this.findZone(-a.z+.5,a.y+.5));4>this.activeZone[0]?(a=this.adjCorner[this.activeFace[0]][this.activeZone[0]],
this.activeFace[1]=a[0][0],this.activeZone[1]=a[0][1],this.activeFace[2]=a[1][0],this.activeZone[2]=a[1][1]):8>this.activeZone[0]&&(a=this.adjSide[this.activeFace[0]][this.activeZone[0]-4],this.activeFace[1]=a[0],this.activeZone[1]=a[1]);V.touch3d()}else this.activeFace[0]=-1,this.activeFace[1]=-1,this.activeFace[2]=-1}findZone(a,c){for(var b=0;9>b;b++)if(a>this.zones[4*b]&&c>this.zones[4*b+1]&&a<this.zones[4*b+2]&&c<this.zones[4*b+3])return b;return-1}show(a){a&&!this.isAttached()?this.attach():
!a&&this.isAttached()&&this.detach()}toJson(){return{visible:this.isAttached()}}};V3.NavCube.VIEWPORT=140;V3.NavCube.vs="#version 300 es\n\nprecision mediump float;\nprecision mediump int;\n\nuniform mat4 modelViewMatrix; \nuniform mat4 projectionMatrix; \n\nconst vec3 cNormal[6] = vec3[6](\n                        vec3(0,0,-1),\n                        vec3(0,0, 1),\n                        vec3(0,-1,0),\n                        vec3(0, 1,0),\n                        vec3(-1,0,0),\n                        vec3( 1,0,0));\n                        \n                        \nconst vec3 cVertex[24] = vec3[24](\n                        // z-\n                        vec3( 0.5,-0.5,-0.5), vec3(-0.5,-0.5,-0.5),\n                        vec3(-0.5, 0.5,-0.5), vec3( 0.5, 0.5,-0.5),\n                        // z+\n                        vec3(-0.5,-0.5, 0.5), vec3( 0.5,-0.5, 0.5), \n                        vec3( 0.5, 0.5, 0.5), vec3(-0.5, 0.5, 0.5),\n                        \n                        // y-\n                        vec3(-0.5,-0.5,-0.5), vec3( 0.5,-0.5,-0.5), \n                        vec3( 0.5,-0.5, 0.5), vec3(-0.5,-0.5, 0.5),\n                        // y+\n                        vec3(-0.5, 0.5, 0.5), vec3( 0.5, 0.5, 0.5), \n                        vec3( 0.5, 0.5,-0.5), vec3(-0.5, 0.5,-0.5),\n                        \n                        // x-\n                        vec3(-0.5,-0.5,-0.5), vec3(-0.5,-0.5, 0.5), \n                        vec3(-0.5, 0.5, 0.5), vec3(-0.5, 0.5,-0.5),\n                        // x+\n                        vec3( 0.5,-0.5, 0.5), vec3( 0.5,-0.5,-0.5), \n                        vec3( 0.5, 0.5,-0.5), vec3( 0.5, 0.5, 0.5));\n\n#define W (1.0/4.0)\t\t\t     \t\t\n#define H (1.0/3.0)\t\t\n                \nconst vec2 cUV[24] = vec2[24](\n                        // z-\n                        vec2(3.0*W,2.0*H), vec2(4.0*W,2.0*H), \n                        vec2(4.0*W,1.0*H), vec2(3.0*W,1.0*H),\n                        // z+\n                        vec2(1.0*W,2.0*H), vec2(2.0*W,2.0*H), \n                        vec2(2.0*W,1.0*H), vec2(1.0*W,1.0*H),\n                        \n                        // y-\n                        vec2(1.0*W,3.0*H), vec2(2.0*W,3.0*H), \n                        vec2(2.0*W,2.0*H), vec2(1.0*W,2.0*H),\n                        // y+\n                        vec2(1.0*W,1.0*H), vec2(2.0*W,1.0*H), \n                        vec2(2.0*W,0.0*H), vec2(1.0*W,0.0*H),\n                        \n                        // x-\n                        vec2(0.0*W,2.0*H), vec2(1.0*W,2.0*H), \n                        vec2(1.0*W,1.0*H), vec2(0.0*W,1.0*H),\n                        // x+\n                        vec2(2.0*W,2.0*H), vec2(3.0*W,2.0*H), \n                        vec2(3.0*W,1.0*H), vec2(2.0*W,1.0*H));\n\nconst vec2 tUV[4] = vec2[4](\n                        vec2(0.0,0.0), vec2(1.0,0.0),\n                        vec2(1.0,1.0), vec2(0.0,1.0));\n\n\nin float index;\n\nin vec3 position;\nin vec2 uv;\nin vec2 fuv;\n\nout vec2 vUV;\nout vec2 vtUV;\nout vec3 vNormal;\nout float vFace;\n\nvoid main()\t\n{\n    gl_Position = projectionMatrix * (modelViewMatrix * vec4(cVertex[gl_VertexID], 1.0));\n    \n    mat3 normalMatrix = mat3(modelViewMatrix);\n\n    vFace = float(gl_VertexID/4);\n    vNormal = normalize(normalMatrix * cNormal[gl_VertexID/4]);\n    vUV = cUV[gl_VertexID];\n    vtUV = tUV[gl_VertexID%4];\n}\n";
V3.NavCube.fs="#version 300 es\n\nprecision mediump float;\nprecision mediump int;\n\nuniform sampler2D navTexture;\nuniform vec4 uZones[9];\nuniform vec3 uActive;\nuniform ivec3 uRegion;\n\nin vec3 vNormal;\nin vec2 vUV;\nin vec2 vtUV;\nin float vFace;\n\n\nout vec3 fragmentColor;\n\nconst float C = 0.1;\n\n\nvoid main()\t\n{\n    vec3 color = texture(navTexture, vUV).rgb;\n    \n    vec3 test = abs(vec3(vFace) - uActive);\n    if (test.x < 0.0001)\n    {\n        int region = uRegion.x; \n        if (all(greaterThan(vtUV, vec2(uZones[region].xy))) && all(lessThan(vtUV, vec2(uZones[region].zw)))) \n        {\n            color = 0.8*color + vec3(0.0,0.0,0.1);\n        }  \n    }\n    else if (test.y < 0.0001)\n    {\n        int region = uRegion.y; \n        if (all(greaterThan(vtUV, vec2(uZones[region].xy))) && all(lessThan(vtUV, vec2(uZones[region].zw)))) \n        {\n            color = 0.8*color + vec3(0.0,0.0,0.1);\n        }  \n    }\n    else if (test.z < 0.0001)\n    {\n        int region = uRegion.z; \n        if (all(greaterThan(vtUV, vec2(uZones[region].xy))) && all(lessThan(vtUV, vec2(uZones[region].zw)))) \n        {\n            color = 0.8*color + vec3(0.0,0.0,0.1);\n        }  \n    }\n    \n    fragmentColor = (0.2+0.6*(dot(vNormal, vec3(0.70710678118, 0, 0.70710678118))+dot(vNormal, vec3(-0.70710678118, 0, 0.70710678118))))*color;\n}\n";
</script>
<script id="/3d/controls/target.js">V3.TargetShader=class extends GL.ShaderMVP{constructor(){super(V3.TargetShader.vs,V3.TargetShader.fs)}compile(){super.compile();this.defineAttribute("position",3,gl.FLOAT,!1);this.matrix=gl.getUniformLocation(this.glId,"targetMatrix");this.radius=gl.getUniformLocation(this.glId,"radius");this.color=gl.getUniformLocation(this.glId,"color")}};V3.TargetShader.vs="#version 300 es\n\nprecision mediump float;\nprecision mediump int;\n\nuniform mat4 modelViewMatrix; \nuniform mat4 projectionMatrix; \n\nuniform float radius;\n\nuniform mat4 targetMatrix; \n\nin vec3 position;\n\nout vec2 uv;\n\nvoid main()\t\n{\n    vec4 viewVertex = modelViewMatrix * targetMatrix * vec4(position*radius, 1.0 );\n    uv = position.xz;\n    gl_Position = projectionMatrix * viewVertex;\n}\n";
V3.TargetShader.fs="#version 300 es\n\nprecision mediump float;\nprecision mediump int;\n\nuniform vec3 color;\n\nin vec2 uv;\n\nout vec4 fragmentColor;\n\nvoid main()\t\n{\n    vec2 circle = uv;\n    float r = 0.2;\n    float d = length(circle);\n\n    float t = 1.0 - smoothstep(r,r+0.3,d) - smoothstep(r,r-0.3,d);\n\n//    fragmentColor = vec4(vec3(0.0,0.502,1.00),t);\n    fragmentColor = vec4(color,t);\n }\n";
V3.Target=class extends V.EventHandler{constructor(a){super(V.EventHandler.PRIO1);this.controller=a;this.position=new GL.ArrayBuffer(new Float32Array([-.5,0,.5,.5,0,.5,.5,0,-.5,-.5,0,-.5]));this.index=new GL.ElementBuffer(new Uint16Array([0,1,2,0,2,3]));this.point={x:0,y:0,z:0};this.matrix=GM.Matrix4.create();this.color=[.5,.5,.5];this.shader=new V3.TargetShader;this.shader.compile();this.pointerAge=V.time;this.mode="auto"}setMatrix(a,b){var c=0!=b.z?GM.Vector3.normalize({x:b.z,y:b.z,z:-b.x-b.y},
{}):GM.Vector3.normalize({x:-b.y-b.z,y:b.x,z:b.x},{}),d=GM.Vector3.normalize(GM.Vector3.cross(c,b,{}),{});GM.Matrix4.copy([c.x,c.y,c.z,0,b.x,b.y,b.z,0,d.x,d.y,d.z,0,a.x,a.y,a.z,1],this.matrix);this.point=a}onUpdate(a){"auto"===this.mode&&this.controller.pointerAge!=this.pointerAge&&(a=this.controller.cast3d,a.distance!=Number.POSITIVE_INFINITY?(this.setMatrix(this.controller.pointerRay.at(a.distance,{}),a.normal),this.visible=!0):this.visible=!1,this.pointerAge=this.controller.pointerAge,V.touch3d())}onRender3D(a){this.visible&&
(this.shader.useProgram(V.camera),gl.uniform1f(this.shader.radius,.05*GM.Vector3.distance(V.camera.position,this.point)),gl.uniformMatrix4fv(this.shader.matrix,!1,this.matrix),gl.uniform3fv(this.shader.color,this.color),this.shader.enableBuffer(this),this.shader.bindBuffer(this),gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.enable(gl.BLEND),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.index.glId),gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null),
gl.disable(gl.BLEND),gl.enable(gl.DEPTH_TEST),gl.enable(gl.CULL_FACE),this.shader.disableBuffer(this))}show(a){a&&!this.isAttached()?this.attach():!a&&this.isAttached()&&this.detach()}toJson(){return{color:this.color,matrix:this.matrix,mode:this.mode,visible:this.isAttached()}}fromJson(a){a.hasOwnProperty("mode")&&(this.mode=a.mode);a.hasOwnProperty("point")&&(this.matrix[12]=a.point.x,this.matrix[13]=a.point.y,this.matrix[14]=a.point.z,this.point=a.point,this.isAttached()&&(this.visible=!0));a.hasOwnProperty("normal")&&
(this.setMatrix(this.point,a.normal),this.isAttached()&&(this.visible=!0));a.hasOwnProperty("visible")&&(a.visible&&!this.isAttached()?this.attach():!a.visible&&this.isAttached()&&this.detach());a.hasOwnProperty("color")&&(this.color=a.color)}};
</script>
<script id="/3d/controls/transform.js">V3.Rotator=class extends O.Object{constructor(a){super("rotator");this.transformer=a;this.anchor=this.addAnchor(new O.Anchor);this.anchor.addListener(this);this.active=!1;this.position=0;this.ruler=new Path2D;this.ruler.moveTo(-V3.Rotator.DIMX,0);this.ruler.lineTo(V3.Rotator.DIMX,0);this.ruler.moveTo(0,-21);this.ruler.lineTo(0,21);this.controlPoint=new O.ControlPoint(this.anchor,new C.Horizontal(this.anchor))}attach(){super.attach();this.addControl(this.controlPoint)}detach(){super.detach();this.removeControl(this.controlPoint)}startControl(){this.startPosition=
this.anchor.sx;this.active=!0;this.transformer.onSliderDown()}moveControl(a){this.transformer.onSliderMove(3*(this.anchor.sx-this.startPosition)/gl.drawingBufferWidth);V.touch3d()}endControl(){this.active=!1;this.transformer.onSliderUp()}updatePosition(a){var b=(a.max.y-a.min.y)/2,c=(a.max.z-a.min.z)/2,d=(a.max.x+a.min.x)/2,f=(a.max.y+a.min.y)/2,g=(a.max.z+a.min.z)/2,e=V.camera.yAxis;d-=(a.max.x-a.min.x)/2*e.x*1.772;f-=e.y*b*1.772;g-=e.z*c*1.772;this.anchor.set3D({x:d,y:f,z:g})}render2D(a){a.setTransform(1,
0,0,1,this.anchor.sx,this.anchor.sy);a.strokeStyle="red";a.stroke(this.ruler)}};V3.Rotator.DIMX=121;
V3.TransformerShader=class extends GL.ShaderMVP{constructor(){super(V3.TransformerShader.vs,V3.TransformerShader.fs)}compile(){super.compile();this.defineAttribute("position",3,gl.FLOAT,!1);this.defineAttribute("uv",2,gl.FLOAT,!1);this.defineAttribute("face",1,gl.FLOAT,!0);this.sampler0=gl.getUniformLocation(this.glId,"sampler0");this.sampler1=gl.getUniformLocation(this.glId,"sampler1");this.activeFace=gl.getUniformLocation(this.glId,"activeFace")}};V3.TransformerShader.vs="#version 300 es\n\nprecision mediump float;\nprecision mediump int;\n\nuniform mat4 modelViewMatrix; \nuniform mat4 projectionMatrix;\n\nin vec3 position;\nin vec2 uv;\nin float face;\n\nout vec3 viewPosition;\nout vec2 textureCoord;\nout float currentFace;\n\nvoid main()\t\n{\n    vec4 viewVertex = modelViewMatrix * vec4(position, 1.0 );\n    \n    viewPosition = position.xyz;\n    \n    textureCoord = uv;\n    currentFace = face;\n\n    gl_Position = projectionMatrix * viewVertex;\n}";
V3.TransformerShader.fs="#version 300 es\n\nprecision mediump float;\nprecision mediump int;\n\nin vec2 textureCoord;\nin float currentFace;\n\nuniform sampler2D sampler0;\nuniform sampler2D sampler1;\nuniform float activeFace; \n\nout vec4 fragmentColor;\n\n\nvoid main()\t\n{\n    //if (currentFace == 1.0)\n    if (abs(currentFace - activeFace) < 0.2)\n    {\n        fragmentColor = texture(sampler1, vec2(textureCoord.s, textureCoord.t));\n    }\n    else\n    {\n        fragmentColor = texture(sampler0, vec2(textureCoord.s, textureCoord.t));\n    }\n    \n    //fragmentColor = vec4(lColor, surfaceColor.a);\n    \n\n    /*\n    //if (currentFace == 1.0)\n    if (abs(currentFace - activeFace) < 0.2)\n    {\n        gl_FragColor = vec4(0.1,0.1,1.0,0.4);//texture2D(sampler1, vec2(textureCoord.s, textureCoord.t));\n    }\n    else\n    {\n        gl_FragColor = vec4(1.0,1.0,1.0,0.2);//texture2D(sampler0, vec2(textureCoord.s, textureCoord.t));\n    }\n    */\n }\n";
V3.Transformer=class extends O.Composite{constructor(){super("transformer");this.shader=new V3.TransformerShader;this.shader.compile();this.uv=new GL.ArrayBuffer(new Float32Array([0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1]));this.face=new GL.ArrayBuffer(new Float32Array([4,4,4,4,5,5,5,5,2,2,2,2,3,3,3,3,0,0,0,0,1,1,1,1]));this.normal=[{x:-1,y:0,z:0},{x:1,y:0,z:0},{x:0,y:-1,z:0},{x:0,y:1,z:0},{x:0,y:0,z:-1},{x:0,y:0,z:1}];this.index=new GL.ElementBuffer(new Uint16Array([2,
1,0,0,3,2,4,5,6,6,7,4,8,9,10,10,11,8,14,13,12,12,15,14,18,17,16,16,19,18,20,21,22,22,23,20]));this.texture0=new GL.Texture(new GL.ImageLoader("/3d/controls/transform-inactive.png"));this.texture1=new GL.Texture(new GL.ImageLoader("/3d/controls/transform-active.png"));this.activeFace=-1;this.p0=new GM.Vector3;this.p1=new GM.Vector3;this.rotation=new GM.Quaternion;this.plane=GM.Plane.create();this.transformMatrix=GM.Matrix4.create();this.originalMatrix=GM.Matrix4.create();this.rotator=new V3.Rotator(this);
this.ray=new GM.Ray}attach(){super.attach();O.instance.addEventListener("onMouseDown",this);O.instance.addEventListener("onMouseMove",this);O.instance.addEventListener("onMouseUp",this)}detach(){super.detach();O.instance.removeEventListener("onMouseDown",this);O.instance.removeEventListener("onMouseMove",this);O.instance.removeEventListener("onMouseUp",this)}render3D(a){this.rotator.active||(V.camera.pushWorldMatrix(this.transformMatrix),this.shader.useProgram(V.camera),gl.activeTexture(gl.TEXTURE0),
gl.bindTexture(gl.TEXTURE_2D,this.texture0.glId),gl.uniform1i(this.shader.sampler0,0),gl.activeTexture(gl.TEXTURE1),gl.bindTexture(gl.TEXTURE_2D,this.texture1.glId),gl.uniform1i(this.shader.sampler1,1),gl.uniform1f(this.shader.activeFace,this.activeFace),this.shader.enableBuffer(this),this.shader.bindBuffer(this),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.index.glId),gl.disable(gl.DEPTH_TEST),gl.enable(gl.BLEND),gl.drawElements(gl.TRIANGLES,this.index.length,gl.UNSIGNED_SHORT,0),gl.disable(gl.BLEND),
gl.enable(gl.DEPTH_TEST),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null),this.shader.disableBuffer(this),V.camera.popWorldMatrix())}updateTransform(){GM.Matrix4.copy(this.originalMatrix,this.transform.matrix);this.rotator.active?GM.Matrix4.multiply(this.transform.matrix,this.transformMatrix,this.transform.matrix):GM.Matrix4.multiply(this.transformMatrix,this.transform.matrix,this.transform.matrix);this.transform.update()}containsPoint2D(a){V.camera.getRay(a,this.ray);a=this.ray.intersectBox(this.transform);
return null!=a?(this.activeFace=a.face,GM.Plane.fromNormalPoint(this.normal[this.activeFace],this.ray.at(a.distance,this.p0),this.plane),!0):!1}onUpdate(){GL.BoundingBox.copy(this.transform,this.aabb);this.active&&(V.camera.moving=!0)}isVisible(){return!0}onMouseDown(a){this.active=!0;this.removeObject(this.rotator);a.stopImmediatePropagation()}onMouseMove(a){0<=this.activeFace&&(V.camera.getRay(a,this.ray),this.ray.intersectPlane(this.plane,this.p1),this.p1.sub(this.p0),GM.Matrix4.position(this.p1,
this.transformMatrix),this.updateTransform())}onMouseUp(a){0<=this.activeFace&&(V.postMessage("import.update",{id:this.transform.id,transform:Array.from(this.transform.matrix)}),this.init(),this.activeFace=-1,this.p1.x=0,this.p1.y=0,this.p1.z=0,this.rotator.updatePosition(this.transform),this.addObject(this.rotator),V.touch2d());this.active=!1}onSliderDown(){}onSliderMove(a){this.rotation.fromAxisAngle({x:0,y:1,z:0},3.1472*a);GM.Matrix4.quaternion(this.rotation,this.transformMatrix);this.updateTransform()}onSliderUp(){V.postMessage("import.update",
{id:this.transform.id,transform:Array.from(this.transform.matrix)});this.init();this.rotator.updatePosition(this.transform)}init(){let a=this.transform.min,b=this.transform.max;this.position=new GL.ArrayBuffer(new Float32Array([a.x,a.y,a.z,b.x,a.y,a.z,b.x,b.y,a.z,a.x,b.y,a.z,a.x,a.y,b.z,b.x,a.y,b.z,b.x,b.y,b.z,a.x,b.y,b.z,a.x,a.y,a.z,b.x,a.y,a.z,b.x,a.y,b.z,a.x,a.y,b.z,a.x,b.y,a.z,b.x,b.y,a.z,b.x,b.y,b.z,a.x,b.y,b.z,a.x,a.y,a.z,a.x,b.y,a.z,a.x,b.y,b.z,a.x,a.y,b.z,b.x,a.y,a.z,b.x,b.y,a.z,b.x,b.y,b.z,
b.x,a.y,b.z]));GM.Matrix4.copy(this.transform.matrix,this.originalMatrix);GM.Matrix4.copy([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this.transformMatrix)}set(a){this.transform&&this.clr();O.instance.addObject(this);this.transform=a;this.init();this.addObject(this.rotator);this.rotator.updatePosition(this.transform);V.touch3d()}clr(){null!=this.transform&&(O.instance.removeObject(this.id),this.removeObject(this.rotator),this.transform=null,V.touch3d())}};
V3.Transformer.get=()=>{V3.Transformer.instance||(V3.Transformer.instance=new V3.Transformer);return V3.Transformer.instance};V.recvMessage("*.unselect",(a,b)=>{V3.Transformer.instance&&V3.Transformer.instance.transform&&(V.postMessage("import.unselect",V3.Transformer.instance.transform.toJson(),b),V3.Transformer.instance.clr())});
V3.Transform=class{constructor(a,b,c){this.id=a;this.type="import";this.model=c;this.visible=b.hasOwnProperty("visible")?b.visible:!0;GL.BoundingBox.copy(this.model,GL.BoundingBox.init(this));GL.BoundingBox.transform(this.model,b.transform,this);this.matrix=GM.Matrix4.init(b.transform);this.inverse=GM.Matrix4.invert(b.transform,GM.Matrix4.create());this.ray=new GM.Ray;this.visible=!0;this.frustum=GM.Frustum.create();V.recvMessage("import.viewpoint",d=>{d.id==this.id&&(d.viewpoint?(d=d.viewpoint[this.model.id])&&
this.model.setViewpoint(d):this.model.setViewpoint(null),V.touch3d())});V.recvMessage("import.update",d=>{d.id==this.id&&("undefined"!=typeof d.visible&&(this.visible=d.visible),V.postMessage("import.update",d),V.touch3d())});this.objects=[]}update(){GM.Matrix4.invert(this.matrix,this.inverse);GL.BoundingBox.transform(this.model,this.matrix,this);this.objects.forEach(a=>{a.anchors.forEach(b=>{let c=GM.Vector3.transform(b,this.matrix,{});b.wx=c.x;b.wy=c.y;b.wz=c.z});a.projectAnchors()})}render(a){this.visible&&
GM.Frustum.intersectsBox(a,this)&&(GM.Frustum.transform(a,this.inverse,this.frustum),V.camera.pushWorldMatrix(this.matrix),this.model.render(this.frustum),V.camera.popWorldMatrix())}raycast(a,b){if(null!=a.intersectBox(this)){let c=b.distance;GM.Ray.transform(a,this.inverse,this.ray);this.model.raycast(this.ray,b);b.distance<c&&(b.normal&&GM.Vector3.rotate(b.normal,this.matrix,b.normal),b.xyz&&GM.Vector3.transform(b.xyz,this.matrix,b.xyz))}}addAnchors(a){a.anchors.forEach(b=>{b.x=b.wx;b.y=b.wy;b.z=
b.wz;let c=GM.Vector3.transform(b,this.matrix,{});b.wx=c.x;b.wy=c.y;b.wz=c.z});a.projectAnchors();this.objects.push(a)}removeAnchors(a){a=this.objects.indexOf(a);this.objects.splice(a,1)}unload(){V3.Transformer.instance&&V3.Transformer.instance.transform==this&&V3.Transformer.instance.clr();this.model.unload()}setViewpoint(a){a.visible!=this.visible&&(this.visible=a.visible,V.postMessage("import.update",{id:this.id,visible:this.visible}));a.model&&this.model.setViewpoint(a.model)}getViewpoint(){return{visible:this.visible,
model:this.model.getViewpoint()}}toJson(){return{id:this.id,type:"import",document:this.model.id,transform:Array.from(this.matrix)}}};
</script>
<script id="/3d/cloud/cloud.js">M.CloudNode=class{constructor(a,b,c,d,e){this.model=a;this.path=b.path;this.resolution=b.resolution;this.memoryUsed=b.memoryUsed;this.buffers={};for(name in c)this.buffers[name]=new GL.ArrayBuffer(c[name]);this.borrowed=0;this.kdtree=d;this.points=c.position;this.class=c.class;this.normals=c.normal;this.min=new GM.Vector3(b.min[0],b.min[1],b.min[2]);this.max=new GM.Vector3(b.max[0],b.max[1],b.max[2]);M.boundingBox&&(this.boundingBox=new GL.BoundingBox({min:this.min,max:this.max}));b.hasOwnProperty("axis")&&
(this.axis=b.axis,this.split=b.split,this.low={loading:!1,parent:this,path:this.path+"0"},this.high={loading:!1,parent:this,path:this.path+"1"});this.loading=!1;this.loadedAt=V.time;this.pointCount=b.count;this.nearDistance=Number.POSITIVE_INFINITY;this.nodeMap=e;this.nodeMap[this.path]=this;M.CloudNode.memoryUsed+=this.memoryUsed}clear(){this.low&&null!=this.low.points&&(this.low.clear(),this.low=null);this.high&&null!=this.high.points&&(this.high.clear(),this.high=null);for(name in this.buffers)this.buffers[name].clear();
this.points=this.points=null;delete this.nodeMap[this.path];M.CloudNode.memoryUsed-=this.memoryUsed}unload(){this.clear();let a=this.nodeMap[this.path.slice(0,-1)];a.low==this?a.low={loading:!1,parent:a,path:a.low.path}:a.high==this&&(a.high={loading:!1,parent:a,path:a.high.path})}render(a,b){b.setPointSize(a,1.62474487139*this.resolution);0<this.pointCount&&(b.bindBuffer(this.buffers),gl.drawArrays(gl.POINTS,0,this.pointCount));M.CloudNode.nodesRendered+=1;M.CloudNode.pointsRendered+=this.pointCount;
M.boundingBox&&M.boundingBox.push(this.boundingBox)}load(){null!=this.low.points||this.low.loading||(this.low.loading=this.model.schedulePacket(this.low));null!=this.high.points||this.high.loading||(this.high.loading=this.model.schedulePacket(this.high));return null!=this.low.points&&null!=this.high.points}kdIntersect(a,b,c,d,e,h,k,f){if(this.kdtree&&h<this.kdtree.length){var g,l=c[0]-b[0],n=c[1]-b[1],m=c[2]-b[2];l>=n&&l>=m&&(g=0);n>=l&&n>=m&&(g=1);m>=l&&m>=n&&(g=2);var q=this.kdtree[h];l=Math.floor((e+
d)/2);n=b.slice(0);m=c.slice(0);m[g]=q;var p=a.intersectMinMax(n,m);p&&p>k&&(p=null);b=b.slice(0);c=c.slice(0);b[g]=q;(g=a.intersectMinMax(b,c))&&g>k&&(g=null);if(null!=p&&null!=g){if(p<g)return d=this.kdIntersect(a,n,m,d,l,2*h+1,k,f),d.d===Number.POSITIVE_INFINITY?this.kdIntersect(a,b,c,l,e,2*h+2,k,f):d;e=this.kdIntersect(a,b,c,l,e,2*h+2,k,f);return e.d===Number.POSITIVE_INFINITY?this.kdIntersect(a,n,m,d,l,2*h+1,k,f):e}if(null!=p)return this.kdIntersect(a,n,m,d,l,2*h+1,k,f);if(null!=g)return this.kdIntersect(a,
b,c,l,e,2*h+2,k,f)}else{h=3.17*this.resolution*this.resolution;g=Number.POSITIVE_INFINITY;for(l=0;d<e;d++){c=this.points[3*d];n=this.points[3*d+1];m=this.points[3*d+2];b=c-a.origin.x;p=n-a.origin.y;q=m-a.origin.z;var r=b*a.direction.x+p*a.direction.y+q*a.direction.z;if(0<r&&r<k&&(b-=a.direction.x*r,p-=a.direction.y*r,q-=a.direction.z*r,b*b+p*p+q*q<h)){if(f){if(f.classes&&this.class&&f.classes[this.class[d]])continue;if(0!=f.clip[3]&&c*f.clip[0]+n*f.clip[1]+m*f.clip[2]<f.clip[3])continue;if(0!=f.clip[7]&&
c*f.clip[4]+n*f.clip[5]+m*f.clip[6]<f.clip[7])continue;if(0!=f.clip[11]&&c*f.clip[8]+n*f.clip[9]+m*f.clip[10]<f.clip[11])continue;if(0!=f.clip[15]&&c*f.clip[12]+n*f.clip[13]+m*f.clip[14]<f.clip[15])continue}r<g&&(g=r,l=d)}}return g==Number.POSITIVE_INFINITY?M.CloudNode.NO_INTERSECTION:{d:g,n:this.normals?this.normals[l]:523264,p:{x:this.points[3*l],y:this.points[3*l+1],z:this.points[3*l+2]}}}}intersect(a,b,c){var d=[this.min.x,this.min.y,this.min.z],e=[this.max.x,this.max.y,this.max.z],h=a.intersectMinMax(d,
e);h&&h>b&&(h=null);var k=M.CloudNode.NO_INTERSECTION;if(h)if(this.low&&this.low.points&&this.high&&this.high.points){let f;switch(this.axis){case 0:f=a.origin.x;break;case 1:f=a.origin.y;break;case 2:f=a.origin.z}f>this.split?(k=this.high.intersect(a,b,c),k==M.CloudNode.NO_INTERSECTION&&(k=this.low.intersect(a,b,c))):(k=this.low.intersect(a,b,c),k==M.CloudNode.NO_INTERSECTION&&(k=this.high.intersect(a,b,c)))}else k=this.kdIntersect(a,d,e,0,this.pointCount,0,b,c);return k}};
M.CloudNode.NO_INTERSECTION={d:Number.POSITIVE_INFINITY,n:0};M.CloudNode.memoryUsed=0;M.CloudNode.IN=1;M.CloudNode.OUT=-1;M.CloudNode.pointsRendered=0;M.CloudNode.nodesRendered=0;
M.Cloud=class extends V.Dataset{constructor(a,b){super(a);this.loadedCb=b;this.min=new GM.Vector3(this.root.min[0],this.root.min[1],this.root.min[2]);this.max=new GM.Vector3(this.root.max[0],this.root.max[1],this.root.max[2]);this.maxBuffers=50;this.maxLod=1E-5;this.loadingMap=new Set;this.nodeMap={};this.frustum=GM.Frustum.create();this.loadingQ=new V.Queue;this.loadingQ.enqueue({path:"n",loading:!0,parent:{path:null}});this.loadPacket();this.renderQ=new V.PriorityQueue(function(c,d){return c.distance-
d.distance});this.shader=new M.PointShader(this);this.shader.compile();V.recvMessage("cloud.point.max",c=>{c.id==this.id&&(this.maxBuffers=c.value,V.touch3d(),V.postMessage("cloud.point.max",c))})}unload(){this.loadingMap.forEach(function(a){V.stopLoading();a.abort()});this.node&&(this.node.clear(),this.node=null);this.shader.clear();V.touch3d()}packetProcessed(a){var b=a.data.config.path,c=new M.CloudNode(this,a.data.config,a.data.buffers,a.data.kdTree,this.nodeMap);if("n"===b)this.node=c,this.node.parent=
{},this.loadedCb(this.config);else if(a=this.nodeMap[a.data.parent])b===a.path+"0"?a.low=c:a.high=c,c.parent=a;V.touch3d();if(M.CloudNode.memoryUsed>M.MIN_MEM)for(b=new V.PriorityQueue(function(d,e){return d.gcPriority-e.gcPriority}),b.enqueue(this.node);!b.empty()&&!(c=b.dequeue(),a=!0,c.low&&c.low.points&&(c.low.gcPriority=GM.Frustum.farDistance(this.frustum,c.low),b.enqueue(c.low),a=!1),c.high&&c.high.points&&(c.high.gcPriority=GM.Frustum.farDistance(this.frustum,c.high),b.enqueue(c.high),a=!1),
a&&(a=this.nodeMap[c.path.slice(0,-1)])&&!GM.Frustum.intersectsBox(this.frustum,a)&&c.unload(),M.CloudNode.memoryUsed<M.MIN_MEM););}async packetReceived(a,b){b=b.currentTarget;this.loadingMap.delete(b);V.stopLoading();if(200===b.status||304===b.status){var c=new DataView(b.response),d=c.getUint32(0,!0),e=JSON.parse((new TextDecoder("utf-8")).decode(new Uint8Array(b.response,4,d)));d=4*Math.ceil((4+d)/4);var h=c.getUint32(d,!0);d+=4;var k=e.attributes;c={};for(var f=0;f<k.length;f++){var g=k[f];"float32"==
g.type?(c[g.name]=new Float32Array(b.response,d,h*g.size),d+=h*g.size*4):"uint8"==g.type?(c[g.name]=new Uint8Array(b.response,d,h*g.size),d+=h*g.size):"uint16"==g.type?(c[g.name]=new Uint16Array(b.response,d,h*g.size),d+=h*g.size*2):"INT_2_10_10_10_REV"==g.type&&(c[g.name]=new Int32Array(b.response,d,h*g.size),d+=h*g.size*4);d=4*Math.ceil(d/4)}h=null;k=(b.response.byteLength-d)/4;0<k&&(h=new Float32Array(b.response,d,k));e.memoryUsed=d;this.packetProcessed({data:{parent:a.parent.path,config:e,buffers:c,
kdTree:h}})}else a.loading=!1,401===b.status&&(this.url=await this.refreshToken());this.loadPacket()}async packetError(a,b){this.loadingMap.delete(b.currentTarget);V.stopLoading();a.loading=!1;this.url=await this.refreshToken();this.loadPacket()}loadPacket(){for(;4>this.loadingMap.size&&!this.loadingQ.empty();){var a=this.loadingQ.dequeue(),b=new XMLHttpRequest;b.open("GET",this.url.replace("%s",a.path),!0);b.responseType="arraybuffer";b.onerror=this.packetError.bind(this,a);b.onload=this.packetReceived.bind(this,
a);this.loadingMap.add(b);V.startLoading();try{b.send(null)}catch(c){console.log("Error loading point segment : "+c)}}}schedulePacket(a){return 8>this.loadingQ.size?(this.loadingQ.enqueue(a),this.loadPacket(),!0):!1}render(a){GM.Frustum.copy(a,this.frustum);var b=V.camera.projection;if(this.node){var c=new V.PriorityQueue(function(h,k){return h.splitPrio-k.splitPrio});c.enqueue(this.node);this.renderQ.clear();for(var d=this.maxBuffers-1;!c.empty();){var e=c.dequeue();d++;null!=e.low&&null!=e.high?
0<d-2?e.load()?(GM.Frustum.intersectsBox(a,e.low)&&(e.low.splitPrio=b==V3.PERSPECTIVE?e.low.nearDistance/e.low.resolution:1/e.low.resolution,e.low.distance=e.low.nearDistance,d--,c.enqueue(e.low)),GM.Frustum.intersectsBox(a,e.high)&&(e.high.splitPrio=b==V3.PERSPECTIVE?e.high.nearDistance/e.high.resolution:1/e.high.resolution,e.high.distance=e.high.nearDistance,d--,c.enqueue(e.high))):(this.renderQ.enqueue(e),d--):(this.renderQ.enqueue(e),d--):(this.renderQ.enqueue(e),d--)}}M.CloudNode.pointsRendered=
0;M.CloudNode.nodesRendered=0;this.shader.useProgram(V.camera);for(this.shader.enableBuffer();!this.renderQ.empty();)e=this.renderQ.dequeue(),e.render(V.camera,this.shader);this.shader.disableBuffer();if(M.boundingBox){for(a=0;a<M.boundingBox.length;a++)M.boundingBox[a].render(V.camera);M.boundingBox=[]}}raycast(a,b){if(this.node){let e=this.node.intersect(a,b.distance,{clip:this.shader.clipPlanes,classes:this.shader.excluded});if(e!=M.CloudNode.NO_INTERSECTION){b.distance=e.d;if(b.normal){a=e.n>>
0&1023;var c=e.n>>10&1023,d=e.n>>20&1023;b.normal={x:a&512?-(~a&511)+1:a,y:c&512?-(~c&511)+1:c,z:d&512?-(~d&511)+1:d}}b.xyz&&(b.xyz=e.p)}}}setViewpoint(a){null!=a&&(this.maxBuffers=a.maxBuffers||50,this.shader.setViewpoint(a.shader))}getViewpoint(){return{shader:this.shader.getViewpoint(),maxBuffers:this.maxBuffers}}};
</script>
<script id="/3d/cloud/shader.js">M.CloudShader=class extends GL.ShaderMVP{constructor(){super(M.CloudShader.vs,M.CloudShader.fs);this.scalar=1;this.clipPlanes=new Float32Array(16);this.clipPlanes.fill(0)}compile(){for(var a=this.clipPlanes,b=0;4>b;b++)a.length>=4*(b+1)&&0!=a[4*b+3]&&(this.config+="#define CLIP"+b+" "+a[4*b]+","+a[4*b+1]+","+a[4*b+2]+","+a[4*b+3]+"\n");super.compile();this.defineAttribute("position",3,gl.FLOAT,!1);this.screenH=gl.getUniformLocation(this.glId,"screenH");this.pointSize=gl.getUniformLocation(this.glId,
"pointSize");this.alpha=gl.getUniformLocation(this.glId,"alpha");this.ortho=gl.getUniformLocation(this.glId,"ortho")}useProgram(a){super.useProgram(a);gl.uniform1f(this.screenH,gl.drawingBufferHeight);a.projection==V3.ORTHOGRAPHIC?gl.uniform1f(this.ortho,1):gl.uniform1f(this.ortho,0)}setPointSize(a,b){a.projection==V3.ORTHOGRAPHIC?gl.uniform1f(this.pointSize,b*this.scalar*a.projection.zoom):gl.uniform1f(this.pointSize,b*this.scalar)}setAlpha(a){gl.uniform1f(this.alpha,a)}};M.CloudShader.vs="\nprecision mediump float;\nprecision mediump int;\n\nuniform mat4 modelViewMatrix; \nuniform mat4 projectionMatrix; \n\nuniform float pointSize;\nuniform float screenH;\nuniform float alpha;\nuniform float ortho;\n\n#if defined(COLOR_RGB)\n    attribute vec3 color;\n#elif defined(COLOR_INTENSITY)\n    uniform vec3 colors[3];\n    attribute float intensity;\n    uniform float maxi;\n    uniform float mini;\n#elif defined(COLOR_HEIGHT)\n    uniform vec3 colors[3];\n    uniform float maxh;\n    uniform float minh;\n#elif defined(COLOR_SLOPE)\n    uniform vec3 colors[3];\n#endif\n    \n#if defined(CLASS_FILTER)\n    uniform vec4 classes[19];\n    attribute float clazz;\n#endif\n\n#if defined(LIGHTING) || defined(COLOR_SLOPE) || defined(SLOPE_FILTER)  || defined(CLASS_FILTER)\n    attribute vec3 normal;\n#endif\n\n#if defined(SLOPE_FILTER)\n    uniform float slopeMin;\n    uniform float slopeMax;\n#endif\n\nattribute vec3 position;\n\nvarying vec4 pixelColor;\nvarying vec3 worldPosition;\nvarying float discarded;\n\nvoid main()\t\n{\n    float ambient;\n    vec3 vertexColor;\n    \n    discarded = 1.0;\n    #if defined(COLOR_RGB)\n    \n        vertexColor = color;\n        ambient = 0.4;\n        \n    #elif defined(COLOR_BW)\n    \n        vertexColor = vec3(1);\n        ambient = 0.0;\n        \n    #elif defined(COLOR_INTENSITY)\n    \n        float d = clamp(intensity, mini, maxi);\n        d = 2.99*(d-mini)/(maxi - mini);\n        int i = int(floor(d));\n        vertexColor = mix(colors[i], colors[i+1], fract(d));\n        ambient = 0.4;\n        \n    #elif defined(COLOR_HEIGHT)\n    \n        float d = clamp(position.y, minh, maxh);\n        d = 2.99*(d-minh)/(maxh - minh);\n        int i = int(floor(d));\n        vertexColor = vec3(mix(colors[i], colors[i+1], fract(d)));\n    \n    #elif defined(COLOR_SLOPE)\n    \n        float d = acos(abs(normal.y))/1.5700.309632679;\n        d = 3.0*d;\n        int i = int(floor(d));\n        vertexColor = vec3(mix(colors[i], colors[i+1], fract(d)));\n        \n    #endif\n    \n    #if defined(COLOR_CLASS)\n        \n        vec4 clazzColor = classes[int(clamp(clazz, 0.0, 18.0))];\n        vertexColor = vec3(clazzColor);\n        \n    #endif\n\n    // filtering\n    bool filtered = false;\n    \n    #if defined(SLOPE_FILTER)\n    if (!filtered)\n    {\n        float s = acos(abs(normal.y))/1.57079632679;\n        filtered = (s < slopeMin || s > slopeMax);\n    }\n    #endif\n    \n    #if defined(CLASS_FILTER)\n    if (!filtered)\n    {\n        vec4 clazzColor = classes[int(clamp(clazz, 0.0, 18.0))];\n        discarded = clazzColor[3];\n    }\n    #endif\n    \n\n    if (filtered)\n    {\n        vertexColor = vec3(0.8,0.8,0.8);\n        discarded = 0.0;\n    }\t\n\n    #if defined(LIGHTING)\n    {\n        mat3 normalMatrix = mat3(modelViewMatrix);\n    \n        vec3 light = vec3(0.0,0.0,1.0);\n        vec3 viewNormal = normalMatrix * normal;\n        float LdotN = max(abs(dot(light, viewNormal)), ambient);\n        \n        vertexColor = pow(vertexColor*vec3(LdotN), vec3(1.0/1.223));\n    }\n    #endif\n    \n    vec4 viewVertex = modelViewMatrix * vec4(position, 1.0 );\n\n    gl_Position = projectionMatrix * viewVertex;\n    \n    if (ortho == 1.0)\n    {\n        gl_PointSize = pointSize;\n    }\n    else\n    {\n        gl_PointSize = screenH*projectionMatrix[1][1]*pointSize/(-2.0*viewVertex.z);\n    }\n    \n    pixelColor = vec4(vertexColor, alpha);\n    worldPosition = position.xyz;\n}\n";
M.CloudShader.fs="precision mediump float;\nprecision mediump int;\n\nvarying vec4 pixelColor;\nvarying vec3 worldPosition;\nvarying float discarded;\n\nvoid main()\t\n{\n    if (discarded == 0.0)\n    {\n        discard;\n    }\n\n#if defined(CLIP0)\n    {\n        vec4 plane = vec4(CLIP0);\n        if (dot(worldPosition, plane.xyz) < plane.w)\n        {\n            discard;\n        }\n    }\n#endif\n#if defined(CLIP1)\n    {\n        vec4 plane = vec4(CLIP1);\n        if (dot(worldPosition, plane.xyz) < plane.w)\n        {\n            discard;\n        }\n    }\n#endif\n#if defined(CLIP2)\n    {\n        vec4 plane = vec4(CLIP2);\n        if (dot(worldPosition, plane.xyz) < plane.w)\n        {\n            discard;\n        }\n    }\n#endif\n#if defined(CLIP3)\n    {\n        vec4 plane = vec4(CLIP3);\n        if (dot(worldPosition, plane.xyz) < plane.w)\n        {\n            discard;\n        }\n    }\n#endif\n\n    vec2 coord = 2.0 * gl_PointCoord - 1.0;\n    if (dot(coord, coord) > 1.0)\n    {\n        discard;\n    }\n\n    gl_FragColor = pixelColor;\n}\n";
M.CloudShader.COLOR="COLOR_RGB";M.CloudShader.BW="COLOR_BW";M.CloudShader.INTENSITY="COLOR_INTENSITY";M.CloudShader.HEIGHT="COLOR_HEIGHT";M.CloudShader.SLOPE="COLOR_SLOPE";M.CloudShader.COLOR_CLASS="COLOR_CLASS";M.CloudShader.LIGHTING="LIGHTING";M.CloudShader.SLOPE_FILTER="SLOPE_FILTER";M.CloudShader.CLASS_FILTER="CLASS_FILTER";
M.PointShader=class extends M.CloudShader{constructor(a){super();this.dataset=a;this.defines[M.CloudShader.LIGHTING]=!1;this.defines[M.CloudShader.COLOR_CLASS]=!1;this.defines[M.CloudShader.INTENSITY]=!1;this.defines[M.CloudShader.BW]=!1;this.defines[M.CloudShader.COLOR]=!1;this.defines[M.CloudShader.SLOPE]=!1;this.defines[M.CloudShader.HEIGHT]=!1;this.defines[M.CloudShader.SLOPE_FILTER]=!1;this.defines[M.CloudShader.CLASS_FILTER]=!1;this.uniforms={height:{min:0,max:1},slope:{min:0,max:1},intensity:{min:0,
max:1},classes:[0,0,1,1,0,1,0,1,.619,.498,.427,1,.309,.466,.247,1,.129,.537,.129,1,.807,.937,.749,1,.537,0,.098,1,.537,.537,.537,1,.537,.537,.537,1,.247,.639,.866,1,.38,.38,.38,1,.537,.537,.537,1,.537,.537,.537,1,.537,.537,.537,1,.537,.537,.537,1,.537,.537,.537,1,.537,.537,.537,1,.537,.537,.537,1,1,1,1,1],colors:[0,1,0,0,0,1,1,0,0]};this.excluded=Array(18).fill(!1);this.options={};for(a=0;a<this.dataset.root.attributes.length;a++)this.options[this.dataset.root.attributes[a].name]=this.dataset.root.attributes[a];
null!=this.options.color?this.defines[M.CloudShader.COLOR]=!0:null!=this.options["class"]?(this.defines[M.CloudShader.COLOR_CLASS]=!0,this.defines[M.CloudShader.LIGHTING]=!0):null!=this.options.intensity?(this.defines[M.CloudShader.INTENSITY]=!0,this.defines[M.CloudShader.LIGHTING]=!0):null!=this.options.normal&&(this.defines[M.CloudShader.BW]=!0,this.defines[M.CloudShader.LIGHTING]=!0);this.options["class"]&&(this.defines[M.CloudShader.CLASS_FILTER]=!0);V.recvMessage("cloud.shader.update",b=>{if(b.id==
this.dataset.id){"undefined"!=typeof b.lighting&&(this.defines[M.CloudShader.LIGHTING]=b.lighting,this.compile());b.hasOwnProperty("mode")&&(this.defines[M.CloudShader.COLOR_CLASS]=!1,this.defines[M.CloudShader.INTENSITY]=!1,this.defines[M.CloudShader.BW]=!1,this.defines[M.CloudShader.COLOR]=!1,this.defines[M.CloudShader.SLOPE]=!1,this.defines[M.CloudShader.HEIGHT]=!1,this.defines[b.mode]=!0,this.defines[M.CloudShader.LIGHTING]=b.mode==M.CloudShader.COLOR?!1:!0,this.compile());if(b.slope){var d=this.defines[M.CloudShader.SLOPE_FILTER];
this.defines[M.CloudShader.SLOPE_FILTER]=0!=b.slope.min||1!=b.slope.max;this.uniforms.slope=b.slope;d!=this.defines[M.CloudShader.SLOPE_FILTER]?this.compile():this.defines[M.CloudShader.SLOPE_FILTER]&&(gl.useProgram(this.glId),gl.uniform1f(this.slopeMin,b.slope.min),gl.uniform1f(this.slopeMax,b.slope.max),gl.useProgram(null))}b.clipPlanes&&(this.clipPlanes.set(b.clipPlanes),this.compile());b.classes&&(b.classes.forEach(c=>{this.uniforms.classes[4*c.index+3]=c.state?1:0;this.excluded[c.index]=!c.state}),
this.defines[M.CloudShader.CLASS_FILTER]&&(gl.useProgram(this.glId),gl.uniform4fv(this.classes,new Float32Array(this.uniforms.classes)),gl.useProgram(null)));V.touch3d();V.postMessage("cloud.shader.update",this.getViewpoint())}});V.recvMessage("cloud.point.scale",b=>{b.id==this.dataset.id&&(this.scalar=b.value,V.postMessage("cloud.point.scale",b),V.touch3d())})}setViewpoint(a){this.scalar=a.scalar;Object.assign(this.uniforms,a.uniforms);Object.assign(this.defines,a.defines);a.defines.COLOR_CLASS&&
!a.defines.hasOwnProperty("CLASS_FILTER")&&(this.defines[M.CloudShader.CLASS_FILTER]=!0,this.defines[M.CloudShader.COLOR_CLASS]=!1);a.clipPlanes&&this.clipPlanes.set(a.clipPlanes);this.compile()}getViewpoint(){return{uniforms:this.uniforms,defines:this.defines,scalar:this.scalar,clipPlanes:Array.from(this.clipPlanes)}}compile(){super.compile();this.defines[M.CloudShader.COLOR]?this.defineAttribute("color",3,gl.UNSIGNED_BYTE,!0):this.defines[M.CloudShader.INTENSITY]?(this.defineAttribute("intensity",
1,gl.UNSIGNED_SHORT,!0),this.colors=gl.getUniformLocation(this.glId,"colors"),this.mini=gl.getUniformLocation(this.glId,"mini"),this.maxi=gl.getUniformLocation(this.glId,"maxi")):this.defines[M.CloudShader.HEIGHT]?(this.colors=gl.getUniformLocation(this.glId,"colors"),this.minh=gl.getUniformLocation(this.glId,"minh"),this.maxh=gl.getUniformLocation(this.glId,"maxh")):this.defines[M.CloudShader.SLOPE]&&(this.colors=gl.getUniformLocation(this.glId,"colors"));this.defines[M.CloudShader.CLASS_FILTER]&&
(this.defineAttribute("class",1,gl.UNSIGNED_BYTE,!1,"clazz"),this.classes=gl.getUniformLocation(this.glId,"classes"));if(this.defines[M.CloudShader.LIGHTING]||this.defines[M.CloudShader.SLOPE]||this.defines[M.CloudShader.SLOPE_FILTER])"float32"==this.options.normal.type?this.defineAttribute("normal",3,gl.FLOAT,!1):"INT_2_10_10_10_REV"==this.options.normal.type&&this.defineAttribute("normal",4,gl.INT_2_10_10_10_REV,!0);this.defines[M.CloudShader.SLOPE_FILTER]&&(this.slopeMin=gl.getUniformLocation(this.glId,
"slopeMin"),this.slopeMax=gl.getUniformLocation(this.glId,"slopeMax"));gl.useProgram(this.glId);this.defines[M.CloudShader.INTENSITY]?(gl.uniform3fv(this.colors,new Float32Array(this.uniforms.colors)),gl.uniform1f(this.mini,this.uniforms.intensity.min),gl.uniform1f(this.maxi,this.uniforms.intensity.max)):this.defines[M.CloudShader.HEIGHT]?(gl.uniform3fv(this.colors,new Float32Array(this.uniforms.colors)),gl.uniform1f(this.minh,V.viewer.aabb.min.y),gl.uniform1f(this.maxh,V.viewer.aabb.max.y)):this.defines[M.CloudShader.SLOPE]&&
gl.uniform3fv(this.colors,new Float32Array(this.uniforms.colors));if(this.defines[M.CloudShader.CLASS_FILTER]){gl.uniform4fv(this.classes,new Float32Array(this.uniforms.classes));for(var a=0;a<this.uniforms.classes.length/4;a++)this.excluded[a]=!this.uniforms.classes[4*a+3]}this.defines[M.CloudShader.SLOPE_FILTER]&&(gl.uniform1f(this.slopeMin,this.uniforms.slope.min),gl.uniform1f(this.slopeMax,this.uniforms.slope.max));gl.useProgram(null);V.touch3d()}};
</script>
<script id="/3d/model/model.js">M.Mesh=class{constructor(a){this.name=a.name;this.attributes=["aPosition"];this.aPosition=new GL.ArrayBuffer(a.vertex.data);void 0!=a.normal&&(this.attributes.push("aNormal"),this.aNormal=new GL.ArrayBuffer(a.normal.data));void 0!=a.tangent&&(this.attributes.push("aTangent"),this.aTangent=new GL.ArrayBuffer(a.tangent.data));void 0!=a.color&&(this.attributes.push("aColor"),this.aColor=new GL.ArrayBuffer(a.color.data));void 0!=a.uv&&(this.attributes.push("aUv"),this.aUv=new GL.ArrayBuffer(a.uv.data));
this.vertex=a.vertex.data;this.bvh=a.bvh}clear(){for(var a in this.attributes)this[this.attributes[a]].clear()}setAttribute(a,b){this.attributes.push(a);this[a]=b}hitTestTriangle1(a,b){b.v0v1.subVectors(b.v1,b.v0);b.v0v2.subVectors(b.v2,b.v0);b.pvec.crossVectors(a.direction,b.v0v2);var c=b.v0v1.dot(b.pvec);if(1E-9>Math.abs(c))return Number.POSITIVE_INFINITY;c=1/c;b.tvec.subVectors(a.origin,b.v0);var d=b.tvec.dot(b.pvec)*c;if(0>d||1<d)return Number.POSITIVE_INFINITY;b.qvec.crossVectors(b.tvec,b.v0v1);
a=a.direction.dot(b.qvec)*c;if(0>a||1<d+a)return Number.POSITIVE_INFINITY;b=b.v0v2.dot(b.qvec)*c;return 0>b?Number.POSITIVE_INFINITY:b}raycast(a,b,c){let d=-1;if(this.bvh){var f=new V.Queue;for(a.intersectBox(this.bvh)&&f.enqueue(this.bvh);!f.empty();){var e=f.dequeue();if(null!=e.childL){var g=a.intersectBox(e.childL);g&&g.distance<b.distance&&f.enqueue(e.childL)}null!=e.childH&&(g=a.intersectBox(e.childH))&&g.distance<b.distance&&f.enqueue(e.childH);for(g=e.i0;g<e.iN;g++)if(!c||!c(g)){M.Mesh.V1.v0.readArray(this.vertex,
9*g);M.Mesh.V1.v1.readArray(this.vertex,9*g+3);M.Mesh.V1.v2.readArray(this.vertex,9*g+6);var l=this.hitTestTriangle1(a,M.Mesh.V1);l<b.distance&&(b.distance=l,b.normal&&GM.Vector3.cross(M.Mesh.V1.v0v1,M.Mesh.V1.v0v2,b.normal),d=g)}}}return d}createBoxes(a){var b=new V.Queue;for(b.enqueue(a);!b.empty();)a=b.dequeue(),null!=a.childL&&b.enqueue(a.childL),null!=a.childH&&b.enqueue(a.childH),a.vis=new GL.BoundingBox(a)}renderBoxes(a){var b=new V.Queue;for(b.enqueue(a);!b.empty();)a=b.dequeue(),null!=a.childL&&
b.enqueue(a.childL),null!=a.childH&&b.enqueue(a.childH),a.vis.render()}};M.Mesh.V1={v0:new GM.Vector3,v1:new GM.Vector3,v2:new GM.Vector3,v0v1:new GM.Vector3,v0v2:new GM.Vector3,pvec:new GM.Vector3,tvec:new GM.Vector3,qvec:new GM.Vector3};
M.InstancedNode=class{constructor(a,b,c){this.geometry=b[a.geometry];this.aabb=a.aabb;this.min=a.min;this.max=a.max;this.id=a.id;c[this.id]=this;this.matrixMemory=a.matrix;this.inverse=[];this.matrix=[];this.matrixBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,this.matrixBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.matrixMemory,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,null)}render(a){gl.bindBuffer(gl.ARRAY_BUFFER,this.matrixBuffer);gl.vertexAttribPointer(4,4,gl.FLOAT,gl.FALSE,64,0);gl.vertexAttribPointer(5,
4,gl.FLOAT,gl.FALSE,64,16);gl.vertexAttribPointer(6,4,gl.FLOAT,gl.FALSE,64,32);gl.vertexAttribPointer(7,4,gl.FLOAT,gl.FALSE,64,48);a.bind(this.geometry);gl.drawArraysInstanced(gl.TRIANGLES,0,this.geometry.aPosition.length/3,this.matrixMemory.length/16);a.unbind(this.geometry)}doSelect(a){this.selectionBuffer||(this.selectionBuffer=gl.createBuffer());for(var b=new Float32Array(16*a.length),c=0;c<a.length;c++)b.set(this.matrixMemory.slice(16*a[c],16*(a[c]+1)),16*c);gl.bindBuffer(gl.ARRAY_BUFFER,this.selectionBuffer);
gl.bufferData(gl.ARRAY_BUFFER,b,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,null);return 0<b.length}doHide(a){for(var b=0;b<a.length;b++)this.matrixMemory[16*a[b]+15]=0;gl.bindBuffer(gl.ARRAY_BUFFER,this.matrixBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.matrixMemory,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,null)}doShow(a){if(a)for(var b=0;b<a.length;b++)this.matrixMemory[16*a[b]+15]=1;else for(b=0;b<this.aabb.length;b++)this.matrixMemory[16*b+15]=1;gl.bindBuffer(gl.ARRAY_BUFFER,this.matrixBuffer);
gl.bufferData(gl.ARRAY_BUFFER,this.matrixMemory,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,null)}renderSelection(a){gl.bindBuffer(gl.ARRAY_BUFFER,this.selectionBuffer);gl.vertexAttribPointer(4,4,gl.FLOAT,gl.FALSE,64,0);gl.vertexAttribPointer(5,4,gl.FLOAT,gl.FALSE,64,16);gl.vertexAttribPointer(6,4,gl.FLOAT,gl.FALSE,64,32);gl.vertexAttribPointer(7,4,gl.FLOAT,gl.FALSE,64,48);a.bind(this.geometry);gl.drawArraysInstanced(gl.TRIANGLES,0,this.geometry.aPosition.length/3,1);a.unbind(this.geometry)}raycast(a,
b){var c=a.intersectBox(this);if(c&&c.distance<b.distance)for(c=0;c<this.aabb.length;c++)1==this.matrixMemory[16*c+15]&&a.intersectBox(this.aabb[c])&&(this.inverse[c]||(this.matrix[c]=GM.Matrix4.init(this.matrixMemory.slice(16*c,16*(c+1))),this.inverse[c]=GM.Matrix4.invert(this.matrix[c],GM.Matrix4.create())),GM.Ray.transform(a,this.inverse[c],M.InstancedNode.ray),-1!=this.geometry.raycast(M.InstancedNode.ray,b)&&(b.normal&&GM.Vector3.rotate(b.normal,this.matrix[c],b.normal),b.xyz&&(b.xyz=a.at(b.distance,
b.xyz)),b.object=this.id,b.parts=[c]))}clear(){gl.deleteBuffer(this.matrixBuffer)}getAABB(a){let b=GL.BoundingBox.init({});for(var c=0;c<a.length;c++)GL.BoundingBox.merge(b,this.aabb[a[c]]);return b}getHidden(a){let b=[];for(var c=0;c<this.aabb.length;c++)0==this.matrixMemory[16*c+15]&&b.push(c);b.length&&(a[this.id]=b)}setHidden(a){for(var b=0;b<this.aabb.length;b++)this.matrixMemory[16*b+15]=1;if(a.hidden)for(b=0;b<a.hidden.length;b++)this.matrixMemory[16*a.hidden[b]+15]=0;gl.bindBuffer(gl.ARRAY_BUFFER,
this.matrixBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.matrixMemory,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,null)}};M.InstancedNode.ray=new GM.Ray;
M.CombinedNode=class{constructor(a,b,c){this.geometry=b[a.geometry];this.index=a.index;this.min=a.min;this.max=a.max;this.id=a.id;this.visible=!0;c[this.id]=this;this.matrixBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,this.matrixBuffer);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,null);this.partCount=a.parts;this.partCount||(this.partCount=0,this.index.forEach(d=>this.partCount=Math.max(this.partCount,d+
1)));this.partIndex={};this.hidden=new Set}render(a){this.visible&&(gl.bindBuffer(gl.ARRAY_BUFFER,this.matrixBuffer),gl.vertexAttribPointer(4,4,gl.FLOAT,gl.FALSE,64,0),gl.vertexAttribPointer(5,4,gl.FLOAT,gl.FALSE,64,16),gl.vertexAttribPointer(6,4,gl.FLOAT,gl.FALSE,64,32),gl.vertexAttribPointer(7,4,gl.FLOAT,gl.FALSE,64,48),a.bind(this.geometry),this.hidden.size?(gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer),gl.drawElementsInstanced(gl.TRIANGLES,this.indexCount,gl.UNSIGNED_INT,0,1)):gl.drawArraysInstanced(gl.TRIANGLES,
0,this.geometry.aPosition.length/3,1),a.unbind(this.geometry))}updateIndex(){if(0<this.hidden.size){this.indexBuffer||(this.indexBuffer=gl.createBuffer());for(var a=[],b=0;b<this.partCount;b++)this.hidden.has(b)||a.push(...this.getPart(b));this.indexCount=a.length;gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint32Array(a),gl.STATIC_DRAW)}else this.indexCount=0}doSelect(a){for(var b=[],c=0;c<a.length;c++)b.push(...this.getPart(a[c]));this.selectionCount=
b.length;this.selectionBuffer||(this.selectionBuffer=gl.createBuffer());gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.selectionBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint32Array(b),gl.STATIC_DRAW);return 0<b.length}doHide(a){for(var b=0;b<this.partCount;b++)a.includes(b)&&this.hidden.add(b);this.updateIndex()}doShow(a){if(a)for(var b=0;b<this.partCount;b++)a.includes(b)&&this.hidden.delete(b);else this.hidden.clear();this.updateIndex()}getHidden(a){this.hidden.size&&(a[this.id]=Array.from(this.hidden))}setHidden(a){this.hidden.clear();
a[this.id]&&(this.hidden=new Set(a[this.id]));this.updateIndex()}renderSelection(a){gl.bindBuffer(gl.ARRAY_BUFFER,this.matrixBuffer);gl.vertexAttribPointer(4,4,gl.FLOAT,gl.FALSE,64,0);gl.vertexAttribPointer(5,4,gl.FLOAT,gl.FALSE,64,16);gl.vertexAttribPointer(6,4,gl.FLOAT,gl.FALSE,64,32);gl.vertexAttribPointer(7,4,gl.FLOAT,gl.FALSE,64,48);a.bind(this.geometry);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.selectionBuffer);gl.drawElementsInstanced(gl.TRIANGLES,this.selectionCount,gl.UNSIGNED_INT,0,1);
a.unbind(this.geometry)}raycast(a,b){if(a.intersectBox(this)){let c=this.geometry.raycast(a,b,d=>this.hidden.has(this.index[d]));-1!=c&&(b.object=this.id,b.parts=[this.index[c]],b.xyz&&(b.xyz=a.at(b.distance,b.xyz)))}}clear(){gl.deleteBuffer(this.matrixBuffer)}getPart(a){if(!this.partIndex[a]){let c=[];for(var b=0;b<this.index.length;b++)this.index[b]==a&&(c.push(3*b),c.push(3*b+1),c.push(3*b+2));this.partIndex[a]=c}return this.partIndex[a]}getAABB(a){let b=GL.BoundingBox.init({});for(var c=0;c<a.length;c++)for(var d=
0;d<this.index.length;d++)if(this.index[d]==a[c]){var f=3*d,e=3*d+1,g=3*d+2;GL.BoundingBox.grow(b,{x:this.geometry.vertex[3*f],y:this.geometry.vertex[3*f+1],z:this.geometry.vertex[3*f+2]});GL.BoundingBox.grow(b,{x:this.geometry.vertex[3*e],y:this.geometry.vertex[3*e+1],z:this.geometry.vertex[3*e+2]});GL.BoundingBox.grow(b,{x:this.geometry.vertex[3*g],y:this.geometry.vertex[3*g+1],z:this.geometry.vertex[3*g+2]})}return b}};
M.MaterialNode=class{constructor(a,b,c,d){this.material=c[a.material];this.min=a.min;this.max=a.max;this.instanced=[];for(c=0;c<a.instance.length;c++)this.instanced.push(new M.InstancedNode(a.instance[c],b,d));a.combined&&(this.combined=new M.CombinedNode(a.combined,b,d))}render(){this.material.use();for(var a=0;a<this.instanced.length;a++)this.instanced[a].render(this.material),this.material.doubleSided&&(gl.cullFace(gl.FRONT),this.instanced[a].render(this.material),gl.cullFace(gl.BACK));this.combined&&
(this.combined.render(this.material),this.material.doubleSided&&(gl.cullFace(gl.FRONT),this.combined.render(this.material),gl.cullFace(gl.BACK)))}raycast(a,b){let c=a.intersectBox(this);c&&c.distance<b.distance&&(this.instanced.forEach(d=>d.raycast(a,b)),this.combined&&this.combined.raycast(a,b))}clear(){this.instanced.forEach(a=>a.clear());this.combined&&this.combined.clear()}renderSelection(a){for(var b=0;b<this.instanced.length;b++)this.instanced[b].render(a),this.material.doubleSided&&(gl.cullFace(gl.FRONT),
this.instanced[b].render(a),gl.cullFace(gl.BACK));this.combined&&(this.combined.render(a),this.material.doubleSided&&(gl.cullFace(gl.FRONT),this.combined.render(a),gl.cullFace(gl.BACK)))}getAABB(a){return this}};
M.InternalNode=class{constructor(a,b,c,d){this.min=a.min;this.max=a.max;this.hidden=!1;this.id=a.id;d[this.id]=this;this.internal=[];for(var f=0;f<a.internal.length;f++)this.internal.push(new M.InternalNode(a.internal[f],b,c,d));this.blendStart=a.material.length;this.material=[];for(f=0;f<a.material.length;f++){var e=new M.MaterialNode(a.material[f],b,c,d);e.material.mode==M.Material.BLEND&&this.blendStart==a.material.length&&(this.blendStart=f);this.material.push(e)}}render(a){if(!this.hidden){for(var b=
0;b<this.internal.length;b++)this.internal[b].render(a);if(a==M.Material.OPAQUE)for(b=0;b<this.blendStart;b++)this.material[b].render();else if(a==M.Material.BLEND)for(b=this.blendStart;b<this.material.length;b++)this.material[b].render()}}renderSelection(a){this.internal.forEach(c=>c.renderSelection(a));for(var b=0;b<this.blendStart;b++)this.material[b].renderSelection(a);for(b=this.blendStart;b<this.material.length;b++)this.material[b].renderSelection(a)}raycast(a,b){if(!this.hidden){let c=a.intersectBox(this);
c&&c.distance<b.distance&&(this.internal.forEach(d=>d.raycast(a,b)),this.material.forEach(d=>d.raycast(a,b)))}}clear(){this.internal.forEach(a=>a.clear());this.material.forEach(a=>a.clear())}doSelect(){return!0}doHide(){this.hidden=!0}doShow(){this.hidden=!1}getAABB(a){return this}getHidden(a){this.hidden&&(a[this.id]=!0)}setHidden(a){this.hidden="undefined"!=typeof a[this.id]?a[this.id]:!1}};
M.Model=class extends V.Dataset{constructor(a,b){super(a);this.loadedCb=b;fetch(this.url.replace("%s","model.bin")).then(async d=>{this.createTree(await d.arrayBuffer())});this.min=new GM.Vector3(this.root.min.x,this.root.min.y,this.root.min.z);this.max=new GM.Vector3(this.root.max.x,this.root.max.y,this.root.max.z);a=[];for(b=0;b<this.root.images.length;b++){var c=new GL.ImageLoader;c.listen(this);a.push(c)}this.textures=[];for(b=0;b<this.root.textures.length;b++)this.textures.push(new GL.Texture(a[this.root.textures[b].source],
this.root.samplers[this.root.textures[b].sampler],this.root.images[this.root.textures[b].source].uri));for(b=0;b<a.length;b++)a[b].load(this.url.replace("%s",`${this.root.images[b].uri}`));this.selection=new Set;M.Model.selectedMaterial||(M.Model.selectedMaterial=new M.IfcSurfaceStyle({surfaceColor:{r:0,g:1,b:0,a:.5}}));V.recvMessage("node.select",d=>{if(d[this.id]){let e=d[this.id];for(var f in e)this.registry[f].doSelect(e[f])?this.selection.add(f):this.selection.delete(f);V.postMessage("node.select",
d);V.touch3d()}});V.recvMessage("*.unselect",d=>{this.selection.clear();V.touch3d()});V.recvMessage("node.unselect",d=>{d.hasOwnProperty(this.id)&&this.selection.clear()});V.recvMessage("node.hide",d=>{if(d[this.id]){let e=d[this.id];for(var f in e)this.registry[f].doHide(e[f]);V.postMessage("node.hide",d);V.touch3d()}});V.recvMessage("node.show",d=>{if(d[this.id]){let e=d[this.id];for(var f in e)this.registry[f].doShow(e[f]);V.postMessage("node.show",d);V.touch3d()}});V.recvMessage("node.focus",
d=>{d.hasOwnProperty(this.id)&&(d[this.id]?this.focalNode=this.registry[d[this.id]]:delete this.focalNode,V.touch3d())});V.recvMessage("node.aabb.get",d=>{if(d[this.id]){var f=GL.BoundingBox.init({});d=d[this.id];for(var e in d)GL.BoundingBox.merge(f,this.registry[e].getAABB(d[e]));V.postMessage("node.aabb.get",f)}});V.recvMessage("model.hierarchy.get",d=>{d.id&&d.id!=this.id||this.model&&V.postMessage("model.hierarchy.get",this.model.hierarchy)});V.recvMessage("model.materials.get",d=>{d.id==this.id&&
V.postMessage("model.materials.get",this.model.materials)});V.recvMessage("model.reset",d=>{if(d.id==this.id){delete this.focalNode;this.selection.clear();for(let f in this.registry)this.registry[f].doShow()}})}unload(){this.materials.forEach(a=>a.clear());this.geometries.forEach(a=>a.clear());this.rootNode&&this.rootNode.clear();V.touch3d()}notify(){V.touch3d()}createTree(a){var b=(new DataView(a)).getUint32(0,!0);let c=JSON.parse((new TextDecoder("utf-8")).decode(new Uint8Array(a,4,b))),d=b+4;b%
4&&(d+=4-b%4);this.materials=[];for(b=0;b<c.materials.length;b++)"LineMaterial"==c.materials[b].type?this.materials.push(new M.LineMaterial(c.materials[b])):"PbrMaterial"==c.materials[b].type?this.materials.push(new M.PbrMaterial(c.materials[b],this.textures)):"IfcSurfaceStyle"==c.materials[b].type&&this.materials.push(new M.IfcSurfaceStyle(c.materials[b],this.textures));this.geometries=[];c.geometries.forEach(e=>{if(e.bvh){var g=(new TextDecoder("utf-8")).decode(new Uint8Array(a,d+e.vertex.offset+
4*e.vertex.size,e.bvh));e.bvh=JSON.parse(g)}e.vertex.data=new Float32Array(a,d+e.vertex.offset,e.vertex.size);e.normal&&(e.normal.data="float32"==e.normal.type||"float"==e.normal.type?new Float32Array(a,d+e.normal.offset,e.normal.size):new Int32Array(a,d+e.normal.offset,e.normal.size));e.tangent&&(e.tangent.data=new Float32Array(a,d+e.tangent.offset,e.tangent.size));e.uv&&(e.uv.data=new Float32Array(a,d+e.uv.offset,e.uv.size));this.geometries.push(new M.Mesh(e))});let f=(e,g,l)=>{for(var h=0;h<e.internal.length;h++)f(e.internal[h],
g,l);for(h=0;h<e.material.length;h++){var m=e.material[h],p=g,q=l;if(m.combined){var k=m.combined;k.index=new Uint32Array(p,q+k.index.offset,k.index.size)}for(k=0;k<m.instance.length;k++){var n=m.instance[k];n.matrix=new Float32Array(p,q+n.matrix.offset,n.matrix.size)}}};f(c.internal,a,d);this.registry={};this.rootNode=new M.InternalNode(c.internal,this.geometries,this.materials,this.registry);V.touch3d();this.model=c;this.loadedCb(this.config)}setViewpoint(a){if(a){for(let b in this.registry)this.registry[b].setHidden(a.hidden);
a&&a.focal?this.focalNode=this.registry[a.focal]:delete this.focalNode}else{for(let b in this.registry)this.registry[b].setHidden({});delete this.focalNode}}getViewpoint(){var a={hidden:{},focal:this.focalNode?this.focalNode.id:null};for(let b in this.registry)this.registry[b].getHidden(a.hidden);return a}render(a){GL.Shader.glId=null;if(null!=this.rootNode&&(gl.blendFuncSeparate(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA,gl.ONE,gl.ONE_MINUS_SRC_ALPHA),gl.blendEquation(gl.FUNC_ADD),gl.disable(gl.BLEND),
gl.enableVertexAttribArray(4),gl.enableVertexAttribArray(5),gl.enableVertexAttribArray(6),gl.enableVertexAttribArray(7),gl.vertexAttribDivisor(4,1),gl.vertexAttribDivisor(5,1),gl.vertexAttribDivisor(6,1),gl.vertexAttribDivisor(7,1),this.focalNode?(this.focalNode.render(M.Material.OPAQUE),gl.enable(gl.BLEND),this.focalNode.render(M.Material.BLEND)):(this.rootNode.render(M.Material.OPAQUE),gl.enable(gl.BLEND),this.rootNode.render(M.Material.BLEND)),gl.disable(gl.BLEND),this.selection.size&&(M.Model.selectedMaterial.use(),
gl.disable(gl.DEPTH_TEST),gl.enable(gl.BLEND),this.selection.forEach(b=>{this.registry[b].renderSelection(M.Model.selectedMaterial)}),gl.disable(gl.BLEND),gl.enable(gl.DEPTH_TEST)),gl.disableVertexAttribArray(4),gl.disableVertexAttribArray(5),gl.disableVertexAttribArray(6),gl.disableVertexAttribArray(7),gl.disable(gl.BLEND),M.Model.boundingBox))for(a=0;a<M.Model.boundingBox.length;a++)M.Model.boundingBox[a].render(V.camera)}raycast(a,b){this.rootNode&&(this.focalNode?this.focalNode.raycast(a,b):this.rootNode.raycast(a,
b))}renderBox(){this.boundingBox&&this.boundingBox.render(V.camera)}};
M.Deleted=function(a){this.position=new GL.ArrayBuffer(new Float32Array([a.min.x,a.min.y,a.min.z,a.max.x,a.min.y,a.min.z,a.max.x,a.min.y,a.min.z,a.max.x,a.max.y,a.min.z,a.max.x,a.max.y,a.min.z,a.min.x,a.max.y,a.min.z,a.min.x,a.max.y,a.min.z,a.min.x,a.min.y,a.min.z,a.min.x,a.min.y,a.max.z,a.max.x,a.min.y,a.max.z,a.max.x,a.min.y,a.max.z,a.max.x,a.max.y,a.max.z,a.max.x,a.max.y,a.max.z,a.min.x,a.max.y,a.max.z,a.min.x,a.max.y,a.max.z,a.min.x,a.min.y,a.max.z,a.min.x,a.min.y,a.min.z,a.min.x,a.min.y,a.max.z,
a.min.x,a.max.y,a.min.z,a.min.x,a.max.y,a.max.z,a.max.x,a.max.y,a.min.z,a.max.x,a.max.y,a.max.z,a.max.x,a.min.y,a.min.z,a.max.x,a.min.y,a.max.z]));this.color=new GL.ArrayBuffer(new Uint8Array([255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0]));M.Deleted.shader||(M.Deleted.shader=new GL.LineShader,M.Deleted.shader.compile())};
M.Deleted.prototype.render=function(a){M.Deleted.shader.useProgram(V.camera);gl.disable(gl.DEPTH_TEST);M.Deleted.shader.enableBuffer(this);M.Deleted.shader.bindBuffer(this);gl.drawArrays(gl.LINES,0,24);M.Deleted.shader.disableBuffer(this);gl.enable(gl.DEPTH_TEST)};M.Deleted.prototype.setColor=function(a,b,c){this.color=new GL.ArrayBuffer(new Uint8Array([a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c]))};
M.Deleted.prototype.clear=function(){this.position.clear();this.color.clear()};
</script>
<script id="/3d/model/shader.js">M.Material=class{constructor(a){this.shader=a;this.mode=M.Material.OPAQUE}use(){this.shader.isActive()||this.shader.useProgram(V.camera);this.shader.bindMaterial(this)}bind(a){this.shader.enableBuffer(a);this.shader.bindBuffer(a)}unbind(a){this.shader.disableBuffer(a)}clear(){}};M.Material.OPAQUE=1;M.Material.BLEND=2;M.Material.MASK=3;
M.PbrMaterial=class extends M.Material{constructor(a,b){super(M.PbrShader.get());this.controlV=new Int32Array(new ArrayBuffer(this.shader.controlSize));this.controlV[0]=0;this.controlV[1]=0;this.controlV[2]=0;this.controlV[3]=0;this.controlV[4]=0;this.controlUB=gl.createBuffer();this.metallicV=new Float32Array(new ArrayBuffer(this.shader.metallicSize));this.metallicUB=gl.createBuffer();this.textures=b;this.update(a)}update(a){if(a.pbrMetallicRoughness){a.pbrMetallicRoughness.baseColorFactor?(this.metallicV[0]=
a.pbrMetallicRoughness.baseColorFactor[0],this.metallicV[1]=a.pbrMetallicRoughness.baseColorFactor[1],this.metallicV[2]=a.pbrMetallicRoughness.baseColorFactor[2],this.metallicV[3]=a.pbrMetallicRoughness.baseColorFactor[3]):(this.metallicV[0]=1,this.metallicV[1]=1,this.metallicV[2]=1,this.metallicV[3]=1);a.emissiveFactor?(this.metallicV[4]=a.emissiveFactor[0],this.metallicV[5]=a.emissiveFactor[1],this.metallicV[6]=a.emissiveFactor[2],this.metallicV[7]=1):(this.metallicV[4]=0,this.metallicV[5]=0,this.metallicV[6]=
0,this.metallicV[7]=0);this.doubleSided=a.doubleSided;this.metallicV[8]=void 0!=a.pbrMetallicRoughness.roughnessFactor?a.pbrMetallicRoughness.roughnessFactor:1;this.metallicV[9]=void 0!=a.pbrMetallicRoughness.metallicFactor?a.pbrMetallicRoughness.metallicFactor:1;a.alphaMode&&("MASK"==a.alphaMode?(this.mode=M.Material.MASK,this.metallicV[10]=a.alphaCutoff?a.alphaCutoff:.5):"BLEND"==a.alphaMode&&(this.mode=M.Material.BLEND));this.controlV[5]=this.mode;this.NO_TEXTURE=new GL.Texture;var b=a.pbrMetallicRoughness.baseColorTexture;
b?(this.controlV[0]=1,this.baseColorTexture=this.textures[b.index]):(this.controlV[0]=0,this.baseColorTexture=this.NO_TEXTURE);(b=a.pbrMetallicRoughness.metallicRoughnessTexture)?(this.controlV[1]=1,this.metallicRoughnessTexture=this.textures[b.index]):(this.controlV[1]=0,this.metallicRoughnessTexture=this.NO_TEXTURE);(b=a.normalTexture)?(this.controlV[2]=1,this.normalTexture=this.textures[b.index]):(this.controlV[2]=0,this.normalTexture=this.NO_TEXTURE);(b=a.occlusionTexture)?(this.controlV[3]=1,
this.occlusionTexture=this.textures[b.index]):(this.controlV[3]=0,this.occlusionTexture=this.NO_TEXTURE);(b=a.emissiveTexture)?(this.controlV[4]=1,this.emissiveTexture=this.textures[b.index]):(this.controlV[4]=0,this.emissiveTexture=this.NO_TEXTURE);gl.bindBuffer(gl.UNIFORM_BUFFER,this.controlUB);gl.bufferData(gl.UNIFORM_BUFFER,this.controlV,gl.DYNAMIC_DRAW);gl.bindBuffer(gl.UNIFORM_BUFFER,null);gl.bindBuffer(gl.UNIFORM_BUFFER,this.metallicUB);gl.bufferData(gl.UNIFORM_BUFFER,this.metallicV,gl.DYNAMIC_DRAW);
gl.bindBuffer(gl.UNIFORM_BUFFER,null)}}clear(){gl.deleteBuffer(this.controlUB);gl.deleteBuffer(this.metallicUB)}};
M.PbrShader=class extends GL.ShaderMVP{constructor(a){super(M.PbrShader.vs,M.PbrShader.fs);this.NO_TEXTURE=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,this.NO_TEXTURE);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGB,1,1,0,gl.RGB,gl.UNSIGNED_BYTE,new Uint8Array([255,255,255]));gl.generateMipmap(gl.TEXTURE_2D);gl.bindTexture(gl.TEXTURE_2D,null);this.compile();this.clipPlanes=new Float32Array(16);this.clipPlanes.fill(0)}compile(){GL.ShaderMVP.prototype.compile.call(this);this.defineAttribute("aPosition",3,
gl.FLOAT,!1);this.defineAttribute("aNormal",4,gl.INT_2_10_10_10_REV,!0);this.defineAttribute("aTangent",4,gl.FLOAT,!1);this.defineAttribute("aUv",2,gl.FLOAT,!1);this.baseColorTexture=gl.getUniformLocation(this.glId,"sBaseColorTexture");this.metallicRoughnessTexture=gl.getUniformLocation(this.glId,"sMetallicRoughnessTexture");this.normalTexture=gl.getUniformLocation(this.glId,"sNormalTexture");this.occlusionTexture=gl.getUniformLocation(this.glId,"sOcclusionTexture");this.emissiveTexture=gl.getUniformLocation(this.glId,
"sEmissiveTexture");gl.useProgram(this.glId);gl.uniform1i(this.baseColorTexture,0);gl.uniform1i(this.metallicRoughnessTexture,1);gl.uniform1i(this.normalTexture,2);gl.uniform1i(this.occlusionTexture,3);gl.uniform1i(this.emissiveTexture,4);gl.useProgram(null);this.controlUBO=gl.getUniformBlockIndex(this.glId,"Control");gl.uniformBlockBinding(this.glId,this.controlUBO,1);this.controlSize=gl.getActiveUniformBlockParameter(this.glId,this.controlUBO,gl.UNIFORM_BLOCK_DATA_SIZE);this.metallicUBO=gl.getUniformBlockIndex(this.glId,
"MetallicRoughness");gl.uniformBlockBinding(this.glId,this.metallicUBO,2);this.metallicSize=gl.getActiveUniformBlockParameter(this.glId,this.metallicUBO,gl.UNIFORM_BLOCK_DATA_SIZE)}bindMaterial(a){gl.bindBufferBase(gl.UNIFORM_BUFFER,1,a.controlUB);gl.bindBufferBase(gl.UNIFORM_BUFFER,2,a.metallicUB);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,a.baseColorTexture.glId);gl.activeTexture(gl.TEXTURE1);gl.bindTexture(gl.TEXTURE_2D,a.metallicRoughnessTexture.glId);gl.activeTexture(gl.TEXTURE2);
gl.bindTexture(gl.TEXTURE_2D,a.normalTexture.glId);gl.activeTexture(gl.TEXTURE3);gl.bindTexture(gl.TEXTURE_2D,a.occlusionTexture.glId);gl.activeTexture(gl.TEXTURE4);gl.bindTexture(gl.TEXTURE_2D,a.emissiveTexture.glId);a.alphaMode==M.Material.BLEND?gl.enable(gl.BLEND):gl.disable(gl.BLEND)}clear(){super.clear();gl.deleteTexture(this.NO_TEXTURE)}toJson(){return{name:this.name}}};M.PbrShader.get=function(){M.PbrShader.instance||(M.PbrShader.instance=new M.PbrShader,M.PbrShader.instance.compile());return M.PbrShader.instance};
M.PbrShader.vs="#version 300 es\n\nprecision mediump float;\nprecision mediump int;\n\nuniform mat4 modelViewMatrix; \nuniform mat4 projectionMatrix; \n\nlayout(std140) uniform Control {\n    uniform int cBaseColorTexture;\n    uniform int cMetallicRoughnessTexture;\n    uniform int cNormalTexture;\n    uniform int cOcclusionTexture;\n    uniform int cEmissiveTexture;\n    uniform int cAlphaMode;\n};\n\n\nlayout(location = 0) in vec3 aPosition;\nlayout(location = 1) in vec3 aNormal;\nlayout(location = 2) in vec4 aTangent;\nlayout(location = 3) in vec2 aUv;\nlayout(location = 4) in mat4 aMatrix;\n\nout mat3 vTBN;\nout vec3 vNormal;\n\nout vec3 vCamera;\nout vec2 vUv;\nout vec3 vLight;\n\nvoid main()\t\n{\n    mat4 viewMatrix = modelViewMatrix * aMatrix;\n    mat3 normalMatrix = mat3(viewMatrix);\n\n    vec4 viewVertex = viewMatrix*vec4(aPosition, 1.0);\n    vCamera = viewVertex.xyz;\n    \n    vNormal = normalize(normalMatrix * aNormal);\n    \n    if (cNormalTexture == 1)\n    {\n        vec3 t = normalize(normalMatrix * aTangent.xyz);\n        vec3 b = cross(vNormal, t) * aTangent.w;\n        vTBN = mat3(t, b, vNormal);\n    }\n    \n    vUv = aUv;\n\n    //vLight = vec3(0.57735026919, 0.57735026919, 0.57735026919);\n    //vLight = vec3(1, 0, 0);\n    vLight = vec3(0, 0, 1);\n    \n    gl_Position = projectionMatrix * viewVertex;\n}\n\n";
M.PbrShader.fs="#version 300 es\n\nprecision mediump float;\nprecision mediump int;\n\nin vec3 vCamera;\nin vec3 vNormal;\nin mat3 vTBN;\nin vec2 vUv;\nin vec3 vLight;\n\nuniform sampler2D sBaseColorTexture;\nuniform sampler2D sMetallicRoughnessTexture;\nuniform sampler2D sNormalTexture;\nuniform sampler2D sOcclusionTexture;\nuniform sampler2D sEmissiveTexture;\n\nlayout(std140) uniform Control \n{\n    uniform int cBaseColorTexture;\n    uniform int cMetallicRoughnessTexture;\n    uniform int cNormalTexture;\n    uniform int cOcclusionTexture;\n    uniform int cEmissiveTexture;\n    uniform int cAlphaMode;\n};\n\nconst int OPAQUE = 1;\nconst int BLEND = 2;\nconst int MASK = 3;\n\nlayout(std140) uniform MetallicRoughness \n{\n    uniform vec4 uBaseColorFactor;\n    uniform vec4 uEmissiveFactor;\n    uniform float uRoughness;\n    uniform float uMetallic;\n    uniform float uAlphaCutoff;\n};\n\nout vec4 fragmentColor;\n\nconst float M_PI = 3.141592653589793;\nconst vec3 F0 = vec3(0.04);\n\nstruct AngularInfo\n{\n    float NdotL;\n    float NdotV;\n    float NdotH;\n    float LdotH;\n    float VdotH;\n\n    vec3 padding;\n};\n\n\nAngularInfo getAngularInfo(vec3 pointToLight, vec3 normal, vec3 view)\n{\n    vec3 n = normalize(normal);\n    vec3 v = normalize(view);\n    vec3 l = normalize(pointToLight);\n    vec3 h = normalize(l + v);\n\n    float NdotL = clamp(dot(n, l), 0.0, 1.0);\n    float NdotV = clamp(dot(n, v), 0.0, 1.0);\n    float NdotH = clamp(dot(n, h), 0.0, 1.0);\n    float LdotH = clamp(dot(l, h), 0.0, 1.0);\n    float VdotH = clamp(dot(v, h), 0.0, 1.0);\n\n    return AngularInfo(\n        NdotL,\n        NdotV,\n        NdotH,\n        LdotH,\n        VdotH,\n        vec3(0, 0, 0)\n    );\n}\n\nvec3 LINEARtoSRGB(vec3 color);\nvec4 SRGBtoLINEAR(vec4 srgbIn);\nvec3 toneMap(vec3 color);\n\nvoid main()\t\n{\n    vec4 lBaseColor = uBaseColorFactor;\n\n    if (cBaseColorTexture == 1)\n    {\n        lBaseColor *= SRGBtoLINEAR(texture(sBaseColorTexture, vUv));\n    }\n    \n    float lRoughness = uRoughness;\n    float lMetallic = uMetallic;\n    if (cMetallicRoughnessTexture == 1)\n    {\n        vec4 value = texture(sMetallicRoughnessTexture, vUv);\n        lRoughness *= value.g;\n        lMetallic *= value.b;\n    }\n    lRoughness = max(lRoughness, 0.04);\n\n    vec3 lNormal;\n    if (cNormalTexture == 1)\n    {\n        lNormal = vTBN * (2.0 * texture(sNormalTexture, vUv).rgb - 1.0);   \n    }\n    else\n    {\n        lNormal = vNormal;\n    }\n    \n    if (!gl_FrontFacing)\n    {\n        lNormal =- lNormal;\n    }\n  \n    AngularInfo angles = getAngularInfo(vLight, lNormal, -vCamera);\n\n    vec3 lColor = vec3(0.0, 0.0, 0.0);\n    if (angles.NdotL > 0.0 || angles.NdotV > 0.0)\n    {\n        vec3 lDiffuse = lBaseColor.rgb * (vec3(1.0) - F0) * (1.0 - lMetallic);\n        vec3 lSpecular = mix(F0, lBaseColor.rgb, lMetallic);\n\n        vec3 specularR0 = lSpecular;\n        vec3 specularR90 = vec3(clamp(max(max(lSpecular.r, lSpecular.g), lSpecular.b) * 50.0, 0.0, 1.0));\n    \n        // specular\n        vec3 F = specularR0 + (specularR90 - specularR0) * pow(clamp(1.0 - angles.VdotH, 0.0, 1.0), 5.0);\n        \n        // visibility occlusion\n        float alphaRoughnessSq = pow(lRoughness, 4.0);\n        float Vis = 0.0;\n        float GGXV = angles.NdotL * sqrt(angles.NdotV * angles.NdotV * (1.0 - alphaRoughnessSq) + alphaRoughnessSq);\n        float GGXL = angles.NdotV * sqrt(angles.NdotL * angles.NdotL * (1.0 - alphaRoughnessSq) + alphaRoughnessSq);\n        float GGX = GGXV + GGXL;\n        if (GGX > 0.0)\n        {\n            Vis = 0.5 / GGX;\n        }\n        \n        // microfacet distribution\n        float f = (angles.NdotH * alphaRoughnessSq - angles.NdotH) * angles.NdotH + 1.0;\n        float D = alphaRoughnessSq / (M_PI * f * f);\n \n        lColor = (angles.NdotL + 0.15)* ((1.0-F)*lDiffuse + F*Vis*D);\n    }\n    \n    if (cOcclusionTexture == 1)\n    {\n        float ao = texture(sOcclusionTexture, vUv).r;\n        lColor = mix(lColor, lColor*ao, 1.0);\n    }\n    \n    if (cEmissiveTexture == 1)\n    {\n        lColor += SRGBtoLINEAR(texture(sEmissiveTexture, vUv)).rgb * uEmissiveFactor.rgb;\n    }\n    else\n    {\n        lColor += uEmissiveFactor.rgb;\n    }\n    \n    float lAlpha = 1.0;\n    switch (cAlphaMode)\n    {\n        case BLEND:\n            lAlpha = lBaseColor.a;\n        break;\n        case MASK:\n        if(lBaseColor.a < uAlphaCutoff)\n        {\n            discard;\n        }\n        break;\n    }\n    \n    fragmentColor = vec4(toneMap(lColor), lAlpha);\n    //fragmentColor = vec4(lColor, lAlpha);\n    //fragmentColor = vec4(1);\n    //fragmentColor = vec4(LINEARtoSRGB(lBaseColor.rgb), 1.0);\n    //fragmentColor = vec4(LINEARtoSRGB(lSpecular.rgb), 1.0);\n    //fragmentColor = vec4(f0);\n    //fragmentColor = vec4(vec3(pow(angles.VdotH, 8.0)), 1.0);\n    //fragmentColor = vec4(vec3(angles.NdotH), 1.0);\n    //fragmentColor = vec4(texture (sBaseColorTexture, vUv).rgb, 1);\n    //fragmentColor = vec4(texture (sBaseColorTexture, vUv).rgb, 1);\n    //fragmentColor = vec4(normalize(vNormal), 1.0);\n    //fragmentColor = vec4(vec3(lMetallic), 1.0);\n    //fragmentColor = vec4(texture(sEmissiveTexture, vUv).rgb, 1);\n}\n\n\nconst float GAMMA = 2.2;\nconst float EXPOSURE = 1.3;\n\nvec3 LINEARtoSRGB(vec3 color)\n{\n    return pow(color, vec3(1.0/GAMMA));\n}\n\nvec4 SRGBtoLINEAR(vec4 srgbIn)\n{\n    return vec4(pow(srgbIn.xyz, vec3(GAMMA)), srgbIn.w);\n}\n\n// Hejl Richard tone map\n// see: http://filmicworlds.com/blog/filmic-tonemapping-operators/\nvec3 toneMapHejlRichard(vec3 color)\n{\n    color = max(vec3(0.0), color - vec3(0.004));\n    return (color*(6.2*color+.5))/(color*(6.2*color+1.7)+0.06);\n}\n\n// ACES tone map\n// see: https://knarkowicz.wordpress.com/2016/01/06/aces-filmic-tone-mapping-curve/\nvec3 toneMapACES(vec3 color)\n{\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return LINEARtoSRGB(clamp((color * (A * color + B)) / (color * (C * color + D) + E), 0.0, 1.0));\n}\n\nvec3 toneMap(vec3 color)\n{\n    color *= EXPOSURE;\n\n//   return toneMapHejlRichard(color);\n    return toneMapACES(color);\n//    return LINEARtoSRGB(color);\n}\n\n\n\n\n";
M.IfcSurfaceStyle=class extends M.Material{constructor(a){super(M.IfcSurfaceShader.get());this.surfaceColor=new Float32Array([a.surfaceColor.r,a.surfaceColor.g,a.surfaceColor.b,void 0!=a.surfaceColor.a?a.surfaceColor.a:1]);this.config=a;this.mode=1!=this.surfaceColor[3]?M.Material.BLEND:M.Material.OPAQUE}update(a){this.surfaceColor[0]=a.surfaceColor.r;this.surfaceColor[1]=a.surfaceColor.g;this.surfaceColor[2]=a.surfaceColor.b;this.mode==M.Material.BLEND&&(this.surfaceColor[3]=a.surfaceColor.a)}};
M.IfcSurfaceShader=class extends GL.ShaderMVP{constructor(){super(M.IfcSurfaceShader.vs,M.IfcSurfaceShader.fs);this.clipPlanes=new Float32Array(16);this.clipPlanes.fill(0)}compile(){for(var a=this.clipPlanes,b=0;4>b;b++)0!=a[4*b+3]&&(this.config+="#define CLIP"+b+" "+a[4*b]+","+a[4*b+1]+","+a[4*b+2]+","+a[4*b+3]+"\n");super.compile();this.defineAttribute("aPosition",3,gl.FLOAT,!1);this.defineAttribute("aNormal",4,gl.INT_2_10_10_10_REV,!0);this.surfaceColor=gl.getUniformLocation(this.glId,"surfaceColor")}bindMaterial(a){gl.uniform4fv(this.surfaceColor,
a.surfaceColor)}toJson(){return{name:this.name}}static get(){M.IfcSurfaceShader.instance||(M.IfcSurfaceShader.instance=new M.IfcSurfaceShader,M.IfcSurfaceShader.instance.compile());return M.IfcSurfaceShader.instance}};M.IfcSurfaceShader.vs="#version 300 es\n\nprecision mediump float;\nprecision mediump int;\n\nuniform mat4 modelViewMatrix; \nuniform mat4 projectionMatrix; \n\nlayout(location = 0) in vec3 aPosition;\nlayout(location = 1) in vec3 aNormal;\nlayout(location = 3) in vec2 aUv;\nlayout(location = 4) in mat4 aMatrix;\n\nout vec3 vNormal;\nout vec3 vCamera;\nout vec2 vUv;\nout vec3 vLight;\n\nvoid main()\t\n{\n    mat4 viewMatrix = modelViewMatrix * aMatrix;\n    mat3 normalMatrix = mat3(viewMatrix);\n\n    vec4 viewVertex = viewMatrix*vec4(aPosition, 1.0);\n    vCamera = normalize(viewVertex.xyz);\n    \n    vNormal = normalize(normalMatrix * aNormal);\n        \n    vUv = aUv;\n    vLight = normalize(vec3(0, 0, 1));\n    //vLight = normalize(normalMatrix * vec3(0, 0.70710678118, 0.70710678118));\n    //vLight = normalize(normalMatrix * vec3(0.57735026919, 0.57735026919, 0.57735026919));\n    //vLight = vec3(0, 0.70710678118, 0.70710678118);\n    //vLight = vec3(0.57735026919, 0.57735026919, 0.57735026919);\n    \n    gl_Position = projectionMatrix * viewVertex;\n}\n\n";
M.IfcSurfaceShader.fs="#version 300 es\n\nprecision mediump float;\nprecision mediump int;\n\nuniform vec4 surfaceColor; \n\nin vec3 vNormal;\nin vec2 vUv;\nin vec3 vLight;\nin vec3 vCamera;\n\nout vec4 fragmentColor;\n\nconst vec3 cBelow = vec3(0.2,0.2,0.2);\nconst vec3 cAbove = vec3(0.8,0.8,0.8);\n \nconst float GAMMA = 0.9;\nconst float EXPOSURE = 1.3;\n\nvoid main()\t\n{\n    vec3 lNormal = vNormal;\n    if (!gl_FrontFacing)\n    {\n        lNormal =- lNormal;\n    }\n \n    float NdotL = dot(vNormal, vLight);\n\n    float weight = 0.5*NdotL+0.5;\n    \n    vec3 ambient = surfaceColor.rgb*mix(cBelow, cAbove, weight);\n    \n    fragmentColor = vec4(pow(ambient* EXPOSURE, vec3(1.0/GAMMA)), surfaceColor.a);\n    \n    //fragmentColor = vec4(vNormal, 1.0);\n}\n";
</script>
<script id="/3d/overlay/polygon.js">V3.MeshRenderer=class extends GL.ShaderMVP{constructor(){super(V3.MeshRenderer.vs,V3.MeshRenderer.fs)}compile(){super.compile(this);this.defineAttribute("position",3,gl.FLOAT,!1);this.alpha=gl.getUniformLocation(this.glId,"alpha")}render(a,b){this.useProgram(V.camera);this.enableBuffer();this.bindBuffer(a);gl.uniform1f(this.alpha,b);gl.enable(gl.BLEND);gl.disable(gl.CULL_FACE);gl.drawArrays(gl.TRIANGLES,0,a.position.length/3);gl.enable(gl.CULL_FACE);gl.disable(gl.BLEND)}};
V3.MeshRenderer.instance=null;V3.MeshRenderer.get=function(){V3.MeshRenderer.instance||(V3.MeshRenderer.instance=new V3.MeshRenderer,V3.MeshRenderer.instance.compile());return V3.MeshRenderer.instance};V3.MeshRenderer.vs="\nprecision mediump float;\nprecision mediump int;\n\nuniform mat4 modelViewMatrix; \nuniform mat4 projectionMatrix; \n\nattribute vec3 position;\n\n\nvoid main()\t\n{\n    vec4 viewVertex = modelViewMatrix * vec4(position, 1.0 );\n    \n    gl_Position = projectionMatrix * viewVertex;\n}";
V3.MeshRenderer.fs="\nprecision mediump float;\nprecision mediump int;\n\nuniform float alpha; \n\nvoid main()\t\n{\n    gl_FragColor = gl_FrontFacing ?  vec4(0.95,0.95,0.95,0.4*alpha) : vec4(0.95,0.95,0.0,0.4*alpha);\n}\n";
V3.LineRenderer=class extends GL.ShaderMVP{constructor(){super(V3.LineRenderer.vs,V3.LineRenderer.fs)}compile(){this.defines.ORTHOGRAPHIC=V.camera.projection==V3.ORTHOGRAPHIC;GL.ShaderMVP.prototype.compile.call(this);this.defineAttribute("position",3,gl.FLOAT,!1);this.defineAttribute("color",3,gl.UNSIGNED_BYTE,!0);this.screenH=gl.getUniformLocation(this.glId,"screenH");this.pointSize=gl.getUniformLocation(this.glId,"pointSize");this.alpha=gl.getUniformLocation(this.glId,"alpha");this.vbo={position:new GL.ArrayBuffer(12),
color:new GL.ArrayBuffer(1)}}update(a,b){this.vbo.position.set(a);this.vbo.color.set(b)}render3D(a,b,c){1<b&&(this.useProgram(V.camera),this.enableBuffer(),V.camera.projection==V3.ORTHOGRAPHIC?gl.uniform1f(this.pointSize,44*a.resolution*V.camera.projection.zoom):gl.uniform1f(this.pointSize,1.22474487139*a.resolution),this.bindBuffer(this.vbo),gl.disable(gl.DEPTH_TEST),gl.drawArrays(gl.POINTS,0,b),gl.enable(gl.DEPTH_TEST))}useProgram(a,b){GL.ShaderMVP.prototype.useProgram.call(this,a);gl.uniform1f(this.screenH,
gl.drawingBufferHeight)}};V3.LineRenderer.instance=null;V3.LineRenderer.get=()=>{V3.LineRenderer.instance||(V3.LineRenderer.instance=new V3.LineRenderer,V3.LineRenderer.instance.compile());return V3.LineRenderer.instance};V3.LineRenderer.vs="\nprecision mediump float;\nprecision mediump int;\n\nuniform mat4 modelViewMatrix; \nuniform mat4 projectionMatrix; \n\nuniform float pointSize;\nuniform float screenH;\n\nattribute vec3 color;\n\nattribute vec3 position;\n\nvarying vec4 pixelColor;\nvarying vec3 viewPosition;\nvarying vec3 worldPosition;\nvarying float discarded;\n\nvoid main()\t\n{\n    vec4 viewVertex = modelViewMatrix * vec4(position, 1.0 );\n\n    gl_Position = projectionMatrix * viewVertex;\n    \n    #if defined(ORTHOGRAPHIC)\n        gl_PointSize = pointSize;\n    #else\n        gl_PointSize = screenH*projectionMatrix[1][1]*pointSize/(-2.0*viewVertex.z);\n    #endif\n    \n    pixelColor = vec4(color, 1);\n}";
V3.LineRenderer.fs="\nprecision mediump float;\nprecision mediump int;\n\nvarying vec4 pixelColor;\n\n\nvoid main()\t\n{\n    gl_FragColor = pixelColor;\n    \n}";
V3.ControlH=class extends O.Object{constructor(a){super(a.id+"h");this.container=a;this.geometry=a.geometry;this.pointAnchor=this.addAnchor(new O.Anchor);this.startAnchor=this.addAnchor(new O.Anchor)}attach(){super.attach(this);this.update();this.controlPoint=this.addControl(new O.ControlPoint(this.pointAnchor,new C.Ray(this.startAnchor,this.geometry.plane)))}startControl(a){this.container.startControl()}moveControl(a){a=this.startAnchor.wx-this.pointAnchor.wx;var b=this.startAnchor.wy-this.pointAnchor.wy,
c=this.startAnchor.wz-this.pointAnchor.wz;this.geometry.height=Math.sqrt(a*a+b*b+c*c)}endControl(a){this.container.endControl()}update(){var a=this.geometry.center,b=this.geometry.plane,c=this.geometry.height;this.pointAnchor.set3D({x:a.x+c*b.x,y:a.y+c*b.y,z:a.z+c*b.z});this.startAnchor.set3D({x:a.x,y:a.y,z:a.z})}};
V3.ControlZ=class extends O.Object{constructor(a){super(a.id+"z");this.container=a;this.geometry=a.geometry;this.anchor=this.addAnchor(new O.Anchor);this.anchor0=this.addAnchor(new O.Anchor);this.anchor1=this.addAnchor(new O.Anchor);this.style=new O.Style.Line([3,3],C.Line.PASSIVE,O.Segment.NONE);this.line=this.addComponent(new O.Segment(this.anchor0,this.anchor1,null,this.style))}attach(){super.attach(this);this.update();this.controlPoint=this.addControl(new O.ControlPoint(this.anchor,new C.Line(this.anchor,
this.geometry.plane)))}startControl(){this.style.fillStyle=C.Line.ACTIVE;this.style.lineWidth=3;this.container.startControl()}endControl(){this.style.fillStyle=C.Line.PASSIVE;this.style.lineWidth=1;this.container.endControl()}moveControl(a){a=this.anchor.wx-this.center.x;var b=this.anchor.wy-this.center.y,c=this.anchor.wz-this.center.z;this.container.translate(a,b,c);this.anchor0.translate3D(a,b,c);this.anchor1.translate3D(a,b,c);this.center.x=this.anchor.wx;this.center.y=this.anchor.wy;this.center.z=
this.anchor.wz;this.container.moveControl()}update(){this.center=this.geometry.center;this.anchor.set3D(this.center);var a=this.geometry.plane,b=.5*this.geometry.radius;this.anchor0.set3D({x:this.center.x+b*a.x,y:this.center.y+b*a.y,z:this.center.z+b*a.z});this.anchor1.set3D({x:this.center.x-b*a.x,y:this.center.y-b*a.y,z:this.center.z-b*a.z})}};
V3.Polygon=class extends O.Polygon{constructor(a,b){super(a,b);a.height||(a.height=.2*Math.max(this.aabb.max.x-this.aabb.min.x,Math.max(this.aabb.max.y-this.aabb.min.y,this.aabb.max.z-this.aabb.min.z)));this.geometry.height=a.height;this.controlZ=new V3.ControlZ(this);this.controlUV=new O.ControlUV(this);this.controlH=new V3.ControlH(this);this.vbo={position:new GL.ArrayBuffer(1)}}addControls(){this.addObject(this.controlUV);"undefined"===typeof V2&&(this.addObject(this.controlZ),this.mode[O.VOLUME]&&
this.addObject(this.controlH))}removeControls(){this.removeObject(this.controlUV);"undefined"===typeof V2&&(this.removeObject(this.controlZ),this.mode[O.VOLUME]&&this.removeObject(this.controlH))}intersectRay3D(a){a=GM.Ray.intersectPlane(a.ray,this.geometry.plane,{});return this.geometry.containsPoint(a)?V.camera.distanceTo(a):Number.POSITIVE_INFINITY}onUpdate(){super.onUpdate.call(this);if(this.selected&&this.constraint instanceof C.Polygon){var a=GM.Vector3.dot(V.camera.zAxis,this.geometry.plane);
.7<Math.abs(a)?(this.controlUV.attached||this.addObject(this.controlUV),"undefined"===typeof V2&&this.controlZ.attached&&this.removeObject(this.controlZ)):(this.controlUV.attached&&this.removeObject(this.controlUV),"undefined"===typeof V2&&(this.controlZ.attached||this.addObject(this.controlZ)))}}update(a){super.update(a);a.mode&&this.mode[O.VOLUME]&&!a.mode[O.VOLUME]&&this.stopScan()}startControl(a){this.mode[O.VOLUME]&&this.stopScan()}moveControl(){super.moveControl.call(this);this.controlUV.attached&&
this.controlUV.update();this.controlZ.attached&&this.controlZ.update();this.controlH.attached&&this.controlH.update()}render2D(a){super.render2D(a);if(this.mode[O.VOLUME]){var b=this.geometry.height,c=this.geometry.plane,e=c.x*b,d=c.y*b;b*=c.z;c=this.anchors;a.setTransform(1,0,0,1,0,0);for(var k=0;k<c.length;k++){var h=c[k],f=c[(k+1)%c.length],g=V.camera.project({x:h.wx+e,y:h.wy+d,z:h.wz+b});g.x*=O.canvas.width;g.y*=O.canvas.height;f=V.camera.project({x:f.wx+e,y:f.wy+d,z:f.wz+b});f.x*=O.canvas.width;
f.y*=O.canvas.height;a.strokeStyle=C.Line.PASSIVE;a.beginPath();a.moveTo(h.sx,h.sy);a.lineTo(g.x,g.y);a.stroke();a.beginPath();a.moveTo(g.x,g.y);a.lineTo(f.x,f.y);a.stroke()}}}render3D(a){a=this.geometry.triangles;for(var b=new Float32Array(3*a.length),c=0;c<a.length;c++){var e=this.anchors[a[c]];b[3*c]=e.wx;b[3*c+1]=e.wy;b[3*c+2]=e.wz}this.vbo.position.set(b);a=V3.MeshRenderer.get();a.render(this.vbo,this.scale);this.pointCount&&(a=V3.LineRenderer.get(),a.render3D(this.geometry,this.pointCount,.6*
this.scale))}startScan(a){let b=this.geometry.getArea();a=super.startScan(b*a,this.geometry.plane);this.position=new Float32Array(6*a.du);this.color=new Uint8Array(6*a.du);V.postMessage("polygon.scan.start",{id:this.id,samples:{undef:[]}});this.pointCount=0}processScan(){super.processScan();V.camera.moving||(V3.LineRenderer.get().update(this.position,this.color),V.touch3d())}stopScan(){super.stopScan(this);V.postMessage("polygon.scan.stop",{id:this.id,samples:{undef:[]}});this.pointCount=0}startLine(){this.pointCount=
0;this.samples={undef:[]}}sample(a,b,c,e){c=V.viewer.raycast(a,{distance:this.geometry.height}).distance;if(c!=this.geometry.height){c=Math.min(c,this.geometry.height);this.samples.undef.push(c);e=c+b;var d=3*this.pointCount;this.position[d+0]=a.origin.x+a.direction.x*e;this.position[d+1]=a.origin.y+a.direction.y*e;this.position[d+2]=a.origin.z+a.direction.z*e;this.color[d+0]=0;this.color[d+1]=255;this.color[d+2]=0;this.pointCount++;e=c-b;d=3*this.pointCount;this.position[d+0]=a.origin.x+a.direction.x*
e;this.position[d+1]=a.origin.y+a.direction.y*e;this.position[d+2]=a.origin.z+a.direction.z*e;this.color[d+0]=0}else this.samples.undef.push(Number.POSITIVE_INFINITY),d=3*this.pointCount,this.position[d+0]=a.origin.x,this.position[d+1]=a.origin.y,this.position[d+2]=a.origin.z,this.color[d+0]=255;this.color[d+1]=255;this.color[d+2]=0;this.pointCount++}endLine(a){V.postMessage("polygon.scan.sample",{id:this.id,resolution:a.resolution,samples:this.samples})}};
V.recvMessage("polygon.create",(a,b)=>{if(O.Polygon.validate(a)){a=new V3.Polygon(a);if(b.transform){let c=V.viewer.datasets[b.transform];c&&c.addAnchors(a)}O.instance.addObject(a);b.uv=a.geometry.points;V.postMessage("polygon.create",a.toJson(),b);V.touch3d();V.touch2d()}});
V.recvMessage("polygon.delete",function(a,b){if(b.transform){var c=V.viewer.datasets[b.transform];if(c){let e=O.instance.getObject(a.id);c.removeAnchors(e)}}c=O.find(a.id);c.selected&&(c.unselect(),V.postMessage("polygon.unselect",c.toJson(),b));O.instance.removeObject(a.id);V.postMessage("polygon.delete",a,b);V.touch2d();V.touch3d()});V.recvMessage("polygon.scan.start",(a,b)=>{(b=O.instance.getObject(a.id))?b.startScan(a.resolution):V.postMessage("error","polygon not found "+a.id)});
V.recvMessage("polygon.scan.stop",a=>{let b=O.instance.getObject(a.id);b?(b.stopScan(),V.touch3d()):V.postMessage("error","polygon not found "+a.id)});
</script>
<script id="/3d/overlay/line.js">V3.Line=class extends O.Line{constructor(a,b){super(a,b);this.ray=new GM.Ray;this.ray.direction.x=0;this.ray.direction.y=-1;this.ray.direction.z=0}startControl(a){this.timer&&this.stopScan()}stopScan(){this.timer&&clearTimeout(this.timer);V.postMessage("line.scan.stop",{id:this.id})}startScan(a,b){this.timer&&clearTimeout(this.timer);GM.Vector3.copy(b,this.ray.direction);this.scan={id:this.id,resolution:this.length()*a,count:0,samples:{}};this.scan.samples[0]=[];V.postMessage("line.scan.start",this.scan);
this.sampleLine(0,this.scan.resolution)}sampleLine(a,b){var c=this.anchors[a+1].wx-this.anchors[a].wx,d=this.anchors[a+1].wy-this.anchors[a].wy,f=this.anchors[a+1].wz-this.anchors[a].wz,e=Math.sqrt(c*c+d*d+f*f);this.ray.origin.x=this.anchors[a].wx;this.ray.origin.y=this.anchors[a].wy;this.ray.origin.z=this.anchors[a].wz;this.timer=setTimeout(this.processScan.bind(this,{samples:e/b,ddx:c/e*b,ddy:d/e*b,ddz:f/e*b,index:a},b),0)}processScan(a,b){if(V.camera.moving)this.timer=setTimeout(this.processScan.bind(this,
a,b),0);else{for(var c=0;c<Math.min(a.samples,40);c++){var d=V.viewer.raycast(this.ray,{hits:[],distance:Number.POSITIVE_INFINITY}).distance;this.scan.samples[0].push(d);this.scan.count++;this.ray.origin.x+=a.ddx;this.ray.origin.y+=a.ddy;this.ray.origin.z+=a.ddz}a.samples=Math.max(0,a.samples-40);this.timer=null;a.samples?this.timer=setTimeout(this.processScan.bind(this,a,b),0):(V.postMessage("line.scan.sample",this.scan),a.index<this.anchors.length-2?this.sampleLine(a.index+1,b):V.postMessage("line.scan.end",
this.scan))}}};V.recvMessage("line.create",(a,b)=>{if(O.Line.validate(a)){a=new V3.Line(a);if(b.transform){let c=V.viewer.datasets[b.transform];c&&c.addAnchors(a)}O.instance.addObject(a);V.postMessage("line.create",a.toJson(),b);V.touch2d();V.touch3d()}});
V.recvMessage("line.delete",function(a,b){if(a.transform){var c=V.viewer.datasets[a.transform];if(c){let d=O.instance.getObject(a.id);c.removeAnchors(d)}}c=O.find(a.id);c.selected&&(c.unselect(),V.postMessage("line.unselect",c.toJson(),b));V.postMessage("line.delete",a,b);O.instance.removeObject(a.id);V.touch2d()});V.recvMessage("line.scan.start",a=>{let b=O.instance.getObject(a.id);b?b.startScan(a.resolution,a.direction):V.postMessage("error","line not found "+a.id)});
V.recvMessage("line.scan.stop",a=>{let b=O.instance.getObject(a.id);b?(b.stopScan(),V.touch3d()):V.postMessage("error","line not found "+a.id)});
</script>


</html>

