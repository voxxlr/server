<!DOCTYPE html>
<html>
<head>
    
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon"> 
    <title>Voxxlr</title>
    <link rel="canonical" href="https://www.voxxlr.com/index.html">
    <meta charset="utf-8" >
 
    <script>
        
        window.addEventListener("load", function() 
        {
            document.addEventListener('contextmenu', event => event.preventDefault());
            
            var viewer = new V2.Viewer();
            var config = {{#content}}{{{.}}}{{/content}}   {{^content}}null{{/content}};
               
            if (config != null)
            {       	
                let map;
                if (config.type == V2.MOSAIC)
                {
                    map = new M.DemMap(config, V.viewerCb, 0)
                }
                else if (config.type == V2.WMTS)
                {
                    map = new M.Wmts(config, V.viewerCb, 0)
                }
                else if (config.type == V2.IMAGE)
                {
                    map = new M.Image(config, V.viewerCb, 0)
                }
                
                viewer.load(config.id, map);
            }
            else
            {
                V.viewerCb({ type: "map" });
            }
       });
    
    </script>
    
    <style>
    
        body { overflow: hidden;  touch-action: none; }
        canvas { position: absolute; top: 0px; left: 0px; width:100%; height:100% }
        
        #splitterV
        {
            position: absolute;
            margin-left: -1px;
            top: 0;
            border-left: 3px outset #40C4FF;
            pointer-events: none;
        }
        #splitterH
        {
            position: absolute;
            margin-top: -1px;
            left: 0;
            border-top: 3px outset #40C4FF;
            pointer-events: none;
        }
        
        #splitterX
        {
            position: absolute;
            margin-left: -19px;
            margin-top: -19px;
            height: 19px;
            width: 19px;
            background-color: #40C4FF;
        }
        
    </style>
        
</head>

<body>

    <canvas id="canvas3D"></canvas>
    <canvas id="canvas2D" class="events"></canvas>
     
    <div id="splitterV"></div>
    <div id="splitterH"></div>
    <div id="splitterX"></div>

</body>


<script id="/geom/geom.js">GM={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,clamp:function(a,b,c){return Math.max(b,Math.min(c,a))}};
GM.Vector3=class{constructor(a,b,c){this.x=a||0;this.y=b||0;this.z=c||0}clone(){return new GM.Vector3(this.x,this.y,this.z)}copy(a){this.x=a.x;this.y=a.y;this.z=a.z;return this}set(a,b,c){this.x=a;this.y=b;this.z=c;return this}readArray(a,b){this.x=a[b];this.y=a[b+1];this.z=a[b+2];return this}add(a){this.x+=a.x;this.y+=a.y;this.z+=a.z;return this}sub(a){this.x-=a.x;this.y-=a.y;this.z-=a.z;return this}multiply(a){this.x*=a.x;this.y*=a.y;this.z*=a.z;return this}addScaledVector(a,b){this.x+=a.x*b;this.y+=
a.y*b;this.z+=a.z*b;return this}crossVectors(a,b){var c=a.x,d=a.y;a=a.z;var e=b.x,f=b.y;b=b.z;this.x=d*b-a*f;this.y=a*e-c*b;this.z=c*f-d*e;return this}subVectors(a,b){this.x=a.x-b.x;this.y=a.y-b.y;this.z=a.z-b.z;return this}multiplyScalar(a){isFinite(a)?(this.x*=a,this.y*=a,this.z*=a):this.z=this.y=this.x=0;return this}multiplyVectors(a,b){this.x=a.x*b.x;this.y=a.y*b.y;this.z=a.z*b.z;return this}applyMatrix3(a){var b=this.x,c=this.y,d=this.z;a=a.elements;this.x=a[0]*b+a[3]*c+a[6]*d;this.y=a[1]*b+
a[4]*c+a[7]*d;this.z=a[2]*b+a[5]*c+a[8]*d;return this}transform(a){var b=this.x,c=this.y,d=this.z;a=a.elements;this.x=a[0]*b+a[4]*c+a[8]*d+a[12];this.y=a[1]*b+a[5]*c+a[9]*d+a[13];this.z=a[2]*b+a[6]*c+a[10]*d+a[14];return this}applyQuaternion(a){var b=this.x,c=this.y,d=this.z,e=a.x,f=a.y,g=a.z;a=a.w;var h=a*b+f*d-g*c,k=a*c+g*b-e*d,l=a*d+e*c-f*b;b=-e*b-f*c-g*d;this.x=h*a+b*-e+k*-g-l*-f;this.y=k*a+b*-f+l*-e-h*-g;this.z=l*a+b*-g+h*-f-k*-e;return this}divide(a){this.x/=a.x;this.y/=a.y;this.z/=a.z;return this}divideScalar(a){return this.multiplyScalar(1/
a)}min(a){this.x=Math.min(this.x,a.x);this.y=Math.min(this.y,a.y);this.z=Math.min(this.z,a.z);return this}max(a){this.x=Math.max(this.x,a.x);this.y=Math.max(this.y,a.y);this.z=Math.max(this.z,a.z);return this}negate(){this.x=-this.x;this.y=-this.y;this.z=-this.z;return this}dot(a){return this.x*a.x+this.y*a.y+this.z*a.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}normalize(){return this.divideScalar(this.length())}distanceTo(a){return Math.sqrt(this.distanceToSquared(a))}distanceToSquared(a){var b=
this.x-a.x,c=this.y-a.y;a=this.z-a.z;return b*b+c*c+a*a}setFromMatrixColumn(a,b){return this.readArray(a.elements,4*b)}toJson(){return{x:this.x,y:this.y,z:this.z}}static create(a,b,c){return{x:a,y:b,z:c}}static mag(a){return Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z)}static normalize(a,b){var c=GM.Vector3.mag(a);b.x=a.x/c;b.y=a.y/c;b.z=a.z/c;return b}static negate(a,b){b.x=-a.x;b.y=-a.y;b.z=-a.z}static cross(a,b,c){var d=a.x,e=a.y;a=a.z;var f=b.x,g=b.y;b=b.z;c.x=e*b-a*g;c.y=a*f-d*b;c.z=d*g-e*f;return c}static distance(a,
b){var c=a.x-b.x,d=a.y-b.y;a=a.z-b.z;return Math.sqrt(c*c+d*d+a*a)}static dot(a,b){return a.x*b.x+a.y*b.y+a.z*b.z}static rotate(a,b,c){var d=a.x,e=a.y;a=a.z;c.x=b[0]*d+b[4]*e+b[8]*a;c.y=b[1]*d+b[5]*e+b[9]*a;c.z=b[2]*d+b[6]*e+b[10]*a;return c}static addScalar(a,b,c,d){d.x=a.x+b.x*c;d.y=a.y+b.y*c;d.z=a.z+b.z*c;return d}static copy(a,b){b.x=a.x;b.y=a.y;b.z=a.z;return b}static scale(a,b,c){c.x=a.x*b;c.y=a.y*b;c.z=a.z*b;return c}static transform(a,b,c){let d=a.x;var e=a.y;a=a.z;c.x=b[0]*d+b[4]*e+b[8]*
a+b[12];c.y=b[1]*d+b[5]*e+b[9]*a+b[13];c.z=b[2]*d+b[6]*e+b[10]*a+b[14];return c}static subtract(a,b,c){c.x=a.x-b.x;c.y=a.y-b.y;c.z=a.z-b.z;return c}static min(a,b,c){c.x=Math.min(a.x,b.x);c.y=Math.min(a.y,b.y);c.z=Math.min(a.z,b.z);return c}static max(a,b,c){c.x=Math.max(a.x,b.x);c.y=Math.max(a.y,b.y);c.z=Math.max(a.z,b.z);return c}static add(a,b,c){c.x=a.x+b.x;c.y=a.y+b.y;c.z=a.z+b.z;return c}static sub(a,b,c){c=c||{};c.x=a.x-b.x;c.y=a.y-b.y;c.z=a.z-b.z;return c}static sub3V(a,b,c,d,e){e=e||{};e.x=
a-d.x;e.y=b-d.y;e.z=c-d.z;return e}static read(a,b,c){a.x=b[c];a.y=b[c+1];a.z=b[c+2];return a}static fromMatrix(a,b){b.x=a[12];b.y=a[13];b.z=a[14]}};
GM.Ray=class{constructor(a,b){this.origin=void 0!==a?a:new GM.Vector3;this.direction=void 0!==b?b:new GM.Vector3}set(a,b){this.origin.copy(a);this.direction.copy(b);return this}copy(a){this.origin.copy(a.origin);this.direction.copy(a.direction)}transform(a){this.direction.x+=this.origin.x;this.direction.y+=this.origin.y;this.direction.z+=this.origin.z;this.direction.transform(a);this.origin.transform(a);this.direction.x-=this.origin.x;this.direction.y-=this.origin.y;this.direction.z-=this.origin.z;
return this}at(a,b){b.x=this.origin.x+this.direction.x*a;b.y=this.origin.y+this.direction.y*a;b.z=this.origin.z+this.direction.z*a;return b}intersectBox(a){var b=[0,0,0];var c=1/this.direction.x;var d=1/this.direction.y;var e=1/this.direction.z,f=this.origin;if(0<=c){var g=(a.min.x-f.x)*c;c*=a.max.x-f.x;b[0]=0}else g=(a.max.x-f.x)*c,c*=a.min.x-f.x,b[0]=1;var h=b[0];if(0<=d){var k=(a.min.y-f.y)*d;d*=a.max.y-f.y;b[1]=2}else k=(a.max.y-f.y)*d,d*=a.min.y-f.y,b[1]=3;if(g>d||k>c)return null;if(k>g||g!==
g)g=k,h=b[1];if(d<c||c!==c)c=d;0<=e?(k=(a.min.z-f.z)*e,a=(a.max.z-f.z)*e,b[2]=4):(k=(a.max.z-f.z)*e,a=(a.min.z-f.z)*e,b[2]=5);if(g>a||k>c)return null;if(k>g||g!==g)g=k,h=b[2];if(a<c||c!==c)c=a;return 0>c?null:{distance:g,face:h}}intersectMinMax(a,b){var c=1/this.direction.x;var d=1/this.direction.y;var e=1/this.direction.z,f=this.origin;if(0<=c){var g=(a[0]-f.x)*c;c*=b[0]-f.x}else g=(b[0]-f.x)*c,c*=a[0]-f.x;if(0<=d){var h=(a[1]-f.y)*d;d*=b[1]-f.y}else h=(b[1]-f.y)*d,d*=a[1]-f.y;if(g>d||h>c)return null;
if(h>g||g!==g)g=h;if(d<c||c!==c)c=d;0<=e?(h=(a[2]-f.z)*e,a=(b[2]-f.z)*e):(h=(b[2]-f.z)*e,a=(a[2]-f.z)*e);if(g>a||h>c)return null;if(h>g||g!==g)g=h;if(a<c||c!==c)c=a;return 0>c?null:g}intersectPlane(a,b){a=-(GM.Vector3.dot(a,this.origin)-a.w)/GM.Vector3.dot(a,this.direction);return 0<=a?this.at(a,b):null}static transform(a,b,c){GM.Vector3.add(a.direction,a.origin,c.direction);GM.Vector3.transform(c.direction,b,c.direction);GM.Vector3.transform(a.origin,b,c.origin);GM.Vector3.sub(c.direction,c.origin,
c.direction);return c}static intersectPlane(a,b,c){b=-(b.x*a.origin.x+b.y*a.origin.y+b.z*a.origin.z-b.w)/(b.x*a.direction.x+b.y*a.direction.y+b.z*a.direction.z);c.x=a.direction.x*b+a.origin.x;c.y=a.direction.y*b+a.origin.y;c.z=a.direction.z*b+a.origin.z;return c}};
GM.Plane=class{static create(a,b,c,d){return{x:a,y:b,z:c,w:d}}static init(a,b,c,d,e){a.x=b;a.y=c;a.z=d;a.w=e;return a}static fromNormalPoint(a,b,c){GM.Vector3.copy(a,c);c.w=GM.Vector3.dot(b,a)}static copy(a,b){GM.Vector3.copy(a,b);b.w=a.w}static normalize(a,b){var c=1/GM.Vector3.mag(a);GM.Vector3.scale(a,c,b);b.w=a.w*c}static transform(a,b,c){let d=a.x;var e=a.y;let f=a.z;a=a.w;c.x=b[0]*d+b[4]*e+b[8]*f+b[12]*a;c.y=b[1]*d+b[5]*e+b[9]*f+b[13]*a;c.z=b[2]*d+b[6]*e+b[10]*f+b[14]*a;c.w=b[3]*d+b[7]*e+b[11]*
f+b[15]*a;return c}};
GM.Quaternion=class{constructor(a,b,c,d){this.x=a||0;this.y=b||0;this.z=c||0;this.w=void 0!==d?d:1}fromEuler(a){var b=Math.cos(a.x/2),c=Math.cos(a.y/2),d=Math.cos(a.z/2),e=Math.sin(a.x/2),f=Math.sin(a.y/2);a=Math.sin(a.z/2);this.x=e*c*d+b*f*a;this.y=b*f*d-e*c*a;this.z=b*c*a-e*f*d;this.w=b*c*d+e*f*a}fromAxisAngle(a,b){b/=2;var c=Math.sin(b);this.x=a.x*c;this.y=a.y*c;this.z=a.z*c;this.w=Math.cos(b)}slerp(a,b){var c=this.x,d=this.y,e=this.z,f=this.w,g=f*a.w+c*a.x+d*a.y+e*a.z;0>g?(this.w=-a.w,this.x=
-a.x,this.y=-a.y,this.z=-a.z,g=-g):(this.w=a.w,this.x=a.x,this.y=a.y,this.z=a.z);if(1<=g)return this.w=f,this.x=c,this.y=d,this.z=e,this;a=Math.sqrt(1-g*g);if(.001>Math.abs(a))return this.w=.5*(f+this.w),this.x=.5*(c+this.x),this.y=.5*(d+this.y),this.z=.5*(e+this.z),this;var h=Math.atan2(a,g);g=Math.sin((1-b)*h)/a;b=Math.sin(b*h)/a;this.w=f*g+this.w*b;this.x=c*g+this.x*b;this.y=d*g+this.y*b;this.z=e*g+this.z*b;return this}static multiply(a,b,c){const d=a.x,e=a.y,f=a.z;a=a.w;const g=b.x,h=b.y,k=b.z;
b=b.w;c.x=d*b+a*g+e*k-f*h;c.y=e*b+a*h+f*g-d*k;c.z=f*b+a*k+d*h-e*g;c.w=a*b-d*g-e*h-f*k;return c}static between(a,b,c){let d=GM.Vector3.dot(a,b)+1;d<Number.EPSILON?(Math.abs(a.x)>Math.abs(a.z)?(c.x=-a.y,c.y=a.x,c.z=0):(c.x=0,c.y=-a.z,c.z=a.y),c.w=0):(c.x=a.y*b.z-a.z*b.y,c.y=a.z*b.x-a.x*b.z,c.z=a.x*b.y-a.y*b.x,c.w=d);a=Math.sqrt(c.x*c.x+c.y*c.y+c.z*c.z+c.w*c.w);a>Number.EPSILON?(c.x/=a,c.y/=a,c.z/=a,c.w/=a):(c.x=0,c.y=0,c.z=0,c.w=1);return c}static axisAngle(a,b,c,d,e){d/=2;let f=Math.sin(d);e.x=a*f;
e.y=b*f;e.z=c*f;e.w=Math.cos(d);return e}static slerp(a,b,c,d){c.x=a.x;c.y=a.y;c.z=a.z;c.w=a.w;c.slerp(b,d)}static create(a,b,c,d){return{x:a,y:b,z:c,w:d}}};GM.Matrix3=function(){this.elements=new Float32Array([1,0,0,0,1,0,0,0,1])};GM.Matrix3.prototype.clone=function(){var a=new GM.Matrix3;a.elements.set(this.elements);return a};
GM.Matrix4=class{static create(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}static init(a){return new Float32Array(a)}static transpose(a,b){for(var c=0;4>c;c++)for(var d=0;4>d;d++)b[4*c+d]=a[c+4*d];return b}static invert(a,b){let c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],k=a[6],l=a[7],m=a[8],n=a[9],q=a[10],p=a[11],r=a[12],t=a[13],u=a[14];a=a[15];let w=n*u*l-t*q*l+t*k*p-h*u*p-n*k*a+h*q*a,x=r*q*l-m*u*l-r*k*p+g*u*p+m*k*a-g*q*a,y=m*t*l-r*n*l+r*h*p-g*t*p-m*h*a+g*n*a,z=r*n*k-m*t*k-r*h*q+
g*t*q+m*h*u-g*n*u,v=1/(c*w+d*x+e*y+f*z);b[0]=w*v;b[1]=(t*q*f-n*u*f-t*e*p+d*u*p+n*e*a-d*q*a)*v;b[2]=(h*u*f-t*k*f+t*e*l-d*u*l-h*e*a+d*k*a)*v;b[3]=(n*k*f-h*q*f-n*e*l+d*q*l+h*e*p-d*k*p)*v;b[4]=x*v;b[5]=(m*u*f-r*q*f+r*e*p-c*u*p-m*e*a+c*q*a)*v;b[6]=(r*k*f-g*u*f-r*e*l+c*u*l+g*e*a-c*k*a)*v;b[7]=(g*q*f-m*k*f+m*e*l-c*q*l-g*e*p+c*k*p)*v;b[8]=y*v;b[9]=(r*n*f-m*t*f-r*d*p+c*t*p+m*d*a-c*n*a)*v;b[10]=(g*t*f-r*h*f+r*d*l-c*t*l-g*d*a+c*h*a)*v;b[11]=(m*h*f-g*n*f-m*d*l+c*n*l+g*d*p-c*h*p)*v;b[12]=z*v;b[13]=(m*t*e-r*n*
e+r*d*q-c*t*q-m*d*u+c*n*u)*v;b[14]=(r*h*e-g*t*e-r*d*k+c*t*k+g*d*u-c*h*u)*v;b[15]=(g*n*e-m*h*e+m*d*k-c*n*k-g*d*q+c*h*q)*v;return b}static quaternion(a,b){var c=a.x,d=a.y,e=a.z,f=a.w,g=c+c,h=d+d;let k=e+e;a=c*g;let l=c*h;c*=k;let m=d*h;d*=k;e*=k;g*=f;h*=f;f*=k;b[0]=1-(m+e);b[4]=l-f;b[8]=c+h;b[1]=l+f;b[5]=1-(a+e);b[9]=d-g;b[2]=c-h;b[6]=d+g;b[10]=1-(a+m);b[3]=0;b[7]=0;b[11]=0;b[12]=0;b[13]=0;b[14]=0;b[15]=1;return b}static fromEuler(a,b){var c=Math.cos(a.x),d=Math.sin(a.x),e=Math.cos(a.y),f=Math.sin(a.y),
g=Math.cos(a.z);a=Math.sin(a.z);var h=e*g,k=e*a,l=f*g,m=f*a;b[0]=h+m*d;b[4]=l*d-k;b[8]=c*f;b[1]=c*a;b[5]=c*g;b[9]=-d;b[2]=k*d-l;b[6]=m+h*d;b[10]=c*e;return b}static position(a,b){b[12]=a.x;b[13]=a.y;b[14]=a.z;return b}static copy(a,b){b.set(a);return a}static multiply(a,b,c){var d=a[0],e=a[4],f=a[8],g=a[12],h=a[1],k=a[5],l=a[9],m=a[13],n=a[2],q=a[6],p=a[10],r=a[14],t=a[3],u=a[7],w=a[11];a=a[15];var x=b[0],y=b[4],z=b[8],v=b[12],A=b[1],B=b[5],C=b[9],D=b[13],E=b[2],F=b[6],G=b[10],H=b[14],I=b[3],J=b[7],
K=b[11];b=b[15];c[0]=d*x+e*A+f*E+g*I;c[4]=d*y+e*B+f*F+g*J;c[8]=d*z+e*C+f*G+g*K;c[12]=d*v+e*D+f*H+g*b;c[1]=h*x+k*A+l*E+m*I;c[5]=h*y+k*B+l*F+m*J;c[9]=h*z+k*C+l*G+m*K;c[13]=h*v+k*D+l*H+m*b;c[2]=n*x+q*A+p*E+r*I;c[6]=n*y+q*B+p*F+r*J;c[10]=n*z+q*C+p*G+r*K;c[14]=n*v+q*D+p*H+r*b;c[3]=t*x+u*A+w*E+a*I;c[7]=t*y+u*B+w*F+a*J;c[11]=t*z+u*C+w*G+a*K;c[15]=t*v+u*D+w*H+a*b;return c}static yAxisT(a,b){b.x=a[4];b.y=a[5];b.z=a[6];return b}static yAxis(a,b){b.x=a[1];b.y=a[5];b.z=a[9];return b}};
GM.Euler=class{constructor(a,b,c){this.x=a||0;this.y=b||0;this.z=c||0}fromQuaternion(a){var b=a.x+a.x,c=a.y+a.y,d=a.z+a.z,e=a.x*b,f=a.x*c,g=a.x*d,h=a.y*c,k=a.y*d,l=a.z*d;b*=a.w;c*=a.w;a=a.w*d;this.x=Math.asin(-GM.clamp(k-b,-1,1));.99999>Math.abs(k-b)?(this.y=Math.atan2(g+c,1-(e+h)),this.z=Math.atan2(f+a,1-(e+l))):(this.y=Math.atan2(c-g,1-(h+l)),this.z=0)}toJson(){return{x:this.x,y:this.y,z:this.z}}static create(a,b,c){return{x:a,y:b,z:c}}static fromMatrix(a,b){var c=a[0],d=a[8],e=a[1],f=a[5],g=a[9],
h=a[2];a=a[10];b.x=Math.asin(-GM.clamp(g,-1,1));.99999>Math.abs(g)?(b.y=Math.atan2(d,a),b.z=Math.atan2(e,f)):(b.y=Math.atan2(-h,c),b.z=0)}static convert(a,b,c){var d=Math.cos(a.x),e=Math.sin(a.x),f=Math.cos(a.y),g=Math.sin(a.y),h=Math.cos(a.z);a=Math.sin(a.z);let k=GM.Matrix4.create();if("XYZ"===c){c=d*h;var l=d*a,m=e*h,n=e*a;k[0]=f*h;k[4]=-f*a;k[8]=g;k[1]=l+m*g;k[5]=c-n*g;k[9]=-e*f;k[2]=n-c*g;k[6]=m+l*g;k[10]=d*f}else"YXZ"===c?(c=f*h,l=f*a,m=g*h,n=g*a,k[0]=c+n*e,k[4]=m*e-l,k[8]=d*g,k[1]=d*a,k[5]=
d*h,k[9]=-e,k[2]=l*e-m,k[6]=n+c*e,k[10]=d*f):"ZXY"===c?(c=f*h,l=f*a,m=g*h,n=g*a,k[0]=c-n*e,k[4]=-d*a,k[8]=m+l*e,k[1]=l+m*e,k[5]=d*h,k[9]=n-c*e,k[2]=-d*g,k[6]=e,k[1]=d*f):"ZYX"===c?(c=d*h,l=d*a,m=e*h,n=e*a,k[0]=f*h,k[4]=m*g-l,k[8]=c*g+n,k[1]=f*a,k[5]=n*g+c,k[9]=l*g-m,k[2]=-g,k[6]=e*f,k[10]=d*f):"YZX"===c?(c=d*f,l=d*g,m=e*f,n=e*g,k[0]=f*h,k[4]=n-c*a,k[8]=m*a+l,k[1]=a,k[5]=d*h,k[9]=-e*h,k[2]=-g*h,k[6]=l*a+m,k[10]=c-n*a):"XZY"===c&&(c=d*f,l=d*g,m=e*f,n=e*g,k[0]=f*h,k[4]=-a,k[8]=g*h,k[1]=c*a+n,k[5]=d*
h,k[9]=l*a-m,k[2]=m*a-l,k[6]=e*h,k[10]=n*a+c);GM.Euler.fromMatrix(k,b)}static zAxisT(a,b){var c=Math.cos(a.x),d=Math.sin(a.x),e=Math.cos(a.y);b.x=c*Math.sin(a.y);b.y=-d;b.z=c*e;return b}static fromDirection(a){return{x:-Math.asin(-a.y),y:Math.atan2(-a.x,-a.z),z:0}}static copy(a,b){b.x=a.x;b.y=a.y;b.z=a.z;return b}};
GM.Frustum=class{static create(){return[GM.Plane.create(1,0,0,0),GM.Plane.create(1,0,0,0),GM.Plane.create(1,0,0,0),GM.Plane.create(1,0,0,0),GM.Plane.create(1,0,0,0),GM.Plane.create(1,0,0,0)]}static init(a,b){let c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],k=b[6],l=b[7],m=b[8],n=b[9],q=b[10],p=b[11],r=b[12],t=b[13],u=b[14];b=b[15];GM.Plane.init(a[0],f-c,l-g,p-m,b-r);GM.Plane.init(a[1],f+c,l+g,p+m,b+r);GM.Plane.init(a[2],f+d,l+h,p+n,b+t);GM.Plane.init(a[3],f-d,l-h,p-n,b-t);GM.Plane.init(a[4],f-e,l-k,
p-q,b-u);GM.Plane.init(a[5],f+e,l+k,p+q,b+u);GM.Plane.normalize(a[0],a[0]);GM.Plane.normalize(a[1],a[1]);GM.Plane.normalize(a[2],a[2]);GM.Plane.normalize(a[3],a[3]);GM.Plane.normalize(a[4],a[4]);GM.Plane.normalize(a[5],a[5]);return a}static transform(a,b,c){GM.Matrix4.transpose(b,GM.Frustum.matrix);GM.Matrix4.invert(GM.Frustum.matrix,GM.Frustum.matrix);for(b=0;b<a.length;b++)GM.Plane.transform(a[b],GM.Frustum.matrix,c[b])}static intersectsBox(a,b){for(var c=0;5>c;c++){var d=a[c],e=GM.Vector3.dot(d,
{x:0<d.x?b.min.x:b.max.x,y:0<d.y?b.min.y:b.max.y,z:0<d.z?b.min.z:b.max.z})+d.w;d=GM.Vector3.dot(d,{x:0<d.x?b.max.x:b.min.x,y:0<d.y?b.max.y:b.min.y,z:0<d.z?b.max.z:b.min.z})+d.w;if(0>e&&0>d)return!1}d=a[5];e=GM.Vector3.dot(d,{x:0<d.x?b.min.x:b.max.x,y:0<d.y?b.min.y:b.max.y,z:0<d.z?b.min.z:b.max.z})+d.w;d=GM.Vector3.dot(d,{x:0<d.x?b.max.x:b.min.x,y:0<d.y?b.max.y:b.min.y,z:0<d.z?b.max.z:b.min.z})+d.w;if(0>e&&0>d)return!1;b.nearDistance=Math.max(0,Math.min(e,d));return!0}static farDistance(a,b){for(var c=
Number.POSITIVE_INFINITY,d=0;6>d;d++){var e=a[d];c=Math.min(GM.Vector3.dot(e,{x:0<e.x?b.min.x:b.max.x,y:0<e.y?b.min.y:b.max.y,z:0<e.z?b.min.z:b.max.z})+e.w,c);c=Math.min(GM.Vector3.dot(e,{x:0<e.x?b.max.x:b.min.x,y:0<e.y?b.max.y:b.min.y,z:0<e.z?b.max.z:b.min.z})+e.w,c)}return c}static copy(a,b){for(var c=0;6>c;c++)GM.Plane.copy(a[c],b[c])}};GM.Frustum.matrix=GM.Matrix4.create();
GM.Projection=class{constructor(a){this.matrix=GM.Matrix4.create();this.inverse=GM.Matrix4.create();this.mvpMatrix=GM.Matrix4.create();this.mvpInverse=GM.Matrix4.create();this.type=a;this.farOffset=1;this.nearOffset=0;this.far=1E5;this.near=.1}update(a,b,c){GM.Matrix4.invert(this.matrix,this.inverse);GM.Matrix4.multiply(this.matrix,b,this.mvpMatrix);GM.Matrix4.multiply(a,this.inverse,this.mvpInverse)}setRange(a,b){this.near=a;this.far=b}getNear(){return this.near}getFar(){return this.far}set(a){}toJson(){return{}}};
GM.PerspectiveProjection=class extends GM.Projection{constructor(a){super("Perspective");this.setFov(a)}update(a,b,c){let d=this.near,e=this.far,f=c.width/c.height;this.fovV=this.fovH/f;let g=1/this.fovV,h=this.matrix;h[0]=g/f;h[4]=0;h[8]=0;h[12]=0;h[1]=0;h[5]=g;h[9]=0;h[13]=0;h[2]=0;h[6]=0;h[10]=(e+d)/(d-e);h[14]=2*e*d/(d-e);h[3]=0;h[7]=0;h[11]=-1;h[15]=0;super.update(a,b,c)}setFov(a){this.fovH=Math.tan(GM.DEG2RAD*a*.5)}project(a){var b=a.x,c=a.y;a=a.z;var d=this.mvpMatrix,e=1/(d[3]*b+d[7]*c+d[11]*
a+d[15]);0>e&&(e=-e);var f=new GM.Vector3;f.x=(d[0]*b+d[4]*c+d[8]*a+d[12])*e;f.y=(d[1]*b+d[5]*c+d[9]*a+d[13])*e;f.z=(d[2]*b+d[6]*c+d[10]*a+d[14])*e;return f}unproject(a,b){var c=a.x;a=a.y;var d=this.mvpInverse,e=1/(d[3]*c+d[7]*a+d[11]+d[15]);0>e&&(e=-e);b.x=(d[0]*c+d[4]*a+d[8]+d[12])*e;b.y=(d[1]*c+d[5]*a+d[9]+d[13])*e;b.z=(d[2]*c+d[6]*a+d[10]+d[14])*e;return b}setRange2(a,b){var c=b.min,d=b.max,e=0;a.x<c.x?e=c.x-a.x:a.x>d.x&&(e=a.x-d.x);var f=e*e;e=0;a.y<c.y?e=c.y-a.y:a.y>d.y&&(e=a.y-d.y);f+=e*e;
e=0;a.z<c.z?e=c.z-a.z:a.z>d.z&&(e=a.z-d.z);f+=e*e;a=GL.BoundingBox.diagonal(b);f=Math.max(a/1E3,Math.sqrt(f));this.near=f/2;this.far=f+a}getRay(a,b,c){this.unproject(a,c.direction);c.direction.sub(b.position).normalize();c.origin.copy(b.position);return c}toJson(){var a=super.toJson();a.fovV=this.fovV;a.fovH=this.fovH;return a}};
GM.Camera=class{constructor(a){this.viewport=a;this.position=new GM.Vector3;this.rotation=new GM.Euler;this.xAxis=GM.Vector3.create(1,0,0);this.yAxis=GM.Vector3.create(0,1,0);this.zAxis=GM.Vector3.create(0,0,-1);this.ray=new GM.Ray(new GM.Vector3(0,0,0),new GM.Vector3(0,0,-1));this.toggle=this.moving=!1}set(a){this.toggle=!0}changed(){let a=this.toggle;this.toggle=!1;return a}screenToCamera(a){return{x:a.pageX/this.viewport.width*2-1,y:2*-(a.pageY/this.viewport.height)+1}}};
GM.CameraMVP=class extends GM.Camera{constructor(a,b){super(a);this.projection=b;this.matrix=GM.Matrix4.create();this.inverse=GM.Matrix4.create();this.modelViewMatrix=GM.Matrix4.create();this.frustum=GM.Frustum.create()}set(a){super.set();a.matrix?(GM.Euler.fromMatrix(a.matrix,this.rotation),GM.Vector3.fromMatrix(a.matrix,this.position)):(a.position&&GM.Vector3.copy(a.position,this.position),a.rotation&&(a.rotation.order?GM.Euler.convert(a.rotation,this.rotation,a.rotation.order):GM.Vector3.copy(a.rotation,
this.rotation)));a.K&&(this.projection.fovH=.5*a.K[0]/a.K[2])}updateMatrix(){GM.Matrix4.fromEuler(this.rotation,this.matrix);GM.Matrix4.position(this.position,this.matrix);GM.Vector3.read(this.xAxis,this.matrix,0);GM.Vector3.read(this.yAxis,this.matrix,4);GM.Vector3.read(this.zAxis,this.matrix,8);GM.Matrix4.invert(this.matrix,this.inverse);GM.Matrix4.copy(this.inverse,this.modelViewMatrix);this.projection.update(this.matrix,this.inverse,this.viewport);GM.Frustum.init(this.frustum,this.projection.mvpMatrix)}updateRange(a){this.projection.setRange2(this.position,
a)}screenToCamera(a){return{x:a.pageX/this.viewport.width*2-1,y:2*-(a.pageY/this.viewport.height)+1}}intersectsBox(a){return GM.Frustum.intersectsBox(this.frustum,a)}getNearPlane(){var a=this.position.x*this.zAxis.x+this.position.y*this.zAxis.y+this.position.z*this.zAxis.z,b=this.projection.getNear()+.001*(this.projection.getFar()-this.projection.getNear());return{x:this.zAxis.x,y:this.zAxis.y,z:this.zAxis.z,w:a-b}}project(a){a=this.projection.project(a);a.x=(a.x+1)/2;a.y=1-(a.y+1)/2;return a}getRay(a,
b){b||(b=this.ray);return this.projection.getRay(this.screenToCamera(a),this,b)}getRayToPoint(a,b){GM.Vector3.subtract(b,this.position,a.direction);GM.Vector3.normalize(a.direction,a.direction);GM.Vector3.copy(this.position,a.origin);return a}toJson(){return{projection:this.projection.toJson(),position:this.position.toJson(),rotation:this.rotation.toJson(),xAxis:this.xAxis,yAxis:this.yAxis,zAxis:this.zAxis}}};
GM.OrthographicProjection=class extends GM.Projection{constructor(){super("Orthographic");this.zoom=1}update(a,b,c){var d=this.far-this.near,e=this.near+d*this.nearOffset;d=this.far-d*(1-this.farOffset);var f=1/(d-e),g=1/c.height;let h=this.matrix;h[0]=1/c.width*2;h[4]=0;h[8]=0;h[12]=0;h[1]=0;h[5]=2*g;h[9]=0;h[13]=0;h[2]=0;h[6]=0;h[10]=-2*f;h[14]=-((d+e)*f);h[3]=0;h[7]=0;h[11]=0;h[15]=1;super.update(a,b,c)}setRange2(a,b){}project(a){var b=a.x,c=a.y;a=a.z;var d=this.mvpMatrix,e=new GM.Vector3;e.x=
d[0]*b+d[4]*c+d[8]*a+d[12];e.y=d[1]*b+d[5]*c+d[9]*a+d[13];e.z=d[2]*b+d[6]*c+d[10]*a+d[14];return e}unproject(a,b){var c=a.x;a=a.y;var d=this.mvpInverse;b.x=d[0]*c+d[4]*a+d[8]+d[12];b.y=d[1]*c+d[5]*a+d[9]+d[13];b.z=d[2]*c+d[6]*a+d[10]+d[14];return b}getRay(a,b){b=new GM.Vector3(-b.zAxis.x,-b.zAxis.y,-b.zAxis.z);var c=new GM.Vector3;this.unproject(a,c);a=this.getNear();var d=this.getFar();c.x-=b.x*(d-a);c.y-=b.y*(d-a);c.z-=b.z*(d-a);return new GM.Ray(c,b)}};
</script>
<script id="/gl/gl.js">GL={};var gl;GL.Buffer=function(){this.glId=gl.createBuffer()};GL.Buffer.prototype.clear=function(){null!=this.glId&&(gl.deleteBuffer(this.glId),this.glId=null)};
GL.ArrayBuffer=class extends GL.Buffer{constructor(a){super();gl.bindBuffer(gl.ARRAY_BUFFER,this.glId);gl.bufferData(gl.ARRAY_BUFFER,a,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,null);this.length="number"==typeof a?a:a.length}set(a){gl.bindBuffer(gl.ARRAY_BUFFER,this.glId);gl.bufferData(gl.ARRAY_BUFFER,a,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,null);this.length="number"==typeof a?a:a.length}write(a,c){gl.bindBuffer(gl.ARRAY_BUFFER,this.glId);gl.bufferSubData(gl.ARRAY_BUFFER,a,c);gl.bindBuffer(gl.ARRAY_BUFFER,
null)}};GL.ElementBuffer=function(a){GL.Buffer.call(this);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.glId);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,a,gl.STATIC_DRAW);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null);this.length=a.length};GL.ElementBuffer.prototype=Object.create(GL.Buffer.prototype);GL.ElementBuffer.prototype.constructor=GL.ElementBuffer;GL.ImageLoader=function(a,c){this.listener=[];c&&this.listener.push(c);a&&this.load(a)};GL.ImageLoader.prototype.listen=function(a){this.listener.push(a)};
GL.ImageLoader.prototype.load=function(a){function c(b){return 0==(b&b-1)}function d(b){--b;for(var e=1;32>e;e<<=1)b|=b>>e;return b+1}this.image=document.createElementNS("http://www.w3.org/1999/xhtml","img");this.image.onload=function(){URL.revokeObjectURL(this.image.src);if(!c(this.image.width)||!c(this.image.height)){var b=document.createElement("canvas");b.width=d(this.image.width);b.height=d(this.image.height);b.getContext("2d").drawImage(this.image,0,0,b.width,b.height);this.image=b}for(b=0;b<
this.listener.length;b++)this.listener[b].notify(this.image);this.image=null}.bind(this);this.image.crossOrigin="Anonymous";this.image.src=a};
GL.Texture=function(a,c,d){this.name=d;this.glId=gl.createTexture();this.sampler=c;this.sampler||(this.sampler={});gl.bindTexture(gl.TEXTURE_2D,this.glId);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,1,1,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array([255,255,255,255]));gl.bindTexture(gl.TEXTURE_2D,null);a instanceof GL.ImageLoader?a.listen(this):a instanceof Image&&this.notify(a)};
GL.Texture.prototype.clear=function(){null!=this.glId&&(gl.deleteTexture(this.glId),this.glId=null)};
GL.Texture.prototype.notify=function(a){gl.bindTexture(gl.TEXTURE_2D,this.glId);this.sampler.minFilter?gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.sampler.minFilter):gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST_MIPMAP_LINEAR);this.sampler.magFilter?gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.sampler.magFilter):gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);this.sampler.wrapS?gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,this.sampler.wrapS):
gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.REPEAT);this.sampler.wrapT?gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,this.sampler.wrapT):gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.REPEAT);gl.supports_EXT_texture_filter_anisotropic&&gl.texParameterf(gl.TEXTURE_2D,gl.anisotropy,gl.maxAnisotropy);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,a);gl.generateMipmap(gl.TEXTURE_2D);gl.bindTexture(gl.TEXTURE_2D,null)};
GL.Gradient=function(a){this.name=name;this.glId=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,this.glId);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,a.length/4,1,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array(a));gl.bindTexture(gl.TEXTURE_2D,null)};
GL.Material=function(a){this.name=a.id;this.diffuse=a.diffuse;this.emissive=a.emissive;this.specular=a.specular;this.ambient=a.ambient;this.normal=a.normal;this.transparency=a.transparency};GL.Material.prototype.clear=function(){};
</script>
<script id="/gl/shader.js">GL.Shader=function(a,b){this.defines={};this.uniforms={};this.vertexShader=gl.createShader(gl.VERTEX_SHADER);this.fragmentShader=gl.createShader(gl.FRAGMENT_SHADER);this.glId=gl.createProgram();gl.attachShader(this.glId,this.vertexShader);gl.attachShader(this.glId,this.fragmentShader);this.vertexCode=a;this.fragmentCode=b;this.config=""};GL.Shader.prototype.defineUniforms=function(a){for(var b=0;b<a.length;b++)this.uniforms[a[b]]=gl.getUniformLocation(this.glId,a[b])};
GL.Shader.prototype.enableBuffer=function(a){if(a)for(var b=0;b<this.attributes.length;b++){var c=this.attributes[b];a[c.name]&&gl.enableVertexAttribArray(c.location)}else for(b=0;b<this.attributes.length;b++)c=this.attributes[b],gl.enableVertexAttribArray(c.location)};GL.Shader.prototype.bindBuffer=function(a){for(var b=0;b<this.attributes.length;b++){var c=this.attributes[b];a[c.name]&&(gl.bindBuffer(gl.ARRAY_BUFFER,a[c.name].glId),gl.vertexAttribPointer(c.location,c.size,c.type,c.normalize,0,0))}};
GL.Shader.prototype.disableBuffer=function(a){if(a)for(var b=0;b<this.attributes.length;b++){var c=this.attributes[b];a[c.name]&&gl.disableVertexAttribArray(c.location)}else for(b=0;b<this.attributes.length;b++)c=this.attributes[b],gl.disableVertexAttribArray(c.location)};GL.Shader.prototype.defineAttribute=function(a,b,c,e,d){d=gl.getAttribLocation(this.glId,null==d?a:d);-1!=d?this.attributes.push({location:d,name:a,size:b,type:c,normalize:e}):console.log("attribute "+a+" not found ")};
GL.Shader.prototype.undefineAttribute=function(a){for(var b=0;b<this.attributes.length;b++)if(this.attributes[b].name===a){this.attributes.splice(b,1);break}};GL.Shader.prototype.defineDirective=function(a){this.defines[a]=value};GL.Shader.prototype.undefineDirective=function(a){delete this.defines[a]};
GL.Shader.prototype.compile=function(a){for(var b in this.defines)1==this.defines[b]&&(this.config+="#define "+b+"\n");this.vertexCode.startsWith("#version")?(a=this.vertexCode.indexOf("\n")+1,a=this.vertexCode.slice(0,a)+this.config+this.vertexCode.slice(a)):a=this.config+this.vertexCode;gl.shaderSource(this.vertexShader,a);gl.compileShader(this.vertexShader);!1===gl.getShaderParameter(this.vertexShader,gl.COMPILE_STATUS)&&console.error("Vertex Shader compile error");""!==gl.getShaderInfoLog(this.vertexShader)&&
console.warn(gl.getShaderInfoLog(this.vertexShader));this.fragmentCode.startsWith("#version")?(a=this.fragmentCode.indexOf("\n")+1,a=this.fragmentCode.slice(0,a)+this.config+this.fragmentCode.slice(a)):a=this.config+this.fragmentCode;gl.shaderSource(this.fragmentShader,a);gl.compileShader(this.fragmentShader);!1===gl.getShaderParameter(this.fragmentShader,gl.COMPILE_STATUS)&&console.error("Fragment Shader compile error");""!==gl.getShaderInfoLog(this.fragmentShader)&&console.warn(gl.getShaderInfoLog(this.fragmentShader));
gl.linkProgram(this.glId);this.config="";this.attributes=[]};GL.Shader.prototype.useProgram=function(a){GL.Shader.glId=this.glId;gl.useProgram(this.glId)};GL.Shader.prototype.isActive=function(){return GL.Shader.glId==this.glId};GL.Shader.prototype.clear=function(){gl.deleteProgram(this.glId)};GL.ShaderMVP=function(a,b){GL.Shader.call(this,a,b)};GL.ShaderMVP.prototype=Object.create(GL.Shader.prototype);GL.ShaderMVP.prototype.constructor=GL.ShaderMVP;
GL.ShaderMVP.prototype.useProgram=function(a){GL.Shader.prototype.useProgram.call(this);gl.uniformMatrix4fv(this.modelViewMatrix,!1,a.modelViewMatrix);gl.uniformMatrix4fv(this.projectionMatrix,!1,a.projection.matrix)};GL.ShaderMVP.prototype.updateModelMatrix=function(a){gl.uniformMatrix4fv(this.modelViewMatrix,!1,a.modelViewMatrix)};
GL.ShaderMVP.prototype.compile=function(){GL.Shader.prototype.compile.call(this);this.modelViewMatrix=gl.getUniformLocation(this.glId,"modelViewMatrix");this.projectionMatrix=gl.getUniformLocation(this.glId,"projectionMatrix")};GL.LineShader=function(){GL.ShaderMVP.call(this,GL.LineShader.vs,GL.LineShader.fs)};GL.LineShader.prototype=Object.create(GL.ShaderMVP.prototype);GL.LineShader.prototype.constructor=GL.LineShader;
GL.LineShader.prototype.compile=function(){GL.ShaderMVP.prototype.compile.call(this);this.defineAttribute("position",3,gl.FLOAT,!1);this.defineAttribute("color",3,gl.UNSIGNED_BYTE,!0)};GL.LineShader.vs="\nprecision mediump float;\nprecision mediump int;\n\nuniform mat4 modelViewMatrix; \nuniform mat4 projectionMatrix; \n\nattribute vec3 position;\nattribute vec3 color;\n\nvarying vec3 vColor;\n\nvoid main()\t\n{\n    vColor = color;\n    gl_Position = projectionMatrix * (modelViewMatrix * vec4(position, 1.0));\n}\n";
GL.LineShader.fs="\nprecision mediump float;\nprecision mediump int;\n\nvarying vec3 vColor;\n\nvoid main()\t\n{\n    gl_FragColor = vec4(vColor, 1);\n    //gl_FragColor = vec4(1,1,1, 1);\n}";GL.CopyShader=function(){GL.Shader.call(this,GL.CopyShader.vs,GL.CopyShader.fs)};GL.CopyShader.prototype=Object.create(GL.ShaderMVP.prototype);GL.CopyShader.prototype.constructor=GL.CopyShader;
GL.CopyShader.prototype.compile=function(){GL.ShaderMVP.prototype.compile.call(this);this.defineAttribute("position",3,gl.FLOAT,!1);this.defineAttribute("color",3,gl.UNSIGNED_BYTE,!0)};GL.CopyShader.vs="\nattribute vec3 position;\n\nvoid main()\t\n{\n    gl_Position = position;\n}\n";GL.CopyShader.fs="\nprecision mediump float;\nprecision mediump int;\n\nvarying vec3 vColor;\n\nvoid main()\t\n{\n    gl_FragColor = vec4(vColor, 1);\n    //gl_FragColor = vec4(1,1,1, 1);\n}";
</script>
<script id="/gl/object.js">GL.Axis=function(a,b,c){this.pz=this.py=this.px=0;this.sx=a|1;this.sy=b|1;this.sz=c|1;this.visible=!0;this.color=new GL.ArrayBuffer(new Uint8Array([255,0,0,255,0,0,0,255,0,0,255,0,0,0,255,0,0,255]));this.shader=new GL.LineShader;this.shader.compile();this.update()};GL.Axis.prototype.render=function(a){this.visible&&(this.shader.useProgram(a),this.shader.enableBuffer(this),this.shader.bindBuffer(this),gl.disable(gl.DEPTH_TEST),gl.drawArrays(gl.LINES,0,6),this.shader.disableBuffer(this),gl.enable(gl.DEPTH_TEST))};
GL.Axis.prototype.update=function(){this.position=new GL.ArrayBuffer(new Float32Array([this.px,this.py,this.pz,this.px+this.sx,this.py,this.pz,this.px,this.py,this.pz,this.px,this.py+this.sy,this.pz,this.px,this.py,this.pz,this.px,this.py,this.pz+this.sz]))};GL.Axis.prototype.resize=function(a,b){b=.25*GM.Vector3.mag(GM.Vector3.sub3V(this.px,this.py,this.pz,b.position));this.sx=Math.min(b,a.max.x-a.min.x);this.sy=Math.min(b,a.max.y-a.min.y);this.sz=Math.min(b,a.max.z-a.min.z);this.update()};
GL.Axis.prototype.moveTo=function(a,b,c){this.px=a;this.py=b;this.pz=c;this.update()};
GL.BoundingBox=class{constructor(a){this.position=new GL.ArrayBuffer(new Float32Array([a.min.x,a.min.y,a.min.z,a.max.x,a.min.y,a.min.z,a.max.x,a.min.y,a.min.z,a.max.x,a.max.y,a.min.z,a.max.x,a.max.y,a.min.z,a.min.x,a.max.y,a.min.z,a.min.x,a.max.y,a.min.z,a.min.x,a.min.y,a.min.z,a.min.x,a.min.y,a.max.z,a.max.x,a.min.y,a.max.z,a.max.x,a.min.y,a.max.z,a.max.x,a.max.y,a.max.z,a.max.x,a.max.y,a.max.z,a.min.x,a.max.y,a.max.z,a.min.x,a.max.y,a.max.z,a.min.x,a.min.y,a.max.z,a.min.x,a.min.y,a.min.z,a.min.x,
a.min.y,a.max.z,a.min.x,a.max.y,a.min.z,a.min.x,a.max.y,a.max.z,a.max.x,a.max.y,a.min.z,a.max.x,a.max.y,a.max.z,a.max.x,a.min.y,a.min.z,a.max.x,a.min.y,a.max.z]));this.color=new GL.ArrayBuffer(new Uint8Array([255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0,255,0,0]));this.shader=new GL.LineShader;this.shader.compile()}render(a){this.shader.useProgram(a);gl.disable(gl.DEPTH_TEST);
this.shader.enableBuffer(this);this.shader.bindBuffer(this);gl.drawArrays(gl.LINES,0,24);this.shader.disableBuffer(this);gl.enable(gl.DEPTH_TEST)}setColor(a,b,c){this.color=new GL.ArrayBuffer(new Uint8Array([a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c,a,b,c]))}update(a){this.position=new GL.ArrayBuffer(new Float32Array([a.min.x,a.min.y,a.min.z,a.max.x,a.min.y,a.min.z,a.max.x,a.min.y,a.min.z,a.max.x,a.max.y,
a.min.z,a.max.x,a.max.y,a.min.z,a.min.x,a.max.y,a.min.z,a.min.x,a.max.y,a.min.z,a.min.x,a.min.y,a.min.z,a.min.x,a.min.y,a.max.z,a.max.x,a.min.y,a.max.z,a.max.x,a.min.y,a.max.z,a.max.x,a.max.y,a.max.z,a.max.x,a.max.y,a.max.z,a.min.x,a.max.y,a.max.z,a.min.x,a.max.y,a.max.z,a.min.x,a.min.y,a.max.z,a.min.x,a.min.y,a.min.z,a.min.x,a.min.y,a.max.z,a.min.x,a.max.y,a.min.z,a.min.x,a.max.y,a.max.z,a.max.x,a.max.y,a.min.z,a.max.x,a.max.y,a.max.z,a.max.x,a.min.y,a.min.z,a.max.x,a.min.y,a.max.z]))}static init(a){a.min=
{x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY,z:Number.POSITIVE_INFINITY};a.max={x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY,z:Number.NEGATIVE_INFINITY};return a}static create(a,b){return{min:{x:a.x||a[0],y:a.y||a[1],z:a.z||a[2]},max:{x:b.x||b[0],y:b.y||b[1],z:b.z||b[2]}}}static set(a,b,c){a.min={x:b.x||b[0],y:b.y||b[1],z:b.z||b[2]};a.max={x:c.x||c[0],y:c.y||c[1],z:c.z||c[2]}}static merge(a,b){GM.Vector3.min(a.min,b.min,a.min);GM.Vector3.max(a.max,b.max,a.max)}static grow(a,b){GM.Vector3.min(a.min,
b,a.min);GM.Vector3.max(a.max,b,a.max)}static center(a,b){b=b||{};b.x=(a.min.x+a.max.x)/2;b.y=(a.min.y+a.max.y)/2;b.z=(a.min.z+a.max.z)/2;return b}static diagonal(a){var b=a.max.x-a.min.x,c=a.max.y-a.min.y;a=a.max.z-a.min.z;return Math.sqrt(b*b+c*c+a*a)}static copy(a,b){GM.Vector3.copy(a.min,b.min);GM.Vector3.copy(a.max,b.max);return b}static transform(a,b,c){var d=[b[0]*a.min.x,b[4]*a.min.x,b[8]*a.min.x],e=[b[0]*a.max.x,b[4]*a.max.x,b[8]*a.max.x],f=[b[1]*a.min.y,b[5]*a.min.y,b[9]*a.min.y],g=[b[1]*
a.max.y,b[5]*a.max.y,b[9]*a.max.y],h=[b[2]*a.min.z,b[6]*a.min.z,b[10]*a.min.z];a=[b[2]*a.max.z,b[6]*a.max.z,b[10]*a.max.z];c.min.x=Math.min(d[0],e[0])+Math.min(f[0],g[0])+Math.min(h[0],a[0])+b[12];c.max.x=Math.max(d[0],e[0])+Math.max(f[0],g[0])+Math.max(h[0],a[0])+b[12];c.min.y=Math.min(d[1],e[1])+Math.min(f[1],g[1])+Math.min(h[1],a[1])+b[13];c.max.y=Math.max(d[1],e[1])+Math.max(f[1],g[1])+Math.max(h[1],a[1])+b[13];c.min.z=Math.min(d[2],e[2])+Math.min(f[2],g[2])+Math.min(h[2],a[2])+b[14];c.max.z=
Math.max(d[2],e[2])+Math.max(f[2],g[2])+Math.max(h[2],a[2])+b[14]}};
</script>
<script id="/index.js">U={};
V=function(){var a={viewer:null,touch3d:function(){V.viewer.repaint3d=!0},touch2d:function(){V.viewer.repaint2d=!0},api:{},notify:(b,c)=>{V.EventHandler.APPEVENTS[b].forEach(d=>d.method(c))},startLoading:()=>{a.loading++},stopLoading:()=>{a.loading--},loading:0};a.time=window.performance.now();a.DRAGERROR={r:1,g:.8,b:.8};a.DRAGOK={r:.8,g:1,b:.8};a.NODRAG={r:1,g:1,b:1};a.keyMap=[];a.keyCount=0;document.addEventListener("keydown",b=>{a.keyMap[b.keyCode]||(a.keyCount++,a.keyMap[b.keyCode]=!0)});document.addEventListener("keyup",
b=>{a.keyCount&&(a.keyCount--,a.keyMap[b.keyCode]=!1)});document.addEventListener("mouseout",b=>{a.keyMap=[];a.keyCount=0});a.log=!1;a.postMessage=(b,c,d)=>{V.logging&&console.log(`%c>>>> ${b}\n`,"color:grey; font-weight:800",c);window.parent.postMessage({action:b,args:c,optional:d},"*")};a.recvMessage=(b,c,d)=>{b instanceof Array?b.forEach(e=>a.recvMessage(e,c)):(c.owner=d,V.api[b]?V.api[b].push(c):V.api[b]=[c])};a.unrecvMessage=(b,c)=>{if(b instanceof Array)b.forEach(d=>a.unrecvMessage(d,c));else if(V.api[b]){let d=
V.api[b];for(b=0;b<d.length;b++)d[b].owner==c&&d.splice(b,1)}};a.viewerCb=function(b){let c={},d=RegExp("[?&]custom=([^&#]*)").exec(window.location.href);d&&(c=JSON.parse(decodeURIComponent(d[1])));V.postMessage("viewer.load",b,c)};a.importCb=function(b,c){V.postMessage("import.create",b,this)};a.METRIC=0;a.IMPERIAL=1;a.units=0;a.canvas=document.getElementById("canvas3D");window.addEventListener("message",function(b){if(b.data.action instanceof Array)b.data.action.forEach((e,f)=>{if(e=this.api[e]){this.logging&&
console.log(`%c<<< ${b.data.action}\n`,"color:green; font-weight:800",b.data.args[f]);for(var g=0;g<e.length;g++)e[g](b.data.args[f]||{},b.data.custom||{})}else this.logging&&console.log(`%c<<< ${b.data.action}\n`,"color:red; font-weight:800",b.data.args)});else{var c=this.api[b.data.action];if(c){this.logging&&console.log(`%c<<< ${b.data.action}\n`,"color:green; font-weight:800",b.data.args);for(var d=0;d<c.length;d++)c[d](b.data.args||{},b.data.custom||{})}else this.logging&&console.log(`%c<<< ${b.data.action}\n`,
"color:red; font-weight:800",b.data.args)}}.bind(a));return a}();M={MAX_MEM:367001600,MIN_MEM:325058560,memoryUsed:0,rendered:0};
V.EventHandler=class{constructor(a,b){this.prioSys=a;this.prioApp=b||a;this.cvsListener=[];this.onMouseDown&&this.cvsListener.push({name:"mousedown",method:this.onMouseDown.bind(this),options:{capture:!1}});this.onMouseMove&&this.cvsListener.push({name:"mousemove",method:this.onMouseMove.bind(this),options:{capture:!1}});this.onMouseUp&&this.cvsListener.push({name:"mouseup",method:this.onMouseUp.bind(this),options:{capture:!1}});this.onMouseOut&&this.cvsListener.push({name:"mouseout",method:this.onMouseOut.bind(this),
options:{capture:!1}});this.onMouseWheel&&(this.cvsListener.push({name:"mousewheel",method:this.onMouseWheel.bind(this),options:{capture:!1,passive:!1}}),this.cvsListener.push({name:"DOMMouseScroll",method:this.onMouseWheel.bind(this),options:{capture:!1}}));this.onDblClick&&this.cvsListener.push({name:"dblclick",method:this.onDblClick.bind(this),options:{capture:!1}});this.onClick&&this.cvsListener.push({name:"click",method:this.onClick.bind(this),options:{capture:!1}});this.onTouchStart&&this.cvsListener.push({name:"touchstart",
method:this.onTouchStart.bind(this),options:{capture:!1}});this.onTouchEnd&&this.cvsListener.push({name:"touchend",method:this.onTouchEnd.bind(this),options:{capture:!1}});this.onTouchCancel&&this.cvsListener.push({name:"touchcancel",method:this.onTouchCancel.bind(this),options:{capture:!1}});this.onTouchMove&&this.cvsListener.push({name:"touchmove",method:this.onTouchMove.bind(this),options:{capture:!1}});this.keyListener=[];this.onKeyUp&&this.keyListener.push({name:"keyup",method:this.onKeyUp.bind(this),
options:{capture:!1}});this.onKeyDown&&this.keyListener.push({name:"keydown",method:this.onKeyDown.bind(this),options:{capture:!1}});this.onKeyPressed&&this.keyListener.push({name:"keypress",method:this.onKeyPressed.bind(this),options:{capture:!1}});this.appListener=[];for(var c in V.EventHandler.APPEVENTS)this[c]&&this.appListener.push({name:c,method:this[c].bind(this)})}attach(){V.EventHandler.SYSPRIO.forEach(a=>a.forEach(b=>b.detachSysHandlers()));V.EventHandler.SYSPRIO[this.prioSys].push(this);
V.EventHandler.SYSPRIO.forEach(a=>a.forEach(b=>b.attachSysHandlers()));V.EventHandler.APPPRIO.forEach(a=>a.forEach(b=>b.detachAppHandlers()));V.EventHandler.APPPRIO[this.prioApp].push(this);V.EventHandler.APPPRIO.forEach(a=>a.forEach(b=>b.attachAppHandlers()))}detach(){V.EventHandler.SYSPRIO.forEach(a=>a.forEach(b=>b.detachSysHandlers()));V.EventHandler.SYSPRIO[this.prioSys].splice(V.EventHandler.SYSPRIO[this.prioSys].indexOf(this),1);V.EventHandler.SYSPRIO.forEach(a=>a.forEach(b=>b.attachSysHandlers()));
V.EventHandler.APPPRIO.forEach(a=>a.forEach(b=>b.detachAppHandlers()));V.EventHandler.APPPRIO[this.prioApp].splice(V.EventHandler.APPPRIO[this.prioApp].indexOf(this),1);V.EventHandler.APPPRIO.forEach(a=>a.forEach(b=>b.attachAppHandlers()))}detachSysHandlers(){this.cvsListener.forEach(a=>V.EventHandler.CONTAINER.removeEventListener(a.name,a.method,a.options));this.keyListener.forEach(a=>document.removeEventListener(a.name,a.method,a.options))}attachSysHandlers(){this.cvsListener.forEach(a=>V.EventHandler.CONTAINER.addEventListener(a.name,
a.method,a.options));this.keyListener.forEach(a=>document.addEventListener(a.name,a.method,a.options))}detachAppHandlers(){this.appListener.forEach(a=>V.EventHandler.APPEVENTS[a.name].pop(a))}attachAppHandlers(){this.appListener.forEach(a=>V.EventHandler.APPEVENTS[a.name].push(a))}isAttached(){return V.EventHandler.APPPRIO[this.prioApp].includes(this)}};V.EventHandler.APPPRIO=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]];V.EventHandler.SYSPRIO=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]];
V.EventHandler.APPEVENTS={onRender2D:[],onRender3D:[],onResize:[],onUpdate:[]};V.EventHandler.PRIO0=0;V.EventHandler.PRIO1=1;V.EventHandler.PRIO2=2;V.EventHandler.PRIO3=3;V.EventHandler.PRIO4=4;V.EventHandler.PRIO5=5;V.EventHandler.PRIO6=6;V.EventHandler.CONTAINER=document.querySelector(".events");
V.Viewer=class{constructor(a){V.viewer=this;this.datasets={};this.aabb=GL.BoundingBox.init({});this.canvas=V.canvas;this.canvas.width=this.canvas.clientWidth;this.canvas.height=this.canvas.clientHeight;this.overlay=new O.Overlay(this);this.overlay.attach();window.addEventListener("resize",()=>{this.canvas.width=this.canvas.clientWidth;this.canvas.height=this.canvas.clientHeight;V.camera.updateMatrix();V.notify("onResize",{width:window.innerWidth,height:window.innerHeight});V.touch2d();V.touch3d()});
gl=this.canvas.getContext("webgl2",a)||this.canvas.getContext("experimental-webgl",a);gl.clearColor(1,1,1,1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.enable(gl.DEPTH_TEST);gl.enable(gl.CULL_FACE);gl.cullFace(gl.BACK);(a=gl.getExtension("EXT_texture_filter_anisotropic"))?(gl.anisotropy=a.TEXTURE_MAX_ANISOTROPY_EXT,gl.maxAnisotropy=gl.getParameter(a.MAX_TEXTURE_MAX_ANISOTROPY_EXT),gl.supports_EXT_texture_filter_anisotropic=!0):gl.supports_EXT_texture_filter_anisotropic=
!1;GL.GL_EXT_frag_depth=gl.getExtension("EXT_frag_depth");this.animateFn=this.animate.bind(this);this.repaint=this.visible=!0;V.recvMessage("viewer.image.get",b=>{this.imageCallback=b;V.touch3d()});V.recvMessage("import.update",b=>{this.datasets[b.id]&&b.hasOwnProperty("visible")&&(this.datasets[b.id].visible=b.visible,V.touch3d())});V.recvMessage("import.delete",(b,c)=>{if(c=this.datasets[b.id])c.unload(),V.postMessage("import.delete",b),delete this.datasets[b.id],V.touch3d();GL.BoundingBox.init(this.aabb,
{});for(var d in this.datasets)GL.BoundingBox.merge(this.aabb,this.datasets[d])});V.recvMessage("viewer.unload",b=>{for(var c in this.datasets)this.datasets[c].unload(),delete this.datasets[c];GL.BoundingBox.init(this.aabb,{});V.postMessage("viewer.unload",b)});V.recvMessage("repaint",b=>{V.touch2d();V.touch3d()});V.recvMessage("viewpoint",b=>{for(var c in this.datasets){let d=this.datasets[c];b[d.id]&&d.setViewpoint(b[d.id])}V.touch3d();V.postMessage("viewpoint",b)});V.recvMessage("raycast.overlay",
b=>{let c=V.camera.getRay({pageX:b.x,pageY:b.y});b=O.instance.raycast(c,b.x,b.y);V.postMessage("raycast.overlay",b)});V.recvMessage("raycast.content",b=>{let c=V.camera.getRay({pageX:b.x,pageY:b.y});b=V.viewer.raycast(c,{xyz:{},normal:b.normal,distance:Number.POSITIVE_INFINITY});b.distance!=Number.POSITIVE_INFINITY&&b.normal&&GM.Vector3.normalize(b.normal,b.normal);V.postMessage("raycast.content",b)});V.recvMessage("camera.project",b=>{b=V.camera.project(b);V.postMessage("camera.project",{pageX:b.x*
O.canvas.width,pageY:b.y*O.canvas.height})});V.recvMessage("viewer.update",(b,c)=>{b.hasOwnProperty("logging")&&(V.logging=b.logging);b.hasOwnProperty("units")&&(V.units="imperial"===b.units?V.IMPERIAL:V.METRIC);b.hasOwnProperty("clearColor")&&gl.clearColor(b.clearColor[0],b.clearColor[1],b.clearColor[2],1);b.hasOwnProperty("code")&&Function("return "+decodeURI(b.code))().call();V.postMessage("viewer.update",b,c)})}raycast(a,b){for(var c in this.datasets){let e=this.datasets[c];if(e.visible){var d=
a.intersectBox(e);d&&d.distance<b.distance&&(d=b.distance,e.raycast(a,b),b.distance<d&&(b.id=e.id))}}return b}load(a,b){GL.BoundingBox.merge(this.aabb,b);this.datasets[a]=b}startImage(){this.imageCallback.width&&this.imageCallback.height&&(this.imageCallback.oldWidth=this.canvas.width,this.imageCallback.oldHeight=this.canvas.height,V.canvas.width=this.imageCallback.width,V.canvas.height=this.imageCallback.height,V.notify("onResize",{width:V.canvas.width,height:V.canvas.height}),V.touch2d())}endImage(){if(this.imageCallback.oldWidth&&
this.imageCallback.oldHeight){if(this.imageCallback.overlay){var a=document.createElement("canvas");a.width=V.canvas.width;a.height=V.canvas.height;var b=a.getContext("2d");b.drawImage(V.canvas,0,0,a.width,a.height);b.drawImage(O.canvas,0,0,a.width,a.height);V.postMessage("viewer.image.get",a.toDataURL(this.imageCallback.type,this.imageCallback.options))}else V.postMessage("viewer.image.get",V.canvas.toDataURL(this.imageCallback.type,this.imageCallback.options));V.canvas.width=this.imageCallback.oldWidth;
V.canvas.height=this.imageCallback.oldHeight;V.notify("onResize",{width:V.canvas.width,height:V.canvas.height});gl.viewport(0,0,gl.drawingBufferWidth,gl.drawingBufferHeight);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);this.render(this.camera);V.notify("onRender3D",this);V.notify("onRender2D",this)}else if(this.imageCallback.maxWidth||this.imageCallback.maxHeight){a=document.createElement("canvas");b=a.getContext("2d");if(this.imageCallback.maxWidth&&this.imageCallback.maxHeight){var c=Math.min(1,
Math.max(this.imageCallback.maxHeight/gl.drawingBufferHeight,this.imageCallback.maxWidth/gl.drawingBufferWidth));a.width=this.imageCallback.maxWidth;a.height=this.imageCallback.maxHeight;let d=Math.floor(.5*(1-c)*gl.drawingBufferWidth),e=Math.floor(.5*(1-c)*gl.drawingBufferHeight);b.drawImage(V.canvas,d,e,gl.drawingBufferWidth*c,gl.drawingBufferHeight*c,0,0,a.width,a.height);this.imageCallback.overlay&&b.drawImage(O.canvas,d,e,gl.drawingBufferWidth*c,gl.drawingBufferHeight*c,0,0,a.width,a.height)}else c=
1,!this.imageCallback.maxHeight&&gl.drawingBufferWidth>this.imageCallback.maxWidth?c=Math.min(c,this.imageCallback.maxWidth/gl.drawingBufferWidth):!this.imageCallback.maxWidth&&gl.drawingBufferHeight>this.imageCallback.maxHeight&&(c=Math.min(c,this.imageCallback.maxHeight/gl.drawingBufferHeight)),a.width=gl.drawingBufferWidth*c,a.height=gl.drawingBufferHeight*c,b.drawImage(V.canvas,0,0,a.width,a.height),this.imageCallback.overlay&&b.drawImage(O.canvas,0,0,a.width,a.height);V.postMessage("viewer.image.get",
a.toDataURL(this.imageCallback.type,this.imageCallback.options))}else this.imageCallback.overlay?(a=document.createElement("canvas"),a.width=V.canvas.width,a.height=V.canvas.height,b=a.getContext("2d"),b.drawImage(V.canvas,0,0,a.width,a.height),b.drawImage(O.canvas,0,0,a.width,a.height),V.postMessage("viewer.image.get",a.toDataURL(this.imageCallback.type,this.imageCallback.options))):V.postMessage("viewer.image.get",V.canvas.toDataURL(this.imageCallback.type,this.imageCallback.options))}animate(){requestAnimationFrame(this.animateFn);
if(this.visible){var a=window.performance.now();V.dT=(a-V.time)/1E3;V.time=a;this.imageCallback&&this.startImage();a=V.camera.moving;V.camera.moving=V.camera.changed();V.notify("onUpdate",{});V.camera.starting=V.camera.moving&&!a;if(V.viewer.repaint3d||V.camera.moving)V.viewer.repaint3d=!1,gl.viewport(0,0,gl.drawingBufferWidth,gl.drawingBufferHeight),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),this.render(this.camera),V.notify("onRender3D",this);if(V.viewer.repaint2d||V.camera.moving)V.viewer.repaint2d=
!1,V.notify("onRender2D",this);this.imageCallback&&(this.endImage(),delete this.imageCallback);V.camera.stopping=a&&!V.camera.moving;a&&V.postMessage("camera.update",V.camera.toJson())}}setBufferSize(a,b){V.canvas.width=a;V.canvas.height=b;V.camera.moving=!0}};
V.Dataset=class{constructor(a){this.config=a;this.id=a.id;this.type=a.type;this.root=a.root;this.visible=a.hasOwnProperty("visible")?a.visible:!0;this.lastRefresh=0;this.url=a.source;this.refresh=a.refresh}refreshToken(){!this.promise&&this.refresh&&(this.promise=new Promise((a,b)=>{var c=new XMLHttpRequest;c.open("GET",this.refresh,!0);c.onload=d=>{200==c.status?(d=JSON.parse(d.currentTarget.responseText),this.url=d.source.data,this.refresh=d.source.refresh,a(this.url)):b(c.status)};c.onerror=d=>
{b(c.status)};c.send()}),this.promise.then(()=>{this.promise=null}));return this.promise}};
V.CameraController=class extends V.EventHandler{constructor(a,b,c,d){super(a,b);this.name=name;this.camera=c;this.currPos={x:0,y:0};this.currZoom=0;this.pointerPosition={pageX:0,pageY:0};this.pointerRay=new GM.Ray;this.pointerAge=0;this.cast3d={distance:Number.POSITIVE_INFINITY};this.ray=new GM.Ray;this.q0=new GM.Quaternion;this.qN=new GM.Quaternion;this.qR=new GM.Quaternion;this.min=new GM.Vector3(0,0,0);this.max=new GM.Vector3(0,0,0);this.drag=0;this.dragMax=d;this.shiftKey=!1;this.tn=0;this.keys=
{};this.position={sT:1,p0:{x:0,y:0,z:0},p1:{x:0,y:0,z:0}};this.rotation={sT:1,q0:new GM.Quaternion,q1:new GM.Quaternion,qR:new GM.Quaternion};this.tweenT=this.tweenR=400}tweenPosition(a,b){this.position.p0.x=this.camera.position.x;this.position.p0.y=this.camera.position.y;this.position.p0.z=this.camera.position.z;this.position.p1.x=a.x;this.position.p1.y=a.y;this.position.p1.z=a.z;this.position.t=V.time+(b||this.tweenT);this.position.sT=0}tweenRotation(a,b){this.rotation.q0.fromEuler(this.camera.rotation);
this.rotation.q1.fromEuler(a);this.rotation.t=V.time+(b||this.tweenR);this.rotation.sT=0}tweenStart(a){this.t0=V.time;this.updateFn=a;this.drag=0}tweenStop(){this.position.sT=1;this.position.sT=1;this.updateFn=null;this.drag=0}onUpdate(a){if(1>this.position.sT||1>this.rotation.sT){if(1>this.position.sT){this.position.sT=Math.min(1,(V.time-this.t0)/(this.position.t-this.t0));var b=Easing.Sinusoidal.In(this.position.sT),c=this.position.p0,d=this.position.p1;this.camera.position.x=c.x+(d.x-c.x)*b;this.camera.position.y=
c.y+(d.y-c.y)*b;this.camera.position.z=c.z+(d.z-c.z)*b}1>this.rotation.sT&&(this.rotation.sT=Math.min(1,(V.time-this.t0)/(this.rotation.t-this.t0)),GM.Quaternion.slerp(this.rotation.q0,this.rotation.q1,this.rotation.qR,Easing.Sinusoidal.In(this.rotation.sT)),this.camera.rotation.fromQuaternion(this.rotation.qR));this.camera.moving=!0;this.updateFn&&(this.updateFn.call(this,this,a),1==this.position.sT&&1==this.rotation.sT&&(this.updateFn=null))}else this.updateFn&&(this.updateFn.call(this,this,a),
this.drag&&1==this.drag--&&(this.updateFn=null),this.camera.moving=!0);V.camera.stopping&&(V.camera.getRay(this.pointerPosition,this.pointerRay),V.postMessage("viewer.mousemove",this.castRay3d()))}getWheelDelta(a){var b=a.shiftKey?.2:1;if(void 0!==a.wheelDelta)return-b*a.wheelDelta/4300;if(void 0!==a.detail)return b*a.detail/250}onMouseWheel(a){this.currPos=this.camera.screenToCamera(this.pointerPosition);this.currZoomD=this.getWheelDelta(a);this.currZoom-=this.currZoomD;this.currZoom=Math.min(Math.max(-1,
this.currZoom),1);a.preventDefault()}onMouseDown(a){this.startPos=this.camera.screenToCamera(this.pointerPosition);this.currPos.x=this.startPos.x;this.currPos.y=this.startPos.y;this.drag=0;V.postMessage("viewer.mousedown",this.cast3d)}onTouchStart(a){a=a.targetTouches;1==a.length&&(this.pointerPosition={pageX:a[0].pageX,pageY:a[0].pageY},this.onMouseDown({pageX:a[0].pageX,pageY:a[0].pageY,button:0}),V.camera.getRay(this.pointerPosition,this.pointerRay),this.cast2d=O.instance.raycast(this.pointerRay,
this.pointerPosition),V.postMessage("viewer.mousemove",this.castRay3d()),this.touchStamp=V.time,this.touchLast=a[0])}onMouseMove(a){this.currPos=this.camera.screenToCamera(a);this.shiftKey=a.shiftKey;this.pointerPosition={pageX:a.pageX,pageY:a.pageY};null!=this._timer||V.camera.moving||(this._timer=setTimeout(()=>{null!=this._timer&&V.postMessage("viewer.mousemove",this.castRay3d())},150));V.camera.getRay(this.pointerPosition,this.pointerRay)}onTouchMove(a){a=a.targetTouches;1==a.length&&(this.onMouseMove({pageX:a[0].pageX,
pageY:a[0].pageY,button:0}),this.touchLast=a[0]);this.touchStamp=0}onMouseUp(a){this.drag=this.dragMax}onMouseOut(a){this.currZoom=0;this.updateFn=null}onClick(a){a.ray=V.camera.getRay(a,this.ray);this.cast2d=O.instance.raycast(a.ray,a.pageX,a.pageY);if(0<this.cast2d.hits.length){this.cast2d.hits.sort(function(c,d){return c.distance-d.distance});var b=this.cast2d.hits[0].object;V.postMessage(b.type+".click",b.CLICK({id:b.id,type:b.type,pageX:a.pageX,pageY:a.pageY}));return!0}return!1}onDblClick(a){V.camera.getRay(this.pointerPosition,
this.pointerRay);this.castRay3d();a.ray=this.ray;if(0<this.cast2d.hits.length){var b=this.cast2d.hits[0].object;V.postMessage(b.type+".dblclick",b.DBLCLICK({id:b.id,type:b.type,pageX:a.pageX,pageY:a.pageY}));return!0}V.postMessage("viewer.dblclick",this.cast3d);return!1}onTouchEnd(a){if(0==a.targetTouches.length){a.pageX=this.touchLast.pageX;a.pageY=this.touchLast.pageY;if(300>V.time-this.touchStamp)return this.onDblClick(a);this.onMouseUp(a);return this.onClick(a)}return!1}onKeyDown(a){this.drag=
0;this.keys[a.keyCode]=!0}onKeyUp(a){V.keyCount||(this.drag=this.dragMax);delete this.keys[a.keyCode];this.startPos.x=this.currPos.x;this.startPos.y=this.currPos.y}onTouchCancel(a){}castRay3d(){let a=V.viewer.raycast(this.pointerRay,{xyz:{},normal:{},distance:Number.POSITIVE_INFINITY});a.distance!=Number.POSITIVE_INFINITY&&GM.Vector3.normalize(a.normal,a.normal);this.cast3d=a;this.pointerAge=V.time;this._timer=null;return a}};
Easing={Linear:function(a){return a},Quadratic:{In:function(a){return a*a},Out:function(a){return a*(2-a)},InOut:function(a){return 1>(a*=2)?.5*a*a:-.5*(--a*(a-2)-1)}},Cubic:{In:function(a){return a*a*a},Out:function(a){return--a*a*a+1},InOut:function(a){return 1>(a*=2)?.5*a*a*a:.5*((a-=2)*a*a+2)}},Quartic:{In:function(a){return a*a*a*a},Out:function(a){return 1- --a*a*a*a},InOut:function(a){return 1>(a*=2)?.5*a*a*a*a:-.5*((a-=2)*a*a*a-2)}},Sinusoidal:{In:function(a){return 1-Math.cos(a*Math.PI/2)},
Out:function(a){return Math.sin(a*Math.PI/2)},InOut:function(a){return.5*(1-Math.cos(Math.PI*a))}},Exponential:{In:function(a){return 0===a?0:Math.pow(1024,a-1)},Out:function(a){return 1===a?1:1-Math.pow(2,-10*a)},InOut:function(a){return 0===a?0:1===a?1:1>(a*=2)?.5*Math.pow(1024,a-1):.5*(-Math.pow(2,-10*(a-1))+2)}},Circular:{In:function(a){return 1-Math.sqrt(1-a*a)},Out:function(a){return Math.sqrt(1- --a*a)},InOut:function(a){return 1>(a*=2)?-.5*(Math.sqrt(1-a*a)-1):.5*(Math.sqrt(1-(a-=2)*a)+1)}},
Elastic:{In:function(a){var b=.1;if(0===a)return 0;if(1===a)return 1;if(!b||1>b){b=1;var c=.1}else c=.4*Math.asin(1/b)/(2*Math.PI);return-(b*Math.pow(2,10*--a)*Math.sin(2*(a-c)*Math.PI/.4))},Out:function(a){var b=.1;if(0===a)return 0;if(1===a)return 1;if(!b||1>b){b=1;var c=.1}else c=.4*Math.asin(1/b)/(2*Math.PI);return b*Math.pow(2,-10*a)*Math.sin(2*(a-c)*Math.PI/.4)+1},InOut:function(a){var b=.1;if(0===a)return 0;if(1===a)return 1;if(!b||1>b){b=1;var c=.1}else c=.4*Math.asin(1/b)/(2*Math.PI);return 1>
(a*=2)?-.5*b*Math.pow(2,10*--a)*Math.sin(2*(a-c)*Math.PI/.4):b*Math.pow(2,-10*--a)*Math.sin(2*(a-c)*Math.PI/.4)*.5+1}},Back:{In:function(a){return a*a*(2.70158*a-1.70158)},Out:function(a){return--a*a*(2.70158*a+1.70158)+1},InOut:function(a){return 1>(a*=2)?.5*a*a*(3.5949095*a-2.5949095):.5*((a-=2)*a*(3.5949095*a+2.5949095)+2)}},Bounce:{In:function(a){return 1-Easing.Bounce.Out(1-a)},Out:function(a){return a<1/2.75?7.5625*a*a:a<2/2.75?7.5625*(a-=1.5/2.75)*a+.75:a<2.5/2.75?7.5625*(a-=2.25/2.75)*a+.9375:
7.5625*(a-=2.625/2.75)*a+.984375},InOut:function(a){return.5>a?.5*Easing.Bounce.In(2*a):.5*Easing.Bounce.Out(2*a-1)+.5}}};V.KEY_CANCEL=3;V.KEY_HELP=6;V.KEY_BACK_SPACE=8;V.KEY_TAB=9;V.KEY_CLEAR=12;V.KEY_RETURN=13;V.KEY_ENTER=14;V.KEY_SHIFT=16;V.KEY_CONTROL=17;V.KEY_ALT=18;V.KEY_PAUSE=19;V.KEY_CAPS_LOCK=20;V.KEY_ESCAPE=27;V.KEY_SPACE=32;V.KEY_PAGE_UP=33;V.KEY_PAGE_DOWN=34;V.KEY_END=35;V.KEY_HOME=36;V.KEY_LEFT=37;V.KEY_UP=38;V.KEY_RIGHT=39;V.KEY_DOWN=40;V.KEY_PRINTSCREEN=44;V.KEY_INSERT=45;
V.KEY_DELETE=46;V.KEY_0=48;V.KEY_1=49;V.KEY_2=50;V.KEY_3=51;V.KEY_4=52;V.KEY_5=53;V.KEY_6=54;V.KEY_7=55;V.KEY_8=56;V.KEY_9=57;V.KEY_SEMICOLON=59;V.KEY_EQUALS=61;V.KEY_A=65;V.KEY_B=66;V.KEY_C=67;V.KEY_D=68;V.KEY_E=69;V.KEY_F=70;V.KEY_G=71;V.KEY_H=72;V.KEY_I=73;V.KEY_J=74;V.KEY_K=75;V.KEY_L=76;V.KEY_M=77;V.KEY_N=78;V.KEY_O=79;V.KEY_P=80;V.KEY_Q=81;V.KEY_R=82;V.KEY_S=83;V.KEY_T=84;V.KEY_U=85;V.KEY_V=86;V.KEY_W=87;V.KEY_X=88;V.KEY_Y=89;V.KEY_Z=90;V.KEY_CONTEXT_MENU=93;V.KEY_NUMPAD0=96;V.KEY_NUMPAD1=97;
V.KEY_NUMPAD2=98;V.KEY_NUMPAD3=99;V.KEY_NUMPAD4=100;V.KEY_NUMPAD5=101;V.KEY_NUMPAD6=102;V.KEY_NUMPAD7=103;V.KEY_NUMPAD8=104;V.KEY_NUMPAD9=105;V.KEY_MULTIPLY=106;V.KEY_ADD=107;V.KEY_SEPARATOR=108;V.KEY_SUBTRACT=109;V.KEY_DECIMAL=110;V.KEY_DIVIDE=111;V.KEY_F1=112;V.KEY_F2=113;V.KEY_F3=114;V.KEY_F4=115;V.KEY_F5=116;V.KEY_F6=117;V.KEY_F7=118;V.KEY_F8=119;V.KEY_F9=120;V.KEY_F10=121;V.KEY_F11=122;V.KEY_F12=123;V.KEY_F13=124;V.KEY_F14=125;V.KEY_F15=126;V.KEY_F16=127;V.KEY_F17=128;V.KEY_F18=129;
V.KEY_F19=130;V.KEY_F20=131;V.KEY_F21=132;V.KEY_F22=133;V.KEY_F23=134;V.KEY_F24=135;V.KEY_NUM_LOCK=144;V.KEY_SCROLL_LOCK=145;V.KEY_COMMA=188;V.KEY_PERIOD=190;V.KEY_SLASH=191;V.KEY_BACK_QUOTE=192;V.KEY_OPEN_BRACKET=219;V.KEY_BACK_SLASH=220;V.KEY_CLOSE_BRACKET=221;V.KEY_QUOTE=222;V.KEY_META=224;V.Queue=function(){this.last=this.first=null;this.size=0};V.Queue.prototype.enqueue=function(a){this.first?this.last.next=a:this.first=a;this.last=a;this.size++};
V.Queue.prototype.dequeue=function(){var a=this.first;this.first=this.first.next;null==this.first&&(this.last=null);a.next=null;this.size--;return a};V.Queue.prototype.empty=function(){return null==this.first};V.Queue.prototype.clear=function(){this.last=this.first=null;this.size=0};V.Queue.prototype.front=function(){return this.first};V.PriorityQueue=function(a){this.data=[];this.length=0;this.compare=a};
V.PriorityQueue.prototype.enqueue=function(a){this.data.push(a);this.length++;this._up(this.length-1)};V.PriorityQueue.prototype.dequeue=function(){var a=this.data[0];this.length--;0<this.length&&(this.data[0]=this.data[this.length],this._down(0));this.data.pop();return a};V.PriorityQueue.prototype.empty=function(){return 0==this.length};V.PriorityQueue.prototype.clear=function(){this.data=[];this.length=0};
V.PriorityQueue.prototype._up=function(a){for(var b=this.data,c=this.compare,d=b[a];0<a;){var e=a-1>>1,f=b[e];if(0<=c(d,f))break;b[a]=f;a=e}b[a]=d};V.PriorityQueue.prototype._down=function(a){for(var b=this.data,c=this.compare,d=this.length>>1,e=b[a];a<d;){var f=(a<<1)+1,g=f+1,h=b[f];g<this.length&&0>c(b[g],h)&&(f=g,h=b[g]);if(0<=c(h,e))break;b[a]=h;a=f}b[a]=e};
</script>
<script id="/overlay/overlay.js">O={instance:null,camera:null,DISTANCE:"distance",ANGLE:"angle",VOLUME:"volume",AREA:"area",canvas:document.getElementById("canvas2D"),units:0,numberFormat:new Intl.NumberFormat,s1:1,s2:1,s3:1,setScalar:function(a,b,c){O.s1=a;O.s2=b;O.s3=c},cursor:a=>{O.canvas.style.cursor=a},add:a=>{O.instance.addObject(a)},find:a=>O.instance.registry[a],remove:a=>{a instanceof O.Object?O.instance.removeObject(a.id):O.instance.removePanel(a)},getSelected:()=>O.instance.getSelected(),getAll:a=>{let b={};O.instance.objects.forEach(c=>
{c.type===a&&(b[c.id]=c.toJson())});return b},Component:function(a){this.style=a;this.visible=!0;this.zIndex=100;this.normal3D={x:0,y:0,z:0}}};O.Component.prototype.setVisibile=function(a){this.visible=a};
O.Object=class{constructor(a,b,c){this.id=null==a?(new Date).getTime():a;this.exclude=c;this.components=[];this.controls=[];this.anchors=[];if(this.activation=b)this.activation.easing=this.activation.easing||"Linear";this.aabb={min:{x:0,y:0,z:0},max:{x:0,y:0,z:0},center:{x:0,y:0,z:0}};this.attached=this.selected=!1;this.scale=1;this.visible=!0}CLICK(a){return a}DBLCLICK(a){return a}detach(){for(var a=0;a<this.controls.length;a++)this.controls[a].detach();this.attached=!1}attach(){for(var a=0;a<this.controls.length;a++)this.controls[a].attach();
this.attached=!0}onUpdate(a){this.activation&&this.visible&&(this.scale=Easing[this.activation.easing](V.viewer.getDistanceAlpha(this.aabb.center,this.activation.p0,this.activation.p1)))}isVisible(){return this.visible&&V.camera.intersectsBox(this.aabb)}addAnchor(a){this.anchors.push(a);return a}insertAnchor(a,b){this.anchors.splice(a,0,b);return b}removeAnchor(a){this.anchors.splice(this.anchors.indexOf(a),1)}addControl(a){this.controls.push(a);a.attach();a.addListener(this);return a}insertControl(a,
b){this.controls.splice(a,0,b);b.attach();b.addListener(this);return b}removeControl(a){[a]=this.controls.splice(this.controls.indexOf(a),1);a.detach()}addComponent(a){this.components.push(a);return a}insertComponent(a,b){this.components.splice(a,0,b);return b}removeComponent(a){this.components.splice(this.components.indexOf(a),1)}endControl(){V.touch2d()}projectAnchors(){for(var a=0;a<this.anchors.length;a++)this.anchors[a].project();var b=this.aabb.min,c=this.aabb.max,d=this.aabb.center;b.x=Number.POSITIVE_INFINITY;
b.y=Number.POSITIVE_INFINITY;b.z=Number.POSITIVE_INFINITY;c.x=Number.NEGATIVE_INFINITY;c.y=Number.NEGATIVE_INFINITY;c.z=Number.NEGATIVE_INFINITY;for(a=0;a<this.anchors.length;a++){var e=this.anchors[a];b.x=Math.min(e.wx,b.x);b.y=Math.min(e.wy,b.y);b.z=Math.min(e.wz,b.z);c.x=Math.max(e.wx,c.x);c.y=Math.max(e.wy,c.y);c.z=Math.max(e.wz,c.z)}d.x=(c.x+b.x)/2;d.y=(c.y+b.y)/2;d.z=(c.z+b.z)/2}updateUnits(){for(var a=0;a<this.components.length;a++)this.components[a].updateUnits&&this.components[a].updateUnits()}intersectRay3D(a){var b=
Number.POSITIVE_INFINITY;this.components.forEach(c=>{c.intersectRay3D&&(b=Math.min(b,c.intersectRay3D(a,this)))});return b}containsPoint2D(a){if(this.selected)for(var b=0;b<this.controls.length;b++)if(this.controls[b].containsPoint2D(a))return a.component=this.controls[b],!0;for(b=0;b<this.components.length;b++)if(this.components[b].containsPoint2D&&this.components[b].containsPoint2D(a))return a.component=this.components[b],!0;return!1}select(){this.projectAnchors();this.selected?console.log("object already selected"):
(this.selected=!0,this.onDblClick&&O.instance.addEventListener("onDblClick",this))}unselect(){this.selected=!1;for(var a=0;a<this.controls.length;a++)this.controls[a].detach();this.controls=[];this.onDblClick&&O.instance.removeEventListener("onDblClick",this)}update(a){a.hasOwnProperty("activation")&&(this.activation=a.activation,V.touch2d());a.hasOwnProperty("visible")&&(this.visible=a.visible)&&this.projectAnchors()}render2D(a){if(0<this.scale)for(var b=0;b<this.components.length;b++){var c=this.components[b];
c.visible&&c.render2D&&this.components[b].render2D(a)}}render3D(a){for(var b=0;b<this.components.length;b++)this.components[b].visible&&this.components[b].render3D&&this.components[b].render3D(a,this)}toJson(a){let b={};if(void 0==a||a.includes("id"))b.id=this.id;(void 0==a||a.includes("activation"))&&this.activation&&(b.activation=this.activation);(void 0==a||a.includes("visible"))&&this.hasOwnProperty("visible")&&(b.visible=this.visible);return b}};O.Object.INFINITE={easing:"Linear"};
O.Composite=class extends O.Object{constructor(a,b,c){super(a,b,c);this.objects=[]}detach(){super.detach();for(var a=0;a<this.objects.length;a++)this.objects[a].detach()}attach(){super.attach();for(var a=0;a<this.objects.length;a++)this.objects[a].attach()}onUpdate(a){super.onUpdate(a);if(this.activation&&V.camera.moving)for(var b=0;b<this.objects.length;b++)this.objects[b].scale=this.scale;for(b=0;b<this.objects.length;b++)this.objects[b].onUpdate(a)}addObject(a){a.attached||a.attach();this.objects.push(a);
return a}insertObject(a,b){b.attached&&b.detach();this.objects.splice(a,0,b);return b}removeObject(a){a.attached&&a.detach();this.objects.splice(this.objects.indexOf(a),1)}projectAnchors(){super.projectAnchors();for(var a=0;a<this.objects.length;a++)this.objects[a].projectAnchors()}select(){super.select();for(var a=0;a<this.objects.length;a++)this.objects[a].select()}unselect(){super.unselect();for(var a=0;a<this.objects.length;a++)this.objects[a].unselect()}render2D(a){super.render2D(a);for(var b=
0;b<this.objects.length;b++)this.objects[b].visible&&this.objects[b].render2D(a)}render3D(a){for(var b=0;b<this.objects.length;b++)this.objects[b].visible&&this.objects[b].render3D(a,this);super.render3D(a)}};
O.Overlay=class extends V.EventHandler{constructor(){super(V.EventHandler.PRIO0,V.EventHandler.PRIO3);O.canvas.width=O.canvas.clientWidth;O.canvas.height=O.canvas.clientHeight;this.context=O.canvas.getContext("2d");O.instance=this;this.objects=[];this.visibleObjects=[];this.registry={};this.points=[];this.handlers={onMouseDown:[],onMouseMove:[],onMouseUp:[],onMouseOut:[],onClick:[],onDblClick:[]};O.ControlPoint.PATH=new Path2D;O.ControlPoint.PATH.arc(0,0,O.ControlPoint.R,0,2*Math.PI);this.anchors=
{};V.recvMessage("anchor.create",a=>{if(this.anchors[a.id])V.postMessage("error","anchor already exists "+a.id);else{let b=new O.AnchorX(a,a.id);this.anchors[a.id]=b;V.postMessage("anchor.create",Object.assign(b.toJson(),{id:b.id}))}});V.recvMessage("anchor.update",a=>{this.anchors[a.id]?a.hasOwnProperty("point")&&(this.anchors[a.id].set3D(a),V.postMessage("anchor.update",Object.assign(anchor.toJson(),{id:anchor.id}))):V.postMessage("error","anchor does not exist "+a.id)});V.recvMessage("anchor.delete",
a=>{this.anchors[a.id]?(delete this.anchors[a.id],V.postMessage("anchor.delete",a)):V.postMessage("error","anchor does not exist "+a.id)});V.recvMessage("viewpoint.get",a=>{let b={};this.objects.forEach(c=>{c.exclude||c.visible||(b[c.id]=!0)});a.hidden=Object.assign(a.hidden||{},b)});V.recvMessage("viewpoint",a=>{let b=a.hidden;this.objects.forEach(c=>{c.exclude||c.visible==!b[c.id]||(c.visible=!b[c.id],V.postMessage(`${c.type}.update`,{id:c.id,visible:c.visible}))});V.touch2d()});V.recvMessage("viewer.unload",
a=>{this.objects.forEach(b=>{delete this.registry[b.id];b.detach()});this.objects=[];this.visibleObjects=[]});V.recvMessage("*.scan.stop",(a,b)=>{this.objects.forEach(c=>{"function"===typeof c.stopScan&&c.stopScan()});V.postMessage("*.selected.get",{},b);V.touch2d()});V.recvMessage("*.unselect",(a,b)=>{if(a&&a.id){let c=this.getObject(a.id);c&&(c.unselect(),V.postMessage(`${c.type}.unselect`,{id:c.id},b))}else this.objects.forEach(c=>{c.selected&&(c.unselect(),V.postMessage(`${c.type}.unselect`,{id:c.id},
b))});V.postMessage("*.unselect",a,b);V.touch2d()});V.recvMessage("*.selected.get",(a,b)=>{let c={};this.objects.forEach(d=>{d.selected&&(c[d.id]=d.toJson(a.filter))});V.postMessage("*.selected.get",c,b);V.touch2d()});V.recvMessage("*.get",(a,b)=>{this.objects.forEach(c=>{a[c.id]=c.toJson(a.filter)})});V.recvMessage("*.delete",(a,b)=>{let c=null;a.filter&&(c=Function("return "+decodeURI(entry.filter))());for(var d=this.objects.length-1;0<=d;d--){var e=this.objects[d];if(null==c||c.call(e))delete this.registry[e.id],
e.detach(),this.objects.splice(d,1),e=this.visibleObjects.indexOf(e),-1!=e&&this.visibleObjects.splice(e,1)}V.postMessage("*.delete",a,b)});V.recvMessage("record.cancel",(a,b)=>{O.Builder.get().end();V.touch2d()});V.recvMessage("viewer.update",a=>{if(a.hasOwnProperty("units"))for(a=0;a<this.objects.length;a++)this.objects[a].updateUnits()})}addEventListener(a,b,c,d){c={object:b,zIndex:null==c?999:c};c.callback=d?d:b[a].bind(b);a=this.handlers[a];a.push(c);for(b=a.length-1;0<b;b--)a[b].zIndex<a[b-
1].zIndex&&(d=a[b-1],a[b-1]=a[b],a[b]=d)}removeEventListener(a,b){a=this.handlers[a];for(var c=0;c<a.length;c++)if(a[c].object===b){a.splice(c,1);break}}onMouseDown(a){for(var b=this.handlers.onMouseDown,c=0;c<b.length;c++)if(b[c].object.containsPoint2D(a)){b[c].callback(a);break}}onMouseMove(a){for(var b=this.handlers.onMouseMove,c=0;c<b.length;c++)b[c].callback(a)}onMouseUp(a){for(var b=this.handlers.onMouseUp,c=0;c<b.length;c++)b[c].callback(a)}onMouseOut(a){for(var b=this.handlers.onMouseOut,
c=0;c<b.length;c++)b[c].callback(a)}onClick(a){for(var b=this.handlers.onClick,c=0;c<b.length;c++)if(b[c].object.containsPoint2D){if(b[c].object.containsPoint2D(a)){b[c].callback(a);break}}else if(b[c].callback(a))break}onDblClick(a){for(var b=this.handlers.onDblClick,c=0;c<b.length;c++)if(b[c].object.containsPoint2D){if(b[c].object.containsPoint2D(a)){b[c].callback(a);break}}else{b[c].callback(a);break}}onUpdate(a){this.visibleObjects=[];this.objects.forEach(b=>{b.isVisible()&&this.visibleObjects.push(b)});
this.visibleObjects.forEach(b=>{b.onUpdate(a)});V.camera.moving&&(this.updateAnchors=!0)}onRender3D(a){this.updateAnchors&&(this.points.forEach(b=>b.anchor.project()),this.visibleObjects.forEach(b=>b.projectAnchors()),Object.keys(this.anchors).forEach(b=>this.anchors[b].project()),this.updateAnchors=!1);this.visibleObjects.forEach(b=>{b.render3D&&b.visible&&b.render3D(a)})}onRender2D(a){this.context.clearRect(0,0,O.canvas.width,O.canvas.height);this.context.beginPath();a.background&&this.context.drawImage(a.background,
0,0);this.context.save();for(a=0;a<this.visibleObjects.length;a++)this.visibleObjects[a].visible&&this.visibleObjects[a].render2D(this.context);this.context.restore();this.context.save();this.context.lineWidth=3;for(a=0;a<this.points.length;a++)this.points[a].render2D(this.context);this.context.lineWidth=1;this.context.restore()}onResize(a){O.canvas.width=a.width;O.canvas.height=a.height;this.updateAnchors=!0;for(var b=0;b<this.visibleObjects.length;b++)if(this.visibleObjects[b].onResize)this.visibleObjects[b].onResize(a)}getSelected(a){for(a=
0;a<this.objects.length;a++)if(this.objects[a].selected)return this.objects[a];return null}createControlPoint(a,b){a=b.getPoint(a);return null!=a?(b=new O.ControlPoint(new O.Anchor(a),b),b.attach(),b):null}removeControlPoint(a){for(var b=0;b<this.points.length;b++)if(this.points[b]==a){this.points.splice(b,1);break}}addControlPoint(a){this.points.push(a)}addObject(a){a.attach();this.objects.push(a);this.registry[a.id]=a;this.updateAnchors=!0;this.visibleObjects.push(a)}removeObject(a){for(var b=0;b<
this.objects.length;b++)if(this.objects[b].id==a)return a=this.objects[b],delete this.registry[a.id],a.detach(),this.objects.splice(b,1),b=this.visibleObjects.indexOf(a),-1!=b&&this.visibleObjects.splice(b,1),a;return null}raycast(a,b,c){var d={ray:a,distance:Number.POSITIVE_INFINITY,pageX:b,pageY:c,hits:[]};this.context.save();this.visibleObjects.forEach(e=>{let f=e.intersectRay3D(d);0<e.scale&&f!=Number.POSITIVE_INFINITY&&d.hits.push({distance:f,object:e})});this.context.restore();return d}getObject(a){return this.registry[a]}};
O.Builder=class extends V.EventHandler{constructor(){super(V.EventHandler.PRIO1);this.points=[]}start(a){this.tool&&this.end();this.tool=a;O.cursor("crosshair");this.attach()}end(){this.points.forEach(a=>a.detach());this.points=[];this.tool=null;O.cursor("default");this.isAttached()&&this.detach()}onClick(a){let b=this.tool.addPoint(a,this.escaped);if(b&&(this.points.push(b),this.tool.isDone(this.points))){var c=[];this.points.forEach(d=>c.push(d.anchor.toJson()));this.tool.complete(c);this.end()}a.stopImmediatePropagation()}onKeyUp(a){27==
a.keyCode?(this.escaped=!0,this.tool.isDone(a.keyCode)&&this.end()):8==a.keyCode&&this.removePoint&&this.removePoint()}};O.Builder.get=function(){O.Builder.instance||(O.Builder.instance=new O.Builder);return O.Builder.instance};
</script>
<script id="/overlay/anchor.js">O.Anchor=class{constructor(a){a?(this.wx=a.x||0,this.wy=a.y||0,this.wz=a.z||0):this.wz=this.wy=this.wx=0;this.listener=[];this.id=O.Anchor.nextId++;this.project()}between3D(a,b,c){return new O.Anchor({x:a.wx+(b.wx-a.wx)*c,y:a.wy+(b.wy-a.wy)*c,z:a.wz+(b.wz-a.wz)*c})}set3D(a){this.wx=a.x;this.wy=a.y;this.wz=a.z;for(a=0;a<this.listener.length;a++)this.listener[a].update3D&&this.listener[a].update3D();this.project()}translate3D(a,b,c){this.wx+=a;this.wy+=b;this.wz+=c;this.px=this.wx;this.py=this.wy;this.pz=
this.wz;for(a=0;a<this.listener.length;a++)this.listener[a].update3D&&this.listener[a].update3D();this.project()}project(){var a=V.camera.project({x:this.wx,y:this.wy,z:this.wz});this.sx=a.x*O.canvas.width;this.sy=a.y*O.canvas.height}move2D(a){this.sx=a.pageX;this.sy=a.pageY}addListener(a){this.listener.push(a)}removeListener(a){for(var b=0;b<this.listener.length;b++)if(this.listener[b]==a){this.listener.splice(b,1);break}}toJson(a){return{x:this.wx,y:this.wy,z:this.wz}}};O.Anchor.nextId=1;
O.AnchorX=class extends O.Anchor{constructor(a,b){super(a);this.id=b}project(){super.project();0<this.sx&&this.sx<O.canvas.width&&0<this.sy&&this.sy<O.canvas.height&&V.postMessage("anchor.update",{id:this.id,xyz:{x:this.wx,y:this.wy,z:this.wz},uv:{x:this.sx,y:this.sy}})}};
O.ControlPoint=class{constructor(a,b){this.constraint=b;this.anchor=a;this.anchor.addListener(this);this.zIndex=0;this.visible=!0;this.timer=null;this.click=function(c){c.preventDefault();c.stopPropagation()};this.listener=[]}detach(){O.instance.removeEventListener("onMouseDown",this);O.instance.removeControlPoint(this)}attach(){O.instance.addControlPoint(this);O.instance.addEventListener("onMouseDown",this,0)}updateAnchor(a){a=this.constraint.moveControl(a,this);if(null!=a){this.anchor.set3D(a);
for(var b=0;b<this.listener.length;b++)void 0!=this.listener[b].moveControl&&this.listener[b].moveControl(this);O.cursor("crosshair")}else O.cursor("not-allowed");return a}onMouseDown(a){O.instance.addEventListener("onMouseUp",this,0);O.instance.addEventListener("onMouseMove",this,0);O.instance.addEventListener("onMouseOut",this,0);for(var b=0;b<this.listener.length;b++)void 0!=this.listener[b].startControl&&this.listener[b].startControl(this);this.dragEvent={pageX:a.pageX,pageY:a.pageY};O.cursor("crosshair");
a.stopImmediatePropagation()}onMouseMove(a){this.constraint instanceof C.Intersect?(this.anchor.move2D(a),null==this.timer&&(this.timer=setTimeout(function(){null!=this.timer&&(this.updateAnchor(this.dragEvent),this.timer=null)}.bind(this),400)),this.dragEvent={pageX:a.pageX,pageY:a.pageY}):(this.dragEvent={pageX:a.pageX,pageY:a.pageY},this.updateAnchor(this.dragEvent));V.touch2d();a.stopImmediatePropagation()}onMouseUp(a){O.instance.removeEventListener("onMouseUp",this);O.instance.removeEventListener("onMouseMove",
this);O.instance.removeEventListener("onMouseOut",this);null!=this.timer&&(clearTimeout(this.timer),this.timer=null);this.updateAnchor(a)||this.anchor.project();for(var b=0;b<this.listener.length;b++)void 0!=this.listener[b].endControl&&this.listener[b].endControl(this);O.cursor("default");a.stopImmediatePropagation()}onMouseOut(a){this.onMouseUp(a)}containsPoint2D(a){var b=a.pageX-this.anchor.sx;a=a.pageY-this.anchor.sy;return b*b+a*a<O.ControlPoint.R2}addListener(a){this.listener.push(a)}removeListener(a){for(var b=
0;b<this.listener.length;b++)if(this.listener[b]==a){this.listener.splice(b,1);break}}render2D(a){this.visible&&(a.strokeStyle=this.constraint.strokeStyle,a.setTransform(1,0,0,1,this.anchor.sx,this.anchor.sy),a.stroke(O.ControlPoint.PATH))}};O.ControlPoint.R=7;O.ControlPoint.R2=O.ControlPoint.R*O.ControlPoint.R;O.ControlPoint.PATH=null;
C={create:function(a){return"Cloud"===a[0]?new C.Intersect(a[1]):C[a[0]]?new C[a[0]](a[1]):C.Intersect.instance},p:{x:0,y:0,z:0},Plane:function(a){this.plane=a;this.strokeStyle=C.Plane.ACTIVE}};C.Plane.ACTIVE="#66FF00";C.Plane.PASSIVE="#4FC40F";C.Plane.prototype.moveControl=function(a){return this.getPoint(a)};
C.Plane.prototype.getPoint=function(a){a=V.camera.getRay(a);var b=-(this.plane.x*a.origin.x+this.plane.y*a.origin.y+this.plane.z*a.origin.z-this.plane.w)/(this.plane.x*a.direction.x+this.plane.y*a.direction.y+this.plane.z*a.direction.z);C.p.x=a.direction.x*b+a.origin.x;C.p.y=a.direction.y*b+a.origin.y;C.p.z=a.direction.z*b+a.origin.z;return C.p};C.Plane.prototype.toJson=function(){return["Plane",this.plane]};C.Intersect=function(){this.strokeStyle=C.Intersect.ACTIVE};C.Intersect.ACTIVE="#40C4FF";
C.Intersect.PASSIVE="#40C4FF";C.Intersect.prototype.moveControl=function(a){return this.getPoint(a)};C.Intersect.prototype.getPoint=function(a){a=V.camera.getRay(a);a=V.viewer.raycast(a,{distance:Number.POSITIVE_INFINITY,xyz:{}});return a.distance!=Number.POSITIVE_INFINITY?(C.p.x=a.xyz.x,C.p.y=a.xyz.y,C.p.z=a.xyz.z,C.p):null};C.Intersect.prototype.toJson=function(){return["Intersect"]};C.Intersect.instance=new C.Intersect;
C.Segment=function(a,b){this.anchor0=a;this.anchor1=b;this.t=0;this.strokeStyle=C.Segment.ACTIVE};C.Segment.ACTIVE="green";C.Segment.PASSIVE="#c2a90f";
C.Segment.prototype.moveControl=function(a){a=V.camera.getRay(a);var b=this.anchor0.wx-a.origin.x,c=this.anchor0.wy-a.origin.y,f=this.anchor0.wz-a.origin.z,e=this.anchor1.wx-this.anchor0.wx,d=this.anchor1.wy-this.anchor0.wy,g=this.anchor1.wz-this.anchor0.wz,h=Math.sqrt(e*e+d*d+g*g);e/=h;d/=h;g/=h;var k=e*a.direction.x+d*a.direction.y+g*a.direction.z;this.t=Math.min(h,Math.max(0,(k*(a.direction.x*b+a.direction.y*c+a.direction.z*f)-(e*b+d*c+g*f))/(1-k*k)));C.p.x=this.t*e+this.anchor0.wx;C.p.y=this.t*
d+this.anchor0.wy;C.p.z=this.t*g+this.anchor0.wz;this.t/=h;return C.p};C.Segment.prototype.toJson=function(){return["Segment"]};C.Ray=function(a,b){this.nx=b.x;this.ny=b.y;this.nz=b.z;this.anchor=a;this.strokeStyle=C.Ray.ACTIVE};C.Ray.ACTIVE="yellow";C.Ray.PASSIVE="#c2a90f";
C.Ray.prototype.moveControl=function(a){var b=V.camera.getRay(a),c=this.anchor.wx-b.origin.x,f=this.anchor.wy-b.origin.y,e=this.anchor.wz-b.origin.z;a=this.nx*b.direction.x+this.ny*b.direction.y+this.nz*b.direction.z;var d=this.nx*c+this.ny*f+this.nz*e;b=b.direction.x*c+b.direction.y*f+b.direction.z*e;c=1-a*a;return.001<c?(a=Math.max(0,(a*b-d)/c),C.p.x=a*this.nx+this.anchor.wx,C.p.y=a*this.ny+this.anchor.wy,C.p.z=a*this.nz+this.anchor.wz,C.p):null};C.Ray.prototype.toJson=function(){return["Ray"]};
C.Line=function(a,b){this.nx=b.x;this.ny=b.y;this.nz=b.z;this.anchor=a;this.strokeStyle=C.Line.ACTIVE};C.Line.ACTIVE=C.Ray.ACTIVE;C.Line.PASSIVE=C.Ray.PASSIVE;C.Line.prototype.moveControl=function(a){return this.getPoint(a)};
C.Line.prototype.getPoint=function(a){var b=V.camera.getRay(a),c=this.anchor.wx-b.origin.x,f=this.anchor.wy-b.origin.y,e=this.anchor.wz-b.origin.z;a=this.nx*b.direction.x+this.ny*b.direction.y+this.nz*b.direction.z;var d=this.nx*c+this.ny*f+this.nz*e;b=b.direction.x*c+b.direction.y*f+b.direction.z*e;c=1-a*a;return.001<c?(a=(a*b-d)/c,C.p.x=a*this.nx+this.anchor.wx,C.p.y=a*this.ny+this.anchor.wy,C.p.z=a*this.nz+this.anchor.wz,C.p):null};C.Horizontal=function(a,b){this.anchor=a;this.strokeStyle=C.Line.ACTIVE};
C.Horizontal.ACTIVE=C.Ray.ACTIVE;C.Horizontal.PASSIVE=C.Ray.PASSIVE;C.Horizontal.prototype.moveControl=function(a){return this.getPoint(a)};
C.Horizontal.prototype.getPoint=function(a){var b=V.camera.getRay(a),c=this.anchor.wx-b.origin.x,f=this.anchor.wy-b.origin.y,e=this.anchor.wz-b.origin.z;a=V.camera.xAxis;var d=a.x*b.direction.x+a.y*b.direction.y+a.z*b.direction.z,g=a.x*c+a.y*f+a.z*e;b=b.direction.x*c+b.direction.y*f+b.direction.z*e;c=1-d*d;return.001<c?(d=(d*b-g)/c,C.p.x=d*a.x+this.anchor.wx,C.p.y=d*a.y+this.anchor.wy,C.p.z=d*a.z+this.anchor.wz,C.p):null};C.Sphere=function(a,b){this.strokeStyle=C.Plane.ACTIVE};C.Sphere.ACTIVE=C.Plane.ACTIVE;
C.Sphere.PASSIVE=C.Plane.PASSIVE;C.Sphere.prototype.moveControl=function(a){return this.getPoint(a)};C.Sphere.prototype.getPoint=function(a){a=V.camera.getRay(a);C.p.x=.708*a.direction.x;C.p.y=.708*a.direction.y;C.p.z=.708*a.direction.z;return C.p};C.Sphere.prototype.toJson=function(){return["Sphere"]};C.Polygon=function(a){this.geometry=a;this.strokeStyle=C.Plane.ACTIVE};
C.Polygon.prototype.moveControl=function(a,b){a=GM.Ray.intersectPlane(V.camera.getRay(a),this.geometry.plane,{});return this.geometry.canMovePoint(b.anchor.id,a)?a:null};C.Polygon.prototype.getPoint=function(a){return GM.Ray.intersectPlane(V.camera.getRay(a),this.geometry.plane,{})};C.Polygon.prototype.toJson=function(){return["Polygon",this.geometry.plane]};
</script>
<script id="/overlay/component.js">O.Style={FRONT:1,BACK:2,FRONT_BACK:3,NONE:0,A:8};
O.Style.Line=class{constructor(a,b,c){this.selected=!1;this.lineWidth=1;this.fillStyle=b||"red";this.dash=a;this.arrows=c}render2d(a,b,c,d,e,g){var k=d-b,h=e-c,f=Math.atan2(h,k);a.setTransform(1,0,0,1,b,c);a.beginPath();a.moveTo(0,0);a.lineTo(k,h);a.lineWidth=this.lineWidth;a.strokeStyle=this.fillStyle;this.dash&&a.setLineDash(this.dash);a.stroke();this.dash&&a.setLineDash([]);a.lineWidth=1;if(this.arrows==O.Style.FRONT||this.arrows==O.Style.FRONT_BACK)a.beginPath(),a.moveTo(k,h),a.lineTo(k-12*Math.cos(f-
Math.PI/7),h-12*Math.sin(f-Math.PI/7)),a.lineTo(k-12*Math.cos(f+Math.PI/7),h-12*Math.sin(f+Math.PI/7)),a.fillStyle=this.fillStyle,a.fill();if(this.arrows==O.Style.BACK||this.arrows==O.Style.FRONT_BACK)a.beginPath(),a.moveTo(0,0),a.lineTo(12*Math.cos(f-Math.PI/7),12*Math.sin(f-Math.PI/7)),a.lineTo(12*Math.cos(f+Math.PI/7),12*Math.sin(f+Math.PI/7)),a.fillStyle=this.fillStyle,a.fill();g&&g.size.width*g.size.width<.25*(k*k+h*h)&&(f=b<d?-f:Math.PI-f,k=Math.cos(f),f=Math.sin(f),a.setTransform(k,-f,f,k,
(b+d)/2,(c+e)/2),a.fillStyle="rgba(255,255,255,0.7)",b=O.Style.A,c=g.size.width+2*O.Style.A,d=12+O.Style.A,e=-c/2,f=-d+-3,a.moveTo(e+b,f),a.lineTo(e+c-b,f),a.quadraticCurveTo(e+c,f,e+c,f+b),a.lineTo(e+c,f+d-b),a.quadraticCurveTo(e+c,f+d,e+c-b,f+d),a.lineTo(e+b,f+d),a.quadraticCurveTo(e,f+d,e,f+d-b),a.lineTo(e,f+b),a.quadraticCurveTo(e,f,e+b,f),a.fill(),a.font="12px Arial",a.textAlign="center",a.textBaseline="bottom",a.fillStyle="blue",a.fillText(g.text,0,-3-O.Style.A/2+1))}containsPoint2d(a,b,c,d,
e){d-=b;e-=c;let g=((a.pageX-b)*d+(a.pageY-c)*e)/(d*d+e*e);0>g?g=0:1<g&&(g=1);d=a.pageX-g*d-b;e=a.pageY-g*e-c;return 225>d*d+e*e}createLabel(a,b){a=V.to1DUnitString(b);O.instance.context.font="12px Arial";return{text:a,size:O.instance.context.measureText(a)}}};
O.Style.Line.Custom=class{constructor(a,b){this.selected=!1;this.exec={};a.init&&(this.exec.init=Function("return "+decodeURI(a.init))());a.render2d&&(this.exec.render2d=Function("return "+decodeURI(a.render2d))());a.intersect2d&&(this.exec.intersect2d=Function("return "+decodeURI(a.intersect2d))());a.update&&(this.exec.update=Function("return "+decodeURI(a.update))());this.scope=Object.assign({},b);this.exec.init&&this.exec.init.call(this.scope)}render2d(a,b,c,d,e,g){this.exec.render2d.call(this.scope,
a,{x0:b,y0:c,x1:d,y1:e,t:V.time,dt:V.dT,label:g,selected:this.selected})&&V.touch2d()}containsPoint2d(a,b,c,d,e){return this.exec.intersect2d?this.exec.intersect2d.call(this.scope,O.instance.context,a.pageX,a.pageY,{x0:b,y0:c,x1:d,y1:e}):!1}update(a){a&&(this.exec.update?this.exec.update.call(this.scope,a):Object.assign(this.scope,a))}};
O.Segment=class extends O.Component{constructor(a,b,c,d){super(d);this.anchor0=a;this.anchor0.addListener(this);this.anchor1=b;this.anchor1.addListener(this);this.text=c;this.update3D()}update3D(){if(this.text){let a=G.sx*(this.anchor0.wx-this.anchor1.wx),b=G.sy*(this.anchor0.wy-this.anchor1.wy),c=G.sz*(this.anchor0.wz-this.anchor1.wz);this.label=this.style.createLabel(this.text,Math.sqrt(a*a+b*b+c*c))}}updateUnits(){if(this.text){let a=G.sx*(this.anchor0.wx-this.anchor1.wx),b=G.sy*(this.anchor0.wy-
this.anchor1.wy),c=G.sz*(this.anchor0.wz-this.anchor1.wz);this.label=this.style.createLabel(this.text,Math.sqrt(a*a+b*b+c*c))}}updateLabel(a){if(this.text=a){a=G.sx*(this.anchor0.wx-this.anchor1.wx);let b=G.sy*(this.anchor0.wy-this.anchor1.wy),c=G.sz*(this.anchor0.wz-this.anchor1.wz);this.label=this.style.createLabel(this.text,Math.sqrt(a*a+b*b+c*c))}else delete this.label}intersectRay3D(a){return this.containsPoint2D(a)?V.camera.distanceTo({x:this.anchor0.wx,y:this.anchor0.wy,z:this.anchor0.wz}):
Number.POSITIVE_INFINITY}containsPoint2D(a){return this.style.containsPoint2d(a,this.anchor0.sx,this.anchor0.sy,this.anchor1.sx,this.anchor1.sy)}render2D(a){this.style.render2d(a,this.anchor0.sx,this.anchor0.sy,this.anchor1.sx,this.anchor1.sy,this.label)}};
O.Style.Arc=class{constructor(a,b,c){this.selected=!1;this.fillStyle=b;this.dash=a;this.labelled=c;this.length2=0}line(a){a.strokeStyle=this.fillStyle;this.dash&&a.setLineDash(this.dash);a.stroke();this.dash&&a.setLineDash([])}render2d(a,b,c,d,e,g,k,h,f){var l=b-d,m=c-e;b=Math.sqrt(l*l+m*m);l/=b;m/=b;c=Math.atan2(m,l);g-=d;var n=k-e,p=Math.sqrt(g*g+n*n);g/=p;n/=p;k=Math.atan2(n,g);1>Math.abs(g*l+n*m)+.05&&(b=Math.min(b,p)/2.7,a.setTransform(1,0,0,1,d,e),a.beginPath(),a.arc(0,0,b,c,k,0<GM.Vector3.dot(V.camera.zAxis,
h)),a.strokeStyle=this.fillStyle,this.dash&&a.setLineDash(this.dash),a.stroke(),this.dash&&a.setLineDash([]),f&&f.size.width*f.size.width<b*b*.7&&(h=l+g,l=m+n,m=Math.sqrt(h*h+l*l),k=Math.PI/2-(c+k)/2,c=-Math.cos(k),k=-Math.sin(k),a.setTransform(c,-k,k,c,d+h/m*b,e+l/m*b),d=O.Style.A,e=f.size.width+2*O.Style.A,c=12+O.Style.A,h=-e/2,b=-c+-3,a.beginPath(),a.fillStyle="rgba(255,255,255,0.7)",a.moveTo(h+d,b),a.lineTo(h+e-d,b),a.quadraticCurveTo(h+e,b,h+e,b+d),a.lineTo(h+e,b+c-d),a.quadraticCurveTo(h+e,
b+c,h+e-d,b+c),a.lineTo(h+d,b+c),a.quadraticCurveTo(h,b+c,h,b+c-d),a.lineTo(h,b+d),a.quadraticCurveTo(h,b,h+d,b),a.fill(),a.font="12px Arial",a.textAlign="center",a.textBaseline="bottom",a.fillStyle="blue",a.fillText(f.text,0,-3-O.Style.A/2+1)))}createLabel(a,b){a=b.toFixed(0)+String.fromCharCode(176);O.instance.context.font="12px Arial";return{text:a,size:O.instance.context.measureText(a)}}};
O.Arc=class extends O.Component{constructor(a,b,c,d,e){super(e);this.anchor1=b;this.anchor1.addListener(this);this.anchor0=a;this.anchor0.addListener(this);this.anchor2=c;this.anchor2.addListener(this);this.text=d;this.angle=0;this.update3D()}update3D(){var a=this.anchor0.wx-this.anchor1.wx,b=this.anchor0.wy-this.anchor1.wy,c=this.anchor0.wz-this.anchor1.wz,d=Math.sqrt(a*a+b*b+c*c);a/=d;b/=d;c/=d;d=this.anchor2.wx-this.anchor1.wx;var e=this.anchor2.wy-this.anchor1.wy,g=this.anchor2.wz-this.anchor1.wz,
k=Math.sqrt(d*d+e*e+g*g);d/=k;e/=k;g/=k;this.angle=180*Math.acos(a*d+b*e+c*g)/Math.PI;this.normal3D.x=b*g-c*e;this.normal3D.y=c*d-a*g;this.normal3D.z=a*e-b*d;this.text&&(this.label=this.style.createLabel(this.text,this.angle))}updateLabel(a){(this.text=a)?this.label=this.style.createLabel(this.text,this.angle):delete this.label}render2D(a){this.style.render2d(a,this.anchor0.sx,this.anchor0.sy,this.anchor1.sx,this.anchor1.sy,this.anchor2.sx,this.anchor2.sy,this.normal3D,this.label)}};
</script>
<script id="/overlay/geometry.js">G={EPSISLON:.999,sx:1,sy:1,sz:1,getPlane:function(b,a,c){var d=b.wx-a.wx,e=b.wy-a.wy,f=b.wz-a.wz;b=c.wx-a.wx;let g=c.wy-a.wy,h=c.wz-a.wz;c=g*f-h*e;f=h*d-b*f;d=b*e-g*d;e=Math.sqrt(c*c+f*f+d*d);c/=e;f/=e;d/=e;w=a.wx*c+a.wy*f+a.wz*d;return{x:c,y:f,z:d,w}},edgeIntersect:function(b,a,c,d){let e=b.du*(c.v-b.v)-b.dv*(c.u-b.u);d=b.du*(d.v-b.v)-b.dv*(d.u-b.u);if(0<e*d)return!1;e=c.du*(b.v-c.v)-c.dv*(b.u-c.u);d=c.du*(a.v-c.v)-c.dv*(a.u-c.u);return 0<e*d?!1:!0},containsPoint:function(b,a,c,d){let e=.5*(-a.v*
c.u+b.v*(-a.u+c.u)+b.u*(a.v-c.v)+a.u*c.v),f=0>e?-1:1;c=(b.v*c.u-b.u*c.v+(c.v-b.v)*d.u+(b.u-c.u)*d.v)*f;b=(b.u*a.v-b.v*a.u+(b.v-a.v)*d.u+(a.u-b.u)*d.v)*f;return 0<c&&0<b&&c+b<2*e*f},Polygon:function(b){this.plane=b;this.sv=this.su=1;this.vEnd=this.vPos=0}};G.Polygon.prototype.translate=function(b,a,c){this.plane.w+=this.plane.x*b+this.plane.y*a+this.plane.z*c};
G.Polygon.prototype.update=function(b){for(var a={x:0,y:0,z:0},c=0;c<b.length;c++)a.x+=b[c].wx,a.y+=b[c].wy,a.z+=b[c].wz;a.x/=b.length;a.y/=b.length;a.z/=b.length;this.radius=Number.NEGATIVE_INFINITY;var d={x:b[0].wx-a.x,y:b[0].wy-a.y,z:b[0].wz-a.z};for(c=1;c<b.length;c++){var e=b[c].wx-a.x,f=b[c].wy-a.y,g=b[c].wz-a.z,h=e*e+f*f+g*g;this.radius<h&&(d.x=e,d.y=f,d.z=g,this.radius=h)}this.radius=Math.sqrt(this.radius);e=Math.sqrt(d.x*d.x+d.y*d.y+d.z*d.z);d.x/=e;d.y/=e;d.z/=e;e={x:this.plane.y*d.z-this.plane.z*
d.y,y:this.plane.z*d.x-this.plane.x*d.z,z:this.plane.x*d.y-this.plane.y*d.x};f=[];this.umin=Number.POSITIVE_INFINITY;this.umax=Number.NEGATIVE_INFINITY;this.vmin=Number.POSITIVE_INFINITY;this.vmax=Number.NEGATIVE_INFINITY;for(c=0;c<b.length;c++){h=b[c].wx-a.x;var k=b[c].wy-a.y,l=b[c].wz-a.z;g=h*e.x+k*e.y+l*e.z;h=h*d.x+k*d.y+l*d.z;f.push({u:g,v:h,id:b[c].id,next:(c+1)%b.length});this.umin=Math.min(this.umin,g);this.umax=Math.max(this.umax,g);this.vmin=Math.min(this.vmin,h);this.vmax=Math.max(this.vmax,
h)}this.du=this.umax-this.umin;this.dv=this.vmax-this.vmin;b=[];g=c=0;do{h=f[g];k=f[h.next];l=f[k.next];if((k.u-h.u)*(l.v-h.v)<(k.v-h.v)*(l.u-h.u)){let m=l.next;for(;m!==g;){let n=f[m];if(G.containsPoint(h,k,l,n))break;m=n.next}m==g&&(b.push(g,h.next,k.next),f[g].next=k.next)}g=f[g].next;if(c++>3*f.length){console.log("DDDDDDDDDDDDDDDDDDD");break}}while(f[f[g].next].next!=g);this.points=f;this.u=e;this.v=d;this.center=a;this.triangles=b;a=this.u.x*G.sx;d=this.u.y*G.sy;e=this.u.z*G.sz;this.su=Math.sqrt(a*
a+d*d+e*e);a=this.v.x*G.sx;d=this.v.y*G.sy;e=this.v.z*G.sz;this.sv=Math.sqrt(a*a+d*d+e*e)};G.Polygon.prototype.getMesh=function(b){let a=b?this.plane.x*b:0,c=b?this.plane.y*b:0;b=b?this.plane.z*b:0;let d=new Float32Array(3*this.triangles.length);for(var e=0;e<this.triangles.length;e++){let f=this.points[this.triangles[e]];d[3*e]=this.center.x+f.u*this.u.x+f.v*this.v.x+a;d[3*e+1]=this.center.y+f.u*this.u.y+f.v*this.v.y+c;d[3*e+2]=this.center.z+f.u*this.u.z+f.v*this.v.z+b}return d};
G.Polygon.prototype.containsPoint=function(b){var a=b.x-this.center.x,c=b.y-this.center.y;b=b.z-this.center.z;a={u:a*this.u.x+c*this.u.y+b*this.u.z,v:a*this.v.x+c*this.v.y+b*this.v.z};for(c=0;c<this.triangles.length/3;c++)if(G.containsPoint(this.points[this.triangles[3*c]],this.points[this.triangles[3*c+1]],this.points[this.triangles[3*c+2]],a))return!0;return!1};
G.Polygon.prototype.canRemovePoint=function(b,a){var c=0;for(a=0;a<this.points.length;a++){var d=this.points[a];d.next=(a+1)%this.points.length;var e=this.points[d.next];d.id==b&&(c=a);d.du=e.u-d.u;d.dv=e.v-d.v}b=this.points[(c-1+this.points.length)%this.points.length];d=this.points[(c+1)%this.points.length];b.next=(b.next+1)%this.points.length;b.du=d.u-b.u;b.dv=d.v-b.v;e=(c-3+this.points.length)%this.points.length;for(a=0;a<this.points.length-4;a++){var f=this.points[e];if(G.edgeIntersect(b,d,f,
this.points[f.next]))return!1;e=(e-1+this.points.length)%this.points.length}e=(c+2)%this.points.length;for(a=0;a<this.points.length-4;a++){f=this.points[e];if(G.edgeIntersect(b,d,f,this.points[f.next]))return!1;e=(e+1)%this.points.length}b=0;c=(c+1)%this.points.length;for(a=0;a<this.points.length-1;a++)d=this.points[c],c=d.next,e=this.points[c],b+=(d.u+e.u)*(d.v-e.v);return 0<b};
G.Polygon.prototype.canMovePoint=function(b,a){var c=a.x-this.center.x,d=a.y-this.center.y,e=a.z-this.center.z;a=c*this.u.x+d*this.u.y+e*this.u.z;var f=c*this.v.x+d*this.v.y+e*this.v.z;for(d=e=c=0;d<this.points.length;d++){let g=this.points[d];g.next=(d+1)%this.points.length;let h=this.points[g.next];g.id==b&&(g.u=a,g.v=f,c=d);h.id==b&&(h.u=a,h.v=f,e=d);g.du=h.u-g.u;g.dv=h.v-g.v}a=this.points[e];b=this.points[c];e=(e-2+this.points.length)%this.points.length;for(d=0;d<this.points.length-3;d++){f=this.points[e];
if(G.edgeIntersect(a,b,f,this.points[f.next]))return!1;e=(e-1+this.points.length)%this.points.length}a=this.points[(c+1)%this.points.length];c=(c+2)%this.points.length;for(d=0;d<this.points.length-3;d++){e=this.points[c];if(G.edgeIntersect(b,a,e,this.points[e.next]))return!1;c=(c+1)%this.points.length}return 0<this.getArea()};
G.Polygon.prototype.getArea=function(){let b=0,a=this.points.length-1;for(var c=0;c<this.points.length;c++)b+=(this.points[a].u+this.points[c].u)*(this.points[a].v-this.points[c].v),a=c;return b/2};
G.Polygon.prototype.startScan=function(b,a){let c=this.points,d=[];for(var e=0;e<c.length;e++){let f=c[e],g=c[(e+1)%c.length];Math.abs(g.v-f.v)>b&&d.push({id0:f.id,id1:g.id,vmin:Math.min(f.v,g.v),vmax:Math.max(f.v,g.v),umin:Math.min(f.u,g.u),umax:Math.max(f.u,g.u),u0:f.u,v0:f.v,m:(g.u-f.u)/(g.v-f.v)})}d.sort(function(f,g){return f.vmin-g.vmin});this.edges=d;this.vEdge=0;this.vEnd=this.vmax-.5*b;this.vPos=this.vmin+.5*b;this.active=[];this.integral=0;this.resolution=b;this.ray=new GM.Ray;this.ray.direction.x=
a.x;this.ray.direction.y=a.y;this.ray.direction.z=a.z;return this.context={du:Math.ceil(this.du/b),dv:Math.ceil(this.dv/b),resolution:b}};
G.Polygon.prototype.scanLine=function(b){for(var a=0;a<this.active.length;a++)this.edges[this.active[a]].vmax<this.vPos&&(this.active.splice(a,1),a--);for(a=this.vEdge;a<this.edges.length;a++)this.edges[a].vmin<this.vPos&&(this.active.push(a),this.vEdge++);for(a=0;a<this.active.length;a++){var c=this.edges[this.active[a]];c.u=c.u0+c.m*(this.vPos-c.v0)}this.active=this.active.sort(function(g,h){return this.edges[g].u-this.edges[h].u}.bind(this));b.startLine&&b.startLine(this.context);c=this.center.x+
this.vPos*this.v.x;let d=this.center.y+this.vPos*this.v.y,e=this.center.z+this.vPos*this.v.z;for(a=0;a<Math.floor(this.active.length/2);a++){let g=this.edges[this.active[2*a+1]];for(var f=this.edges[this.active[2*a]].u;f<g.u;f+=this.resolution)this.ray.origin.x=c+f*this.u.x,this.ray.origin.y=d+f*this.u.y,this.ray.origin.z=e+f*this.u.z,b.sample(this.ray,this.resolution,f-this.umin,this.vPos-this.vmin)}b.endLine&&b.endLine(this.context);this.vPos+=this.resolution};
G.Polygon.prototype.endScan=function(){return this.vPos>=this.vEnd?!0:!1};
</script>
<script id="/overlay/elevation.js">O.Elevation=function(a,b){O.Object.call(this,a.id,a.content.radius);this.callback=b;this.type="elevation";this.constraint=C.create(a.content.constraint);this.anchor0=this.addAnchor(new O.Anchor(a.content.p0||a.content.points[0]));this.anchor1=this.addAnchor(new O.Anchor(a.content.p1||a.content.points[1]));this.anchorC=this.addAnchor(new O.Anchor({x:this.anchor1.wx,y:this.anchor0.wy,z:this.anchor1.wz}));this.projectAnchors();this.line=this.addComponent(new O.Segment(this.anchor0,this.anchor1,new O.Style.Line([3,
3],"red",O.Style.NONE,!0)));this.vert=this.addComponent(new O.Segment(this.anchorC,this.anchor1,new O.Style.Line(null,"red",O.Style.FRONT,!0)));this.horz=this.addComponent(new O.Segment(this.anchorC,this.anchor0,new O.Style.Line(null,"red",O.Style.FRONT,!0)));this.arc=this.addComponent(new O.Arc(this.anchor1,this.anchor0,this.anchorC,new O.Style.Line(null,"blue",O.Style.NONE,!0)))};O.Elevation.prototype=Object.create(O.Object.prototype);O.Elevation.prototype.constructor=O.Elevation;
O.Elevation.NAME="elevation";O.Elevation.prototype.select=function(a){O.Object.prototype.select.call(this);this.addControl(new O.ControlPoint(this.anchor0,this.constraint));this.addControl(new O.ControlPoint(this.anchor1,this.constraint))};O.Elevation.prototype.moveControl=function(a){this.anchorC.set3D({x:this.anchor1.wx,y:this.anchor0.wy,z:this.anchor1.wz})};
O.Elevation.prototype.endControl=function(){O.Object.prototype.endControl.call(this);this.callback.update&&this.callback.update(this,{p0:this.anchor0.toJson(),p1:this.anchor1.toJson()})};
O.Elevation.Builder=class{constructor(a,b){this.config=a||{};this.custom=b;this.constraint=V.viewer.getConstraint()}addPoint(a,b){return O.instance.createControlPoint(a,this.constraint)}removePoint(a){2==points.length&&points[this.points.length-1].detach()}isDone(a){return 2==a.length}complete(a){this.config.type="elevation";this.config.points=a;this.config.constraint=this.constraint.toJson();V.postMessage("elevation.record",this.config,this.custom)}};
V.recvMessage("elevation.record",(a,b)=>{O.Builder.get().start(new O.Elevation.Builder(a,b))});V.recvMessage("elevation.update",function(a,b){var c=O.instance.getObject(a.id);c&&(c.update(a),V.postMessage("elevation.update",a,b),V.touch2d(),V.touch3d())});V.recvMessage("elevation.select",function(a,b){if(a=O.instance.getObject(a.id))a.select(),V.postMessage("elevation.select",a.toJson(),b),V.touch2d()});
V.recvMessage("elevation.unselect",function(a,b){O.instance.getObject(a.id)&&(line.unselect(),V.postMessage("elevation.unselect",a,b),V.touch2d())});
</script>
<script id="/overlay/line.js">O.Line=class extends O.Object{constructor(a){super(a.id,a.activation);this.type="line";this.visible=a.visible;this.constraint=C.create(a.constraint);this.mode=a.mode;this.lineStyle=a.code?new O.Style.Line.Custom(a.code,a.scope):new O.Style.Line(null,"red",O.Style.FRONT);this.arcStyle=new O.Style.Arc([3,3],"blue",this.mode[O.ANGLE]);for(var b=0;b<a.points.length;b++)this.addAnchor(new O.Anchor(a.points[b]));this.projectAnchors();this.addComponent(new O.Segment(this.anchors[0],this.anchors[1],this.mode[O.DISTANCE],
this.lineStyle));for(b=0;b<a.points.length-2;b++)this.addComponent(new O.Arc(this.anchors[b],this.anchors[b+1],this.anchors[b+2],this.mode[O.ANGLE],this.arcStyle)).visible=this.mode[O.ANGLE],this.addComponent(new O.Segment(this.anchors[b+1],this.anchors[b+2],this.mode[O.DISTANCE],this.lineStyle))}length(){let a=0;for(var b=0;b<this.anchors.length-1;b++){let c=this.anchors[b+1].wx-this.anchors[b].wx,e=this.anchors[b+1].wy-this.anchors[b].wy,f=this.anchors[b+1].wz-this.anchors[b].wz;a+=Math.sqrt(c*
c+e*e+f*f)}return a}select(){super.select();for(var a=0;a<this.anchors.length;a++)this.addControl(new O.ControlPoint(this.anchors[a],this.constraint))}update(a){super.update(a);a.hasOwnProperty("mode")&&(this.mode=a.mode,this.components.forEach(b=>{b instanceof O.Segment?b.updateLabel(this.mode[O.DISTANCE]):b instanceof O.Arc&&(b.visible=this.mode[O.ANGLE],b.updateLabel(this.mode[O.ANGLE]))}));a.scope&&this.lineStyle.update(a.scope)}onDblClick(a){if(a.component instanceof O.ControlPoint)for(var b=
1;b<this.controls.length-1;b++){if(this.controls[b]===a.component){this.components.splice(2*(b-1),2);var c=this.anchors[b-1];this.removeControl(this.controls[b]);this.removeAnchor(this.anchors[b]);var e=2*(b-1),f=this.components[e];f.anchor0=c;f.anchor0.addListener(f);f.update3D();b<this.controls.length-1&&(e=this.components[e+1],e.anchor0=c,e.anchor0.addListener(e),e.update3D());1<b&&(b=this.components[2*(b-1)-1],b.anchor2=f.anchor1,b.anchor2.addListener(b),b.update3D());break}}else if(a.component instanceof
O.Segment)for(b=0;b<this.components.length;b++)if(this.components[b]==a.component){c=this.constraint.getPoint(a);if(null!=c){f=a.component.anchor0;c=this.insertAnchor(b/2+1,new O.Anchor(c));e=a.component.anchor1;if(b<2*(this.controls.length-2)){var d=this.components[b+1];d.anchor0.removeListener(d);d.anchor0=c;d.anchor0.addListener(d);d.update3D()}1<b&&(d=this.components[(b-1+2*this.controls.length)%(2*this.controls.length)],d.anchor2.removeListener(d),d.anchor2=c,d.anchor2.addListener(d),d.update3D());
d=this.components[b];d.anchor0.removeListener(d);d.anchor0=c;d.anchor0.addListener(d);d.update3D();d=b;this.insertComponent(d,new O.Arc(f,c,e,this.mode[O.ANGLE],this.arcStyle)).visible=this.mode[O.ANGLE];this.insertComponent(d,new O.Segment(f,c,this.mode[O.DISTANCE],this.lineStyle));this.insertControl(b/2+1,new O.ControlPoint(c,this.constraint))}break}a.stopImmediatePropagation();this.endControl()}endControl(){super.endControl();V.postMessage("line.update",this.toJson())}toJson(a){let b={};if(void 0==
a||a.includes("type"))b.type=this.type;if(void 0==a||a.includes("points")){for(var c=[],e=0;e<this.anchors.length;e++)c.push(this.anchors[e].toJson());b.points=c}if(void 0==a||a.includes("constraint"))b.constraint=this.constraint.toJson();if(void 0==a||a.includes("mode"))b.mode=this.mode;return Object.assign(super.toJson(a),b)}};
O.Line.validate=a=>{if(!a.points||2>a.points.length)return V.postMessage("error","No enough points to complete line"),!1;if(O.find(a.id))return V.postMessage("error",`Duplicate line ID : ${a.id}`),!1;a.hasOwnProperty("visible")||(a.visible=!0);a.hasOwnProperty("constraint")||(a.constraint=V.viewer.getConstraint());a.hasOwnProperty("mode")||(a.mode={});return!0};
O.Line.Builder=class{constructor(a,b){this.config=a||{};this.custom=b;this.constraint=V.viewer.getConstraint()}addPoint(a,b){return O.instance.createControlPoint(a,this.constraint)}removePoint(a){2==points.length&&points[this.points.length-1].detach()}isDone(a){return 2==a.length}complete(a){this.config.type="line";this.config.points=a;this.config.constraint=this.constraint.toJson();V.postMessage("line.record",this.config,this.custom)}};
V.recvMessage("line.record",(a,b)=>{O.Builder.get().start(new O.Line.Builder(a,b))});V.recvMessage("line.update",(a,b)=>{var c=O.instance.getObject(a.id);c&&(c.update(a),V.postMessage("line.update",c.toJson(),b),V.touch2d(),V.touch3d())});V.recvMessage("line.select",(a,b)=>{if(a=O.instance.getObject(a.id))a.select(),V.postMessage("line.select",a.toJson(),b),V.touch2d()});
V.recvMessage("line.unselect",(a,b)=>{if(a=O.instance.getObject(a.id))a.unselect(),V.postMessage("line.unselect",a.toJson(),b),V.touch2d()});V.recvMessage("line.get",(a,b)=>{if(a&&a.id){var c=O.instance.getObject(a.id);c&&V.postMessage("line.get",c.toJson(a.filter),b)}else V.postMessage("line.get",O.getAll("line"),b)});
</script>
<script id="/overlay/polygon.js">O.ControlUV=class extends O.Object{constructor(a){super(a.id+"uv");this.container=a;this.geometry=a.geometry;this.anchor=this.addAnchor(new O.Anchor);this.anchor0=this.addAnchor(new O.Anchor);this.anchor1=this.addAnchor(new O.Anchor);this.anchor2=this.addAnchor(new O.Anchor);this.anchor3=this.addAnchor(new O.Anchor);this.style=new O.Style.Line([3,3],C.Plane.PASSIVE,O.Style.NONE);this.line=this.addComponent(new O.Segment(this.anchor0,this.anchor1,null,this.style));this.line=this.addComponent(new O.Segment(this.anchor2,
this.anchor3,null,this.style))}attach(){super.attach();this.update();this.controlPoint=this.addControl(new O.ControlPoint(this.anchor,new C.Plane(this.geometry.plane)))}startControl(a){this.style.fillStyle=C.Plane.ACTIVE;this.style.lineWidth=3;this.container.startControl()}endControl(a){this.style.fillStyle=C.Plane.PASSIVE;this.style.lineWidth=1;this.container.endControl()}moveControl(a){a=this.anchor.wx-this.center.x;let b=this.anchor.wy-this.center.y,c=this.anchor.wz-this.center.z;this.container.translate(a,
b,c);this.anchor0.translate3D(a,b,c);this.anchor1.translate3D(a,b,c);this.anchor2.translate3D(a,b,c);this.anchor3.translate3D(a,b,c);this.center.x=this.anchor.wx;this.center.y=this.anchor.wy;this.center.z=this.anchor.wz;this.container.moveControl()}update(){this.center=this.geometry.center;this.anchor.set3D(this.center);let a=.25*this.geometry.radius,b=this.geometry.u,c=this.geometry.v;this.anchor0.set3D({x:this.center.x+a*b.x,y:this.center.y+a*b.y,z:this.center.z+a*b.z});this.anchor1.set3D({x:this.center.x-
a*b.x,y:this.center.y-a*b.y,z:this.center.z-a*b.z});this.anchor2.set3D({x:this.center.x+a*c.x,y:this.center.y+a*c.y,z:this.center.z+a*c.z});this.anchor3.set3D({x:this.center.x-a*c.x,y:this.center.y-a*c.y,z:this.center.z-a*c.z})}};
O.Polygon=class extends O.Composite{constructor(a){super(a.id,a.activation);this.type="polygon";this.mode=a.mode;this.visible=a.visible;this.lineStyle=new O.Style.Line(null,"red",O.Segment.NONE);this.arcStyle=new O.Style.Arc([3,3],"blue",null!=this.mode[O.ANGLE]);for(var b=0;b<a.points.length;b++)this.addAnchor(new O.Anchor(a.points[b]));this.projectAnchors();for(b=0;b<a.points.length;b++)this.addComponent(new O.Segment(this.anchors[b],this.anchors[(b+1)%this.anchors.length],this.mode[O.DISTANCE],
this.lineStyle)),this.addComponent(new O.Arc(this.anchors[b],this.anchors[(b+1)%this.anchors.length],this.anchors[(b+2)%this.anchors.length],this.mode[O.ANGLE],this.arcStyle)).visible=this.mode[O.ANGLE];"Polygon"==a.constraint[0]?(this.geometry=new G.Polygon(a.constraint[1]),this.constraint=new C.Polygon(this.geometry)):(this.geometry=new G.Polygon(G.getPlane(this.anchors[0],this.anchors[1],this.anchors[2])),this.constraint=new C.create(a.constraint));this.geometry.update(this.anchors);this.processScanFn=
this.processScan.bind(this)}update(a){super.update(a);this.selected&&this.constraint instanceof C.Polygon&&this.removeControls();a.hasOwnProperty("mode")&&(this.mode=a.mode,this.components.forEach(b=>{b instanceof O.Segment?b.updateLabel(this.mode[O.DISTANCE]):b instanceof O.Arc&&(b.visible=this.mode[O.ANGLE],b.updateLabel(this.mode[O.ANGLE]))}));this.selected&&this.constraint instanceof C.Polygon&&this.addControls()}onDblClick(a){this.startControl();if(a.component instanceof O.ControlPoint){if(3<
this.controls.length)for(var b=0;b<this.controls.length;b++)if(this.controls[b]===a.component){if(this.geometry.canRemovePoint(a.component.anchor.id)){this.components.splice(2*b,2);this.removeControl(this.controls[b]);this.removeAnchor(this.anchors[b]);var c=(b-1+this.controls.length)%this.controls.length*2,e=this.components[c],f=this.components[c+1];c=(b-2+this.controls.length)%this.controls.length*2;c=this.components[c+1];b=this.components[b%this.controls.length*2];f.anchor1=f.anchor2;f.anchor2=
b.anchor1;f.anchor2.addListener(f);f.update3D();c.anchor2=f.anchor1;c.anchor2.addListener(c);c.update3D();e.anchor1=b.anchor0;e.anchor1.addListener(e);e.update3D()}else O.cursor("not-allowed"),setTimeout(function(){O.cursor("default")},1E3);break}}else if(a.component instanceof O.Segment){if(3==this.controls.length&&!(this.constraint instanceof C.Polygon)){this.geometry.plane=G.getPlane(this.anchors[0],this.anchors[1],this.anchors[2]);this.constraint=new C.Polygon(this.geometry);for(b=0;b<this.controls.length;b++)this.controls[b].constraint=
this.constraint;this.addControls()}for(b=0;b<this.components.length;b++)if(this.components[b]==a.component){e=a.component.anchor0;f=this.insertAnchor(b/2+1,new O.Anchor(this.constraint.getPoint(a)));c=a.component.anchor1;var d=this.components[b+1];d.anchor0.removeListener(d);d.anchor0=f;d.anchor0.addListener(d);d.update3D();d=this.components[(b-1+2*this.controls.length)%(2*this.controls.length)];d.anchor2.removeListener(d);d.anchor2=f;d.anchor2.addListener(d);d.update3D();d=this.components[b];d.anchor0.removeListener(this.components[b]);
d.anchor0=f;d.anchor0.addListener(this.components[b]);d.update3D();d=b;this.insertComponent(d,new O.Arc(e,f,c,this.mode[O.ANGLE],this.arcStyle)).visible=this.mode[O.ANGLE];this.insertComponent(d,new O.Segment(e,f,this.mode[O.DISTANCE],this.lineStyle));this.insertControl(b/2+1,new O.ControlPoint(f,this.constraint));break}}a.stopImmediatePropagation();this.endControl()}toJson(a){let b={};if(void 0==a||a.includes("type"))b.type=this.type;if(void 0==a||a.includes("points")){let e=[];for(var c=0;c<this.anchors.length;c++)e.push(this.anchors[c].toJson());
b.points=e}if(void 0==a||a.includes("constraint"))b.constraint=this.constraint.toJson();if(void 0==a||a.includes("mode"))b.mode=this.mode;return Object.assign(super.toJson(a),b)}translate(a,b,c){for(var e=0;e<this.anchors.length;e++)this.anchors[e].translate3D(a,b,c);this.geometry.translate(a,b,c)}moveControl(){3==this.anchors.length&&(this.geometry.plane=G.getPlane(this.anchors[0],this.anchors[1],this.anchors[2]));this.geometry.update(this.anchors);V.touch3d()}endControl(a){super.endControl();3==
this.anchors.length&&(this.geometry.plane=G.getPlane(this.anchors[0],this.anchors[1],this.anchors[2]));this.geometry.update(this.anchors);V.touch3d();V.postMessage("polygon.update",this.toJson(),{uv:this.geometry.points})}select(){super.select();for(var a=0;a<this.anchors.length;a++)this.addControl(new O.ControlPoint(this.anchors[a],this.constraint));this.constraint instanceof C.Polygon&&this.addControls()}unselect(){super.unselect();this.constraint instanceof C.Polygon&&this.removeControls()}processScan(){V.camera.moving||
this.geometry.scanLine(this);this.geometry.endScan()?(V.postMessage("polygon.scan.end",this.toJson()),this.timer=null):this.timer=setTimeout(this.processScanFn,0)}startScan(a,b){this.timer&&this.stopScan();this.timer=setTimeout(this.processScanFn,0);return this.geometry.startScan(a,b)}stopScan(){this.timer&&(clearTimeout(this.timer),this.timer=null)}render2D(a){super.render2D(a)}};
O.Polygon.validate=a=>{if(!a.points||3>a.points.length)return V.postMessage("error","No enough points to complete line"),!1;if(O.find(a.id))return V.postMessage("error",`Duplicate line ID : ${a.id}`),!1;a.hasOwnProperty("visible")||(a.visible=!0);a.hasOwnProperty("constraint")||(a.constraint=V.viewer.getConstraint());a.hasOwnProperty("mode")||(a.mode={});return!0};
O.Polygon.Builder=class{constructor(a,b){this.config=a||{};this.custom=b;this.constraint=V.viewer.getConstraint()}addPoint(a,b){return O.instance.createControlPoint(a,this.constraint)}removePoint(a){3<points.length&&points[this.points.length-1].detach()}isDone(a){return 3==a.length}complete(a){this.config.type="polygon";this.config.points=a;this.config.constraint=this.constraint.toJson();V.postMessage("polygon.record",this.config,this.custom)}};
V.recvMessage("polygon.record",(a,b)=>{O.Builder.get().start(new O.Polygon.Builder(a,b))});V.recvMessage("polygon.select",function(a,b){if(a=O.instance.getObject(a.id))a.select(),V.postMessage("polygon.select",a.toJson(),b),V.touch2d()});V.recvMessage("polygon.unselect",function(a,b){if(a=O.instance.getObject(a.id))a.unselect(),V.postMessage("polygon.unselect",a.toJson(),b),V.touch2d()});
V.recvMessage("polygon.update",(a,b)=>{let c=O.instance.getObject(a.id);c&&(c.update(a),b.uv=c.geometry.points,V.postMessage("polygon.update",c.toJson(),b),V.touch2d(),V.touch3d())});V.recvMessage("polygon.get",(a,b)=>{if(a&&a.id){let c=O.instance.getObject(a.id);c&&V.postMessage("polygon.get",c.toJson(a.filter),b)}else V.postMessage("polygon.get",O.getAll("polygon"),b)});
</script>
<script id="/overlay/point.js">O.Point=class extends O.Object{constructor(a){super(a.id,a.activation,a.exclude);this.type="point";this.visible=a.visible;this.constraint=C.create(a.constraint);this.anchor=this.addAnchor(new O.Anchor(a.point));this.projectAnchors();this.exec={};a.code.init&&(this.exec.init=Function("return "+decodeURI(a.code.init))());a.code.render2d&&(this.exec.render2d=Function("return "+decodeURI(a.code.render2d))());a.code.update&&(this.exec.update=Function("return "+decodeURI(a.code.update))());a.code.intersect&&
(this.exec.intersect=Function("return "+decodeURI(a.code.intersect))());this.scope=Object.assign({},a.scope);this.exec.init&&this.exec.init.call(this.scope);this.source={code:a.code,scope:a.scope};this.meta=a.meta}CLICK(a){a.point={x:this.anchor.wx,y:this.anchor.wy,z:this.anchor.wz};a.meta=this.meta;return a}DBLCLICK(a){a.point={x:this.anchor.wx,y:this.anchor.wy,z:this.anchor.wz};a.meta=this.meta;return a}update(a){super.update(a);a.point&&(this.anchor.set3D(a.point),this.projectAnchors());a.scope&&
(this.source.scope=Object.assign(this.source.scope,a.scope),this.exec.update?this.exec.update.call(this.scope,this.source.scope):Object.assign(this.scope,a.scope));a.meta&&(this.meta=Object.assign({},a.meta));V.touch2d();V.touch3d()}containsPoint2D(a){return this.exec.intersect?this.exec.intersect.call(this.scope,O.instance.context,a.pageX,a.pageY,{scale:this.scale,x:this.anchor.sx,y:this.anchor.sy}):!1}intersectRay3D(a){return this.containsPoint2D(a)?V.camera.distanceTo({x:this.anchor.wx,y:this.anchor.wy,
z:this.anchor.wz}):Number.POSITIVE_INFINITY}render2D(a){this.exec.render2d&&(a.setTransform(this.scale,0,0,this.scale,this.anchor.sx,this.anchor.sy),this.exec.render2d.call(this.scope,a,{scale:this.scale,x:this.anchor.sx,y:this.anchor.sy,t:V.time,dt:V.dT,selected:this.selected})&&V.touch2d())}select(){super.select();this.addControl(new O.ControlPoint(this.anchor,this.constraint))}endControl(){super.endControl();V.postMessage("point.update",this.toJson())}toJson(a){let b={};if(void 0==a||a.includes("type"))b.type=
this.type;if(void 0==a||a.includes("point"))b.point=this.anchor.toJson();if(void 0==a||a.includes("code"))b.code=this.source.code;if(void 0==a||a.includes("scope"))b.scope=this.source.scope;return Object.assign(super.toJson(a),b)}};
O.Point.validate=a=>{if(!a.point)return V.postMessage("error","No coordinates supplied"),!1;if(O.find(a.id))return V.postMessage("error",`Duplicate point ID : ${a.id}`),!1;if(!a.hasOwnProperty("code"))return V.postMessage("error","Point requires a code object"),!1;a.hasOwnProperty("visible")||(a.visible=!0);a.hasOwnProperty("constraint")||(a.constraint=V.viewer.getConstraint());return!0};
O.Point.Builder=class{constructor(a,b){this.config=a||{};this.custom=b;this.constraint=V.viewer.getConstraint()}addPoint(a,b){return O.instance.createControlPoint(a,this.constraint)}removePoint(a){}isDone(a){return 1==a.length}complete(a){this.config.type="point";this.config.point=a[0];this.config.constraint=this.constraint.toJson();V.postMessage("point.record",this.config,this.custom)}};V.recvMessage("point.record",(a,b)=>{O.Builder.get().start(new O.Point.Builder(a,b))});
V.recvMessage("point.create",(a,b)=>{if(O.Point.validate(a)){a=new O.Point(a);if(b.transform){let c=V.viewer.datasets[b.transform];c&&c.addAnchors(a)}O.instance.addObject(a);V.postMessage("point.create",a.toJson(),b);V.touch3d();V.touch2d()}});V.recvMessage("point.delete",function(a,b){if(b.transform&&(b=V.viewer.datasets[b.transform])){let c=O.instance.getObject(a.id);b.removeAnchors(c)}O.instance.removeObject(a.id);V.postMessage("point.delete",a);V.touch2d()});
V.recvMessage("point.update",function(a,b){var c=O.instance.getObject(a.id);c&&(c.update(a),V.postMessage("point.update",a,b),V.touch2d(),V.touch3d())});V.recvMessage("point.select",function(a,b){if(a=O.instance.getObject(a.id))a.select(),V.postMessage("point.select",a.toJson(),b),V.touch2d()});V.recvMessage("point.unselect",function(a,b){var c=O.instance.getObject(a.id);c&&(c.unselect(),V.postMessage("point.unselect",a,b),V.touch2d())});
V.recvMessage("point.get",(a,b)=>{if(a&&a.id){var c=O.instance.getObject(a.id);c&&V.postMessage("point.get",c.toJson(a.filter),b)}else V.postMessage("point.get",O.getAll("point"),b)});
</script>
<script id="/2d/map/shader.js">M.Shader=class extends GL.Shader{constructor(a,b){super(a,b)}compile(){super.compile();this.defineAttribute("position",2,gl.FLOAT,!1);this.dxy=gl.getUniformLocation(this.glId,"dxy");this.projection=gl.getUniformLocation(this.glId,"projection");this.split=gl.getUniformLocation(this.glId,"split");this.pane=gl.getUniformLocation(this.glId,"pane")}start(a,b){gl.useProgram(this.glId);this.enableBuffer();this.bindBuffer(b);gl.activeTexture(gl.TEXTURE0);gl.uniform1i(this.samplerMap,0);gl.uniform2f(this.split,
M.splitV*gl.drawingBufferWidth,(1-M.splitH)*gl.drawingBufferHeight);gl.uniform1f(this.pane,a)}end(){this.disableBuffer()}renderNode(a,b){M.Shader.projection[0]=a.projX;M.Shader.projection[1]=a.projY;gl.uniform3f(this.projection,M.Shader.projection[0],M.Shader.projection[1],M.Shader.projection[2]);gl.uniform2f(this.dxy,a.pixelX,a.pixelY);gl.bindTexture(gl.TEXTURE_2D,b);gl.drawArrays(gl.TRIANGLES,0,6)}renderImage(a,b,c,d,f,e){M.Shader.projection[0]=c;M.Shader.projection[1]=d;gl.uniform3f(this.projection,
M.Shader.projection[0],M.Shader.projection[1],M.Shader.projection[2]);gl.uniform2f(this.dxy,a,b);gl.bindTexture(gl.TEXTURE_2D,e);gl.drawArrays(gl.TRIANGLES,0,M.Shader.vbo.position.length/2)}};
M.Shader.init=function(){var a=new Float32Array(12);a[0]=0;a[1]=0;a[2]=1;a[3]=0;a[4]=1;a[5]=1;a[6]=0;a[7]=0;a[8]=1;a[9]=1;a[10]=0;a[11]=1;var b=new Float32Array(12);b[0]=0;b[1]=0;b[2]=256;b[3]=0;b[4]=256;b[5]=256;b[6]=0;b[7]=0;b[8]=256;b[9]=256;b[10]=0;b[11]=256;M.Shader.vbo={uv:new GL.ArrayBuffer(a),position:new GL.ArrayBuffer(b)};M.Shader.projection=new Float32Array([0,0,-.0078125])};
M.ColorShader=class extends M.Shader{constructor(){super(M.ColorShader.vs,M.ColorShader.fs)}compile(){super.compile();this.defineAttribute("uv",2,gl.FLOAT,!1);this.samplerMap=gl.getUniformLocation(this.glId,"samplerMap")}start(a,b){super.start(a,b);gl.disable(gl.DEPTH_TEST);gl.depthMask(!1)}end(){gl.depthMask(!0);gl.enable(gl.DEPTH_TEST);super.end()}};M.ColorShader.vs="#version 300 es\n\nprecision mediump float;\nprecision mediump int;\n\nuniform vec3 projection;\nuniform vec2 dxy;\n\nin vec2 uv;\nin vec2 position;\n\nout vec2 textureCoord;\n\nvoid main()\t\n{\n    textureCoord = uv;\n    \n    vec4 vertex = vec4((position.x - dxy.x), (position.y - dxy.y), 1.0, 1.0);\n    vertex.x *= projection.x;\n    vertex.y *= projection.y;\n    gl_Position = vertex;\n    \n}";
M.ColorShader.fs="#version 300 es\n\nprecision mediump float;\nprecision mediump int;\n\nuniform sampler2D samplerMap;\nuniform vec3 transparent; \nuniform vec2 split;\nuniform float pane;\n\nin vec2 textureCoord;\n\nout vec4 fragmentColor;\n\n\nvoid main()\t\n{\n    vec4 color = texture(samplerMap, vec2(textureCoord.s, textureCoord.t));\n    \n    if (vec3(color) == vec3(1.0))\n    {\n        discard;\n    } \n    \n    if (pane == 0.0)\n    {\n        if (gl_FragCoord.x > split.x || gl_FragCoord.y < split.y)\n        {\n            discard;\n        }\n    }\n    else\n    {\n        if (gl_FragCoord.x < split.x && gl_FragCoord.y > split.y)\n        {\n            discard;\n        }\n    }\n    \n    color.a = 1.0;\n    fragmentColor =  color;  \n}";
M.DepthShader=class extends M.Shader{constructor(){super(M.DepthShader.vs,M.DepthShader.fs);this.gradient=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,this.gradient);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0);gl.texImage2D(gl.TEXTURE_2D,
0,gl.RGB,3,1,0,gl.RGB,gl.UNSIGNED_BYTE,new Uint8Array([0,0,255,0,255,0,255,0,0]));gl.bindTexture(gl.TEXTURE_2D,null)}compile(){super.compile();this.defineAttribute("uv",2,gl.FLOAT,!1);this.split=gl.getUniformLocation(this.glId,"split");this.samplerMap=gl.getUniformLocation(this.glId,"samplerMap");this.mode=gl.getUniformLocation(this.glId,"mode");this.range=gl.getUniformLocation(this.glId,"range");this.samplerGrd=gl.getUniformLocation(this.glId,"gradient");this.light=gl.getUniformLocation(this.glId,
"light")}start(a,b,c){gl.activeTexture(gl.TEXTURE1);gl.bindTexture(gl.TEXTURE_2D,this.gradient);gl.depthFunc(gl.ALWAYS);super.start(a,b);gl.uniform1i(this.mode,c);gl.uniform1i(this.samplerGrd,1);gl.uniform2f(this.light,1,1);gl.uniform2f(this.range,V.viewer.aabb.min.z,V.viewer.aabb.max.z)}end(){super.end();gl.depthFunc(gl.LESS)}};M.DepthShader.vs="#version 300 es\n\nprecision mediump float;\nprecision mediump int;\n\nuniform mat4 projectionMatrix; \n\nuniform vec3 projection;\nuniform vec2 dxy;\n\nin vec2 uv;\nin vec2 position;\n\nout vec2 textureCoord;\n\nvoid main()\t\n{\n    textureCoord = uv;\n\n    vec4 vertex = vec4((position.x - dxy.x), (position.y - dxy.y), 1.0, 1.0);\n    vertex.x *= projection.x;\n    vertex.y *= projection.y;\n    gl_Position = vertex;\n}";
M.DepthShader.fs="#version 300 es\n\nprecision mediump float;\nprecision mediump int;\n\nuniform sampler2D samplerMap;\nuniform sampler2D gradient;\n\nuniform vec2 range;\nuniform vec2 light;\nuniform int mode;\n\nuniform vec2 split;\nuniform float pane;\n\nin vec2 textureCoord;\n\nout vec4 fragmentColor;\n\nconst int DUAL = 1;\nconst int SINGLE = 2;\n\nconst float B = 1.0/130.0;\nconst float R = 1.0 - 2.0*B;\n\n\nvoid main()\t\n{\n    vec2 coord = vec2(B + textureCoord.s*R, B + textureCoord.t*R);\n\n    vec4 value = texture (samplerMap, coord);\n    if (value.r == -10000.00)\n    {\n        discard;\n    } \n    \n    float dh = range.y - range.x;\n    float c0 = (texture(samplerMap, coord + 0.5*B*light).r-range.x)/dh;\n    float c1 = (texture(samplerMap, coord - 0.5*B*light).r-range.x)/dh;\n    float brightness = 1.0-(c0 - c1)/(4.0*B);\n    \n    float height = (value.r - range.x)/dh;\n    \n    vec4 color = texture (gradient, vec2(height, 0.5));\n    \n    if (pane == 0.0)\n    {\n        if (gl_FragCoord.x > split.x || gl_FragCoord.y < split.y)\n        {\n            if (mode == SINGLE)\n            {\n                fragmentColor =  vec4(1.0);\n            }\n            else discard;\n        }\n        else\n        {\n            fragmentColor =  vec4(color.rgb * brightness, 1.0);\n        }\n    }\n    else\n    {\n        if (gl_FragCoord.x < split.x && gl_FragCoord.y > split.y)\n        {\n            if (mode == SINGLE)\n            {\n                fragmentColor =  vec4(1.0);\n            }\n            else discard;\n        }\n        else\n        {\n            fragmentColor =  vec4(color.rgb * brightness, 1.0);\n        }\n    }\n            \n    gl_FragDepth = 1.0-height;\n}\n";
</script>
<script id="/2d/map/map.js">M.rendered=0;M.maxZoom=0;M.minZoom=19;M.NO_DEPTH=-1E4;M.splitV=0;M.splitH=1;M.DUAL=1;M.SINGLE=2;M.Node=function(a,b,c){this.z=a;this.y=c;this.x=b;this.glTextureId=[];this.loaderIMG=[];this.bufferIMG=[];this.scale=1<<a;this.min={x:256*b/this.scale,y:256*c/this.scale};this.max={x:256*(b+1)/this.scale,y:256*(c+1)/this.scale}};
M.Node.prototype.descend=function(a,b){if(this.z<=b){this.pixelX=V.camera.position.x*this.scale-256*this.x;this.pixelY=256*this.y+256-V.camera.position.y*this.scale;var c=2/(V.camera.pixelSize*this.scale);this.projX=c/gl.drawingBufferWidth;this.projY=c/gl.drawingBufferHeight;this.c00||(this.c00=new M.Node(this.z+1,2*this.x,2*this.y),this.c10=new M.Node(this.z+1,2*this.x+1,2*this.y),this.c01=new M.Node(this.z+1,2*this.x,2*this.y+1),this.c11=new M.Node(this.z+1,2*this.x+1,2*this.y+1));a.loadTile(this);
this.c00.visible=V.camera.intersectsBox(this.c00);this.c01.visible=V.camera.intersectsBox(this.c01);this.c10.visible=V.camera.intersectsBox(this.c10);this.c11.visible=V.camera.intersectsBox(this.c11);this.c00.visible?this.c00.descend(a,b):a.cancelImage(this.c00);this.c01.visible?this.c01.descend(a,b):a.cancelImage(this.c01);this.c10.visible?this.c10.descend(a,b):a.cancelImage(this.c10);this.c11.visible?this.c11.descend(a,b):a.cancelImage(this.c11)}};
M.Node.prototype.render=function(a){if(this.z<=a.zoom){var b=!0,c=!0,d=!0,e=!0;null==this.c00&&console.log("dasdasdasdadasdasd");this.c00.visible&&(b=this.c00.render(a));this.c01.visible&&(c=this.c01.render(a));this.c10.visible&&(d=this.c10.render(a));this.c11.visible&&(e=this.c11.render(a));return b&&c&&d&&e?!0:a.renderNode(this)}return!1};M.Node.prototype.contains=function(a){return!(a.x>this.max.x||a.x<this.min.x||a.y>this.max.y||a.y<this.min.y)};
M.Node.prototype.sample=function(a,b){if(this.z<a.zoom){var c=M.NO_DEPTH;this.c00&&(this.c00.contains(b)?c=this.c00.sample(a,b):this.c01.contains(b)?c=this.c01.sample(a,b):this.c10.contains(b)?c=this.c10.sample(a,b):this.c11.contains(b)&&(c=this.c11.sample(a,b)));return c==M.NO_DEPTH?a.sampleNode(this,b):c}return a.sampleNode(this,b)};M.Node.prototype.clear=function(a){a.clearNode(this);this.c00&&(this.c00.clear(a),this.c10.clear(a),this.c01.clear(a),this.c11.clear(a))};M.Loader=function(){};
M.PngLoader=function(){M.Loader.call(this);this.max=32};M.PngLoader.prototype=Object.create(M.Loader.prototype);M.PngLoader.prototype.constructor=V.PngLoader;M.PngLoader.BLANK_TILE=0;M.PngLoader.init=function(){var a=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,a);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGB,1,1,0,gl.RGB,gl.UNSIGNED_BYTE,new Uint8Array([255,255,255]));gl.generateMipmap(gl.TEXTURE_2D);gl.bindTexture(gl.TEXTURE_2D,null);M.PngLoader.BLANK_TILE=a};
M.PngLoader.prototype.imageLoaded=function(a){a=a.srcElement;this.max++;V.stopLoading();var b=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,b);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,
a);gl.bindTexture(gl.TEXTURE_2D,null);V.memoryUsed+=196608;a.layer.loadNode(a.node,b);a.node=null;URL.revokeObjectURL(a.src);V.touch3d()};M.PngLoader.prototype.imageError=function(a){a=a.srcElement;var b=a.node;this.max++;V.stopLoading();b&&(a.layer.loadNode(a.node,M.PngLoader.BLANK_TILE),a.node=null,a.layer=null,URL.revokeObjectURL(a.src),V.touch3d())};
M.PngLoader.prototype.scheduleImage=function(a,b,c){if(0<this.max){this.max--;V.startLoading();var d=new Image;d.onload=this.imageLoaded.bind(this);d.onerror=this.imageError.bind(this);d.crossOrigin="Anonymous";d.layer=a;d.node=b;d.src=c;return d}return null};M.PngLoader.prototype.cancelImage=function(a){URL.revokeObjectURL(a.src);a.node=null;a.layer=null;a.src=""};M.PngLoader.prototype.deleteImage=function(a){a!=M.PngLoader.BLANK_TILE&&gl.deleteTexture(a)};
M.BinLoader=function(){M.Loader.call(this);this.loadingCount=0};M.BinLoader.prototype=Object.create(M.Loader.prototype);M.BinLoader.prototype.constructor=V.BinLoader;M.BinLoader.BLANK_TILE=0;
M.BinLoader.init=function(){var a=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,a);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0);gl.texImage2D(gl.TEXTURE_2D,0,gl.R32F,1,1,0,gl.RED,gl.FLOAT,new Float32Array([M.NO_DEPTH]));gl.bindTexture(gl.TEXTURE_2D,
null);M.BinLoader.BLANK_TILE=a};
M.BinLoader.prototype.imageLoaded=function(a,b,c){V.stopLoading();if(null!=b){if(c){var d=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,d);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0);gl.texImage2D(gl.TEXTURE_2D,0,gl.R32F,260,260,0,gl.RED,
gl.FLOAT,c);gl.bindTexture(gl.TEXTURE_2D,null);V.memoryUsed+=196608;a.loadNode(b,d,c)}else a.loadNode(b,M.BinLoader.BLANK_TILE);V.touch3d()}this.loadingCount--};
M.BinLoader.prototype.scheduleImage=function(a,b,c){if(5>this.loadingCount){var d=new XMLHttpRequest;d.open("GET",c,!0);d.responseType="arraybuffer";d.onerror=()=>{this.imageLoaded(a,b,null)};d.onload=()=>{200===d.status||0===d.status?this.imageLoaded(a,b,new Float32Array(d.response)):(401===d.status&&a.refreshToken(),this.imageLoaded(a,b,null))};try{this.loadingCount++,d.send(null)}catch(e){this.imageLoaded(a,b,null)}return d}};M.BinLoader.prototype.cancelImage=function(a){this.loadingCount--;a.abort()};
M.BinLoader.prototype.deleteImage=function(a){a!=M.BinLoader.BLANK_TILE&&gl.deleteTexture(a)};
M.Layer=class{constructor(a,b,c,d,e){this.index=c;this.url=a;this.loader=b;this.shader=d;this.map=e;this.renderQ=new V.PriorityQueue(function(f,g){return f.z-g.z});this.loadingQ=new V.PriorityQueue(function(f,g){return f.z-g.z})}refreshToken(){this.map.refreshToken()}renderNode(a){if(a.min.x>this.mapX1||a.max.x<this.mapX0||a.min.y>this.mapY1||a.max.y<this.mapY0)return!0;a.glTextureId[this.index]&&this.renderQ.enqueue(a);return a.glTextureId[this.index]}sample(a,b){return a.sample(this,b)}sampleNode(a,
b){return a.bufferIMG[this.index]?a.bufferIMG[this.index][260*(Math.floor((b.y-a.min.y)*a.scale)+2)+(Math.floor((b.x-a.min.x)*a.scale)+2)]:M.NO_DEPTH}loadNode(a,b,c){a.glTextureId[this.index]=b;a.bufferIMG[this.index]=c;a.loaderIMG[this.index]=null;a.loadedAt=V.time}schedule(){for(this.zoom=Math.max(V.camera.zoom,this.minZoom);!this.loadingQ.empty();){var a=this.loadingQ.dequeue();a.loaderIMG[this.index]=this.loader.scheduleImage(this,a,this.tileAddress(a))}}loadTile(a){a.min.x>this.mapX1||a.max.x<
this.mapX0||a.min.y>this.mapY1||a.max.y<this.mapY0||a.z<=this.maxZoom&&a.z>=this.minZoom&&(a.glTextureId[this.index]||a.loaderIMG[this.index]||this.loadingQ.enqueue(a))}cancelImage(a){a.loaderIMG[this.index]&&(this.loader.cancelImage(a.loaderIMG[this.index]),a.loaderIMG[this.index]=null)}clear(a){a.clear(this)}clearNode(a){a.bufferIMG[this.index]&&delete a.bufferIMG[this.index];a.glTextureId[this.index]&&(this.loader.deleteImage(a.glTextureId[this.index]),delete a.glTextureId[this.index])}};
M.ColorLayer=class extends M.Layer{constructor(a,b,c,d){super(a.replace("PATH","color").replace("TYPE","png"),M.PngLoader.instance,c,M.ColorShader.instance,d);this.mapX0=b.x0;this.mapX1=b.x1;this.mapY0=b.y0;this.mapY1=b.y1;this.maxZoom=b.maxZoom;this.minZoom=b.minZoom}render(a,b){a.render(this);for(this.shader.start(b,M.Shader.vbo);!this.renderQ.empty();)a=this.renderQ.dequeue(),this.shader.renderNode(a,a.glTextureId[this.index]);this.shader.end()}refreshToken(){this.map.refreshToken().then(a=>{this.url=
a.replace("PATH","color").replace("TYPE","png")})}tileAddress(a){return this.url.replace("FILE",a.z+"/"+a.x+"/"+a.y)}};
M.DepthLayer=class extends M.Layer{constructor(a,b,c,d){super(a.replace("PATH","elevation").replace("TYPE","bin"),M.BinLoader.instance,c,M.DepthShader.instance,d);this.mapX0=b.x0;this.mapX1=b.x1;this.mapY0=b.y0;this.mapY1=b.y1;this.maxZoom=b.maxZoom;this.minZoom=b.minZoom}render(a,b,c){a.render(this);c==M.DUAL&&gl.colorMask(!1,!1,!1,!1);for(this.shader.start(b,M.Shader.vbo,c);!this.renderQ.empty();)a=this.renderQ.dequeue(),this.shader.renderNode(a,a.glTextureId[this.index]);c==M.DUAL&&gl.colorMask(!0,
!0,!0,!0);this.shader.end()}refreshToken(){this.map.refreshToken().then(a=>{this.url=a.replace("PATH","elevation").replace("TYPE","bin")})}tileAddress(a){return this.url.replace("FILE",a.z+"/"+a.x+"/"+a.y)}};
M.Map=class extends V.Dataset{constructor(a,b){super(a);this.maxZoom=this.minZoom=0;this.pane=b;GL.BoundingBox.init(this);this.tree=new M.Node(0,0,0);this.layers=[]}addLayer(a){this.layers.push(a);this.minZoom=Math.max(a.minZoom,this.minZoom);this.maxZoom=Math.max(a.maxZoom,this.maxZoom);GL.BoundingBox.grow(this,{x:a.mapX0,y:a.mapY0,z:0});GL.BoundingBox.grow(this,{x:a.mapX1,y:a.mapY1,z:0});M.minZoom=Math.min(this.minZoom,M.minZoom);M.maxZoom=Math.max(this.maxZoom,M.maxZoom);return a}unload(){this.layers.forEach(a=>
{a.clear(this.tree)})}update(){this.tree.descend(this,Math.max(V.camera.zoom,this.minZoom));this.layers.forEach(a=>{a.schedule()})}loadTile(a){this.layers.forEach(b=>{b.loadTile(a)})}cancelImage(a){this.layers.forEach(b=>{b.cancelImage(a)})}getViewpoint(){return{}}setViewpoint(a){}};
M.DemMap=class extends M.Map{constructor(a,b,c){super(a,c);this.root.color&&(this.colorLayer=this.addLayer(new M.ColorLayer(this.url,this.root.color,0,this)));this.root.elevation&&(this.depthLayer=this.addLayer(new M.DepthLayer(this.url,this.root.elevation,1,this)),this.min.z=this.root.elevation.min,this.max.z=this.root.elevation.max);b(this.config)}render(a){this.depthLayer&&this.depthLayer.render(this.tree,a==M.SINGLE?1:this.pane,a);this.colorLayer&&this.colorLayer.render(this.tree,this.pane)}raycast(a,
b){let c=Number.POSITIVE_INFINITY;if(this.depthLayer){var d=this.depthLayer.sample(this.tree,a.origin);d!=M.NO_DEPTH&&(d-=a.origin.z,-1==a.direction.z?c=-d:1==a.direction.z&&(c=d))}b.distance=Math.min(b.distance,c);b.hits&&b.hits.push({id:this.id,distance:c});b.xyz&&(b.xyz={x:a.origin.x,y:a.origin.y,z:c})}};
M.OsmLayer=class extends M.Layer{constructor(a,b,c,d){super(a,M.PngLoader.instance,c,M.ColorShader.instance,d);this.mapX0=0;this.mapX1=256;this.mapY0=0;this.mapY1=256;this.maxZoom=b;this.minZoom=2}refreshToken(){}render(a,b){a.render(this);for(this.shader.start(b,M.Shader.vbo);!this.renderQ.empty();)a=this.renderQ.dequeue(),this.shader.renderNode(a,a.glTextureId[this.index]);this.shader.end()}tileAddress(a){return this.url.replace("{x}",a.x).replace("{y}",a.y).replace("{z}",a.z)}};
M.Wmts=class extends M.Map{constructor(a,b,c){super(a,c);this.layer=this.addLayer(new M.OsmLayer(this.url,a.maxZoom,0,this));b(this.config)}render(a){this.layer.render(this.tree,this.pane)}raycast(a,b){b.distance=0;b.hits&&b.hits.push({id:this.id,distance:0});b.xyz&&(b.xyz={x:a.origin.x,y:a.origin.y,z:0})}};
</script>
<script id="/2d/map/image.js">M.Image=class extends V.Dataset{constructor(a,d,f){super(a);let e=new Image;e.onload=()=>{this.textureId=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,this.textureId);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0);gl.texImage2D(gl.TEXTURE_2D,
0,gl.RGBA8,gl.RGBA,gl.UNSIGNED_BYTE,e);gl.generateMipmap(gl.TEXTURE_2D);gl.bindTexture(gl.TEXTURE_2D,null);URL.revokeObjectURL(e.src);d(this.config);V.touch3d()};let c=new Float32Array(12);c[0]=0;c[1]=0;c[2]=1;c[3]=0;c[4]=1;c[5]=1;c[6]=0;c[7]=0;c[8]=1;c[9]=1;c[10]=0;c[11]=1;let b=new Float32Array(12);b[0]=a.x0;b[1]=a.y0;b[2]=256-a.x0;b[3]=a.y0;b[4]=256-a.x0;b[5]=256-a.y0;b[6]=a.x0;b[7]=a.y0;b[8]=256-a.x0;b[9]=256-a.y0;b[10]=a.x0;b[11]=256-a.y0;this.vbo={uv:new GL.ArrayBuffer(c),position:new GL.ArrayBuffer(b)};
GL.BoundingBox.set(this,[b[0],b[1],0],[b[4],b[5],0]);M.minZoom=Math.min(0,M.minZoom);M.maxZoom=Math.max(Math.ceil(Math.log(Math.max(a.x1-a.x0,a.y1-a.y0))),M.maxZoom);e.crossOrigin="Anonymous";e.src=this.url;this.pane=f}update(){}render(a){if(this.textureId){var d=2/V.camera.pixelSize;a=d/gl.drawingBufferWidth;d/=gl.drawingBufferHeight;M.ColorShader.instance.start(this.pane,this.vbo);M.ColorShader.instance.renderImage(V.camera.position.x,256-V.camera.position.y,a,d,this.vbo,this.textureId);M.ColorShader.instance.end()}}unload(){gl.deleteTexture(this.textureId);
delete this.textureId}raycast(a,d){d.distance=0;d.hits&&d.hits.push({id:this.id,distance:0});d.xyz&&(d.xyz={x:a.origin.x,y:a.origin.y,z:0})}getViewpoint(){return{}}setViewpoint(a){}};
</script>
<script id="/2d/index.js">var V2={MOSAIC:"map",WMTS:"wmts",IMAGE:"image"};
V2.Viewer=class extends V.Viewer{constructor(){super({alpha:!1,depth:!0,stencil:!1,antialias:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1});V.camera=new V2.Camera(this.canvas);V.camera.moving=!0;this.splitter=new V2.Splitter(this.canvas);this.splitter.attach();this.controller=new V2.Controller;this.controller.attach();M.Shader.init();M.ColorShader.instance=new M.ColorShader;M.ColorShader.instance.compile();M.DepthShader.instance=new M.DepthShader;M.DepthShader.instance.compile();M.PngLoader.init();
M.PngLoader.instance=new M.PngLoader(32);M.BinLoader.init();M.BinLoader.instance=new M.BinLoader;V2.MeshShader.instance=new V2.MeshShader;V2.MeshShader.instance.compile();V.recvMessage("import.create",(a,b)=>{let c=b.id||a.id,d=b.pane||0;if(this.datasets[c])V.postMessage("error","duplicate document id "+c);else{let e;a.type==V2.MOSAIC?e=new M.DemMap(a,V.importCb.bind(b),d):a.type==V2.WMTS?e=new M.Wmts(a,V.importCb.bind(b),d):a.type==V2.IMAGE&&(e=new M.Image(a,V.importCb.bind(b),d));super.load(c,e);
V.touch3d();V.touch2d()}});V.recvMessage("*.get",(a,b)=>{V.postMessage("*.get",a,b)});V.recvMessage("viewpoint.get",a=>{a.camera=V.camera.toJson();for(var b in this.datasets)a[b]=this.datasets[b].getViewpoint();V.postMessage("viewpoint.get",a)});V.to1DUnitString=a=>{a*=39062.5;switch(V.units){case V.METRIC:return O.numberFormat.format(a.toFixed(2))+" m";case V.IMPERIAL:a*=39.3701;var b=Math.floor(a/12);a=Math.round(a-12*b);return O.numberFormat.format(b)+"' "+a+'"'}};V.to2DUnitString=a=>{a*=1.52587890625E9;
switch(V.units){case V.METRIC:return O.numberFormat.format(a.toFixed(2))+" m\u00b2";case V.IMPERIAL:return O.numberFormat.format((10.7639*a).toFixed(2))+" ft\u00b2"}};V.to3DUnitString=a=>{a*=5.9604644775390625E13;switch(V.units){case V.METRIC:return O.numberFormat.format(a.toFixed(2))+" m\u00b3";case V.IMPERIAL:return O.numberFormat.format((35.3147*a).toFixed(2))+" ft\u00b3"}};this.animate()}view(a){let b=GL.BoundingBox.center(a);b.z=this.aabb.max.z;let c=a.max.x-a.min.x;a=a.max.y-a.min.y;V.camera.set(b,
Math.ceil(Math.log2(256/Math.sqrt(c*c+a*a)))+1)}load(a,b){super.load(a,b);a=GL.BoundingBox.center(this.aabb);a.z=this.aabb.max.z;b=this.aabb.max.x-this.aabb.min.x;let c=this.aabb.max.y-this.aabb.min.y;V.camera.set(a,Math.ceil(Math.log2(256/Math.sqrt(b*b+c*c)))+1)}getDistanceAlpha(a,b,c){a=V.camera.distanceTo(a);return a>c?0:a<=b?1:GM.clamp(1-(a-b)/(c-b),0,1)}render(){V.camera.updateMatrix();for(var a in this.datasets){let b=this.datasets[a];b.visible&&(b.update(),2==Object.keys(this.datasets).length?
b.render(M.DUAL):b.render(M.SINGLE))}gl.bindTexture(gl.TEXTURE_2D,null)}getConstraint(){return C.create(["Plane",{x:0,y:0,z:1,w:this.aabb.max.z}])}};
V2.Splitter=class extends V.EventHandler{constructor(a){super(V.EventHandler.PRIO0);this.canvas=a;this.mouseMove=b=>{this.set(Math.max(Math.min(b.clientX/this.canvas.offsetWidth,1),0),Math.max(Math.min(b.clientY/this.canvas.offsetHeight,1),0),!0);V.postMessage("splitter.update",{visible:!this.handle.hidden,splitV:this.splitV,splitH:this.splitH});V.touch3d();b.stopPropagation();b.preventDefault()};this.touchMove=b=>{this.set(Math.max(Math.min(b.targetTouches[0].clientX/this.canvas.offsetWidth,1),0),
Math.max(Math.min(b.targetTouches[0].clientY/this.canvas.offsetHeight,1),0),!0);V.postMessage("splitter.update",{visible:!this.handle.hidden,splitV:this.splitV,splitH:this.splitH});V.touch3d();b.stopPropagation();b.preventDefault()};this.moveEnd=b=>{document.removeEventListener("mousemove",this.mouseMove,!1);document.removeEventListener("touchmove",this.touchMove,!1);document.removeEventListener("mouseup",this.moveEnd,!1);document.removeEventListener("touchend",this.moveEnd,!1);b.stopPropagation();
b.preventDefault();if(b=O.getSelected())b.visible=!0;V.touch3d()};this.moveStart=b=>{if(b=O.getSelected())b.visible=!1;V.touch3d();document.addEventListener("mousemove",this.mouseMove,!1);document.addEventListener("touchmove",this.touchMove,!1);document.addEventListener("mouseup",this.moveEnd,!1);document.addEventListener("touchend",this.moveEnd,!1)};this.splitterV=document.getElementById("splitterV");this.splitterH=document.getElementById("splitterH");this.handle=document.getElementById("splitterX");
this.handle.addEventListener("mousedown",this.moveStart,!1);this.handle.addEventListener("touchstart",this.moveStart,!1);window.addEventListener("resize",()=>{this.set(this.splitV,this.splitH)});this.listener=[];V.recvMessage("splitter",b=>{let c=this.splitV;b.hasOwnProperty("u")?c=b.u:b.hasOwnProperty("splitV")&&(c=b.splitV);let d=this.splitH;b.hasOwnProperty("v")?d=b.v:b.hasOwnProperty("splitH")&&(d=b.splitH);b.hasOwnProperty("visible")&&this.show(b.visible);this.set(c,d);V.postMessage("splitter",
{visible:!this.handle.hidden,splitV:this.splitV,splitH:this.splitH});V.touch3d()});V.recvMessage("viewpoint",b=>{this.set(b.splitter.splitV,b.splitter.splitH);this.show(b.splitter.visible)});V.recvMessage("viewpoint.get",b=>{b.splitter={splitV:this.splitV,splitH:this.splitH,visible:!this.handle.hidden}});this.set(.9,.9)}show(a){this.splitterV.hidden=!a;this.splitterH.hidden=!a;this.handle.hidden=!a}set(a,b){this.splitV=a;this.splitH=b;this.handle.style.left=Math.max(19,this.splitV*this.canvas.offsetWidth)+
"px";this.handle.style.top=Math.max(80,this.splitH*this.canvas.offsetHeight)+"px";this.splitterV.style.left=this.splitV*this.canvas.offsetWidth+"px";this.splitterV.style.bottom=(1-this.splitH)*this.canvas.offsetHeight+"px";this.splitterH.style.right=(1-this.splitV)*this.canvas.offsetWidth+"px";this.splitterH.style.top=this.splitH*this.canvas.offsetHeight+"px";M.splitV=a;M.splitH=b}addListener(a){this.listener.push(a)}removeListener(a){for(var b=0;b<a.length;b++)if(a[b].owner===a){a.splice(b,1);break}}};
V2.Camera=class extends GM.Camera{constructor(a){super(a);this.point=new GM.Vector3(0,0,0);this.min={x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY};this.max={x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY};this.zoom=this.zoomTransition=0;V.recvMessage("camera.set",b=>{let c=b.position||GL.BoundingBox.center(V.viewer.aabb);c.hasOwnProperty("z")||(c.z=0);b=b.hasOwnProperty("zoom")?b.zoom:Math.ceil(Math.log(Math.max(gl.drawingBufferWidth/(V.viewer.aabb.max.x-V.viewer.aabb.min.x),gl.drawingBufferHeight/
(V.viewer.aabb.max.y-V.viewer.aabb.min.y))));this.set(c,b);V.postMessage("camera",{position:c,zoom:b})})}set(a,b){super.set();GM.Vector3.copy(a,this.position);this.zoom=b;this.zoomTransition=0;this.updateMatrix();V.touch2d();V.touch3d()}toJson(){return{position:this.position.toJson(),zoom:this.zoom}}updateMatrix(){this.pixelSize=1/Math.pow(2,V.camera.zoom+V.camera.zoomTransition);var a=gl.drawingBufferWidth*this.pixelSize,b=gl.drawingBufferHeight*this.pixelSize;this.min.x=this.position.x-.5*a;this.min.y=
this.position.y-.5*b;this.max.x=this.position.x+.5*a;this.max.y=this.position.y+.5*b}getRay(a,b){b||(b=this.ray);a=this.screenToCamera(a);var c=.5*a.y*gl.drawingBufferHeight;b.origin.x=this.position.x+.5*a.x*gl.drawingBufferWidth*this.pixelSize;b.origin.y=this.position.y-c*this.pixelSize;b.origin.z=this.position.z;b.direction.x=0;b.direction.y=0;b.direction.z=-1;return b}project(a){this.point.x=(a.x-this.position.x)/(gl.drawingBufferWidth*this.pixelSize)+.5;this.point.y=.5-(this.position.y-a.y)/(gl.drawingBufferHeight*
this.pixelSize);return this.point}unproject(a){this.point.x=(a.x-this.position.x)/(gl.drawingBufferWidth*this.pixelSize)+.5;this.point.y=.5-(this.position.y-a.y)/(gl.drawingBufferHeight*this.pixelSize);return this.point}intersectsBox(a){return this.min.x>a.max.x||this.max.x<a.min.x||this.min.y>a.max.y||this.max.y<a.min.y?!1:!0}focus(a,b){this.position.x=a;this.position.y=b;this.moving=!0}distanceTo(a){return M.maxZoom-(this.zoom+V.camera.zoomTransition)}};
V2.Controller=class extends V.CameraController{constructor(){super(V.EventHandler.PRIO1,V.EventHandler.PRIO1,V.camera,1);V.recvMessage("controller.view",a=>{var b=a.aabb;b||(b=V.viewer.aabb);a=GL.BoundingBox.center(b);a.z=b.max.z||this.camera.position.z;let c=b.max.x-b.min.x;b=b.max.y-b.min.y;this.tweenPosition(a);this.camera.zoom=Math.ceil(Math.log2(256/Math.sqrt(c*c+b*b)))+1;this.camera.zoomTransition=0;this.tweenStart(this.zoomFn)});V.recvMessage("controller.target",a=>{this.startD=V.time;this.drag=
0;this.camera.zoomTransition=-1;this.camera.zoom++;this.updateFn=this.zoomFn});V.recvMessage("viewpoint",a=>{this.tweenPosition(a.camera.position);this.camera.zoom=a.camera.zoom;this.tweenStart(null)})}panFn(a){a=.5*(this.currPos.y-this.startPos.y)*gl.drawingBufferHeight;var b=1<<V.camera.zoom;this.camera.position.x=this.sx-.5*(this.currPos.x-this.startPos.x)*gl.drawingBufferWidth/b;this.camera.position.y=this.sy+a/b}zoomFn(a){a=1/Math.pow(2,this.camera.zoom+this.camera.zoomTransition);0<V.camera.zoomTransition?
this.camera.zoomTransition=Math.max(0,this.camera.zoomTransition-Easing.Linear((V.time-this.startD)/1800)):0>V.camera.zoomTransition&&(this.camera.zoomTransition=Math.min(0,this.camera.zoomTransition+Easing.Linear((V.time-this.startD)/1800)));var b=1/Math.pow(2,this.camera.zoom+this.camera.zoomTransition);this.camera.position.x-=.5*this.currPos.x*gl.drawingBufferWidth*(b-a);this.camera.position.y+=.5*this.currPos.y*gl.drawingBufferHeight*(b-a);0==V.camera.zoomTransition&&(this.updateFn=null)}onMouseDown(a){super.onMouseDown(a);
0==a.button&&(this.sx=this.camera.position.x,this.sy=this.camera.position.y,this.updateFn=this.panFn)}onDblClick(a){!super.onDblClick(a)&&V.camera.zoom<M.maxZoom&&(a=this.cast3d,a.distance!=Number.POSITIVE_INFINITY&&V.postMessage(V.viewer.datasets[a.id].type+".dblclick",a))}onMouseWheel(a){super.onMouseWheel(a);0==V.camera.zoomTransition&&(0>this.getWheelDelta(a)?V.camera.zoom<M.maxZoom&&(this.startD=V.time,this.camera.zoomTransition=-1,this.camera.zoom++):(this.startD=V.time,this.camera.zoomTransition=
1,this.camera.zoom--));this.updateFn=this.zoomFn;a.stopImmediatePropagation()}onTouchStart(a){super.onTouchStart(a);this.sx=this.camera.position.x;this.sy=this.camera.position.y;this.updateFn=this.panFn}};
</script>
<script id="/2d/overlay/polygon.js">V2.MeshShader=function(){GL.Shader.call(this,V2.MeshShader.vs,V2.MeshShader.fs)};V2.MeshShader.prototype=Object.create(GL.Shader.prototype);V2.MeshShader.prototype.constructor=V2.MeshShader;
V2.MeshShader.prototype.compile=function(){GL.Shader.prototype.compile.call(this);this.defineAttribute("position",2,gl.FLOAT,!1);this.defineAttribute("uv",2,gl.FLOAT,!1);this.alpha=gl.getUniformLocation(this.glId,"alpha");this.depth=gl.getUniformLocation(this.glId,"depth");this.dxy=gl.getUniformLocation(this.glId,"dxy");this.projection=gl.getUniformLocation(this.glId,"projection");this.samplerMap=gl.getUniformLocation(this.glId,"samplerMap");gl.useProgram(this.glId);gl.uniform1i(this.samplerMap,0);
gl.useProgram(null)};
V2.MeshShader.prototype.render3D=function(a,b,c){gl.useProgram(this.glId);this.enableBuffer();this.bindBuffer(a);M.Shader.projection[0]=2/gl.drawingBufferWidth;M.Shader.projection[1]=2/gl.drawingBufferHeight;gl.uniform3f(this.projection,M.Shader.projection[0],M.Shader.projection[1],M.Shader.projection[2]);gl.uniform2f(this.dxy,V.camera.position.x,V.camera.position.y);let d=V.viewer.aabb.min.z,e=V.viewer.aabb.max.z;0==e-d?gl.uniform1f(this.depth,1):gl.uniform1f(this.depth,(b-d)/(e-d));gl.uniform1f(this.alpha,
c);gl.disable(gl.CULL_FACE);gl.enable(gl.BLEND);gl.drawArrays(gl.TRIANGLES,0,a.position.length/2);gl.disable(gl.BLEND);gl.enable(gl.CULL_FACE)};V2.MeshShader.vs="#version 300 es\n\nprecision mediump float;\nprecision mediump int;\n\nuniform vec3 projection;\nuniform vec2 dxy;\n\nin vec2 uv;\nin vec2 position;\n\nout vec2 textureCoord;\n\nvoid main()\t\n{\n    //vec4 vertex = vec4((position.x - dxy.x), (dxy.y - position.y), 1.0, 1.0);\n    textureCoord = uv;\n    \n    vec4 vertex = vec4(position.x, position.y, 0, 1.0);\n    vertex.x *= projection.x;\n    vertex.y *= projection.y;\n    gl_Position = vertex;\n}\n";
V2.MeshShader.fs="#version 300 es\n\nprecision mediump float;\nprecision mediump int;\n\nuniform sampler2D samplerMap;\nuniform float alpha; \nuniform float depth; \n\nin vec2 textureCoord;\n\nout vec4 fragmentColor;\n\nconst float UNDEF = 128.0/255.0;\nconst float EDIT = 127.0/255.0;\n\nconst float MIN_BELOW = 0.0/255.0;\nconst float MAX_BELOW = 126.0/255.0;\nconst float MIN_ABOVE = 129.0/255.0;\nconst float MAX_ABOVE = 255.0/255.0;\n\n\nvoid main()\t\n{\n    gl_FragDepth = 1.0-depth;\n\n    vec4 color = texture(samplerMap, vec2(textureCoord.s, textureCoord.t));\n\n    if (color.r >= MIN_ABOVE)\n    {\n        // above\n        fragmentColor = vec4(0,0.2+0.8*(color.r-MIN_ABOVE)/MAX_ABOVE,0,alpha);\n    }\n    else if (color.r <= MAX_BELOW)\n    {\n        // below\n        fragmentColor = vec4(0.2+0.8*color.r/MAX_BELOW,0,0,alpha);\n    }\n    else if (color.r == UNDEF)\n    {\n        fragmentColor = vec4(0.95,0.95,0.95,alpha);\n    } \n    else if (color.r == EDIT)\n    {\n        fragmentColor = vec4(0.95,0.95,0.0,alpha);\n    }\n    \n    else\n    {\n        fragmentColor = vec4(1.0,1.0,1.0,alpha);\n    }\n    \n}\n";
V2.Polygon=class extends O.Polygon{constructor(a,b){super(a,b);a.H||(a.H=this.aabb.center);this.geometry.height=a.height;this.controlUV=new V2.Polygon.UV(this);this.controlH=new V2.Polygon.H(this,a);this.vbo={position:new GL.ArrayBuffer(1),uv:new GL.ArrayBuffer(1)};this.buffer={position:new Float32Array(2*this.geometry.triangles.length),uv:new Float32Array(2*this.geometry.triangles.length)};this.updateUV();this.glTextureId=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,this.glTextureId);gl.texParameteri(gl.TEXTURE_2D,
gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);this.initTexture(V2.Polygon.UNDEF)}toJson(a){let b={};if(void 0==a||a.includes("h"))b.H=this.controlH.location;return Object.assign(super.toJson(a),b)}update(a){"undefined"!==typeof a.mode&&a.mode[O.VOLUME]!=this.mode[O.VOLUME]&&this.intiTexture(V2.Polygon.UNDEF);super.update(a)}intersectRay3D(a){a=
GM.Ray.intersectPlane(a.ray,this.geometry.plane,{});return this.geometry.containsPoint(a)?V.camera.distanceTo(a):Number.POSITIVE_INFINITY}unselect(){this.geometry.endScan()||this.stopScan();super.unselect();this.initTexture(V2.Polygon.UNDEF)}addControls(){this.addObject(this.controlUV);this.addObject(this.controlH)}removeControls(){this.removeObject(this.controlUV);this.removeObject(this.controlH)}updateMesh(){for(var a=this.buffer.position,b=this.geometry,c=0;c<b.triangles.length;c++){var d=b.points[b.triangles[c]],
e=b.center.y+d.u*b.u.y+d.v*b.v.y;a[2*c]=(b.center.x+d.u*b.u.x+d.v*b.v.x-V.camera.position.x)/V.camera.pixelSize;a[2*c+1]=(V.camera.position.y-e)/V.camera.pixelSize}this.vbo.position.set(a)}updateUV(){for(var a=this.buffer.uv,b=this.geometry,c=0;c<b.triangles.length;c++){var d=b.points[b.triangles[c]];a[2*c]=(d.u-b.umin)/b.du;a[2*c+1]=(d.v-b.vmin)/b.dv}this.vbo.uv.set(a)}initTexture(a){this.texture=this.loadTexture(new Uint8Array([a]),1,1)}startControl(a){this.geometry.endScan()?this.initTexture(V2.Polygon.UNDEF):
this.stopScan()}moveControl(){super.moveControl();this.updateUV();this.controlUV.update();V.touch2d();V.touch3d()}endControl(){super.endControl();this.buffer.position.length!=2*this.geometry.triangles.length&&(this.buffer.position=new Float32Array(2*this.geometry.triangles.length),this.buffer.uv=new Float32Array(2*this.geometry.triangles.length),this.updateUV())}render3D(a){super.render3D(a);this.updateMesh();gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,this.glTextureId);1<this.texture.length&&
gl.disable(gl.DEPTH_TEST);V2.MeshShader.instance.render3D(this.vbo,this.anchors[0].wz,.6*this.scale);1<this.texture.length&&gl.enable(gl.DEPTH_TEST)}loadTexture(a,b,c){gl.bindTexture(gl.TEXTURE_2D,this.glTextureId);gl.pixelStorei(gl.UNPACK_ALIGNMENT,1);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!1);gl.texImage2D(gl.TEXTURE_2D,0,gl.R8,b,c,0,gl.RED,gl.UNSIGNED_BYTE,a);gl.bindTexture(gl.TEXTURE_2D,null);return a}startScan(){var a=super.startScan(V.camera.pixelSize,{x:0,y:0,z:-1});this.texture=new Uint8Array(a.du*
a.dv);this.texture.fill(V2.Polygon.UNDEF,0,this.texture.length);this.loadTexture(this.texture,a.du,a.dv);this.samples={};Object.keys(V.viewer.datasets).forEach(b=>this.samples[b]=[]);V.postMessage("polygon.scan.start",{id:this.id,samples:this.samples})}stopScan(){this.geometry.endScan()||(super.stopScan(),this.geometry.vPos=this.geometry.vEnd,this.texture=this.loadTexture(new Uint8Array([V2.Polygon.UNDEF]),1,1),this.samples={},Object.keys(V.viewer.datasets).forEach(a=>this.samples[a]=[]),V.postMessage("polygon.scan.stop",
{id:this.id}))}startLine(a){this.samples={};Object.keys(V.viewer.datasets).forEach(b=>this.samples[b]=[])}sample(a,b,c,d){let e=V.viewer.aabb.max.z,h=a.origin.z;a.origin.z=e;var f=V.viewer.raycast(a,{hits:[],distance:Number.POSITIVE_INFINITY}).hits;a.origin.z=h;f.forEach(g=>{g.distance=e-h-g.distance;this.samples[g.id].push(g.distance)});a=0;a=1<f.length?f[0].distance-f[1].distance:f[0].distance;this.texture[Math.floor(d/b)*Math.ceil(this.geometry.du/b)+Math.floor(c/b)]=a==Number.POSITIVE_INFINITY?
V2.Polygon.UNDEF:0<a?V2.Polygon.MAX_ABOVE:V2.Polygon.MAX_BELOW}endLine(a){this.loadTexture(this.texture,a.du,a.dv);V.postMessage("polygon.scan.sample",{id:this.id,resolution:a.resolution,samples:this.samples});V.touch3d()}};V2.Polygon.UNDEF=128;V2.Polygon.EDIT=127;V2.Polygon.MIN_BELOW=0;V2.Polygon.MAX_BELOW=126;V2.Polygon.MIN_ABOVE=129;V2.Polygon.MAX_ABOVE=255;V2.Polygon.H_RANGE=126;
V2.Polygon.UV=class extends O.Object{constructor(a){super(a.id+"uv");this.container=a;this.geometry=a.geometry;this.anchor=this.addAnchor(new O.Anchor);this.anchor0=this.addAnchor(new O.Anchor);this.anchor1=this.addAnchor(new O.Anchor);this.anchor2=this.addAnchor(new O.Anchor);this.anchor3=this.addAnchor(new O.Anchor);this.style=new O.Style.Line([3,3],C.Plane.PASSIVE,O.Segment.NONE);this.line=this.addComponent(new O.Segment(this.anchor0,this.anchor1,null,this.style));this.line=this.addComponent(new O.Segment(this.anchor2,
this.anchor3,null,this.style))}attach(){super.attach();this.update();this.controlPoint=this.addControl(new O.ControlPoint(this.anchor,new C.Plane(this.geometry.plane)))}startControl(a){this.style.fillStyle=C.Plane.ACTIVE;this.style.lineWidth=3;this.container.startControl()}endControl(a){this.style.fillStyle=C.Plane.PASSIVE;this.style.lineWidth=1;this.container.endControl()}moveControl(a){a=this.anchor.wx-this.center.x;var b=this.anchor.wy-this.center.y;this.container.translate(a,b,0);this.anchor0.translate3D(a,
b,0);this.anchor1.translate3D(a,b,0);this.anchor2.translate3D(a,b,0);this.anchor3.translate3D(a,b,0);this.center.x=this.anchor.wx;this.center.y=this.anchor.wy;this.container.moveControl()}update(){this.center=this.geometry.center;this.anchor.set3D(this.center);var a=.25*this.geometry.radius,b=this.geometry.u,c=this.geometry.v;this.anchor0.set3D({x:this.center.x+a*b.x,y:this.center.y+a*b.y,z:this.center.z+a*b.z});this.anchor1.set3D({x:this.center.x-a*b.x,y:this.center.y-a*b.y,z:this.center.z-a*b.z});
this.anchor2.set3D({x:this.center.x+a*c.x,y:this.center.y+a*c.y,z:this.center.z+a*c.z});this.anchor3.set3D({x:this.center.x-a*c.x,y:this.center.y-a*c.y,z:this.center.z-a*c.z})}};
V2.Polygon.H=class extends O.Object{constructor(a,b){super(a.id+"h");this.location=b.H;this.container=a;this.geometry=a.geometry;this.anchor=this.addAnchor(new O.Anchor(this.location))}attach(){super.attach();this.controlPoint=this.addControl(new O.ControlPoint(this.anchor,C.Surface.instance))}startControl(a){this.container.startControl();this.container.initTexture(V2.Polygon.EDIT)}endControl(a){this.container.initTexture(V2.Polygon.UNDEF);this.container.endControl()}moveControl(a){this.container.translate(0,
0,a.anchor.wz-this.container.anchors[0].wz);this.location.x=a.anchor.wx;this.location.y=a.anchor.wy;this.location.z=a.anchor.wz;V.touch3d()}};C.Surface=function(){this.strokeStyle=C.Surface.ACTIVE};C.Surface.ACTIVE="#40C4FF";C.Surface.PASSIVE="#40C4FF";C.Surface.prototype.moveControl=function(a){return this.getPoint(a)};
C.Surface.prototype.getPoint=function(a){let b=V.camera.getRay(a),c=V.viewer.raycast(b,{hits:[],distance:Number.POSITIVE_INFINITY}).hits;if(1==c.length)a=c[0].distance;else{let d=a.pageY/gl.drawingBufferHeight;a=a.pageX/gl.drawingBufferWidth<M.splitV&&d<M.splitH?c[0].distance:c[1].distance}return a!=Number.POSITIVE_INFINITY?b.at(a,{}):null};C.Surface.prototype.toJson=function(){return["Surface"]};C.Surface.instance=new C.Surface;
V.recvMessage("polygon.create",(a,b)=>{O.Polygon.validate(a)&&(a=new V2.Polygon(a),O.instance.addObject(a),b.uv=a.geometry.points,V.postMessage("polygon.create",a.toJson(),b),V.touch3d(),V.touch2d())});V.recvMessage("polygon.delete",function(a,b){let c=O.find(a.id);c.selected&&(c.unselect(),V.postMessage("polygon.unselect",c.toJson(),b));V.postMessage("polygon.delete",a,b);O.instance.removeObject(a.id);V.touch2d();V.touch3d()});
V.recvMessage("polygon.scan.start",a=>{let b=O.instance.getObject(a.id);b?b.startScan():V.postMessage("error","object not found "+a.id)});V.recvMessage("polygon.scan.stop",a=>{let b=O.instance.getObject(a.id);b?(b.stopScan(),V.touch3d()):V.postMessage("error","object not found "+a.id)});
</script>
<script id="/2d/overlay/line.js">V2.Line=class extends O.Line{constructor(a,b){super(a,b);this.ray=new GM.Ray;this.ray.direction.x=0;this.ray.direction.y=0;this.ray.direction.z=-1}startControl(a){this.timer&&this.stopScan()}stopScan(){this.timer&&(this.timer&&(clearTimeout(this.timer),delete this.timer),V.postMessage("line.scan.stop",{id:this.id}))}startScan(){this.timer&&clearTimeout(this.timer);this.scan={id:this.id,resolution:V.camera.pixelSize,count:0,samples:{},breaks:[]};Object.keys(V.viewer.datasets).forEach(a=>{this.scan.samples[a]=
[]});V.postMessage("line.scan.start",this.scan);this.sampleLine(0,V.camera.pixelSize)}sampleLine(a,b){var c=this.anchors[a+1].wx-this.anchors[a].wx,d=this.anchors[a+1].wy-this.anchors[a].wy,e=Math.sqrt(c*c+d*d);this.ray.origin.x=this.anchors[a].wx;this.ray.origin.y=this.anchors[a].wy;this.ray.origin.z=V.camera.position.z;this.scan.breaks.push(Math.ceil(e/b));this.timer=setTimeout(this.processScan.bind(this,{samples:e/b,ddx:c/e*b,ddy:d/e*b,index:a}),0)}processScan(a){if(V.camera.moving)this.timer=
setTimeout(this.processScan.bind(this,a),0);else{for(var b=0;b<Math.min(a.samples,40);b++)V.viewer.raycast(this.ray,{hits:[],distance:Number.POSITIVE_INFINITY}).hits.forEach(c=>{let d=this.scan.samples[c.id];c.distance!=Number.POSITIVE_INFINITY?d.push(V.viewer.aabb.max.z-c.distance):d.push(Number.POSITIVE_INFINITY)}),this.scan.count++,this.ray.origin.x+=a.ddx,this.ray.origin.y+=a.ddy;a.samples=Math.max(0,a.samples-40);this.timer=null;a.samples?this.timer=setTimeout(this.processScan.bind(this,a),0):
(V.postMessage("line.scan.sample",this.scan),a.index<this.anchors.length-2?this.sampleLine(a.index+1,V.camera.pixelSize):V.postMessage("line.scan.end",this.scan))}}};V.recvMessage("line.create",(a,b)=>{O.Line.validate(a)&&(a=new V2.Line(a),O.instance.addObject(a),V.postMessage("line.create",a.toJson(),b),V.touch2d(),V.touch3d())});
V.recvMessage("line.delete",function(a,b){let c=O.find(a.id);c.selected&&(c.unselect(),V.postMessage("line.unselect",c.toJson(),b));V.postMessage("line.delete",a,b);O.instance.removeObject(a.id);V.touch2d()});V.recvMessage("line.scan.start",a=>{let b=O.instance.getObject(a.id);b?b.startScan():V.postMessage("error","line not found "+a.id)});V.recvMessage("line.scan.stop",a=>{let b=O.instance.getObject(a.id);b?(b.stopScan(),V.touch3d()):V.postMessage("error","line not found "+a.id)});
</script>
<script id="/2d/overlay/floodfill.js">V2.FloodFill=class extends O.Object{constructor(a){super(a.id,a.activation);this.type="floodfill";this.ble=a.hasOwnProperty("visible")?a.visible:!0;this.constraint=new C.Intersect;this.anchor=this.addAnchor(new O.Anchor(a.point));this.anchorL=this.addAnchor(new O.Anchor(a.pL));this.anchorH=this.addAnchor(new O.Anchor(a.pH));this.projectAnchors();V2.FloodFill.Shader.instance||(V2.FloodFill.Shader.instance=new V2.FloodFill.Shader,V2.FloodFill.Shader.instance.compile());this.shader=V2.FloodFill.Shader.instance;
this.ddy=this.ddx=0}unselect(){super.unselect();this.context&&this.stopScan()}select(a){super.select();this.addControl(new O.ControlPoint(this.anchor,this.constraint))}update(a){super.update(a);a.hasOwnProperty("pL")&&(this.anchorL.wx=a.pL.x,this.anchorL.wy=a.pL.y);a.hasOwnProperty("pH")&&(this.anchorH.wx=a.pH.x,this.anchorH.wy=a.pH.y)}startControl(a){this.context&&this.stopScan();delete this.context}endControl(a){super.endControl();this.anchorL.wx=V.camera.min.x;this.anchorL.wy=V.camera.min.y;this.anchorL.project();
this.anchorH.wx=V.camera.max.x;this.anchorH.wy=V.camera.max.y;this.anchorH.project();V.postMessage("floodfill.update",this.toJson());V.touch3d()}intersectRay3D(a){var b=a.pageX-this.anchor.sx,c=a.pageY-this.anchor.sy;b=b*b+c*c;return b<O.ControlPoint.R2?b:a.pageX>this.anchorH.sx||a.pageX<this.anchorL.sx||a.pageY>this.anchorH.sy||a.pageY<this.anchorL.sy?Number.POSITIVE_INFINITY:1E3}render2D(a){super.render2D(a);this.selected||(a.fillStyle="#40C4FF",a.setTransform(1,0,0,1,this.anchor.sx,this.anchor.sy),
a.fill(O.ControlPoint.PATH));a.setTransform(1,0,0,1,0,0);a.strokeStyle="#40C4FF";a.lineWidth=3;a.beginPath();a.rect(this.anchorL.sx,this.anchorL.sy,this.anchorH.sx-this.anchorL.sx,this.anchorH.sy-this.anchorL.sy);a.stroke()}render3D(a){super.render3D(a);null!=this.context&&this.shader.render(this.anchorL,this.anchorH,this.context.pixelSize,this.ddx,this.ddy,.6*this.scale)}stopScan(){this.context&&(this.timer&&(clearTimeout(this.timer),delete this.timer),V.postMessage("floodfill.scan.stop",{id:this.id}),
delete this.context)}startScan(a){this.timer&&clearTimeout(this.timer);this.anchorL.wx<V.camera.min.x&&(this.anchorL.wx=V.camera.min.x);this.anchorH.wx>V.camera.max.x&&(this.anchorH.wx=V.camera.max.x);this.anchorL.wy<V.camera.min.y&&(this.anchorL.wy=V.camera.min.y);this.anchorH.wy>V.camera.max.y&&(this.anchorH.wy=V.camera.max.y);this.ddy=this.ddx=0;"upward"==a?(this.context=new V2.FloodFill.Upward(this),this.shader.setMode(1)):"downward"==a&&(this.context=new V2.FloodFill.Downward(this),this.shader.setMode(0));
this.timer=setTimeout(this.processScan.bind(this,this.context),0);V.postMessage("floodfill.scan.start",{id:this.id,samples:this.context.samples})}processScan(){V.camera.moving?this.timer=setTimeout(this.processScan.bind(this),100):(V.postMessage("floodfill.scan.sample",{id:this.id,resolution:this.context.pixelSize,samples:this.context.scan()}),this.shader.update(this.context.w,this.context.h,this.context.texture),V.touch3d(),this.context.done()?(delete this.timer,this.context.minX!=Number.MAX_VALUE&&
(this.ddx=this.context.minX-this.anchorL.wx,this.ddy=this.anchorH.wy-this.context.maxY,this.anchorL.wx=this.context.minX,this.anchorL.wy=this.context.minY,this.anchorL.project(),this.anchorH.wx=this.context.maxX,this.anchorH.wy=this.context.maxY,this.anchorH.project()),V.postMessage("floodfill.scan.end",{id:this.id,pL:this.anchorL.toJson(),pH:this.anchorH.toJson()}),V.touch2d()):this.timer=setTimeout(this.processScan.bind(this),0))}toJson(a){let b={};if(void 0==a||a.includes("type"))b.type=this.type;
if(void 0==a||a.includes("point"))b.point=this.anchor.toJson();if(void 0==a||a.includes("constraint"))b.constraint=this.constraint.toJson();if(void 0==a||a.includes("pL"))b.pL=this.anchorL.toJson();if(void 0==a||a.includes("pH"))b.pH=this.anchorH.toJson();return Object.assign(super.toJson(a),b)}};
V2.FloodFill.Context=class{constructor(a,b){this.pixelSize=V.camera.pixelSize;this.xH=a.anchorH.wx;this.yH=a.anchorH.wy;this.xL=a.anchorL.wx;this.yL=a.anchorL.wy;this.w=Math.ceil((a.anchorH.wx-a.anchorL.wx)/this.pixelSize);this.h=Math.ceil((a.anchorH.wy-a.anchorL.wy)/this.pixelSize);this.texture=V2.FloodFill.Shader.instance.initialize(this.w,this.h);this.minY=this.minX=Number.MAX_VALUE;this.maxX=-Number.MAX_VALUE;this.maxY=-Number.MAX_VALUE;this.ray=new GM.Ray;this.ray.direction.x=0;this.ray.direction.y=
0;this.ray.direction.z=-1;this.ray.origin.x=a.anchor.wx;this.ray.origin.y=a.anchor.wy;this.ray.origin.z=V.camera.position.z;let c=V.viewer.raycast(this.ray,{hits:[],distance:Number.POSITIVE_INFINITY}).hits;this.ray.direction.z=b;this.ray.origin.z-=c[0].distance;this.samples={};this.id0=c[0].id;this.cache0=new Float32Array(this.w*this.h);this.samples[this.id0]=[];1<c.length&&(this.id1=c[1].id,this.cache1=new Float32Array(this.w*this.h),this.samples[this.id1]=[]);this.stack=[{x:a.anchor.wx,y:a.anchor.wy}]}sample(a,
b){let c=Math.floor((this.yH-b)/this.pixelSize)*this.w+Math.floor((this.xH-a)/this.pixelSize);0==this.cache0[c]&&(this.ray.origin.x=a,this.ray.origin.y=b,a=V.viewer.raycast(this.ray,{hits:[],distance:Number.POSITIVE_INFINITY}).hits,a.length&&(this.cache0[c]=a[0].distance,1<a.length&&(this.cache1[c]=a[1].distance)));return c}done(){return 0==this.stack.length}scan(){for(var a in this.samples)this.samples[a]=[];a=this.stack.pop();for(a.y-=this.pixelSize;a.y>this.yL;){var b=this.sample(a.x,a.y);if(this.outside(this.cache0[b]))break;
a.y-=this.pixelSize}a.y+=this.pixelSize;for(var c=b=!1;a.y<this.yH;){var d=this.sample(a.x,a.y);if(this.outside(this.cache0[d]))break;else{var e=Math.floor((a.x-this.xL)/this.pixelSize),f=Math.floor((a.y-this.yL)/this.pixelSize);this.minX=Math.min(a.x,this.minX);this.maxX=Math.max(a.x,this.maxX);this.minY=Math.min(a.y,this.minY);this.maxY=Math.max(a.y,this.maxY);this.texture[f*this.w+e]=this.color(d);this.samples[this.id0].push(this.cache0[d]);this.id1&&this.samples[this.id1].push(this.cache1[d])}this.cache0[d]=
Number.POSITIVE_INFINITY;d=a.x-this.pixelSize;d>this.xL&&(e=this.sample(d,a.y),this.inside(this.cache0[e])?b||(this.stack.push({x:d,y:a.y}),b=!0):b=!1);d=a.x+this.pixelSize;d<this.xH&&(e=this.sample(d,a.y),this.inside(this.cache0[e])?c||(this.stack.push({x:d,y:a.y}),c=!0):c=!1);a.y+=this.pixelSize}return this.samples}};V2.FloodFill.Context.ABOVE=1;V2.FloodFill.Context.BELOW=255;
V2.FloodFill.Upward=class extends V2.FloodFill.Context{constructor(a){super(a,1)}inside(a){return 0<=a&&a!=Number.POSITIVE_INFINITY}outside(a){return 0>a||a==Number.POSITIVE_INFINITY}color(a){return 0<=(this.cache1?this.cache0[a]-this.cache1[a]:this.cache0[a])?V2.FloodFill.Context.ABOVE:V2.FloodFill.Context.BELOW}};
V2.FloodFill.Downward=class extends V2.FloodFill.Context{constructor(a){super(a,-1)}inside(a){return 0<=a&&a!=Number.POSITIVE_INFINITY}outside(a){return 0>a||a==Number.POSITIVE_INFINITY}color(a){return 0<=(this.cache1?this.cache0[a]-this.cache1[a]:this.cache0[a])?V2.FloodFill.Context.BELOW:V2.FloodFill.Context.ABOVE}};
V2.FloodFill.Shader=class extends GL.Shader{constructor(){super(V2.FloodFill.Shader.vs,V2.FloodFill.Shader.fs);var a=new Float32Array(12);a[0]=0;a[1]=0;a[2]=1;a[3]=0;a[4]=1;a[5]=1;a[6]=0;a[7]=0;a[8]=1;a[9]=1;a[10]=0;a[11]=1;this.vbo={uv:new GL.ArrayBuffer(a),position:new GL.ArrayBuffer(1)}}compile(){super.compile();this.defineAttribute("position",2,gl.FLOAT,!1);this.defineAttribute("uv",2,gl.FLOAT,!1);this.alpha=gl.getUniformLocation(this.glId,"alpha");this.mode=gl.getUniformLocation(this.glId,"mode");
this.dxy=gl.getUniformLocation(this.glId,"dxy");this.projection=gl.getUniformLocation(this.glId,"projection");this.samplerMap=gl.getUniformLocation(this.glId,"samplerMap")}initialize(a,b){var c=new Float32Array(12);c[0]=0;c[1]=0;c[2]=a;c[3]=0;c[4]=a;c[5]=b;c[6]=0;c[7]=0;c[8]=a;c[9]=b;c[10]=0;c[11]=b;this.vbo.position.set(c);this.glTextureId=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,this.glTextureId);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,
gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0);c=new Uint8Array(a*b);gl.pixelStorei(gl.UNPACK_ALIGNMENT,1);gl.texImage2D(gl.TEXTURE_2D,0,gl.R8UI,a,b,0,gl.RED_INTEGER,gl.UNSIGNED_BYTE,c);gl.bindTexture(gl.TEXTURE_2D,null);return c}update(a,b,c){gl.bindTexture(gl.TEXTURE_2D,this.glTextureId);gl.texImage2D(gl.TEXTURE_2D,0,gl.R8UI,a,b,0,gl.RED_INTEGER,
gl.UNSIGNED_BYTE,c);gl.bindTexture(gl.TEXTURE_2D,null)}setMode(a){gl.useProgram(this.glId);gl.uniform1f(this.mode,a);gl.useProgram(null)}render(a,b,c,d,e,f){gl.useProgram(this.glId);this.enableBuffer();this.bindBuffer(this.vbo);gl.activeTexture(gl.TEXTURE0);gl.uniform1i(this.samplerMap,0);let g=2*c/V.camera.pixelSize;M.Shader.projection[0]=g/gl.drawingBufferWidth;M.Shader.projection[1]=g/gl.drawingBufferHeight;a=(a.wx-d-V.camera.position.x)/c-d;b=(V.camera.position.y-b.wy-e)/c;gl.uniform3f(this.projection,
M.Shader.projection[0],M.Shader.projection[1],M.Shader.projection[2]);gl.uniform2f(this.dxy,a,b);gl.uniform1f(this.alpha,f);gl.bindTexture(gl.TEXTURE_2D,this.glTextureId);gl.disable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.drawArrays(gl.TRIANGLES,0,this.vbo.position.length/2);gl.disable(gl.BLEND);gl.enable(gl.DEPTH_TEST)}};V2.FloodFill.Shader.vs="#version 300 es\n\nprecision mediump float;\nprecision mediump int;\n\nuniform vec3 projection;\nuniform vec2 dxy;\n\nin vec2 uv;\nin vec2 position;\n\nout vec2 textureCoord;\n\nvoid main()\t\n{\n\n    textureCoord = uv;\n    \n    vec4 vertex = vec4((position.x + dxy.x), (position.y + dxy.y), 1.0, 1.0);\n    vertex.x *= projection.x;\n    vertex.y *= projection.y;\n    gl_Position = vertex;\n    \n    textureCoord = uv;\n\n    /*\n    textureCoord = uv;\n    \n    vec4 vertex = vec4(position.x, position.y, 0, 1.0);\n    vertex.x *= projection.x;\n    vertex.y *= projection.y;\n    gl_Position = vertex;\n    */\n}";
V2.FloodFill.Shader.fs="#version 300 es\n\nprecision mediump float;\nprecision mediump int;\n\nuniform mediump usampler2D samplerMap;\nuniform vec3 transparent; \nuniform vec3 split;\n\nuniform float mode;\nuniform float alpha;\n\nin vec2 textureCoord;\n\nconst uint UNDEF = uint(0);\nconst uint ABOVE = uint(1);\nconst uint BELOW = uint(255);\n\nout vec4 fragmentColor;\n\nvoid main()\t\n{\n    uint color = texture(samplerMap, vec2(textureCoord.s, textureCoord.t)).r;\n    \n    if (color == UNDEF)\n    {\n        discard;\n    } \n    else if (color == ABOVE)\n    {\n        fragmentColor =  vec4(0.0,1.0,0.0,alpha);\n    }\n    else if (color == BELOW)\n    {\n        fragmentColor =  vec4(1.0,0.0,0,alpha);\n    }  \n}";
V2.FloodFill.Shader.instance=null;
V2.FloodFill.Builder=class{constructor(a,b){this.config=a||{};this.custom=b;this.constraint=V.viewer.getConstraint()}addPoint(a,b){return O.instance.createControlPoint(a,this.constraint)}removePoint(a){}isDone(a){return 1==a.length}complete(a){this.config.visible=!0;this.config.type="floodfill";this.config.point=a[0];this.config.pL={x:V.camera.min.x,y:V.camera.min.y};this.config.pH={x:V.camera.max.x,y:V.camera.max.y};this.config.constraint=this.constraint.toJson();V.postMessage("floodfill.record",
this.config,this.custom)}};V.recvMessage("floodfill.record",(a,b)=>{O.Builder.get().start(new V2.FloodFill.Builder(a,b))});V.recvMessage("floodfill.update",function(a,b){var c=O.instance.getObject(a.id);c&&(c.update(a),V.postMessage("floodfill.update",a,b),V.touch2d(),V.touch3d())});V.recvMessage("floodfill.select",function(a,b){if(a=O.instance.getObject(a.id))a.select(),V.postMessage("floodfill.select",a.toJson(),b),V.touch2d()});
V.recvMessage("floodfill.unselect",function(a,b){var c=O.instance.getObject(a.id);c&&(c.unselect(),V.postMessage("floodfill.unselect",a,b),V.touch2d())});V.recvMessage("floodfill.create",(a,b)=>{a=new V2.FloodFill(a);O.instance.addObject(a);V.postMessage("floodfill.create",a.toJson(),b);V.touch3d();V.touch2d()});
V.recvMessage("floodfill.delete",function(a,b){let c=O.find(a.id);c.selected&&(c.unselect(),V.postMessage("floodfill.unselect",c.toJson(),b));V.postMessage("floodfill.delete",a,b);O.instance.removeObject(a.id);V.touch2d()});V.recvMessage("floodfill.scan.start",a=>{let b=O.instance.getObject(a.id);b?b.startScan(a.mode):V.postMessage("error","floodfill not found "+a.id)});
V.recvMessage("floodfill.scan.stop",a=>{let b=O.instance.getObject(a.id);b?(b.stopScan(),V.touch3d()):V.postMessage("error","floodfill not found "+a.id)});V.recvMessage("floodfill.get",(a,b)=>{if(a&&a.id){var c=O.instance.getObject(a.id);c&&V.postMessage("floodfill.get",c.toJson(a.filter),b)}else V.postMessage("floodfill.get",O.getAll("floodfill"),b)});
</script>


</html>

